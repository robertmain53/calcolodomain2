<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Permutation Calculator — nPr, With Repetition, and Multiset</title>
  <meta name="description" content="Compute permutations (nPr) without repetition, permutations with repetition (n^r), and multiset permutations. Clear formulas, step-by-step example, and accessible, mobile-first UI." />
  <link rel="canonical" href="https://calcdomain.com/permutation-calculator.html" />
  <link rel="icon" type="image/png" href="https://calcdomain.com/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="https://calcdomain.com/favicon.svg" />
  <link rel="shortcut icon" href="https://calcdomain.com/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://calcdomain.com/apple-touch-icon.png" />
  <link rel="manifest" href="https://calcdomain.com/site.webmanifest" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com" defer></script>
  <!-- MathJax for LaTeX -->
  <script defer id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    .prose { max-width: 70ch; }
    .prose h2 { font-size: 1.5rem; font-weight: 700; margin-top: 2rem; margin-bottom: 0.75rem; }
    .prose h3 { font-size: 1.125rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; }
    .prose p, .prose li { line-height: 1.65; }
    .formula-box { background:#f3f4f6; border:1px solid #d1d5db; border-radius:0.75rem; padding:1rem; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    /* Focus visible */
    :focus-visible { outline: 3px solid #2563eb; outline-offset: 2px; border-radius: 6px; }
    /* Results container min-height to avoid CLS */
    #resultsSection { min-height: 9rem; }
    /* Error text */
    .err { color:#b91c1c; }
    /* Touch target min size */
    .tap-target { min-height:48px; min-width:48px; }
    @media print {
      body * { visibility: hidden; }
      #print-section, #print-section * { visibility: visible; }
      #print-section { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>

  <!-- JSON-LD: WebPage -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"Permutation Calculator",
    "description":"Compute permutations (nPr), permutations with repetition (n^r), and multiset permutations with accessible UI and step-by-step example.",
    "url":"https://calcdomain.com/permutation-calculator.html",
    "inLanguage":"en",
    "author":{"@type":"Person","name":"Ugo Candido"},
    "publisher":{"@type":"Organization","name":"CalcDomain"}
  }
  </script>

  <!-- JSON-LD: Breadcrumbs -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://calcdomain.com/"},
      {"@type":"ListItem","position":2,"name":"Math","item":"https://calcdomain.com/math.html"},
      {"@type":"ListItem","position":3,"name":"Algebra","item":"https://calcdomain.com/subcategories/core-math-algebra.html"},
      {"@type":"ListItem","position":4,"name":"Permutation Calculator","item":"https://calcdomain.com/permutation-calculator.html"}
    ]
  }
  </script>

  <!-- JSON-LD: WebApplication -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Permutation Calculator",
    "applicationCategory": "EducationalApplication",
    "operatingSystem": "All",
    "author": {"@type":"Person","name":"Ugo Candido"},
    "publisher": {"@type":"Organization","name":"CalcDomain"},
    "offers": {"@type":"Offer","price":"0","priceCurrency":"USD"}
  }
  </script>

  <!-- JSON-LD: HowTo -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"HowTo",
    "name":"How to calculate permutations",
    "description":"Step-by-step guide for nPr, permutations with repetition, and multiset permutations.",
    "step":[
      {"@type":"HowToStep","name":"Choose mode","text":"Select nPr, With Repetition, or Multiset."},
      {"@type":"HowToStep","name":"Enter inputs","text":"Provide n and r for nPr or repetition; for multiset, enter each item count."},
      {"@type":"HowToStep","name":"Validate","text":"Fix any highlighted errors (non-negative integers, r ≤ n for nPr, at least one count > 0)."},
      {"@type":"HowToStep","name":"Compute","text":"Read the exact and scientific-notation results; copy results if needed."}
    ]
  }
  </script>

  <!-- JSON-LD: FAQPage (5 items) -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {"@type":"Question","name":"What is nPr (permutations without repetition)?","acceptedAnswer":{"@type":"Answer","text":"nPr equals n!/(n−r)! and counts ordered arrangements of r distinct items chosen from n without reuse."}},
      {"@type":"Question","name":"How do permutations with repetition differ?","acceptedAnswer":{"@type":"Answer","text":"With repetition allowed, each of r positions can be any of n items, so the count is n^r."}},
      {"@type":"Question","name":"What are multiset permutations?","acceptedAnswer":{"@type":"Answer","text":"If you have n total items with repeated counts k1, k2, …, the number of distinct orderings is n!/∏(ki!)."}},
      {"@type":"Question","name":"When will the calculator show scientific notation?","acceptedAnswer":{"@type":"Answer","text":"For very large results, the tool returns an exact integer when feasible and always provides a scientific-notation value for readability."}},
      {"@type":"Question","name":"Does the calculator handle very large n and r?","acceptedAnswer":{"@type":"Answer","text":"Yes. It uses BigInt products for exact values up to a safe threshold and logarithms for large cases to provide scientific-notation estimates."}}
    ]
  }
  </script>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- Header (non-sticky for mobile viewport) -->
  <header class="bg-white border-b">
    <nav class="container mx-auto px-4 lg:px-6 py-4 flex items-center justify-between">
      <a href="index.html" class="text-2xl font-bold text-blue-700">CalcDomain</a>
      <div class="hidden md:block text-sm">
        <a href="search.html" class="text-gray-700 hover:text-blue-700 mr-6">Advanced Search</a>
        <a href="index.html#categories" class="text-gray-700 hover:text-blue-700">Categories</a>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 lg:px-6 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Main column -->
      <section class="w-full lg:w-2/3">
        <nav class="text-sm text-gray-600 mb-4" aria-label="Breadcrumb">
          <a href="index.html" class="hover:text-blue-700">Home</a> &raquo;
          <a href="math.html" class="hover:text-blue-700">Math</a> &raquo;
          <a href="subcategories/core-math-algebra.html" class="hover:text-blue-700">Algebra</a> &raquo;
          <span class="text-gray-900">Permutation Calculator</span>
        </nav>

        <div id="print-section" class="bg-white p-6 rounded-lg shadow-md">
          <!-- 1. H1 -->
          <h1 class="text-3xl font-extrabold text-gray-900 mb-2">permutation calculator</h1>

          <!-- 2. Intro -->
          <p class="text-gray-700 mb-6">
            Quickly compute <strong>permutations (nPr)</strong>, <strong>permutations with repetition (n<sup>r</sup>)</strong>,
            and <strong>multiset permutations</strong>. Designed for students, engineers, and analysts who need
            trustworthy results with transparent formulas and accessible UX.
          </p>

          <!-- 3. Calculator Interface -->
          <section id="calculator" class="space-y-6" aria-labelledby="calcTitle">
            <h2 id="calcTitle" class="sr-only">Permutation Calculator Interface</h2>

            <!-- Mode tabs -->
            <div class="bg-gray-100 rounded-lg p-2 flex items-center gap-2" role="tablist" aria-label="Permutation modes">
              <button class="tap-target w-full md:w-auto px-4 py-2 rounded-md font-medium bg-white border border-gray-300 data-[active=true]:bg-blue-600 data-[active=true]:text-white"
                      role="tab" id="tab-npr" aria-controls="panel-npr" aria-selected="true" data-mode="npr">nPr (no repetition)</button>
              <button class="tap-target w-full md:w-auto px-4 py-2 rounded-md font-medium bg-white border border-gray-300"
                      role="tab" id="tab-rep" aria-controls="panel-rep" aria-selected="false" data-mode="rep">With repetition (n^r)</button>
              <button class="tap-target w-full md:w-auto px-4 py-2 rounded-md font-medium bg-white border border-gray-300"
                      role="tab" id="tab-multi" aria-controls="panel-multi" aria-selected="false" data-mode="multi">Multiset</button>
            </div>

            <!-- Panels -->
            <div id="panel-npr" role="tabpanel" aria-labelledby="tab-npr" class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label for="n_npr" class="block text-sm font-medium text-gray-800">
                    n (total distinct items) <span aria-hidden="true" class="text-red-600">*</span>
                  </label>
                  <div class="flex items-start gap-2">
                    <input type="number" inputmode="numeric" id="n_npr" min="0" step="1" value="10"
                           aria-required="true" aria-describedby="n_npr_help n_npr_err"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-600">
                    <button type="button" class="tap-target mt-1 px-2 py-2 border rounded-md"
                            aria-label="What is n?" aria-controls="n_npr_help" aria-expanded="false" data-tooltip>
                      ?
                    </button>
                  </div>
                  <p id="n_npr_help" class="text-xs text-gray-600 mt-1 hidden">
                    Non-negative integer. Number of available distinct items.
                  </p>
                  <p id="n_npr_err" class="text-sm err mt-1" aria-live="polite"></p>
                </div>

                <div>
                  <label for="r_npr" class="block text-sm font-medium text-gray-800">
                    r (positions) <span aria-hidden="true" class="text-red-600">*</span>
                  </label>
                  <div class="flex items-start gap-2">
                    <input type="number" inputmode="numeric" id="r_npr" min="0" step="1" value="3"
                           aria-required="true" aria-describedby="r_npr_help r_npr_err"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-600">
                    <button type="button" class="tap-target mt-1 px-2 py-2 border rounded-md"
                            aria-label="What is r?" aria-controls="r_npr_help" aria-expanded="false" data-tooltip>?</button>
                  </div>
                  <p id="r_npr_help" class="text-xs text-gray-600 mt-1 hidden">
                    Non-negative integer with r ≤ n. Number of ordered positions to fill.
                  </p>
                  <p id="r_npr_err" class="text-sm err mt-1" aria-live="polite"></p>
                </div>

                <div>
                  <label for="exactToggle_npr" class="block text-sm font-medium text-gray-800">Exact integer output</label>
                  <select id="exactToggle_npr" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-600" aria-describedby="exactToggle_help">
                    <option value="auto" selected>Auto (exact if feasible)</option>
                    <option value="force">Force exact (may be slow)</option>
                    <option value="estimate">Estimate only (scientific notation)</option>
                  </select>
                  <p id="exactToggle_help" class="text-xs text-gray-600 mt-1">
                    Large values can be huge; Auto shows exact only when safe and fast.
                  </p>
                </div>
              </div>
            </div>

            <div id="panel-rep" role="tabpanel" aria-labelledby="tab-rep" class="space-y-4 hidden">
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label for="n_rep" class="block text-sm font-medium text-gray-800">
                    n (options per position) <span aria-hidden="true" class="text-red-600">*</span>
                  </label>
                  <div class="flex items-start gap-2">
                    <input type="number" inputmode="numeric" id="n_rep" min="0" step="1" value="10"
                           aria-required="true" aria-describedby="n_rep_help n_rep_err"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-600">
                    <button type="button" class="tap-target mt-1 px-2 py-2 border rounded-md" aria-label="Help" aria-controls="n_rep_help" aria-expanded="false" data-tooltip>?</button>
                  </div>
                  <p id="n_rep_help" class="text-xs text-gray-600 mt-1 hidden">
                    Non-negative integer. Each of the r positions can take any of n options.
                  </p>
                  <p id="n_rep_err" class="text-sm err mt-1" aria-live="polite"></p>
                </div>

                <div>
                  <label for="r_rep" class="block text-sm font-medium text-gray-800">
                    r (positions) <span aria-hidden="true" class="text-red-600">*</span>
                  </label>
                  <div class="flex items-start gap-2">
                    <input type="number" inputmode="numeric" id="r_rep" min="0" step="1" value="3"
                           aria-required="true" aria-describedby="r_rep_help r_rep_err"
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-600">
                    <button type="button" class="tap-target mt-1 px-2 py-2 border rounded-md" aria-label="Help" aria-controls="r_rep_help" aria-expanded="false" data-tooltip>?</button>
                  </div>
                  <p id="r_rep_help" class="text-xs text-gray-600 mt-1 hidden">
                    Non-negative integer. Repetition is allowed; the formula is n^r.
                  </p>
                  <p id="r_rep_err" class="text-sm err mt-1" aria-live="polite"></p>
                </div>

                <div>
                  <label for="exactToggle_rep" class="block text-sm font-medium text-gray-800">Exact integer output</label>
                  <select id="exactToggle_rep" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-600">
                    <option value="auto" selected>Auto (exact if feasible)</option>
                    <option value="force">Force exact</option>
                    <option value="estimate">Estimate only</option>
                  </select>
                </div>
              </div>
            </div>

            <div id="panel-multi" role="tabpanel" aria-labelledby="tab-multi" class="space-y-4 hidden">
              <div class="rounded-md border border-gray-200 p-4">
                <p class="text-sm text-gray-700 mb-3">
                  Enter counts for each repeated item (e.g., letters in a word). The total items
                  \( n = \sum k_i \), result is \( \dfrac{n!}{\prod k_i!} \).
                </p>
                <div id="multisetRows" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                <div class="flex flex-wrap gap-3 mt-3">
                  <button type="button" id="addRow" class="tap-target px-4 py-2 rounded-md bg-blue-600 text-white">Add item</button>
                  <button type="button" id="clearRows" class="tap-target px-4 py-2 rounded-md border">Clear</button>
                </div>
                <p id="multi_err" class="text-sm err mt-2" aria-live="polite"></p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                  <label for="exactToggle_multi" class="block text-sm font-medium text-gray-800">Exact integer output</label>
                  <select id="exactToggle_multi" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-600">
                    <option value="auto" selected>Auto (exact if feasible)</option>
                    <option value="force">Force exact</option>
                    <option value="estimate">Estimate only</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-wrap gap-3">
              <button id="computeBtn" class="tap-target px-5 py-2.5 rounded-md bg-blue-600 text-white font-semibold">Compute</button>
              <button id="copyBtn" class="tap-target px-5 py-2.5 rounded-md border font-semibold" aria-describedby="copyMsg">Copy result</button>
              <span id="copyMsg" class="text-sm text-gray-600" aria-live="polite"></span>
            </div>
          </section>

          <!-- 4. Results Area -->
          <section id="resultsSection" class="mt-6 bg-blue-50 border border-blue-100 rounded-lg p-5" aria-live="polite">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div class="bg-white border rounded-lg p-4 text-center">
                <h4 class="text-sm text-gray-600">Result (exact)</h4>
                <p id="resultExact" class="mt-1 text-xl font-bold text-blue-700 break-all">—</p>
              </div>
              <div class="bg-white border rounded-lg p-4 text-center">
                <h4 class="text-sm text-gray-600">Scientific notation</h4>
                <p id="resultSci" class="mt-1 text-xl font-bold text-blue-700 break-all">—</p>
              </div>
              <div class="bg-white border rounded-lg p-4 text-center">
                <h4 class="text-sm text-gray-600">Digits</h4>
                <p id="resultDigits" class="mt-1 text-xl font-bold text-blue-700">—</p>
              </div>
            </div>
          </section>
        </div>

        <!-- 5. Authoritative Content Ecosystem -->
        <article class="bg-white p-6 rounded-lg shadow-md mt-8 prose">
          <h2>Data source & methodology</h2>
          <p>
            <strong>Authoritative source:</strong> <a class="text-blue-700 underline" href="https://dlmf.nist.gov/" rel="nofollow noopener" target="_blank">
            NIST Digital Library of Mathematical Functions (DLMF)</a>, Sections on factorial/gamma and combinatorial enumeration, 2024 edition.
            <br><em>“All computations strictly follow the formulas and definitions provided by this source.”</em>
          </p>

          <h2>The formulas explained</h2>
          <div class="formula-box">
            <p><strong>Permutations without repetition (nPr):</strong></p>
            <p>\\[ P(n,r) = {}_nP_r = \frac{n!}{(n-r)!}, \quad 0 \le r \le n \\]</p>
            <p><strong>Permutations with repetition:</strong></p>
            <p>\\[ P_{\mathrm{rep}}(n,r) = n^r, \quad n \ge 0,\, r \ge 0 \\]</p>
            <p><strong>Multiset permutations:</strong></p>
            <p>\\[ \text{If } n=\sum_{i=1}^{m} k_i, \quad \#\text{arrangements} = \frac{n!}{\prod_{i=1}^{m} k_i!}. \\]</p>
          </div>

          <h2>Glossary of variables</h2>
          <ul>
            <li><strong>n</strong> — total number of available items (distinct), or options per position (with repetition), or total items in a multiset.</li>
            <li><strong>r</strong> — number of ordered positions to fill.</li>
            <li><strong>k<sub>i</sub></strong> — count of the i-th repeated item in a multiset.</li>
            <li><strong>P(n,r)</strong> — number of ordered selections of length r from n distinct items without reuse.</li>
          </ul>

          <h2>How it works: a step-by-step example</h2>
          <h3>Example 1 — nPr</h3>
          <p>Suppose \(n=10\) items and \(r=3\) positions. Then:</p>
          <p class="formula-box">\\[ P(10,3) = \frac{10!}{(10-3)!} = 10 \times 9 \times 8 = 720. \\]</p>

          <h3>Example 2 — with repetition</h3>
          <p>With \(n=5\) options and \(r=4\) positions allowing reuse:</p>
          <p class="formula-box">\\[ 5^4 = 625. \\]</p>

          <h3>Example 3 — multiset</h3>
          <p>For the word <code>BALLOON</code> with letters counts: B=1, A=1, L=2, O=2, N=1 (total \(n=7\)):</p>
          <p class="formula-box">\\[ \frac{7!}{2!\,2!} = \frac{5040}{4} = 1260. \\]</p>

          <h2>Frequently asked questions</h2>
          <details>
            <summary>Why do you show both exact and scientific notation?</summary>
            <p>Permutation counts grow extremely fast. Exact integers can have thousands of digits; scientific notation keeps results readable while preserving magnitude.</p>
          </details>
          <details>
            <summary>What limits apply to exact integer output?</summary>
            <p>The calculator computes an exact BigInt product when it’s fast and safe (range length and digit count thresholds). You can force exact or estimate only via the dropdown.</p>
          </details>
          <details>
            <summary>Can I compute multiset permutations for many categories?</summary>
            <p>Yes. Add as many rows as needed and enter each count \(k_i\). The tool validates that the total is positive and all \(k_i \ge 0\).</p>
          </details>
          <details>
            <summary>What happens for r &gt; n in nPr mode?</summary>
            <p>Permutations without repetition require \(r \le n\). The tool flags this as an error and won’t compute.</p>
          </details>
          <details>
            <summary>Is the methodology academically sound?</summary>
            <p>Yes. We implement standard definitions aligned with the NIST DLMF and mainstream combinatorics texts. The UI simply operationalizes those formulas with careful numeric handling.</p>
          </details>

          <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700">
            <p><strong>Tool developed by Ugo Candido.</strong> Content reviewed by the CalcDomain Editorial Board.<br>
            Last accuracy review: <time datetime="2025-10-25">October 25, 2025</time></p>
          </div>
        </article>
      </section>

      <!-- Sidebar -->
      <aside class="w-full lg:w-1/3">
        <div class="sticky top-24 space-y-6">
          <div class="bg-gray-200 h-72 rounded-lg flex items-center justify-center text-gray-600">
            Ad Placement (300×600)
          </div>

          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="font-bold text-lg mb-3">Why this calculator stands out</h3>
            <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
              <li>Three modes: nPr, with repetition, and multiset.</li>
              <li>Exact BigInt results when feasible—always with a scientific estimate.</li>
              <li>WCAG-compliant labels, tooltips, and keyboard navigation.</li>
            </ul>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="font-bold text-lg mb-3">Related math tools</h3>
            <ul class="space-y-2 text-sm">
              <li><a href="combination-calculator.html" class="text-blue-700 hover:underline">Combination Calculator (nCr)</a></li>
              <li><a href="factorial-calculator.html" class="text-blue-700 hover:underline">Factorial Calculator</a></li>
              <li><a href="arrangements-vs-combinations.html" class="text-blue-700 hover:underline">Arrangements vs. Combinations</a></li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="bg-white border-t">
    <div class="container mx-auto px-6 py-8 text-center text-gray-600 text-sm">
      <p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
      <div class="mt-4 space-x-4">
        <a href="about.html" class="hover:text-blue-700">About</a>
        <a href="contact.html" class="hover:text-blue-700">Contact</a>
        <a href="privacy.html" class="hover:text-blue-700">Privacy</a>
        <a href="terms.html" class="hover:text-blue-700">Terms</a>
      </div>
    </div>
  </footer>

  <!-- Calculator Logic (defer by default via placement at end) -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    // Utility: show/hide tooltip text blocks tied via aria-controls
    document.querySelectorAll('[data-tooltip]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('aria-controls');
        const el = document.getElementById(id);
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!expanded));
        if (el) el.classList.toggle('hidden', expanded);
      });
    });

    // Tabs
    const tabs = [
      {btn: 'tab-npr', panel: 'panel-npr'},
      {btn: 'tab-rep', panel: 'panel-rep'},
      {btn: 'tab-multi', panel: 'panel-multi'}
    ];
    function activateTab(name) {
      tabs.forEach(t => {
        const b = document.getElementById(t.btn);
        const p = document.getElementById(t.panel);
        const active = (t.btn === name);
        b.setAttribute('aria-selected', active ? 'true' : 'false');
        b.dataset.active = active ? 'true' : 'false';
        p.classList.toggle('hidden', !active);
      });
      // Clear errors on tab switch
      clearErrors();
      updateResults('—','—','—');
    }
    tabs.forEach(t => {
      document.getElementById(t.btn).addEventListener('click', () => activateTab(t.btn));
    });

    // NPR inputs & validation
    const n_npr = document.getElementById('n_npr');
    const r_npr = document.getElementById('r_npr');
    const n_npr_err = document.getElementById('n_npr_err');
    const r_npr_err = document.getElementById('r_npr_err');

    // REP inputs
    const n_rep = document.getElementById('n_rep');
    const r_rep = document.getElementById('r_rep');
    const n_rep_err = document.getElementById('n_rep_err');
    const r_rep_err = document.getElementById('r_rep_err');

    // MULTI
    const multisetRows = document.getElementById('multisetRows');
    const multiErr = document.getElementById('multi_err');
    const addRowBtn = document.getElementById('addRow');
    const clearRowsBtn = document.getElementById('clearRows');

    // Exact toggles
    const exactToggle_npr = document.getElementById('exactToggle_npr');
    const exactToggle_rep = document.getElementById('exactToggle_rep');
    const exactToggle_multi = document.getElementById('exactToggle_multi');

    // Results
    const resultExact = document.getElementById('resultExact');
    const resultSci = document.getElementById('resultSci');
    const resultDigits = document.getElementById('resultDigits');

    // Copy
    const copyBtn = document.getElementById('copyBtn');
    const copyMsg = document.getElementById('copyMsg');

    // Buttons
    document.getElementById('computeBtn').addEventListener('click', compute);

    // Validation handlers (on-blur)
    [n_npr, r_npr, n_rep, r_rep].forEach(el => el && el.addEventListener('blur', validateAll));

    function clearErrors() {
      [n_npr_err, r_npr_err, n_rep_err, r_rep_err, multiErr].forEach(el => { if (el) el.textContent = ''; });
    }

    function isInt(x) { return Number.isInteger(x) && Number.isFinite(x); }
    function parseNonNegInt(el) {
      const v = Number(el.value);
      return (Number.isFinite(v) && v >= 0 && Number.isInteger(v)) ? v : null;
    }

    function validateNPR() {
      let ok = true;
      const n = parseNonNegInt(n_npr);
      const r = parseNonNegInt(r_npr);
      if (n === null) { n_npr_err.textContent = 'Enter a non-negative integer for n.'; ok = false; } else n_npr_err.textContent = '';
      if (r === null) { r_npr_err.textContent = 'Enter a non-negative integer for r.'; ok = false; } else r_npr_err.textContent = '';
      if (ok && r > n) { r_npr_err.textContent = 'For permutations without repetition, r must not exceed n.'; ok = false; }
      return ok;
    }

    function validateREP() {
      let ok = true;
      const n = parseNonNegInt(n_rep);
      const r = parseNonNegInt(r_rep);
      if (n === null) { n_rep_err.textContent = 'Enter a non-negative integer for n.'; ok = false; } else n_rep_err.textContent = '';
      if (r === null) { r_rep_err.textContent = 'Enter a non-negative integer for r.'; ok = false; } else r_rep_err.textContent = '';
      return ok;
    }

    function validateMULTI() {
      let ok = true;
      const counts = getMultisetCounts();
      if (counts.length === 0) { multiErr.textContent = 'Add at least one item count.'; return false; }
      if (counts.some(c => !isInt(c) || c < 0)) { multiErr.textContent = 'All counts must be non-negative integers.'; return false; }
      const total = counts.reduce((a,b)=>a+b,0);
      if (total <= 0) { multiErr.textContent = 'Total count must be greater than zero.'; return false; }
      multiErr.textContent = '';
      return ok;
    }

    function validateAll() {
      const active = activeMode();
      if (active === 'npr') return validateNPR();
      if (active === 'rep') return validateREP();
      if (active === 'multi') return validateMULTI();
      return false;
    }

    function activeMode() {
      if (document.getElementById('panel-npr').classList.contains('hidden') === false) return 'npr';
      if (document.getElementById('panel-rep').classList.contains('hidden') === false) return 'rep';
      return 'multi';
    }

    // Multiset row management
    function addRow(value = 0) {
      const id = 'k_' + (crypto.getRandomValues(new Uint32Array(1))[0]);
      const wrapper = document.createElement('div');
      wrapper.className = 'flex items-start gap-2';
      wrapper.innerHTML = `
        <div class="flex-1">
          <label for="${id}" class="block text-sm font-medium text-gray-800">k (count)</label>
          <input type="number" inputmode="numeric" id="${id}" value="${value}" min="0" step="1"
                 class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-600">
        </div>
        <button type="button" class="tap-target mt-8 px-3 py-2 border rounded-md removeRow" aria-label="Remove row">Remove</button>
      `;
      multisetRows.appendChild(wrapper);
      wrapper.querySelector('.removeRow').addEventListener('click', () => wrapper.remove());
    }
    function clearRows() { multisetRows.innerHTML = ''; }
    function getMultisetCounts() {
      return Array.from(multisetRows.querySelectorAll('input[type="number"]')).map(i => Number(i.value));
    }
    addRow(2); addRow(2); addRow(3);

    addRowBtn.addEventListener('click', () => addRow(0));
    clearRowsBtn.addEventListener('click', () => { clearRows(); addRow(1); });

    // BigInt helpers
    const BIGINT_THRESHOLD_RANGE = 20000; // max multiplicative range length for exact product
    const DIGIT_LIMIT_EXACT = 5000;       // avoid rendering excessively huge exact strings

    function bigintRangeProduct(start, end) {
      // Product of integers from start to end inclusive; start<=end, using BigInt.
      let p = 1n;
      for (let x = start; x <= end; x++) p *= BigInt(x);
      return p;
    }

    function digitsFromLog10(log10v) {
      return Math.max(1, Math.floor(log10v) + 1);
    }

    function toScientificFromLog10(log10v) {
      if (!Number.isFinite(log10v)) return '—';
      const e = Math.floor(log10v);
      const mantLog = log10v - e;
      const mant = Math.pow(10, mantLog);
      return mant.toPrecision(6) + 'e' + (e >= 0 ? '+' : '') + e;
    }

    function log10Factorial(n) {
      // Kamenetsky / Stirling-based approximation with exact small cache
      if (n < 2) return 0;
      // Use Gamma approximation: log10(n!) ≈ n*log10(n/e) + log10(2πn)/2
      const pi2 = Math.log10(2 * Math.PI * n) / 2;
      return n * (Math.log10(n) - Math.LOG10E) + pi2;
    }

    function log10PermRange(n, r) {
      // log10 of product n*(n-1)*...*(n-r+1)
      // Sum log10(k) for k in (n-r+1 .. n)
      let s = 0;
      const start = n - r + 1;
      for (let k = start; k <= n; k++) s += Math.log10(k);
      return s;
    }

    function computeNPR(n, r, exactMode) {
      // Decide exact vs estimate
      const rangeLen = r;
      const log10v = log10PermRange(n, r);
      const digitEstimate = digitsFromLog10(log10v);

      let exact = null;
      if ((exactMode === 'force') || (exactMode === 'auto' && rangeLen <= BIGINT_THRESHOLD_RANGE && digitEstimate <= DIGIT_LIMIT_EXACT)) {
        exact = bigintRangeProduct(n - r + 1, n).toString();
      }
      const sci = toScientificFromLog10(log10v);
      return { exact, sci, digits: digitEstimate };
    }

    function computeREP(n, r, exactMode) {
      const log10v = (n === 0 && r > 0) ? -Infinity : r * (n === 0 ? -Infinity : Math.log10(n));
      const digits = Number.isFinite(log10v) ? digitsFromLog10(log10v) : (r === 0 ? 1 : 1);
      let exact = null;
      if ((exactMode === 'force') || (exactMode === 'auto' && r <= BIGINT_THRESHOLD_RANGE && digits <= DIGIT_LIMIT_EXACT)) {
        let p = 1n;
        const bn = BigInt(n);
        for (let i = 0; i < r; i++) p *= bn;
        exact = p.toString();
      }
      const sci = (n === 0 && r > 0) ? '0' : toScientificFromLog10(r * Math.log10(Math.max(1, n)));
      return { exact: (n===0 && r>0) ? '0' : exact, sci: (n===0 && r>0) ? '0' : sci, digits };
    }

    function computeMULTI(counts, exactMode) {
      const n = counts.reduce((a,b)=>a+b,0);
      // log10(n!) - sum log10(ki!)
      let log10v = log10Factorial(n);
      counts.forEach(k => { log10v -= log10Factorial(k); });
      const digits = digitsFromLog10(log10v);

      let exact = null;
      // Exact via factorial ratio with BigInt if feasible: multiply range and divide factorials progressively.
      // Strategy: numerator = n!, denominator = ∏ ki!, compute as product of ranges to avoid overflow.
      if ((exactMode === 'force') || (exactMode === 'auto' && n <= BIGINT_THRESHOLD_RANGE && digits <= DIGIT_LIMIT_EXACT)) {
        // Compute n! as BigInt
        let num = 1n;
        for (let i=2; i<=n; i++) num *= BigInt(i);
        // Divide by each ki!
        for (const k of counts) {
          for (let j=2; j<=k; j++) num /= BigInt(j); // exact division guaranteed
        }
        exact = num.toString();
      }
      const sci = toScientificFromLog10(log10v);
      return { exact, sci, digits };
    }

    function updateResults(exact, sci, digits) {
      resultExact.textContent = exact ?? '—';
      resultSci.textContent = sci ?? '—';
      resultDigits.textContent = Number.isFinite(digits) ? String(digits) : '—';
      // Re-typeset Math if needed
      if (window.MathJax && MathJax.typesetPromise) MathJax.typesetPromise();
    }

    function compute() {
      clearErrors();
      const mode = activeMode();
      if (mode === 'npr') {
        if (!validateNPR()) { updateResults('—','—','—'); return; }
        const n = Number(n_npr.value), r = Number(r_npr.value);
        const res = computeNPR(n, r, exactToggle_npr.value);
        updateResults(res.exact, res.sci, res.digits);
      } else if (mode === 'rep') {
        if (!validateREP()) { updateResults('—','—','—'); return; }
        const n = Number(n_rep.value), r = Number(r_rep.value);
        const res = computeREP(n, r, exactToggle_rep.value);
        updateResults(res.exact, res.sci, res.digits);
      } else {
        if (!validateMULTI()) { updateResults('—','—','—'); return; }
        const counts = getMultisetCounts();
        const res = computeMULTI(counts, exactToggle_multi.value);
        updateResults(res.exact, res.sci, res.digits);
      }
    }

    copyBtn.addEventListener('click', async () => {
      const payload = `Exact: ${resultExact.textContent}\nScientific: ${resultSci.textContent}\nDigits: ${resultDigits.textContent}`;
      try {
        await navigator.clipboard.writeText(payload);
        copyMsg.textContent = 'Copied!';
        setTimeout(()=>{ copyMsg.textContent=''; }, 1500);
      } catch {
        copyMsg.textContent = 'Copy failed. Select and copy manually.';
        setTimeout(()=>{ copyMsg.textContent=''; }, 2500);
      }
    });

    // Default active tab
    activateTab('tab-npr');
  });
  </script>
</body>
</html>
