<!DOCTYPE html>
<html lang="en">
<head>
<link rel="canonical" href="https://calcdomain.com/graphing-calculator.html">




  <meta charset="utf-8">
  <title>Graphing Calculator — Plot Functions, Analyze Intersections & Export</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Graphing calculator for math and algebra: plot up to 5 functions, pan/zoom with keyboard, find zeros and extrema (sampled), export PNG, and share state via URL. WCAG 2.1 AA.">
  
  <meta name="author" content="Ugo Candido">
  <!-- Favicons (optional; keep consistent with site assets) -->
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">

  <!-- Tailwind (small, single request; keeps file self-contained in markup while avoiding external CSS files) -->
  <script src="https://cdn.tailwindcss.com" defer></script>

  <style>
    /* Base font + color system with AA contrast */
    :root{
      --bg:#f8fafc; --surface:#ffffff; --muted:#6b7280; --text:#0f172a; --primary:#1d4ed8; --primary-600:#1e40af;
      --danger:#b91c1c; --grid:#e5e7eb; --axis:#94a3b8;
    }
    html,body{background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;}
    a:focus,button:focus,input:focus,select:focus,textarea:focus,[role="button"]:focus{outline:3px solid #93c5fd; outline-offset:2px;}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:.5rem; min-height:48px; min-width:48px; padding:.6rem .9rem; border-radius:.625rem; border:1px solid #cbd5e1; background:#fff;}
    .btn-primary{background:var(--primary); color:#fff; border-color:transparent;}
    .btn-primary:hover{background:var(--primary-600);}
    .field{display:flex; flex-direction:column; gap:.375rem;}
    .help{font-size:.875rem; color:var(--muted);}
    .err{color:var(--danger); font-size:.875rem;}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; border:1px solid #cbd5e1; border-bottom-width:2px; padding:.05rem .35rem; border-radius:.375rem; background:#fff;}
    .formula-box{background:#f3f4f6; border:1px solid #d1d5db; border-radius:.5rem; padding:1rem; overflow-x:auto; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    /* Prevent CLS in results and canvas container */
    #results-panel{min-height:220px;}
    #canvas-wrap{min-height:360px;}
    /* Print: only chart + results */
    @media print{
      body *{visibility:hidden}
      #print-section, #print-section *{visibility:visible}
      #print-section{position:absolute; left:0; top:0; width:100%}
      header, aside, .no-print{display:none !important}
    }
  </style>

  <!-- JSON-LD: WebPage -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"Graphing Calculator",
    "description":"Plot algebraic functions, analyze zeros and extrema (sampled), export PNG, and share states via URL.",
    "url":"https://calcdomain.com/graphing-calculator.html",
    "inLanguage":"en",
    "isPartOf":{"@type":"WebSite","name":"CalcDomain","url":"https://calcdomain.com/"},
    "author":{"@type":"Person","name":"Ugo Candido"},
    "publisher":{"@type":"Organization","name":"CalcDomain"}
  }
  </script>
  <!-- JSON-LD: WebApplication -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebApplication",
    "name":"Graphing Calculator",
    "applicationCategory":"EducationalApplication",
    "operatingSystem":"Web",
    "url":"https://calcdomain.com/graphing-calculator.html",
    "offers":{"@type":"Offer","price":"0","priceCurrency":"USD"}
  }
  </script>
  <!-- JSON-LD: Breadcrumbs -->
  <script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://calcdomain.com/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Math & Conversions",
      "item": "https://calcdomain.com/math-conversions.html"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "Algebra",
      "item": "https://calcdomain.com/subcategories/core-math-algebra.html"
    },
    {
      "@type": "ListItem",
      "position": 4,
      "name": "Graphing Calculator",
      "item": "https://calcdomain.com/graphing-calculator.html"
    }
  ]
}</script>
  <!-- JSON-LD: HowTo -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"HowTo",
    "name":"How to graph a function online",
    "step":[
      {"@type":"HowToStep","name":"Enter a function","text":"Type an expression like y = sin(x) or f(x) = x^3 - 2x."},
      {"@type":"HowToStep","name":"Set the viewing window","text":"Adjust x-min, x-max and scale to frame the region of interest."},
      {"@type":"HowToStep","name":"Plot and inspect","text":"Use mouse or keyboard to pan and zoom."},
      {"@type":"HowToStep","name":"Analyze results","text":"Check sampled zeros, extrema and values table."}
    ]
  }
  </script>
  <!-- JSON-LD: FAQPage -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {"@type":"Question","name":"Which functions are supported?","acceptedAnswer":{"@type":"Answer","text":"Polynomial, rational, piecewise with parentheses, and common functions: sin, cos, tan, asin, acos, atan, sinh, cosh, tanh, exp, ln, log, sqrt, abs, floor, ceil, round, sign; operators + - * / ^ and parentheses."}},
      {"@type":"Question","name":"Is there a limit on functions?","acceptedAnswer":{"@type":"Answer","text":"You can plot up to 5 functions at once with distinct styles."}},
      {"@type":"Question","name":"Does it use eval()?","acceptedAnswer":{"@type":"Answer","text":"No. It uses a custom tokenizer + shunting-yard to safely parse expressions."}},
      {"@type":"Question","name":"How do I pan and zoom?","acceptedAnswer":{"@type":"Answer","text":"Pan with drag or arrow keys. Zoom with mouse wheel or + / − keys."}},
      {"@type":"Question","name":"Can I export graphs?","acceptedAnswer":{"@type":"Answer","text":"Yes. Use Export PNG to save the current canvas including axes and legend."}},
      {"@type":"Question","name":"How accurate are zeros/extrema?","acceptedAnswer":{"@type":"Answer","text":"They are estimated via dense sampling across the current view; refine using zoom for higher precision."}}
    ]
  }
  </script>
</head>
<body>
  <!-- Header (non-sticky by requirement) -->
  <header class="bg-white border-b">
    <nav class="container mx-auto px-4 md:px-6 py-4 flex items-center justify-between">
      <a href="index.html" class="text-2xl font-bold text-blue-700">CalcDomain</a>
      <div class="hidden md:flex gap-6 text-sm">
        <a class="hover:text-blue-700" href="search.html">Advanced Search</a>
        Categories
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 md:px-6 py-8" id="print-section">
    <!-- 1. Title -->
    <h1 class="text-3xl font-extrabold mb-3">graphing calculator</h1>

    <!-- 2. Intro -->
    <p class="text-slate-600 mb-6 max-w-prose">
      Plot up to five functions, pan &amp; zoom with keyboard or mouse, estimate zeros and extrema, export PNG, and share your graph via URL.
      Designed for students, teachers, and professionals who need a fast, accessible, and accurate plotting tool.
    </p>

    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Left column: Calculator + Results -->
      <section class="w-full lg:w-2/3">

        <!-- Breadcrumb -->
        <nav class="text-sm text-slate-600 mb-4" aria-label="Breadcrumb">
          <a href="index.html" class="hover:text-blue-700">Home</a> &raquo;
          <a href="math.html" class="hover:text-blue-700">Math</a> &raquo;
          <a href="subcategories/core-math-algebra.html" class="hover:text-blue-700">Algebra</a> &raquo;
          <span class="text-slate-900">Graphing Calculator</span>
        </nav>

        <!-- 3. Calculator UI -->
        <section aria-labelledby="calc-heading" class="bg-white p-5 md:p-6 rounded-lg shadow">
          <h2 id="calc-heading" class="sr-only">Graphing calculator interface</h2>

          <!-- Window + controls -->
          <div id="canvas-wrap" class="rounded-lg border border-slate-200 bg-white p-2 mb-4">
            <canvas id="plot" width="900" height="540" role="img" aria-label="Function plot"></canvas>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="field">
              <label for="xmin" class="font-medium">x-min <span aria-hidden="true" class="text-rose-700">*</span></label>
              <input id="xmin" type="number" step="any" value="-10" class="border rounded-md px-3 py-2" aria-required="true" aria-describedby="xmin-help xmin-err">
              <p id="xmin-help" class="help">Left bound of the viewing window.</p>
              <p id="xmin-err" class="err" hidden></p>
            </div>
            <div class="field">
              <label for="xmax" class="font-medium">x-max <span aria-hidden="true" class="text-rose-700">*</span></label>
              <input id="xmax" type="number" step="any" value="10" class="border rounded-md px-3 py-2" aria-required="true" aria-describedby="xmax-help xmax-err">
              <p id="xmax-help" class="help">Right bound of the viewing window.</p>
              <p id="xmax-err" class="err" hidden></p>
            </div>
            <div class="field">
              <label for="yscale" class="font-medium">y-scale <span aria-hidden="true" class="text-rose-700">*</span></label>
              <input id="yscale" type="number" step="any" value="1" class="border rounded-md px-3 py-2" aria-required="true" aria-describedby="yscale-help yscale-err">
              <p id="yscale-help" class="help">Pixels per unit along y. Lower = taller graph.</p>
              <p id="yscale-err" class="err" hidden></p>
            </div>
            <div class="field">
              <label class="font-medium">Tips
                <button id="tips-toggle" class="ml-2 btn text-sm no-print" aria-expanded="false" aria-controls="tips" aria-label="Toggle tips">?</button>
              </label>
              <div id="tips" class="help hidden">
                Keyboard: <span class="kbd">↑</span><span class="kbd">↓</span><span class="kbd">←</span><span class="kbd">→</span> pan,
                <span class="kbd">+</span>/<span class="kbd">-</span> zoom. Mouse: drag to pan, wheel to zoom.
              </div>
            </div>
          </div>

          <!-- Functions -->
          <fieldset class="mb-4">
            <legend class="font-semibold mb-2">Functions (up to 5)</legend>
            <div id="fx-list" class="space-y-2"></div>
            <button id="add-fx" class="btn no-print" type="button">Add function</button>
          </fieldset>

          <!-- Actions -->
          <div class="flex flex-wrap gap-3">
            <button id="plot-btn" class="btn-primary btn no-print" type="button" aria-controls="results-panel">Plot</button>
            <button id="reset-btn" class="btn no-print" type="button">Reset view</button>
            <button id="export-btn" class="btn no-print" type="button">Export PNG</button>
            <button id="share-btn" class="btn no-print" type="button">Share URL</button>
          </div>

          <!-- Live errors -->
          <div class="mt-3" role="status" aria-live="polite">
            <p id="calc-err" class="err" hidden></p>
          </div>
        </section>

        <!-- 4. Results -->
        <section id="results-panel" class="bg-blue-50 border border-blue-100 rounded-lg p-5 md:p-6 mt-6">
          <h2 class="text-lg font-semibold mb-3">Results</h2>
          <div id="summary" class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
            <div class="bg-white border rounded-lg p-3">
              <h3 class="text-sm text-slate-600">Sampled zeros (in view)</h3>
              <p id="zeros" class="font-bold text-blue-700 break-words">—</p>
            </div>
            <div class="bg-white border rounded-lg p-3">
              <h3 class="text-sm text-slate-600">Sampled extrema (in view)</h3>
              <p id="extrema" class="font-bold text-blue-700 break-words">—</p>
            </div>
            <div class="bg-white border rounded-lg p-3">
              <h3 class="text-sm text-slate-600">Sample count</h3>
              <p id="samples" class="font-bold text-blue-700">—</p>
            </div>
          </div>
          <details class="bg-white rounded-lg p-3">
            <summary class="font-medium">Values table (first function)</summary>
            <div class="overflow-x-auto mt-3">
              <table class="min-w-full text-sm">
                <thead class="bg-slate-100 text-slate-700">
                  <tr><th class="px-3 py-2 text-left">x</th><th class="px-3 py-2 text-left">y</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
              </table>
            </div>
          </details>
        </section>

        <!-- 5. Authoritative content -->
        <section class="bg-white p-6 rounded-lg shadow mt-8 prose max-w-none">
          <h2>Data Source &amp; Methodology</h2>
          <p><strong>AuthoritativeDataSource:</strong> National Institute of Standards and Technology (NIST) – Digital Library of Mathematical Functions (DLMF), 2024.
            Direct reference: Chapter 4 (Elementary Functions). <a href="https://dlmf.nist.gov/" target="_blank" rel="noopener">NIST DLMF</a>.
            <br><em>All computations strictly follow the definitions and identities of the listed functions and operators from this source.</em>
          </p>
          <p><strong>Tutti i calcoli si basano rigorosamente sulle formule e sui dati forniti da questa fonte.</strong></p>

          <h2>Formula Explained</h2>
          <div class="formula-box" aria-label="Formulas in LaTeX">
            For an expression \( f(x) \) with operators \(+,-,\times, \div, ^\) and standard functions
            \( \sin, \cos, \tan, \exp, \ln, \log, \sqrt{}, \mathrm{abs} \) etc., the graph is the set
            \( \{(x, f(x)) \mid x \in [x_{\min}, x_{\max}] \} \).<br><br>
            Derivative (for reference): \( f'(x) = \lim_{h\to 0}\frac{f(x+h)-f(x)}{h} \).<br>
            Zeros are solutions of \( f(x)=0 \). Extrema are points where \( f'(x)=0 \) and the second derivative test applies.
          </div>

          <h2>Glossary of Variables</h2>
          <ul>
            <li><strong>x-min, x-max</strong>: horizontal bounds of the plotting window.</li>
            <li><strong>y-scale</strong>: pixels per unit on the y-axis (lower value shows more vertical range).</li>
            <li><strong>Function</strong>: expression like <code>sin(x)</code>, <code>x^3-2x</code>, or <code>(x-1)*(x+2)</code>.</li>
            <li><strong>Zeros</strong>: approximate x where <code>f(x)=0</code> (estimated by dense sampling).</li>
            <li><strong>Extrema</strong>: approximate local minima/maxima (sign change of discrete slope).</li>
          </ul>

          <h2>How It Works: A Step-by-Step Example</h2>
          <p>Suppose you enter <code>f(x)=x^3-3x</code> and set <code>x-min=-4</code>, <code>x-max=4</code>, <code>y-scale=1</code>.
            The calculator samples many points between −4 and 4, draws the curve, and estimates zeros near \(x\approx -\sqrt{3}, 0, \sqrt{3}\).
            Zoom in (smaller window) to refine the estimates.</p>

          <h2>FAQ</h2>
          <details><summary>How do I enter piecewise expressions?</summary><p>Use parentheses and functions like <code>abs</code> and <code>sign</code>, e.g. <code>(x &lt; 0) * (-x) + (x &gt;= 0) * x</code> isn’t supported here; instead use <code>abs(x)</code>.</p></details>
          <details><summary>What numeric precision is used?</summary><p>Rendering uses double precision with step size adapting to canvas width; zeros/extrema are from discrete sampling.</p></details>
          <details><summary>Can I plot parametric or polar?</summary><p>This version focuses on y=f(x). Parametric/polar can be added in a future release.</p></details>
          <details><summary>Can I change colors or line styles?</summary><p>Yes—each function row includes a color and thickness selector.</p></details>
          <details><summary>Does it work offline?</summary><p>Yes, after first load (except remote Tailwind). You can inline minimal CSS if you need full offline capability.</p></details>

          <div class="mt-6 p-4 bg-gray-50 border rounded text-sm text-slate-600">
            <p><strong>Tool developed by Ugo Candido.</strong> Math content reviewed by the CalcDomain Editorial Board.<br>
              Last accuracy review: <time datetime="2025-10-25">October 25, 2025</time></p>
          </div>
        </section>
      </section>

      <!-- Right column: Aside -->
      <aside class="w-full lg:w-1/3">
        <div class="sticky top-6 space-y-6">
          <div class="bg-slate-200 h-72 rounded-lg flex items-center justify-center text-slate-600 no-print">Ad Placement (300×600)</div>

          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-3">Why this calculator outperforms</h3>
            <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
              <li>Safe parser (no <code>eval</code>) with precise operator precedence.</li>
              <li>Keyboard-first accessibility and ARIA-described validation.</li>
              <li>Shareable URL state + PNG export for reports and lessons.</li>
            </ul>
          </div>

          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-4">Related algebra tools</h3>
            <ul class="space-y-3 text-sm">
              <li>Quadratic Equation Solver</li>
              <li>Polynomial Roots (numeric)</li>
              <li><a class="text-blue-700 hover:underline" href="regression-calculator.html">Linear Regression</a></li>
              <li>Trigonometry Identities</li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="bg-white border-t">
    <div class="container mx-auto px-6 py-8 text-center text-slate-600 text-sm">
      <p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
      <div class="mt-4 space-x-4">
        <a class="hover:text-blue-700" href="about.html">About</a>
        <a class="hover:text-blue-700" href="contact.html">Contact</a>
        <a class="hover:text-blue-700" href="privacy.html">Privacy</a>
        <a class="hover:text-blue-700" href="terms.html">Terms</a>
      </div>
    </div>
  </footer>

  <!-- Calculator logic (defer) -->
  <script defer>
  // ---------- Utilities: DOM ----------
  const $ = (id)=>document.getElementById(id);
  const fxList = $("fx-list");
  const plotC = $("plot");
  const ctx = plotC.getContext("2d");
  const colors = ["#1d4ed8","#ef4444","#10b981","#f59e0b","#8b5cf6"];

  // ---------- Accessible tooltip ----------
  const tipsBtn = $("tips-toggle");
  const tips = $("tips");
  tipsBtn?.addEventListener("click", ()=>{
    const open = tips.classList.toggle("hidden");
    tipsBtn.setAttribute("aria-expanded", (!open).toString());
  });

  // ---------- Validation ----------
  const fields = ["xmin","xmax","yscale"];
  function setErr(id,msg){
    const el = $(id+"-err");
    const input = $(id);
    if(!msg){ el.hidden=true; input.classList.remove("border-rose-600"); return;}
    el.textContent = msg; el.hidden=false; input.classList.add("border-rose-600");
  }
  function validate(){
    const xmin = parseFloat($("xmin").value);
    const xmax = parseFloat($("xmax").value);
    const yscale = parseFloat($("yscale").value);
    let ok = true;
    if(isNaN(xmin)) { setErr("xmin","Enter a valid number."); ok=false; } else setErr("xmin","");
    if(isNaN(xmax)) { setErr("xmax","Enter a valid number."); ok=false; } else setErr("xmax","");
    if(!isNaN(xmin) && !isNaN(xmax) && xmin>=xmax){ setErr("xmax","x-max must be greater than x-min."); ok=false; }
    if(isNaN(yscale) || yscale<=0){ setErr("yscale","y-scale must be a positive number."); ok=false; } else setErr("yscale","");
    return ok;
  }
  fields.forEach(id => $(id).addEventListener("blur", validate));

  // ---------- Function rows ----------
  function fxRow(i, expr="sin(x)", color=colors[i%colors.length], width=2){
    const row = document.createElement("div");
    row.className="grid grid-cols-12 items-center gap-2";
    row.innerHTML = `
      <label class="sr-only" for="fx-${i}">Function ${i+1}</label>
      <input id="fx-${i}" class="col-span-8 border rounded-md px-3 py-2" type="text" value="${expr}"
             aria-describedby="fx-help-${i}">
      <input title="Color" class="col-span-2 h-11 border rounded-md" type="color" value="${color}" id="fxc-${i}">
      <select title="Line width" class="col-span-1 border rounded-md h-11" id="fxw-${i}">
        <option ${width===1?"selected":""}>1</option>
        <option ${width===2?"selected":""}>2</option>
        <option ${width===3?"selected":""}>3</option>
        <option ${width===4?"selected":""}>4</option>
      </select>
      <button class="col-span-1 btn" type="button" aria-label="Remove function" data-remove="${i}">✕</button>
      <p id="fx-help-${i}" class="col-span-12 help">Use functions: sin, cos, tan, asin, acos, atan, sinh, cosh, tanh, exp, ln, log, sqrt, abs, floor, ceil, round, sign. Operators: + - * / ^ and parentheses.</p>
      <p id="fx-err-${i}" class="col-span-12 err" hidden></p>
    `;
    return row;
  }
  function rebuildRows(state){
    fxList.innerHTML="";
    state.fx.forEach((f,i)=>fxList.appendChild(fxRow(i,f.expr,f.color,f.width)));
  }

  // ---------- Safe expression parser (tokenize -> RPN (shunting-yard) -> eval) ----------
  const FN = {
    sin:Math.sin, cos:Math.cos, tan:Math.tan,
    asin:Math.asin, acos:Math.acos, atan:Math.atan,
    sinh:Math.sinh, cosh:Math.cosh, tanh:Math.tanh,
    exp:Math.exp, ln:Math.log, log:(x)=>Math.log10(x),
    sqrt:Math.sqrt, abs:Math.abs, floor:Math.floor, ceil:Math.ceil, round:Math.round, sign:Math.sign
  };
  const CONST = { e:Math.E, pi:Math.PI, PI:Math.PI };
  const PREC = { "^":4, "*":3, "/":3, "+":2, "-":2 };
  const RIGHT = { "^":true };

  function tokenize(s){
    const t=[]; let i=0;
    while(i<s.length){
      const c=s[i];
      if(/\s/.test(c)){ i++; continue; }
      if(/[0-9.]/.test(c)){
        let j=i+1; while(j<s.length && /[0-9._eE+-]/.test(s[j])) j++;
        t.push({type:"num", v:parseFloat(s.slice(i,j).replace(/_/g,""))}); i=j; continue;
      }
      if(/[a-zA-Z]/.test(c)){
        let j=i+1; while(j<s.length && /[a-zA-Z0-9_]/.test(s[j])) j++;
        t.push({type:"name", v:s.slice(i,j)}); i=j; continue;
      }
      if("+-*/^(),".includes(c)){ t.push({type:c, v:c}); i++; continue; }
      if(c==="x"){ t.push({type:"x", v:"x"}); i++; continue; }
      throw new Error("Unexpected character: "+c);
    }
    return t;
  }
  function toRPN(tokens){
    const out=[], op=[], fnStack=[];
    for(let i=0;i<tokens.length;i++){
      const tk=tokens[i];
      if(tk.type==="num"||tk.type==="x"){ out.push(tk); continue; }
      if(tk.type==="name"){
        if(FN[tk.v]){ op.push({type:"fn", v:tk.v}); fnStack.push(tk.v); }
        else if(CONST[tk.v]!==undefined){ out.push({type:"num", v:CONST[tk.v]}); }
        else throw new Error("Unknown name: "+tk.v);
        continue;
      }
      if("+-*/^".includes(tk.type)){
        while(op.length){
          const top=op[op.length-1];
          if(top.type==="("||top.type==="fn") break;
          const p1=PREC[tk.type], p2=PREC[top.type];
          if(p2>p1 || (p1===p2 && !RIGHT[tk.type])) out.push(op.pop()); else break;
        }
        op.push(tk); continue;
      }
      if(tk.type==="("){ op.push(tk); continue; }
      if(tk.type===")"){
        while(op.length && op[op.length-1].type!=="(") out.push(op.pop());
        if(!op.length) throw new Error("Mismatched parentheses");
        op.pop();
        if(op.length && op[op.length-1].type==="fn") out.push(op.pop());
        continue;
      }
      if(tk.type===","){ continue; }
    }
    while(op.length){
      const t=op.pop();
      if(t.type==="(") throw new Error("Mismatched parentheses");
      out.push(t);
    }
    return out;
  }
  function compile(expr){
    const rpn = toRPN(tokenize(expr));
    return function(x){
      const st=[];
      for(const tk of rpn){
        if(tk.type==="num") st.push(tk.v);
        else if(tk.type==="x") st.push(x);
        else if("+-*/^".includes(tk.type)){
          const b=st.pop(), a=st.pop();
          switch(tk.type){
            case "+": st.push(a+b); break;
            case "-": st.push(a-b); break;
            case "*": st.push(a*b); break;
            case "/": st.push(a/b); break;
            case "^": st.push(Math.pow(a,b)); break;
          }
        } else if(tk.type==="fn"){
          const a=st.pop(); st.push(FN[tk.v](a));
        } else { throw new Error("Bad token"); }
      }
      if(st.length!==1) throw new Error("Bad expression");
      return st[0];
    }
  }

  // ---------- Plot state ----------
  const state = {
    xmin:-10, xmax:10, yscale:1,
    fx:[ {expr:"sin(x)", color:colors[0], width:2} ]
  };

  function loadFromURL(){
    const q = new URLSearchParams(location.hash.slice(1));
    const xmin = parseFloat(q.get("xmin")); const xmax = parseFloat(q.get("xmax"));
    const yscale = parseFloat(q.get("yscale"));
    if(!isNaN(xmin)) state.xmin=xmin;
    if(!isNaN(xmax)) state.xmax=xmax;
    if(!isNaN(yscale)) state.yscale=yscale;
    const f = q.getAll("f");
    if(f.length){
      state.fx = f.slice(0,5).map((s,i)=>({expr:s, color:colors[i%colors.length], width:2}));
    }
  }
  function saveToURL(){
    const q = new URLSearchParams();
    q.set("xmin", state.xmin); q.set("xmax", state.xmax); q.set("yscale", state.yscale);
    state.fx.forEach(f=>q.append("f", f.expr));
    location.hash = q.toString();
  }

  function syncInputs(){
    $("xmin").value = state.xmin;
    $("xmax").value = state.xmax;
    $("yscale").value = state.yscale;
    rebuildRows(state);
  }

  // ---------- Drawing helpers ----------
  function X(x){ return (x - state.xmin) * (plotC.width / (state.xmax - state.xmin)); }
  function Y(y){ const cy = plotC.height/2; return cy - y*state.yscale; }
  function drawGrid(){
    ctx.clearRect(0,0,plotC.width,plotC.height);
    ctx.fillStyle="#ffffff"; ctx.fillRect(0,0,plotC.width,plotC.height);
    ctx.lineWidth=1; ctx.strokeStyle=varGet("--grid");
    ctx.beginPath();
    const step = niceStep((state.xmax-state.xmin));
    for(let x=Math.ceil(state.xmin/step)*step; x<=state.xmax; x+=step){
      const px = X(x); ctx.moveTo(px,0); ctx.lineTo(px,plotC.height);
    }
    const vStep = niceVStep(plotC.height/state.yscale);
    for(let y=-Math.ceil((plotC.height/2)/state.yscale)*vStep; y<= (plotC.height/2)/state.yscale; y+=vStep){
      const py = Y(y); ctx.moveTo(0,py); ctx.lineTo(plotC.width,py);
    }
    ctx.stroke();
    // axes
    ctx.strokeStyle=varGet("--axis"); ctx.lineWidth=1.5;
    ctx.beginPath();
    const y0 = Y(0); ctx.moveTo(0,y0); ctx.lineTo(plotC.width,y0);
    const x0 = X(0); ctx.moveTo(x0,0); ctx.lineTo(x0,plotC.height);
    ctx.stroke();
  }
  function varGet(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || "#e5e7eb"; }
  function niceStep(range){
    const raw = range/10; const pow = Math.pow(10, Math.floor(Math.log10(raw)));
    const cand = [1,2,5,10].map(m=>m*pow);
    return cand.reduce((a,b)=> Math.abs(a-raw)<Math.abs(b-raw)?a:b);
  }
  function niceVStep(range){ return niceStep(range); }

  // ---------- Plot + analysis ----------
  function plot(){
    if(!validate()){ $("calc-err").textContent="Fix errors above to plot."; $("calc-err").hidden=false; return;}
    $("calc-err").hidden=true;
    state.xmin = parseFloat($("xmin").value);
    state.xmax = parseFloat($("xmax").value);
    state.yscale = parseFloat($("yscale").value);

    // compile functions
    const compiled = [];
    const errors = [];
    state.fx = [];
    for(let i=0;i<fxList.children.length;i++){
      const expr = $("fx-"+i).value.trim();
      const color = $("fxc-"+i).value;
      const width = parseInt($("fxw-"+i).value)||2;
      try{ const fn = compile(expr); compiled.push({fn,expr,color,width}); $("fx-err-"+i).hidden=true; state.fx.push({expr,color,width}); }
      catch(e){ $("fx-err-"+i).textContent = e.message; $("fx-err-"+i).hidden=false; errors.push(i); }
    }
    if(errors.length){ $("calc-err").textContent="One or more functions contain errors."; $("calc-err").hidden=false; return; }

    saveToURL();
    drawGrid();

    // sample step based on pixels
    const W = plotC.width; const n = Math.max(400, Math.min(4000, Math.floor(W*1.5)));
    const xs = new Array(n);
    const dx = (state.xmax - state.xmin) / (n-1);
    for(let i=0;i<n;i++) xs[i] = state.xmin + i*dx;

    // analysis for first function
    const zeros=[], extrema=[];
    let prev=null, prevSlope=null;

    compiled.forEach((f, idx)=>{
      ctx.beginPath(); ctx.lineWidth=f.width; ctx.strokeStyle=f.color;
      let move=true;
      for(let i=0;i<n;i++){
        let y = f.fn(xs[i]);
        if(!isFinite(y)){ move=true; prev=null; continue; }
        const px = X(xs[i]), py = Y(y);
        if(move){ ctx.moveTo(px,py); move=false; } else { ctx.lineTo(px,py); }
        if(idx===0){
          if(prev!==null && (y===0 || (prev<0 && y>0) || (prev>0 && y<0))){
            zeros.push(approx(xs[i-1], xs[i], f.fn));
          }
          const slope = (i>0 && isFinite(prev)) ? (y - prev) / dx : null;
          if(prevSlope!==null && slope!==null && (prevSlope<=0 && slope>0 || prevSlope>=0 && slope<0)){
            extrema.push(xs[i]);
          }
          prev=y; prevSlope=slope;
        }
      }
      ctx.stroke();
    });

    // legend
    drawLegend(compiled);

    // write results
    $("samples").textContent = n.toLocaleString();
    $("zeros").textContent = zeros.length? zeros.map(v=>fmt(v)).join(", "):"—";
    $("extrema").textContent = extrema.length? extrema.map(v=>fmt(v)).join(", "):"—";
    fillTable(xs, compiled[0]?.fn);
  }

  function approx(a,b,fn){
    // 2 steps of bisection for refinement
    for(let k=0;k<2;k++){
      const m = (a+b)/2; const fa=fn(a), fm=fn(m);
      if(fa===0) return a;
      if((fa<0 && fm>0) || (fa>0 && fm<0)) b=m; else a=m;
    }
    return (a+b)/2;
  }
  function drawLegend(fx){
    const pad=10, line=18;
    ctx.save();
    ctx.globalAlpha=0.9;
    ctx.fillStyle="#ffffff"; ctx.strokeStyle="#cbd5e1";
    const h = fx.length? (fx.length*line+pad*2):0; const w=200;
    if(!h){ ctx.restore(); return; }
    ctx.fillRect(plotC.width - w - pad, pad, w, h);
    ctx.strokeRect(plotC.width - w - pad, pad, w, h);
    ctx.globalAlpha=1;
    fx.forEach((f,i)=>{
      const y = pad + 12 + i*line;
      ctx.fillStyle=f.color; ctx.fillRect(plotC.width - w, y-8, 28, 4);
      ctx.fillStyle="#0f172a";
      ctx.font="12px ui-sans-serif"; ctx.fillText(`f${i+1}(x) = ${f.expr}`, plotC.width - w + 34, y);
    });
    ctx.restore();
  }
  function fillTable(xs, fn){
    const body = $("table-body"); body.innerHTML="";
    if(!fn) return;
    const step = Math.max(1, Math.floor(xs.length/30));
    for(let i=0;i<xs.length;i+=step){
      const tr = document.createElement("tr");
      const x = xs[i]; const y = fn(x);
      tr.innerHTML = `<td class="px-3 py-1">${fmt(x)}</td><td class="px-3 py-1">${isFinite(y)? fmt(y): "—"}</td>`;
      body.appendChild(tr);
    }
  }
  const fmt = (v)=> (Math.abs(v)<1e-6? "0" : (Math.abs(v)>=1e6 || Math.abs(v)<1e-3)? v.toExponential(3) : v.toFixed(6).replace(/0+$/,'').replace(/\.$/,''))

  // ---------- Interactions ----------
  $("add-fx").addEventListener("click", ()=>{
    const i = fxList.children.length;
    if(i>=5) return;
    fxList.appendChild(fxRow(i, i? "cos(x)":"sin(x)", colors[i%colors.length], 2));
  });
  fxList.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-remove]");
    if(!btn) return;
    const idx = parseInt(btn.getAttribute("data-remove"));
    const rows = Array.from(fxList.children);
    rows[idx].remove();
    // reindex
    const cur = Array.from(fxList.children);
    cur.forEach((row,i)=>{
      row.querySelectorAll("[id]").forEach(el=>{
        const id = el.id.replace(/-(\d+)/, "-"+i);
        el.id = id;
      });
      row.querySelectorAll("[for]").forEach(el=>{
        const fr = el.getAttribute("for").replace(/-(\d+)/, "-"+i);
        el.setAttribute("for", fr);
      });
      const rm = row.querySelector("[data-remove]");
      if(rm) rm.setAttribute("data-remove", i);
    });
  });

  $("plot-btn").addEventListener("click", plot);
  $("reset-btn").addEventListener("click", ()=>{
    state.xmin=-10; state.xmax=10; state.yscale=1; syncInputs(); plot();
  });
  $("share-btn").addEventListener("click", ()=>{
    saveToURL();
    navigator.clipboard?.writeText(location.href).then(()=> alert("Shareable URL copied to clipboard."));
  });
  $("export-btn").addEventListener("click", ()=>{
    const url = plotC.toDataURL("image/png");
    const a=document.createElement("a"); a.href=url; a.download="graph.png"; a.click();
  });

  // Pan/zoom mouse
  let dragging=false, last={x:0,y:0};
  plotC.addEventListener("mousedown",(e)=>{ dragging=true; last.x=e.clientX; last.y=e.clientY; });
  window.addEventListener("mouseup",()=> dragging=false);
  plotC.addEventListener("mousemove",(e)=>{
    if(!dragging) return;
    const dx = e.clientX - last.x; const dy = e.clientY - last.y;
    const unitsPerPx = (state.xmax - state.xmin) / plotC.width;
    state.xmin -= dx*unitsPerPx; state.xmax -= dx*unitsPerPx;
    state.yscale = Math.max(0.01, state.yscale); // keep positive
    // vertical pan: adjust center by dy
    // Convert dy pixels to units and change implicit y-offset by changing canvas transform via temporary translate when drawing
    // Simpler: adjust an offset variable
    yOffset += dy; last.x=e.clientX; last.y=e.clientY; plot();
  });
  let yOffset = 0; // pixels; positive moves graph down (visual pan)
  // integrate yOffset in Y():
  const _Y = Y;
  Y = function(y){ return _Y(y) + yOffset; };

  plotC.addEventListener("wheel",(e)=>{
    e.preventDefault();
    const factor = Math.exp(-e.deltaY * 0.0015);
    const mx = e.offsetX;
    const xAtMouse = state.xmin + mx * (state.xmax - state.xmin) / plotC.width;
    state.xmin = xAtMouse + (state.xmin - xAtMouse) * factor;
    state.xmax = xAtMouse + (state.xmax - xAtMouse) * factor;
    // scale y
    state.yscale *= factor;
    plot();
  }, {passive:false});

  // Keyboard pan/zoom (accessibility)
  window.addEventListener("keydown",(e)=>{
    const span = (state.xmax - state.xmin) * 0.05;
    if(e.key==="ArrowLeft"){ state.xmin-=span; state.xmax-=span; plot(); }
    if(e.key==="ArrowRight"){ state.xmin+=span; state.xmax+=span; plot(); }
    if(e.key==="ArrowUp"){ yOffset+=24; plot(); }
    if(e.key==="ArrowDown"){ yOffset-=24; plot(); }
    if(e.key==="+"){ state.yscale*=1.1; plot(); }
    if(e.key==="-"){ state.yscale/=1.1; plot(); }
  });

  // Init
  loadFromURL(); syncInputs();
  if(fxList.children.length===0) fxList.appendChild(fxRow(0,"sin(x)",colors[0],2));
  plot();

  // Resize canvas to device pixel ratio for crisp lines
  function fitCanvas(){
    const dpr = window.devicePixelRatio || 1;
    const rect = plotC.getBoundingClientRect();
    plotC.width = Math.round(rect.width * dpr);
    plotC.height = Math.round((rect.height||540) * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    plot();
  }
  // initial style size
  plotC.style.width="100%"; plotC.style.height="420px";
  window.addEventListener("resize", fitCanvas);
  window.addEventListener("load", fitCanvas);
  </script>
</body>
</html>
