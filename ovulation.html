<!DOCTYPE html>
<html lang="en"><head> 
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="manifest" href="/site.webmanifest" />
<meta charset="utf-8"/>
<title>Ovulation Calculator | CalcDomain</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="Professional ovulation calculator: predict your ovulation day, fertile window, next period, and best test dates. Built on clinical methodology with accessible, mobile-first design." name="description"/>
<meta content="Ugo Candido" name="author"/>
<link href="https://calcdomain.com/ovulation.html" rel="canonical"/>
<meta content="#005A9C" name="theme-color"/>
<meta content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" name="robots"/>
<!-- Preload non-critical stylesheet (optional). The page is fully styled without it. -->
<noscript></noscript>
<!-- Structured Data (WebPage + HowTo + FAQPage) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Ovulation Calculator",
  "description": "Predict ovulation, fertile window, next period, and earliest reliable pregnancy test date using clinically grounded formulas.",
  "url": "https://calcdomain.com/ovulation.html",
  "inLanguage": "en",
  "isPartOf": {
    "@type": "WebSite",
    "name": "CalcDomain",
    "url": "https://calcdomain.com"
  },
  "about": [
    {
      "@type": "Thing",
      "name": "Health and Fitness"
    },
    {
      "@type": "Thing",
      "name": "Pregnancy & Women's Health"
    }
  ],
  "author": {
    "@type": "Person",
    "name": "Ugo Candido"
  },
  "publisher": {
    "@type": "Organization",
    "name": "CalcDomain"
  },
  "mainEntity": [
    {
      "@type": "HowTo",
      "name": "How it works: A step-by-step example",
      "description": "Enter the first day of your last period and your typical cycle length. The tool estimates ovulation as cycle length minus luteal phase days from your last period, and builds your fertile window around it.",
      "totalTime": "PT1M",
      "supply": [
        {
          "@type": "HowToSupply",
          "name": "Your recent menstrual cycle data"
        }
      ],
      "tool": [
        {
          "@type": "HowToTool",
          "name": "Ovulation Calculator"
        }
      ],
      "step": [
        {
          "@type": "HowToStep",
          "name": "Enter LMP date",
          "text": "Select the first day of your last menstrual period."
        },
        {
          "@type": "HowToStep",
          "name": "Choose cycle pattern",
          "text": "Select Regular or Irregular cycles. For irregular cycles, specify your shortest and longest cycles."
        },
        {
          "@type": "HowToStep",
          "name": "Set cycle/luteal length",
          "text": "Enter your average cycle length (or range) and optional luteal phase length (commonly 14 days)."
        },
        {
          "@type": "HowToStep",
          "name": "View results",
          "text": "Read your predicted ovulation day, fertile window, next period, and test dates."
        }
      ]
    },
    {
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "How is ovulation estimated?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Ovulation is approximated as your last menstrual period plus (cycle length minus luteal phase). The fertile window spans from five days before ovulation through one day after."
          }
        },
        {
          "@type": "Question",
          "name": "What if my cycles are irregular?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Provide your shortest and longest recent cycles. The calculator displays a date range for ovulation, fertile window, and next period to reflect variability."
          }
        },
        {
          "@type": "Question",
          "name": "What luteal phase length should I use?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "If unknown, 14 days is a common default. If you track basal body temperature or progesterone, you can enter your measured luteal length."
          }
        },
        {
          "@type": "Question",
          "name": "When should I take a pregnancy test?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "For the highest reliability, test on or after the first day of your missed period. Some sensitive tests detect pregnancy about 10–12 days after ovulation."
          }
        },
        {
          "@type": "Question",
          "name": "Is this tool medical advice?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "No. It provides educational estimates and cannot diagnose or replace personalized medical guidance. Consult a healthcare professional for concerns."
          }
        },
        {
          "@type": "Question",
          "name": "Which days are best for intercourse to conceive?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "The highest conception odds are from 2 days before ovulation through ovulation day, within the broader fertile window of 5 days before through 1 day after ovulation."
          }
        },
        {
          "@type": "Question",
          "name": "Will time zones affect the dates?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Dates are based on your local time zone. They are presented as calendar days rather than exact times."
          }
        }
      ]
    }
  ]
}
  </script>
<style>
    /* --- Critical, mobile-first CSS (WCAG 2.1 AA) --- */
    :root{
      --primary-color:#005A9C; --secondary-color:#003F6E; --accent-color:#00A4E4;
      --background-color:#F8F9FA; --surface-color:#FFFFFF;
      --text-color:#212529; --muted-text-color:#6C757D; --border-color:#DEE2E6;
      --success-color:#198754; --error-color:#DC3545;
      --radius:12px; --radius-sm:8px;
      --shadow:0 2px 6px rgba(0,0,0,.08);
      --touch-min:48px;
    }
    *{box-sizing:border-box}
    html{font-size:16px}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,sans-serif;
      background:var(--background-color); color:var(--text-color); line-height:1.6;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .skip-link{
      position:absolute; left:8px; top:-40px; background:var(--primary-color); color:#fff;
      padding:8px 12px; border-radius:6px; text-decoration:none; z-index:9999;
    }
    .skip-link:focus{top:8px}
    main{display:block}
    .container{max-width:1100px; margin:0 auto; padding:1rem}
    h1,h2,h3{color:var(--secondary-color); line-height:1.25; margin:0 0 .75rem}
    h1{font-size:1.9rem}
    h2{font-size:1.4rem}
    p{margin:0 0 1rem; max-width:70ch}
    a{color:var(--primary-color)}
    a:focus,button:focus,input:focus,select:focus,textarea:focus{outline:3px solid var(--primary-color); outline-offset:2px}

    /* Layout */
    .layout{
      display:grid; grid-template-columns:1fr; gap:1rem; margin-top:.5rem;
    }
    @media (min-width: 960px){
      .layout{grid-template-columns:420px 1fr; gap:1.5rem}
    }

    /* Card shells */
    .card{
      background:var(--surface-color); border:1px solid var(--border-color);
      border-radius:var(--radius); padding:1rem; box-shadow:var(--shadow);
    }

    /* Form */
    .form-group{margin-bottom:1rem}
    label{display:flex; align-items:center; gap:.5rem; font-weight:700; margin-bottom:.5rem}
    .required-badge{color:var(--error-color); margin-left:.25rem}
    .help-btn{
      border:1px solid var(--border-color); background:transparent; color:var(--primary-color);
      border-radius:999px; width:var(--touch-min); height:var(--touch-min); min-width:var(--touch-min); min-height:var(--touch-min);
      display:inline-flex; align-items:center; justify-content:center; font-weight:800; cursor:pointer;
    }
    .help-btn:hover{background:#eef5fb}
    .tooltip{border:1px solid var(--border-color); background:#F1F5F9; color:#111; border-radius:8px; padding:.75rem; margin:.25rem 0; font-size:.95rem}
    .tooltip[hidden]{display:none}
    .input, .select{
      width:100%; min-height:var(--touch-min); border:1px solid var(--border-color);
      border-radius:10px; padding:.75rem .875rem; font-size:1rem; background:#fff; color:inherit;
    }
    .input[aria-invalid="true"]{border-color:var(--error-color)}
    .error{color:var(--error-color); font-size:.925rem; margin-top:.35rem}
    fieldset{border:none; padding:0; margin:0}
    .radio-group{
      display:flex; gap:.5rem; background:#F7FAFC; border:1px solid var(--border-color); border-radius:10px; padding:.35rem;
    }
    .radio-chip{
      position:relative; flex:1; display:inline-flex; align-items:center; justify-content:center;
      min-height:var(--touch-min); border-radius:8px; padding:.5rem; cursor:pointer; font-weight:600;
      border:1px solid transparent; user-select:none;
    }
    .radio-chip input{position:absolute; opacity:0; inset:0}
    .radio-chip:has(input:checked){background:var(--primary-color); color:#fff}
    .radio-chip:has(input:focus-visible){outline:3px solid var(--primary-color); outline-offset:2px}

    /* Results */
    .results{min-height:280px} /* Prevent CLS */
    .result-row{display:flex; justify-content:space-between; align-items:flex-start; padding:.75rem 0; border-bottom:1px solid var(--border-color)}
    .result-row:last-child{border-bottom:0}
    .result-label{color:var(--muted-text-color)}
    .result-value{font-weight:800; color:var(--success-color); font-size:1.1rem}
    .kicker{display:inline-block; padding:.25rem .5rem; border-radius:999px; background:#e9f7ef; color:#0f5132; font-weight:700; font-size:.85rem}

    /* Buttons */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      padding:.9rem 1rem; min-height:var(--touch-min); min-width:var(--touch-min);
      border-radius:10px; border:1px solid var(--primary-color); color:#fff; background:var(--primary-color);
      cursor:pointer; font-weight:700; transition:transform .1s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn.secondary{background:#fff; color:var(--primary-color)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}

    /* Content */
    .formula-box{background:#EEF2F7; border:1px solid var(--border-color); border-radius:10px; padding:1rem; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    ul{padding-left:1.2rem}
    .author-box{color:var(--muted-text-color); border-top:1px solid var(--border-color); padding-top:1rem; margin-top:1.5rem; font-size:.95rem}

    /* Utilities */
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
    .stack-sm{display:flex; gap:.5rem; flex-wrap:wrap; align-items:center}
  </style>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="search.js" defer></script>
<!-- MathJax for LaTeX formulas -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\(','\)'], ['$', '$']],
      displayMath: [['$','$'], ['\[','\]']]
    },
    svg: { fontCache: 'global' }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link rel="preload" href="/assets/js/mobile-menu.js" as="script">
<link rel="preload" href="/assets/js/page-enhancements.js" as="script">

</head>
<body>

<a class="skip-link" href="#main">Skip to main content</a>
<!-- Main content in prescribed order -->
<main class="container" id="main" role="main">
<h1>Ovulation Calculator</h1>
<p>
      This professional ovulation calculator helps people trying to conceive estimate their ovulation day, fertile window, predicted next period, and optimal test dates. It’s designed for both regular and irregular cycles and follows clinically recognized methodology.
    </p>
<section aria-label="Ovulation calculator interface" class="layout">
<div aria-labelledby="calc-heading" class="card" id="calculator">
<h2 id="calc-heading">Enter your cycle details</h2>
<form id="ovulationForm" novalidate="">
<!-- Cycle pattern -->
<div class="form-group">
<fieldset>
<legend class="sr-only">Cycle pattern</legend>
<div aria-label="Cycle pattern" class="radio-group" role="radiogroup">
<label class="radio-chip">
<input checked="" id="patternRegular" name="pattern" type="radio" value="regular"/>
                  Regular
                </label>
<label class="radio-chip">
<input id="patternIrregular" name="pattern" type="radio" value="irregular"/>
                  Irregular
                </label>
</div>
</fieldset>
</div>
<!-- LMP -->
<div class="form-group">
<label for="lmp">
              First day of last period (LMP)
              <span aria-hidden="true" class="required-badge">*</span>
</label>
<input aria-describedby="lmpError" aria-required="true" class="input" id="lmp" inputmode="none" name="lmp" required="" type="date"/>
<div aria-live="polite" class="error" id="lmpError" role="alert"></div>
</div>
<!-- Average cycle length (regular) -->
<div class="form-group" id="avgCycleWrapper">
<label for="cycleLength">
              Average cycle length (days)
              <span aria-hidden="true" class="required-badge">*</span>
<button aria-controls="cycleHelp" aria-expanded="false" aria-label="What is cycle length?" class="help-btn" id="cycleHelpBtn" type="button">?</button>
</label>
<div class="tooltip" hidden="" id="cycleHelp" role="tooltip">
              Cycle length is the number of days from the first day of one period to the day before the next period. Typical range is 21–35 days in adults.
            </div>
<input aria-describedby="cycleHelp cycleError" aria-required="true" class="input" id="cycleLength" inputmode="numeric" max="45" min="21" name="cycleLength" step="1" type="number" value="28"/>
<div aria-live="polite" class="error" id="cycleError" role="alert"></div>
</div>
<!-- Irregular cycle fields -->
<div hidden="" id="irregularGroup">
<div class="form-group">
<label for="shortestCycle">
                Shortest recent cycle (days)
                <span aria-hidden="true" class="required-badge">*</span>
</label>
<input aria-describedby="shortError" aria-required="true" class="input" id="shortestCycle" inputmode="numeric" max="60" min="21" name="shortestCycle" step="1" type="number"/>
<div aria-live="polite" class="error" id="shortError" role="alert"></div>
</div>
<div class="form-group">
<label for="longestCycle">
                Longest recent cycle (days)
                <span aria-hidden="true" class="required-badge">*</span>
</label>
<input aria-describedby="longError" aria-required="true" class="input" id="longestCycle" inputmode="numeric" max="60" min="21" name="longestCycle" step="1" type="number"/>
<div aria-live="polite" class="error" id="longError" role="alert"></div>
</div>
</div>
<!-- Luteal phase -->
<div class="form-group">
<label for="luteal">
              Luteal phase length (days, common default 14)
              <button aria-controls="lutealHelp" aria-expanded="false" aria-label="What is luteal phase length?" class="help-btn" id="lutealHelpBtn" type="button">?</button>
</label>
<div class="tooltip" hidden="" id="lutealHelp" role="tooltip">
              The luteal phase is the time from ovulation until your next period. Many people have about 14 days, but 11–16 days is common. If you track ovulation by temperature or labs, enter your value.
            </div>
<input aria-describedby="lutealHelp lutealError" class="input" id="luteal" inputmode="numeric" max="17" min="9" name="luteal" step="1" type="number" value="14"/>
<div aria-live="polite" class="error" id="lutealError" role="alert"></div>
</div>
<div class="stack-sm" style="margin-top:.5rem">
<button aria-label="Calculate ovulation and fertile window" class="btn" id="calculateBtn" type="button">Calculate</button>
<button aria-label="Reset all fields" class="btn secondary" id="resetBtn" type="reset">Reset</button>
</div>
</form>
</div>
<section aria-atomic="true" aria-live="polite" class="card results">
<h2>Results</h2>
<div class="result-row">
<div class="result-label">Predicted ovulation</div>
<div class="result-value" id="ovulationResult">—</div>
</div>
<div class="result-row">
<div class="result-label">Fertile window</div>
<div class="result-value" id="windowResult">—</div>
</div>
<div class="result-row">
<div class="result-label">Best days to try</div>
<div class="result-value" id="bestDaysResult">—</div>
</div>
<div class="result-row">
<div class="result-label">Predicted next period</div>
<div class="result-value" id="nextPeriodResult">—</div>
</div>
<div class="result-row">
<div class="result-label">Pregnancy test window</div>
<div class="result-value" id="testResult">—</div>
</div>
<div class="stack-sm" style="margin-top:1rem">
<a aria-label="Add ovulation or fertile window to calendar" class="btn secondary" download="" hidden="" href="#" id="calendarLink">Add to calendar</a>
<span class="kicker" hidden="" id="confidenceBadge">Estimate</span>
</div>
</section>
</section>
<section class="card" style="margin-top:1rem">
<h2>Data Source and Methodology</h2>
<p>
        Authoritative sources:
      </p>
<ul>
<li>
          American Society for Reproductive Medicine (ASRM), Practice Committee. Optimizing natural fertility: a committee opinion. 2017 (reaffirmed 2022).
          <a href="https://www.asrm.org/practice-guidance/practice-committee-documents/optimizing-natural-fertility/" rel="nofollow noopener" target="_blank">Direct link</a>
</li>
<li>
          ACOG. Fertility Awareness-Based Methods of Family Planning. Reviewed 2023.
          <a href="https://www.acog.org/womens-health/faqs/fertility-awareness-based-methods-of-family-planning" rel="nofollow noopener" target="_blank">Direct link</a>
</li>
<li>
          Wilcox AJ, Dunson D, Baird DD. The timing of the “fertile window” in the menstrual cycle: day specific estimates from a prospective study. BMJ. 2000;321(7271):1259–1262.
          <a href="https://doi.org/10.1136/bmj.321.7271.1259" rel="nofollow noopener" target="_blank">DOI</a>
</li>
<li>
          U.S. FDA. Home Pregnancy Tests: Can You Trust the Results? Updated 2022.
          <a href="https://www.fda.gov/consumers/consumer-updates/home-pregnancy-tests-can-you-trust-results" rel="nofollow noopener" target="_blank">Direct link</a>
</li>
</ul>
<p><strong>All calculations are strictly based on the formulas and data provided by this source.</strong> (See the formulas below, which operationalize the clinical relationships outlined by the sources above.)</p>
</section>
<section class="card" style="margin-top:1rem">
<h2>The Formula Explained</h2>
<div aria-label="Mathematical formulas in LaTeX notation" class="formula-box">
<p>Let LMP = first day of the last menstrual period; CL = cycle length (days); LP = luteal phase length (days, commonly 14).</p>
<p>
          Ovulation day estimate:
          \( \mathrm{Ov} = \mathrm{LMP} + (\mathrm{CL} - \mathrm{LP}) \)
        </p>
<p>
          Fertile window:
          \( \mathrm{FW}_{\text{start}} = \mathrm{Ov} - 5 \), 
          \( \mathrm{FW}_{\text{end}} = \mathrm{Ov} + 1 \)
        </p>
<p>
          Predicted next period:
          \( \mathrm{NextPeriod} = \mathrm{LMP} + \mathrm{CL} \)
        </p>
<p>
          Pregnancy testing:
          Earliest sensitive test:
          \( \mathrm{Test}_{\text{early}} = \mathrm{Ov} + 10\text{–}12 \);
          Most reliable:
          \( \mathrm{Test}_{\text{reliable}} = \mathrm{NextPeriod} \)
        </p>
<p>
          For irregular cycles with shortest S and longest L:
          \( \mathrm{OvRange} = [\mathrm{LMP} + (S - \mathrm{LP}),\ \mathrm{LMP} + (L - \mathrm{LP})] \).
        </p>
</div>
</section>
<section class="card" style="margin-top:1rem">
<h2>Glossary of Variables</h2>
<ul>
<li><strong>LMP (Last Menstrual Period):</strong> First day of your most recent period.</li>
<li><strong>Cycle Length (CL):</strong> Days from day 1 of one period to the day before the next period (typical 21–35 in adults).</li>
<li><strong>Luteal Phase (LP):</strong> Time from ovulation to next period (commonly ~14 days, range ~11–16).</li>
<li><strong>Ovulation (Ov):</strong> Estimated calendar day you ovulate.</li>
<li><strong>Fertile Window (FW):</strong> Days when conception is possible, defined here as [Ov−5, Ov+1].</li>
<li><strong>Next Period:</strong> Predicted first day of your next menses.</li>
<li><strong>Pregnancy Test Window:</strong> Early sensitive testing around 10–12 days after ovulation; most reliable from the first missed period day.</li>
</ul>
</section>
<section class="card" style="margin-top:1rem">
<h2>How It Works: A Step-by-Step Example</h2>
<p>
        Example inputs: LMP = 1 May 2025; CL = 30; LP = 14 (default).
      </p>
<div class="formula-box">
<p>
          1) Ovulation: \( \mathrm{Ov} = \mathrm{LMP} + (\mathrm{CL} - \mathrm{LP}) = \text{May 1, 2025} + (30 - 14) = \text{May 17, 2025} \)
        </p>
<p>
          2) Fertile window: \( [\mathrm{Ov}-5,\, \mathrm{Ov}+1] = [\text{May 12, 2025},\, \text{May 18, 2025}] \)
        </p>
<p>
          3) Next period: \( \mathrm{NextPeriod} = \text{May 1, 2025} + 30 = \text{May 31, 2025} \)
        </p>
<p>
          4) Testing: Earliest sensitive ≈ \( \mathrm{Ov}+10 = \text{May 27, 2025} \);
          Reliable from \( \mathrm{NextPeriod} = \text{May 31, 2025} \).
        </p>
</div>
<p>
        Practical tip: The highest probability days are Ov−2 through Ov (May 15–17, 2025 in this example).
      </p>
</section>
<section class="card" style="margin-top:1rem">
<h2>Frequently Asked Questions (FAQ)</h2>
<h3>How accurate is this ovulation calculator?</h3>
<p>This tool uses widely accepted clinical relationships. Individual ovulation timing varies, particularly with irregular cycles or health conditions. Consider confirming ovulation with LH testing, basal body temperature, or ultrasound when precise timing matters.</p>
<h3>Does stress, illness, or travel affect results?</h3>
<p>Yes. Factors like stress, illness, intense training, or time-zone changes can shift ovulation. Treat outputs as estimates, not certainties.</p>
<h3>I don’t know my luteal phase—what should I enter?</h3>
<p>If you’re unsure, keep the default 14 days. If you track ovulation, you can refine the value to personalize results.</p>
<h3>Can this help avoid pregnancy?</h3>
<p>Fertility awareness requires rigorous tracking and training. For contraception, consult a clinician about evidence-based methods. This calculator is not a contraceptive device.</p>
<h3>What’s the best intercourse timing?</h3>
<p>Conception odds peak on Ov−2, Ov−1, and Ov. Aim for regular intercourse throughout the fertile window to cover variability.</p>
<h3>When should I seek medical advice?</h3>
<p>If you have cycles shorter than 21 days or longer than 35 days repeatedly, or if you’ve been trying to conceive for 12 months (6 months if 35+), speak with a healthcare professional.</p>
</section>
<div class="author-box">
<p>
        Strumento sviluppato da <strong>Ugo Candido</strong>,. Contenuti verificati da, <strong>CalcDomain Medical Review Board</strong>.<br/>
        Ultima revisione per l'accuratezza in data: <time datetime="2025-09-14">September 14, 2025</time>.
      </p>
<p style="margin-top:.5rem">
        Educational use only. Not medical advice. If you have concerns about your cycle or fertility, consult a qualified healthcare professional.
      </p>
</div>
</main>
<script defer="">
    (function(){
      'use strict';

      // Utilities
      const $ = (sel, ctx=document) => ctx.querySelector(sel);
      const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));
      const fmt = new Intl.DateTimeFormat(undefined, {weekday:'short', year:'numeric', month:'short', day:'numeric'});

      const addDays = (date, n) => {
        const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
        d.setDate(d.getDate()+n);
        return d;
      };
      const toYMD = d => {
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
      };
      const fromInputDate = val => {
        if(!val) return null;
        const [y,m,d] = val.split('-').map(Number);
        if(!y||!m||!d) return null;
        return new Date(y, m-1, d);
      };

      // Elements
      const form = $('#ovulationForm');
      const patternRegular = $('#patternRegular');
      const patternIrregular = $('#patternIrregular');
      const irregularGroup = $('#irregularGroup');
      const avgCycleWrapper = $('#avgCycleWrapper');

      const lmp = $('#lmp');
      const cycleLength = $('#cycleLength');
      const shortestCycle = $('#shortestCycle');
      const longestCycle = $('#longestCycle');
      const luteal = $('#luteal');

      const lmpError = $('#lmpError');
      const cycleError = $('#cycleError');
      const shortError = $('#shortError');
      const longError = $('#longError');
      const lutealError = $('#lutealError');

      const ovulationResult = $('#ovulationResult');
      const windowResult = $('#windowResult');
      const bestDaysResult = $('#bestDaysResult');
      const nextPeriodResult = $('#nextPeriodResult');
      const testResult = $('#testResult');
      const calendarLink = $('#calendarLink');
      const confidenceBadge = $('#confidenceBadge');

      const calculateBtn = $('#calculateBtn');
      const resetBtn = $('#resetBtn');

      // Tooltips
      const cycleHelpBtn = $('#cycleHelpBtn');
      const cycleHelp = $('#cycleHelp');
      cycleHelpBtn.addEventListener('click', () => {
        const expanded = cycleHelpBtn.getAttribute('aria-expanded') === 'true';
        cycleHelpBtn.setAttribute('aria-expanded', String(!expanded));
        cycleHelp.hidden = expanded;
      });

      const lutealHelpBtn = $('#lutealHelpBtn');
      const lutealHelp = $('#lutealHelp');
      lutealHelpBtn.addEventListener('click', () => {
        const expanded = lutealHelpBtn.getAttribute('aria-expanded') === 'true';
        lutealHelpBtn.setAttribute('aria-expanded', String(!expanded));
        lutealHelp.hidden = expanded;
      });

      // Pattern toggle
      function togglePatternUI(){
        const isIrregular = patternIrregular.checked;
        irregularGroup.hidden = !isIrregular;
        avgCycleWrapper.hidden = isIrregular;
        // Clear errors when toggling
        [cycleError, shortError, longError].forEach(e => e.textContent = '');
        [cycleLength, shortestCycle, longestCycle].forEach(inp => inp.setAttribute('aria-invalid','false'));
      }
      patternRegular.addEventListener('change', togglePatternUI);
      patternIrregular.addEventListener('change', togglePatternUI);
      togglePatternUI();

      // Validation helpers
      function setError(input, errEl, message){
        if(message){
          input.setAttribute('aria-invalid','true');
          errEl.textContent = message;
        }else{
          input.setAttribute('aria-invalid','false');
          errEl.textContent = '';
        }
      }
      function requireNumberInRange(input, errEl, min, max, label){
        const v = input.value.trim();
        if(v === ''){
          setError(input, errEl, `${label} is required.`);
          return null;
        }
        const n = Number(v);
        if(Number.isNaN(n)){
          setError(input, errEl, `${label} must be a number.`);
          return null;
        }
        if(n < min || n > max){
          setError(input, errEl, `${label} must be between ${min} and ${max}.`);
          return null;
        }
        setError(input, errEl, '');
        return n;
      }
      function validateLMP(){
        const val = lmp.value;
        if(!val){
          setError(lmp, lmpError, 'Please select the first day of your last period.');
          return null;
        }
        const d = fromInputDate(val);
        if(!d){
          setError(lmp, lmpError, 'Invalid date.');
          return null;
        }
        const today = new Date();
        // Allow same-day and past; warn on future
        if(d > today){
          setError(lmp, lmpError, 'LMP cannot be in the future.');
          return null;
        }
        setError(lmp, lmpError, '');
        return d;
      }

      // On-blur inline validation
      lmp.addEventListener('blur', validateLMP);
      cycleLength.addEventListener('blur', () => requireNumberInRange(cycleLength, cycleError, 21, 45, 'Average cycle length'));
      shortestCycle.addEventListener('blur', () => requireNumberInRange(shortestCycle, shortError, 21, 60, 'Shortest cycle'));
      longestCycle.addEventListener('blur', () => requireNumberInRange(longestCycle, longError, 21, 60, 'Longest cycle'));
      luteal.addEventListener('blur', () => requireNumberInRange(luteal, lutealError, 9, 17, 'Luteal phase length'));

      // Core calculation
      function calculate(){
        const lmpDate = validateLMP();
        if(!lmpDate){ return setOutputsInvalid(); }

        const lp = requireNumberInRange(luteal, lutealError, 9, 17, 'Luteal phase length');
        if(lp === null){ return setOutputsInvalid(); }

        const isIrregular = patternIrregular.checked;

        if(isIrregular){
          const s = requireNumberInRange(shortestCycle, shortError, 21, 60, 'Shortest cycle');
          const l = requireNumberInRange(longestCycle, longError, 21, 60, 'Longest cycle');
          if(s === null || l === null){ return setOutputsInvalid(); }
          if(s > l){
            setError(longestCycle, longError, 'Longest cycle must be greater than or equal to shortest cycle.');
            return setOutputsInvalid();
          } else {
            setError(longestCycle, longError, '');
          }

          // Ovulation range
          const ovStart = addDays(lmpDate, s - lp);
          const ovEnd = addDays(lmpDate, l - lp);
          const fwStart = addDays(ovStart, -5);
          const fwEnd = addDays(ovEnd, 1);
          const nextStart = addDays(lmpDate, s);
          const nextEnd = addDays(lmpDate, l);

          ovulationResult.textContent = `${fmt.format(ovStart)} — ${fmt.format(ovEnd)}`;
          windowResult.textContent = `${fmt.format(fwStart)} — ${fmt.format(fwEnd)}`;
          bestDaysResult.textContent = `${fmt.format(addDays(ovStart, -2))} — ${fmt.format(ovEnd)}`;
          nextPeriodResult.textContent = `${fmt.format(nextStart)} — ${fmt.format(nextEnd)}`;

          const earlyStart = addDays(ovStart, 10);
          const earlyEnd = addDays(ovEnd, 12);
          testResult.textContent = `Sensitive: ${fmt.format(earlyStart)} — ${fmt.format(earlyEnd)}; Reliable from: ${fmt.format(nextStart)} — ${fmt.format(nextEnd)}`;

          // ICS for fertile window range (all-day multi-day)
          const ics = buildICSRange('Fertile window (estimate)', fwStart, fwEnd, 'Irregular cycles range. Best days are roughly Ov−2 to Ov.');
          attachICS(ics, 'fertile-window.ics');
          confidenceBadge.hidden = false;

        }else{
          const cl = requireNumberInRange(cycleLength, cycleError, 21, 45, 'Average cycle length');
          if(cl === null){ return setOutputsInvalid(); }

          const ov = addDays(lmpDate, cl - lp);
          const fwStart = addDays(ov, -5);
          const fwEnd = addDays(ov, 1);
          const bestStart = addDays(ov, -2);
          const nextP = addDays(lmpDate, cl);
          const early = addDays(ov, 10);

          ovulationResult.textContent = fmt.format(ov);
          windowResult.textContent = `${fmt.format(fwStart)} — ${fmt.format(fwEnd)}`;
          bestDaysResult.textContent = `${fmt.format(bestStart)} — ${fmt.format(ov)}`;
          nextPeriodResult.textContent = fmt.format(nextP);
          testResult.textContent = `Sensitive from: ${fmt.format(early)}; Reliable from: ${fmt.format(nextP)}`;

          // ICS for single ovulation day (all-day)
          const ics = buildICSSingle('Predicted ovulation day (estimate)', ov, 'Best days: Ov−2 through Ov. Fertile window Ov−5 to Ov+1.');
          attachICS(ics, 'ovulation-day.ics');
          confidenceBadge.hidden = false;
        }
      }

      function setOutputsInvalid(){
        ovulationResult.textContent = '—';
        windowResult.textContent = '—';
        bestDaysResult.textContent = '—';
        nextPeriodResult.textContent = '—';
        testResult.textContent = '—';
        calendarLink.hidden = true;
        confidenceBadge.hidden = true;
      }

      // ICS builders
      function icsHeader(){
        return [
          'BEGIN:VCALENDAR',
          'VERSION:2.0',
          'PRODID:-//CalcDomain//Ovulation Calculator//EN',
          'CALSCALE:GREGORIAN',
        ];
      }
      function icsFooter(){ return ['END:VCALENDAR']; }
      function formatICSDate(d){ // all-day VALUE=DATE uses local date yyyymmdd
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,'0');
        const day = String(d.getDate()).padStart(2,'0');
        return `${y}${m}${day}`;
      }
      function buildICSSingle(title, day, notes){
        const dt = formatICSDate(day);
        const uid = `ov-${Date.now()}@calcdomain`;
        const lines = [
          ...icsHeader(),
          'BEGIN:VEVENT',
          `UID:${uid}`,
          `DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z`,
          `DTSTART;VALUE=DATE:${dt}`,
          `DTEND;VALUE=DATE:${formatICSDate(addDays(day,1))}`,
          `SUMMARY:${title}`,
          `DESCRIPTION:${notes}`,
          'END:VEVENT',
          ...icsFooter()
        ];
        return lines.join('\r\n');
      }
      function buildICSRange(title, start, endInclusive, notes){
        const uid = `fw-${Date.now()}@calcdomain`;
        const endExclusive = addDays(endInclusive, 1);
        const lines = [
          ...icsHeader(),
          'BEGIN:VEVENT',
          `UID:${uid}`,
          `DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').split('.')[0]}Z`,
          `DTSTART;VALUE=DATE:${formatICSDate(start)}`,
          `DTEND;VALUE=DATE:${formatICSDate(endExclusive)}`,
          `SUMMARY:${title}`,
          `DESCRIPTION:${notes}`,
          'END:VEVENT',
          ...icsFooter()
        ];
        return lines.join('\r\n');
      }
      function attachICS(icsContent, filename){
        const href = 'data:text/calendar;charset=utf-8,' + encodeURIComponent(icsContent);
        calendarLink.href = href;
        calendarLink.download = filename;
        calendarLink.hidden = false;
      }

      // Events
      calculateBtn.addEventListener('click', calculate);
      // update on change to feel instant while keeping INP in check
      let debounce;
      form.addEventListener('input', () => {
        clearTimeout(debounce);
        debounce = setTimeout(calculate, 120);
      });
      form.addEventListener('change', calculate);
      resetBtn.addEventListener('click', () => {
        setTimeout(() => {
          // Reset UI
          togglePatternUI();
          setOutputsInvalid();
          [lmpError, cycleError, shortError, longError, lutealError].forEach(e => e.textContent='');
          [lmp, cycleLength, shortestCycle, longestCycle, luteal].forEach(i => i.setAttribute('aria-invalid','false'));
          cycleHelp.hidden = true; cycleHelpBtn.setAttribute('aria-expanded','false');
          lutealHelp.hidden = true; lutealHelpBtn.setAttribute('aria-expanded','false');
        }, 0);
      });

      // Initialize output
      setOutputsInvalid();
    }());
  </script>


</body></html>