<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loan Amortization Schedule Calculator - Monthly Payment & Interest Breakdown</title>
    <meta name="description" content="Calculate your loan amortization schedule with monthly payment breakdown. See principal, interest, and balance for each payment plus total interest costs.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .prose { max-width: 65ch; }
        .prose h2 { font-size: 1.5rem; font-weight: 600; margin-top: 2rem; margin-bottom: 1rem; }
        .prose h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .prose p { margin-bottom: 1rem; line-height: 1.6; }
        .prose ul, .prose ol { margin-left: 1.5rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.5rem; }
        .prose .formula-box { 
            background:#f3f4f6; border:1px solid #d1d5db; border-radius:8px; padding:1rem; 
            overflow-x:auto; font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; 
        }
        details > summary { cursor: pointer; font-weight: 600; }
        details[open] > summary { margin-bottom: 0.5rem; }
        .scroll-table { max-height: 400px; overflow-y: auto; }
        /* Print-specific styles for clean output */
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; }
            #header, #sidebar, #footer, #seo-content, #print-controls { display: none !important; }
        }
    </style>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "HowTo",
      "name": "How to Calculate Loan Amortization Schedule",
      "description": "A step-by-step guide to calculating loan amortization with payment breakdowns.",
      "step": [
        {"@type": "HowToStep", "name": "Enter Loan Details", "text": "Input your loan amount, interest rate, and loan term in years or months."},
        {"@type": "HowToStep", "name": "Choose Payment Frequency", "text": "Select monthly, biweekly, or weekly payment schedule."},
        {"@type": "HowToStep", "name": "Add Extra Payments", "text": "Optionally add recurring or one-time extra principal payments."},
        {"@type": "HowToStep", "name": "Review Schedule", "text": "View detailed payment breakdown and total interest costs."}
      ]
    }
    </script>
    <script src="search.js" defer></script>
    <style>
        /* CalcDomain Search Styles */
        .search-highlight {
            background: linear-gradient(120deg, #fbbf24 0%, #f59e0b 100%);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
            color: #78350f;
        }
        
        #search-results {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        
        #search-results a {
            display: block;
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        #search-results a:last-child {
            border-bottom: none;
        }
        
        #search-results a:hover {
            background-color: #f8fafc;
            transform: translateX(4px);
        }
        
        #search-results a:focus {
            background-color: #eff6ff;
            outline: 2px solid #3b82f6;
            outline-offset: -2px;
        }
        
        #search-results h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        #search-results p {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #6b7280;
            line-height: 1.4;
        }
        
        #search-results .bg-blue-100 {
            background-color: #dbeafe !important;
            color: #1e40af !important;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        input[type="search"]:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }
        
        @media (max-width: 768px) {
            #search-results {
                max-height: 300px;
                margin-top: 8px;
                border-radius: 8px;
            }
            
            #search-results a {
                padding: 12px;
            }
            
            #search-results h3 {
                font-size: 15px;
            }
            
            #search-results p {
                font-size: 13px;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #search-results.show {
            animation: fadeInUp 0.3s ease-out;
        }
        
        #search-results::-webkit-scrollbar {
            width: 6px;
        }
        
        #search-results::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        #search-results::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        #search-results::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
            </style>
<!-- MathJax for LaTeX formulas -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\(','\)'], ['$', '$']],
      displayMath: [['\[','\]']]
    },
    svg: { fontCache: 'global' }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link rel="preload" href="/assets/js/mobile-menu.js" as="script">
<link rel="preload" href="/assets/js/page-enhancements.js" as="script">

</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
    <nav class="container mx-auto px-4 lg:px-6 py-4">
        <!-- TOP ROW -->
        <div class="flex justify-between items-center">
            <!-- LOGO -->
            <a href="index.html" class="text-2xl font-bold text-blue-600">CalcDomain</a>
            
            <!-- DESKTOP SEARCH -->
            <div class="w-full max-w-md hidden md:block mx-8">
                <div class="relative">
                    <input 
                        type="search" 
                        id="search-input"
                        placeholder="Search for a calculator..." 
                        class="w-full py-2 px-4 pr-10 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        autocomplete="off"
                    >
                    <svg class="w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <!-- CONTAINER RISULTATI RICERCA -->
                    <div id="search-results" class="absolute top-full left-0 right-0 bg-white shadow-lg rounded-lg mt-2 max-h-96 overflow-y-auto z-50 hidden border border-gray-200"></div>
                </div>
            </div>
            
            <!-- NAVIGATION LINKS -->
            <div class="hidden md:flex items-center space-x-6">
                <a href="search.html" class="text-gray-700 hover:text-blue-600 transition-colors">Advanced Search</a>
                <a href="#categories" class="text-gray-700 hover:text-blue-600 transition-colors">Categories</a>
            </div>
            
            <!-- MOBILE TOGGLE -->
            <button id="mobile-menu-toggle" class="md:hidden p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
        
        <!-- MOBILE MENU -->
        <div id="mobile-menu" class="md:hidden mt-4 hidden">
            <div class="mb-4">
                <div class="relative">
                    <input 
                        type="search" 
                        id="mobile-search-input"
                        placeholder="Search calculators..." 
                        class="w-full py-3 px-4 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <svg class="w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
            <div class="space-y-2">
                <a href="search.html" class="block py-2 text-gray-700 hover:text-blue-600">Advanced Search</a>
                <a href="#categories" class="block py-2 text-gray-700 hover:text-blue-600">Categories</a>
            </div>
        </div>
    </nav>
</header>

    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">

            <main class="w-full lg:w-2/3">
                <nav class="text-sm mb-4 text-gray-600">
                    <a href="index.html" class="hover:text-blue-600">Home</a> &raquo;
                    <a href="finance.html" class="hover:text-blue-600">Finance</a> &raquo;
                    <a href="personal-loans.html" class="hover:text-blue-600">Personal Loans</a> &raquo;
                    <span>Loan Amortization Calculator</span>
                </nav>

                <div id="print-section" class="bg-white p-6 rounded-lg shadow-md">
                    <h1 class="text-3xl font-bold mb-2">Advanced Loan Amortization Calculator</h1>
                    <p class="text-gray-600 mb-6">Visualize your loan repayment schedule and see how extra payments can save you thousands in interest and years off your loan.</p>

                    <div id="calculator-ui" class="space-y-6">
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div>
                                <label for="currency" class="block text-sm font-medium text-gray-700">Currency</label>
                                <select id="currency" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="USD" selected>USD — $</option>
                                    <option value="EUR">EUR — €</option>
                                    <option value="GBP">GBP — £</option>
                                    <option value="AUD">AUD — A$</option>
                                    <option value="CAD">CAD — C$</option>
                                    <option value="JPY">JPY — ¥</option>
                                </select>
                            </div>
                            <div>
                                <label for="loanAmount" class="block text-sm font-medium text-gray-700">Loan Amount <span class="text-red-500">*</span></label>
                                <div class="mt-1 relative">
                                    <input type="number" id="loanAmount" value="25000" step="0.01" class="block w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="25000">
                                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" id="currencySymbol1">$</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="interestRate" class="block text-sm font-medium text-gray-700">Annual Interest Rate <span class="text-red-500">*</span></label>
                                <div class="mt-1 relative">
                                    <input type="number" id="interestRate" value="6.0" step="0.01" class="block w-full pr-8 pl-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="6.0">
                                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">%</span>
                                </div>
                            </div>
                            <div>
                                <label for="loanTerm" class="block text-sm font-medium text-gray-700">Loan Term <span class="text-red-500">*</span></label>
                                <div class="mt-1 flex rounded-md shadow-sm">
                                    <input type="number" id="loanTerm" value="5" class="flex-1 block w-full rounded-none rounded-l-md px-3 py-2 border border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="5">
                                    <select id="termUnit" class="inline-flex items-center px-3 rounded-r-md border border-l-0 border-gray-300 bg-gray-50 text-gray-500">
                                        <option value="years" selected>Years</option>
                                        <option value="months">Months</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                             <div>
                                <label for="paymentFrequency" class="block text-sm font-medium text-gray-700">Payment Frequency <span class="text-red-500">*</span></label>
                                <select id="paymentFrequency" class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-white rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="12" selected>Monthly</option>
                                    <option value="26">Biweekly</option>
                                    <option value="52">Weekly</option>
                                </select>
                            </div>
                            <div>
                                <label for="startDate" class="block text-sm font-medium text-gray-700">First Payment Date</label>
                                <input type="date" id="startDate" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>

                        <div class="border-t pt-6 space-y-4">
                            <h3 class="text-base font-medium text-gray-800">Extra Payments (Optional)</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="extraPayment" class="block text-sm font-medium text-gray-700">Extra Recurring Payment</label>
                                    <div class="mt-1 relative">
                                        <input type="number" id="extraPayment" value="50" step="0.01" class="block w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="0">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" id="currencySymbol2">$</span>
                                    </div>
                                    <p class="mt-1 text-xs text-gray-500">Added to each scheduled payment.</p>
                                </div>
                                <div>
                                    <label for="lumpSumPayment" class="block text-sm font-medium text-gray-700">One-Time Payment</label>
                                    <div class="mt-1 relative">
                                        <input type="number" id="lumpSumPayment" step="0.01" class="block w-full pl-8 pr-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="0">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" id="currencySymbol3">$</span>
                                    </div>
                                    <p class="mt-1 text-xs text-gray-500">Applied on the first payment date.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="results" class="mt-8 bg-blue-50 p-6 rounded-lg">
                         <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold text-gray-800">Loan Summary</h3>
                            <div id="print-controls" class="flex gap-2 items-center">
                                <span id="shareFeedback" class="text-sm text-green-600 hidden">Link Copied!</span>
                                <button id="shareButton" title="Copy Share Link" class="p-2 rounded-md hover:bg-blue-200 text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                                </button>
                                <button id="printButton" title="Print Results" class="p-2 rounded-md hover:bg-blue-200 text-blue-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v3a2 2 0 002 2h1v3a2 2 0 002 2h6a2 2 0 002-2v-3h1a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7v3h6v-3z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>

                        <div class="flex flex-col md:flex-row gap-6 items-center">
                            <div class="w-full md:w-2/3 grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div class="bg-white p-3 rounded-lg text-center">
                                    <p class="text-sm text-gray-600">Scheduled Payment</p>
                                    <p class="text-2xl font-bold text-blue-600" id="scheduledPayment">$0.00</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg text-center">
                                    <p class="text-sm text-gray-600">Total Interest</p>
                                    <p class="text-2xl font-bold text-orange-600" id="totalInterest">$0.00</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg text-center">
                                    <p class="text-sm text-gray-600">Payoff Date</p>
                                    <p class="text-2xl font-bold text-green-600" id="payoffDate">—</p>
                                </div>
                                <div class="bg-white p-3 rounded-lg text-center">
                                    <p class="text-sm text-gray-600">Time Saved</p>
                                    <p class="text-2xl font-bold text-green-600" id="timeSaved">—</p>
                                </div>
                            </div>
                            <div class="w-full md:w-1/3 h-40">
                                <canvas id="pieChart"></canvas>
                            </div>
                        </div>

                        <details class="mt-6 bg-white p-4 rounded-lg">
                            <summary>Show Balance Chart</summary>
                            <div class="h-64 mt-4">
                               <canvas id="lineChart"></canvas>
                            </div>
                        </details>
                        
                        <div class="mt-6">
                            <div class="flex justify-between items-center mb-3">
                                <h4 class="text-sm font-semibold text-gray-700">Amortization Schedule</h4>
                                <div id="print-controls" class="flex gap-2">
                                    <button id="exportBtn" class="text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700">Export CSV</button>
                                </div>
                            </div>
                            <div class="scroll-table border rounded-lg bg-white">
                                <table class="w-full text-sm">
                                    <thead class="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th class="px-3 py-2 text-left">#</th>
                                            <th class="px-3 py-2 text-left">Date</th>
                                            <th class="px-3 py-2 text-right">Payment</th>
                                            <th class="px-3 py-2 text-right">Principal</th>
                                            <th class="px-3 py-2 text-right">Interest</th>
                                            <th class="px-3 py-2 text-right">Extra</th>
                                            <th class="px-3 py-2 text-right">Balance</th>
                                        </tr>
                                    </thead>
                                    <tbody id="scheduleBody"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <article id="seo-content" class="bg-white p-6 rounded-lg shadow-md mt-8 prose">
                    <h2>Understanding Loan Amortization</h2>
                    <p>Loan amortization is the process of paying off debt through regular payments over time. Each payment includes both principal (the original loan amount) and interest. Early payments consist mostly of interest, while later payments apply more toward the principal balance.</p>
                </article>
            </main>

            <aside id="sidebar" class="w-full lg:w-1/3">
                <div class="sticky top-24">
                    <div class="bg-gray-200 h-96 rounded-lg mb-6 flex items-center justify-center">
                        <p class="text-gray-500">Sticky Ad Unit (e.g., 300x600)</p>
                    </div>
                </div>
            </aside>

        </div>
    </div>
    
    <footer id="footer" class="bg-white border-t mt-12">
        <div class="container mx-auto px-6 py-8 text-center text-gray-600">
            <p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // ########## DOM ELEMENTS ##########
        const elements = {
            currency: document.getElementById('currency'),
            loanAmount: document.getElementById('loanAmount'),
            interestRate: document.getElementById('interestRate'),
            loanTerm: document.getElementById('loanTerm'),
            termUnit: document.getElementById('termUnit'),
            paymentFrequency: document.getElementById('paymentFrequency'),
            startDate: document.getElementById('startDate'),
            extraPayment: document.getElementById('extraPayment'),
            lumpSumPayment: document.getElementById('lumpSumPayment'),
            scheduledPayment: document.getElementById('scheduledPayment'),
            totalInterest: document.getElementById('totalInterest'),
            payoffDate: document.getElementById('payoffDate'),
            timeSaved: document.getElementById('timeSaved'),
            scheduleBody: document.getElementById('scheduleBody'),
            exportBtn: document.getElementById('exportBtn'),
            shareButton: document.getElementById('shareButton'),
            printButton: document.getElementById('printButton'),
            shareFeedback: document.getElementById('shareFeedback'),
            currencySymbols: [
                document.getElementById('currencySymbol1'),
                document.getElementById('currencySymbol2'),
                document.getElementById('currencySymbol3'),
            ]
        };

        // ########## STATE & CONFIG ##########
        let currencyConfig = { style: 'currency', currency: 'USD' };
        let fullSchedule = [];
        let chartInstances = { pie: null, line: null };
        const currencyMap = {
            USD: { symbol: '$', locale: 'en-US', code: 'USD' },
            EUR: { symbol: '€', locale: 'de-DE', code: 'EUR' },
            GBP: { symbol: '£', locale: 'en-GB', code: 'GBP' },
            AUD: { symbol: 'A$', locale: 'en-AU', code: 'AUD' },
            CAD: { symbol: 'C$', locale: 'en-CA', code: 'CAD' },
            JPY: { symbol: '¥', locale: 'ja-JP', code: 'JPY' },
        };

        // ########## HELPER FUNCTIONS ##########
        const formatMoney = (amount) => new Intl.NumberFormat(currencyConfig.locale, currencyConfig).format(amount);
        const formatDate = (date) => new Intl.DateTimeFormat('en-US', { year: 'numeric', month: 'short', day: '2-digit' }).format(date);
        
        const addPeriod = (date, frequency) => {
            const newDate = new Date(date);
            if (frequency == 12) newDate.setMonth(newDate.getMonth() + 1);
            else if (frequency == 26) newDate.setDate(newDate.getDate() + 14);
            else if (frequency == 52) newDate.setDate(newDate.getDate() + 7);
            return newDate;
        };

        const getTermInMonths = () => {
            const term = parseInt(elements.loanTerm.value) || 0;
            return elements.termUnit.value === 'years' ? term * 12 : term;
        };

        // ########## CORE CALCULATION LOGIC ##########
        function generateSchedule(principal, annualRate, termMonths, frequency, startDate, extraRecurring, extraLump) {
            const periodicRate = (annualRate / 100) / frequency;
            const totalPeriods = termMonths * (frequency / 12);

            const basePayment = periodicRate > 0
                ? (principal * periodicRate) / (1 - Math.pow(1 + periodicRate, -totalPeriods))
                : principal / totalPeriods;
            
            let balance = principal;
            let currentDate = new Date(startDate);
            const schedule = [];
            let totalInterestPaid = 0;
            let i = 1;

            while (balance > 0) {
                const interestPayment = balance * periodicRate;
                let principalPayment = basePayment - interestPayment;
                let currentExtra = extraRecurring;

                if (i === 1) {
                    currentExtra += extraLump;
                }

                if (balance - (principalPayment + currentExtra) < 0) {
                    principalPayment = balance - currentExtra;
                    if (principalPayment < 0) {
                        currentExtra = balance;
                        principalPayment = 0;
                    }
                }

                const totalPaymentForPeriod = principalPayment + interestPayment + currentExtra;
                balance -= (principalPayment + currentExtra);
                totalInterestPaid += interestPayment;

                schedule.push({
                    number: i, date: new Date(currentDate), payment: totalPaymentForPeriod,
                    principal: principalPayment + currentExtra, interest: interestPayment,
                    extra: currentExtra, balance: balance < 0.01 ? 0 : balance,
                });

                if (balance <= 0 || i > totalPeriods * 2) break; // Safety break
                currentDate = addPeriod(currentDate, frequency);
                i++;
            }
            return { schedule, totalInterestPaid, basePayment };
        }

        // ########## UI UPDATE FUNCTIONS ##########
        function updateUI() {
            const principal = parseFloat(elements.loanAmount.value) || 0;
            const annualRate = parseFloat(elements.interestRate.value) || 0;
            const termMonths = getTermInMonths();
            const frequency = parseInt(elements.paymentFrequency.value);
            const startDate = elements.startDate.valueAsDate || new Date();
            const extraRecurring = parseFloat(elements.extraPayment.value) || 0;
            const extraLump = parseFloat(elements.lumpSumPayment.value) || 0;

            if (principal <= 0 || termMonths <= 0) return;

            // Baseline calculation (no extras)
            const baseline = generateSchedule(principal, annualRate, termMonths, frequency, startDate, 0, 0);
            
            // Accelerated calculation (with extras)
            const accelerated = generateSchedule(principal, annualRate, termMonths, frequency, startDate, extraRecurring, extraLump);
            fullSchedule = accelerated.schedule;

            // Update summary
            const lastPayment = accelerated.schedule[accelerated.schedule.length - 1];
            elements.scheduledPayment.textContent = formatMoney(baseline.basePayment);
            elements.totalInterest.textContent = formatMoney(accelerated.totalInterestPaid);
            elements.payoffDate.textContent = lastPayment ? formatDate(lastPayment.date) : '—';

            const monthsSaved = baseline.schedule.length - accelerated.schedule.length;
            if (monthsSaved > 0) {
                const years = Math.floor(monthsSaved / 12);
                const months = monthsSaved % 12;
                elements.timeSaved.textContent = `${years}y ${months}m`;
            } else {
                elements.timeSaved.textContent = '—';
            }
            
            // Update table & charts
            updateScheduleTable();
            updateCharts(principal, accelerated.totalInterestPaid, baseline.schedule, accelerated.schedule);
        }

        function updateScheduleTable() {
            const scheduleToShow = fullSchedule.slice(0, 24); // Always show a preview
            elements.scheduleBody.innerHTML = scheduleToShow.map((row, index) => `
                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}">
                    <td class="px-3 py-2">${row.number}</td>
                    <td class="px-3 py-2">${formatDate(row.date)}</td>
                    <td class="px-3 py-2 text-right">${formatMoney(row.payment)}</td>
                    <td class="px-3 py-2 text-right">${formatMoney(row.principal)}</td>
                    <td class="px-3 py-2 text-right">${formatMoney(row.interest)}</td>
                    <td class="px-3 py-2 text-right">${formatMoney(row.extra)}</td>
                    <td class="px-3 py-2 text-right">${formatMoney(row.balance)}</td>
                </tr>
            `).join('');
             if (fullSchedule.length > 24) {
                 elements.scheduleBody.innerHTML += `<tr><td colspan="7" class="px-3 py-2 text-center text-gray-500">... and ${fullSchedule.length - 24} more payments. Export CSV to see all.</td></tr>`;
             }
        }
        
        function updateCharts(principal, interest, baselineSchedule, acceleratedSchedule) {
            // Pie Chart
            const pieData = {
                labels: ['Principal', 'Total Interest'],
                datasets: [{ data: [principal, interest], backgroundColor: ['#3b82f6', '#f97316'], borderWidth: 0 }]
            };
            if (chartInstances.pie) chartInstances.pie.destroy();
            chartInstances.pie = new Chart('pieChart', { type: 'pie', data: pieData, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }});

            // Line Chart
            const lineData = {
                labels: baselineSchedule.map(p => p.number),
                datasets: [
                    { label: 'Original Balance', data: baselineSchedule.map(p => p.balance), borderColor: '#9ca3af', fill: false, pointRadius: 0 },
                    { label: 'New Balance', data: acceleratedSchedule.map(p => p.balance), borderColor: '#16a34a', fill: false, pointRadius: 0 }
                ]
            };
            if (chartInstances.line) chartInstances.line.destroy();
            chartInstances.line = new Chart('lineChart', { type: 'line', data: lineData, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } } });
        }
        
        // ########## EVENT LISTENERS ##########
        const inputs = [
            'currency', 'loanAmount', 'interestRate', 'loanTerm', 'termUnit', 
            'paymentFrequency', 'startDate', 'extraPayment', 'lumpSumPayment'
        ];
        inputs.forEach(id => document.getElementById(id).addEventListener('input', updateUI));
        
        elements.currency.addEventListener('change', () => {
            const config = currencyMap[elements.currency.value];
            currencyConfig = { style: 'currency', currency: config.code, locale: config.locale };
            elements.currencySymbols.forEach(el => el.textContent = config.symbol);
            updateUI();
        });

        elements.exportBtn.addEventListener('click', () => {
            if (!fullSchedule.length) return;
            const headers = ['#', 'Date', 'Payment', 'Principal', 'Interest', 'Extra', 'Balance'];
            const csv = [headers.join(','), ...fullSchedule.map(row => 
                [row.number, formatDate(row.date), row.payment, row.principal, row.interest, row.extra, row.balance].join(',')
            )].join('\n');
            const link = document.createElement('a');
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            link.download = 'amortization-schedule.csv';
            link.click();
        });

        elements.shareButton.addEventListener('click', () => {
            const params = new URLSearchParams(Object.fromEntries(inputs.map(id => [id, document.getElementById(id).value]))).toString();
            navigator.clipboard.writeText(`${window.location.pathname}?${params}`);
            elements.shareFeedback.classList.remove('hidden');
            setTimeout(() => elements.shareFeedback.classList.add('hidden'), 2000);
        });

        elements.printButton.addEventListener('click', () => window.print());

        // ########## INITIALIZATION ##########
        elements.startDate.valueAsDate = new Date();
        const urlParams = new URLSearchParams(window.location.search);
        inputs.forEach(id => {
            if (urlParams.has(id)) document.getElementById(id).value = urlParams.get(id);
        });
        
        // Trigger initial currency setup
        elements.currency.dispatchEvent(new Event('change'));
    });
    </script>
</body>
</html>
