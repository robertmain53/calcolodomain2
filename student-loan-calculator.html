<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Student Loan Calculator - Federal Plans & Payoff</title>
    <meta name="description" content="Simulate student loan payments under Standard or Income-Driven (SAVE) plans. Add multiple loans, see forgiveness projections, and visualize your payoff journey.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .prose { max-width: 65ch; margin-left: auto; margin-right: auto; }
        .prose h2 { font-size: 1.5rem; font-weight: 600; margin-top: 2.5rem; margin-bottom: 1rem; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem;}
        .prose h3 { font-size: 1.25rem; font-weight: 600; margin-top: 2rem; margin-bottom: 0.5rem; }
        .prose p, .prose ul, .prose ol { margin-bottom: 1rem; line-height: 1.6; color: #374151; }
        .prose ul, .prose ol { list-style-position: outside; padding-left: 1.25rem; }
        .prose li { margin-bottom: 0.5rem; }
        .loan-row { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f9fafb; }
        .remove-btn { background: #ef4444; color: white; border: none; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.875rem; cursor: pointer; }
        .add-loan-btn { background: #10b981; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; }
        .schedule-container { max-height: 400px; overflow-y: auto; border: 1px solid #d1d5db; border-radius: 8px; }
        .schedule-container table { width: 100%; }
        .schedule-container th, .schedule-container td { padding: 0.5rem; text-align: right; }
        .schedule-container th { background: #f9fafb; position: sticky; top: 0; }
    </style>
    <script type="application/ld+json">{ "@context": "https://schema.org", "@type": "HowTo", "name": "How to Simulate Student Loan Payments", "description": "Step-by-step guide to calculating payments under different federal plans.", "step": [ {"@type": "HowToStep", "name": "Add All Loans", "text": "Enter each of your student loans with its balance, rate, and type (Subsidized/Unsubsidized)."}, {"@type": "HowToStep", "name": "Select a Repayment Plan", "text": "Choose between a Standard plan or an Income-Driven plan like SAVE."}, {"@type": "HowToStep", "name": "Enter Income Details (for IDR)", "text": "If you choose an IDR plan, enter your Adjusted Gross Income and family size."}, {"@type": "HowToStep", "name": "Review Projections", "text": "Analyze your estimated monthly payment, total cost, and potential loan forgiveness."} ] }</script>
    <script src="search.js" defer></script>
    <style>
        /* CalcDomain Search Styles */
        .search-highlight {
            background: linear-gradient(120deg, #fbbf24 0%, #f59e0b 100%);
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: 600;
            color: #78350f;
        }
        
        #search-results {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            max-height: 400px;
            overflow-y: auto;
        }
        
        #search-results a {
            display: block;
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s ease;
            text-decoration: none;
        }
        
        #search-results a:last-child {
            border-bottom: none;
        }
        
        #search-results a:hover {
            background-color: #f8fafc;
            transform: translateX(4px);
        }
        
        #search-results a:focus {
            background-color: #eff6ff;
            outline: 2px solid #3b82f6;
            outline-offset: -2px;
        }
        
        #search-results h3 {
            margin: 0 0 8px 0;
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }
        
        #search-results p {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #6b7280;
            line-height: 1.4;
        }
        
        #search-results .bg-blue-100 {
            background-color: #dbeafe !important;
            color: #1e40af !important;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 500;
        }
        
        input[type="search"]:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            border-color: #3b82f6;
        }
        
        @media (max-width: 768px) {
            #search-results {
                max-height: 300px;
                margin-top: 8px;
                border-radius: 8px;
            }
            
            #search-results a {
                padding: 12px;
            }
            
            #search-results h3 {
                font-size: 15px;
            }
            
            #search-results p {
                font-size: 13px;
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #search-results.show {
            animation: fadeInUp 0.3s ease-out;
        }
        
        #search-results::-webkit-scrollbar {
            width: 6px;
        }
        
        #search-results::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        
        #search-results::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        #search-results::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
            </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-sm sticky top-0 z-50">
    <nav class="container mx-auto px-4 lg:px-6 py-4">
        <!-- TOP ROW -->
        <div class="flex justify-between items-center">
            <!-- LOGO -->
            <a href="index.html" class="text-2xl font-bold text-blue-600">CalcDomain</a>
            
            <!-- DESKTOP SEARCH -->
            <div class="w-full max-w-md hidden md:block mx-8">
                <div class="relative">
                    <input 
                        type="search" 
                        id="search-input"
                        placeholder="Search for a calculator..." 
                        class="w-full py-2 px-4 pr-10 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        autocomplete="off"
                    >
                    <svg class="w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                    <!-- CONTAINER RISULTATI RICERCA -->
                    <div id="search-results" class="absolute top-full left-0 right-0 bg-white shadow-lg rounded-lg mt-2 max-h-96 overflow-y-auto z-50 hidden border border-gray-200"></div>
                </div>
            </div>
            
            <!-- NAVIGATION LINKS -->
            <div class="hidden md:flex items-center space-x-6">
                <a href="search.html" class="text-gray-700 hover:text-blue-600 transition-colors">Advanced Search</a>
                <a href="#categories" class="text-gray-700 hover:text-blue-600 transition-colors">Categories</a>
            </div>
            
            <!-- MOBILE TOGGLE -->
            <button id="mobile-menu-toggle" class="md:hidden p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                </svg>
            </button>
        </div>
        
        <!-- MOBILE MENU -->
        <div id="mobile-menu" class="md:hidden mt-4 hidden">
            <div class="mb-4">
                <div class="relative">
                    <input 
                        type="search" 
                        id="mobile-search-input"
                        placeholder="Search calculators..." 
                        class="w-full py-3 px-4 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                    <svg class="w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
            <div class="space-y-2">
                <a href="search.html" class="block py-2 text-gray-700 hover:text-blue-600">Advanced Search</a>
                <a href="#categories" class="block py-2 text-gray-700 hover:text-blue-600">Categories</a>
            </div>
        </div>
    </nav>
</header>

    <div class="container mx-auto px-4 py-8">
        <div class="flex flex-col lg:flex-row gap-8">
            <main class="w-full lg:w-2/3">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h1 class="text-3xl font-bold mb-2">Student Loan Repayment Simulator</h1>
                    <p class="text-gray-600 mb-6">Compare a Standard 10-Year plan against an Income-Driven (SAVE) plan to find your best payoff strategy and see potential forgiveness.</p>

                    <div id="calculator-ui" class="space-y-6">
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-semibold text-gray-800">Your Student Loans</h3>
                                <button type="button" id="addLoanBtn" class="add-loan-btn">+ Add Loan</button>
                            </div>
                            <div id="loansContainer" class="space-y-4"></div>
                        </div>
                        <hr class="border-gray-300">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">Repayment Plan Details</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label for="repaymentPlan" class="block text-sm font-medium">Repayment Plan</label>
                                    <select id="repaymentPlan" class="mt-1 block w-full p-2 border rounded-md">
                                        <option value="standard">Standard 10-Year Plan</option>
                                        <option value="save">SAVE Plan (Simplified Model)</option>
                                    </select>
                                </div>
                                <div>
                                    <label for="graceMonths" class="block text-sm font-medium">Grace Period (months)</label>
                                    <input type="number" id="graceMonths" value="6" step="1" min="0" class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                            </div>
                            <div id="idrInputs" class="hidden mt-4 grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-4">
                                <div>
                                    <label for="agi" class="block text-sm font-medium">Adjusted Gross Income (AGI)</label>
                                    <input type="number" id="agi" value="50000" step="1000" min="0" class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <div>
                                    <label for="familySize" class="block text-sm font-medium">Family Size</label>
                                    <input type="number" id="familySize" value="1" step="1" min="1" class="mt-1 block w-full p-2 border rounded-md">
                                </div>
                                <p class="text-xs text-gray-500 md:col-span-2">This is a simplified model based on current SAVE plan rules. Your actual IDR payment may vary. For official calculations, use the studentaid.gov Loan Simulator.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div id="results" class="mt-8 bg-blue-50 p-6 rounded-lg">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Loan Repayment Analysis</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
                            <div class="bg-white p-4 rounded-lg"><p class="text-sm">Est. Monthly Payment</p><p class="text-2xl font-bold text-blue-600" id="monthlyPayment">$0.00</p></div>
                            <div class="bg-white p-4 rounded-lg"><p class="text-sm">Total Paid</p><p class="text-2xl font-bold" id="totalPaid">$0.00</p></div>
                            <div class="bg-white p-4 rounded-lg"><p class="text-sm">Payoff Date</p><p class="text-2xl font-bold text-green-600" id="payoffDate">—</p></div>
                            <div class="bg-white p-4 rounded-lg md:col-span-1 lg:col-span-3"><p class="text-sm">Projected Loan Forgiveness</p><p class="text-2xl font-bold text-green-600" id="forgivenessAmount">$0.00</p><p class="text-xs" id="forgivenessNote"></p></div>
                        </div>
                        <div class="mt-6">
                            <h4 class="font-semibold mb-2 text-center">Loan Balance Over Time</h4>
                            <div class="h-64 bg-white rounded-lg p-2"><canvas id="balanceChart"></canvas></div>
                        </div>
                         <details class="mt-6 bg-white rounded-lg p-4"><summary>View Amortization Schedule (First 240 Payments)</summary>
                            <div class="mt-4 schedule-container">
                                <table class="w-full text-sm">
                                    <thead><tr class="bg-gray-50"><th class="text-left p-2">Month</th><th class="text-right p-2">Payment</th><th class="text-right p-2">Interest</th><th class="text-right p-2">Principal</th><th class="text-right p-2">Balance</th></tr></thead>
                                    <tbody id="scheduleBody"></tbody>
                                </table>
                            </div>
                        </details>
                    </div>
                </div>
                
                <article class="bg-white p-6 rounded-lg shadow-md mt-8 prose">
                    <h2>Understanding Your Student Loan Repayment</h2>
                    <p>Student loans are one of the most complex forms of debt, with unique features like grace periods, different loan types, and specialized federal repayment plans. This simulator helps you navigate these complexities to find a strategy that fits your financial life. The U.S. Department of Education offers a variety of repayment plans designed to provide flexibility for borrowers.</p>

                    <h3>Comparing Repayment Strategies</h3>
                    <p>Choosing a repayment plan is a critical decision that impacts your monthly budget and the total cost of your loan. This calculator models two of the most common approaches for federal loan borrowers:</p>
                    <ul>
                        <li><strong>Standard 10-Year Plan:</strong> This plan is designed to pay off your loan in 10 years with fixed monthly payments. It typically results in the lowest total interest paid among traditional plans.</li>
                        <li><strong>SAVE Plan (Saving on a Valuable Education):</strong> This is an Income-Driven Repayment (IDR) plan where monthly payments are calculated based on your income and family size, not your loan balance. Payments can be as low as $0. Under the SAVE plan, any interest not covered by your monthly payment is subsidized by the government, preventing your balance from growing. After 20-25 years of payments, any remaining balance may be forgiven.</li>
                    </ul>

                    <h3>Key Student Loan Concepts Explained</h3>
                    <ul>
                        <li><strong>Grace Period:</strong> This is a set period after you graduate or leave school before you must begin making payments, typically 6 months for federal loans.</li>
                        <li><strong>Subsidized vs. Unsubsidized Loans:</strong> For Direct Subsidized Loans, the U.S. Department of Education pays the interest while you're in school at least half-time, for the first six months after you leave school (grace period), and during periods of deferment. For Unsubsidized Loans, the borrower is responsible for all interest that accrues from the date of disbursement.</li>
                        <li><strong>Interest Capitalization:</strong> This occurs when unpaid accrued interest is added to your loan's principal balance. When this happens, you begin paying interest on a higher principal amount, which increases the total cost of your loan. It often happens at the end of a grace period for unsubsidized loans.</li>
                    </ul>
                    
                    <h2>Private Refinancing vs. Federal Plans</h2>
                    <p>You may receive offers to refinance your federal student loans with a private lender. While this can sometimes result in a lower interest rate, it is a permanent decision with significant trade-offs.</p>
                    <ul>
                        <li><strong>Pros of Refinancing:</strong> Potentially lower interest rate, simplified payments if you combine multiple loans, choice of lender.</li>
                        <li><strong>Cons of Refinancing:</strong> You will permanently lose access to all federal loan benefits, including Income-Driven Repayment plans (like SAVE), loan forgiveness programs (like Public Service Loan Forgiveness), and generous deferment and forbearance options.</li>
                    </ul>
                    <p>It is crucial to use a tool like this to simulate your long-term costs under federal plans before considering private refinancing.</p>

                    <h2>Frequently Asked Questions (FAQ)</h2>
                    <details class="border-t py-2">
                        <summary>Should I pay interest during my grace period?</summary>
                        <p class="mt-2 text-gray-700">If you have unsubsidized loans and can afford to, paying the interest as it accrues during your grace period is a smart financial move. It prevents that interest from being capitalized (added to your principal), which can save you a significant amount of money over the life of the loan by keeping your principal balance lower.</p>
                    </details>
                    <details class="border-t py-2">
                        <summary>What is loan forgiveness and is it taxable?</summary>
                        <p class="mt-2 text-gray-700">Loan forgiveness is when the remaining balance of your loan is canceled after you have made a certain number of qualifying payments over a period of years (typically 20-25 for IDR plans). Under current law through 2025, federal student loan forgiveness is not considered taxable income by the federal government, but some states may tax it. This is subject to change.</p>
                    </details>
                     <details class="border-t py-2">
                        <summary>How accurate is the SAVE Plan simulation?</summary>
                        <p class="mt-2 text-gray-700">This calculator uses a simplified model of the SAVE plan based on its core rules (225% of poverty line exemption, 10% of discretionary income). It is an excellent tool for estimation and comparison. However, for an official calculation that can use your specific loan data, you should always consult the official Loan Simulator on studentaid.gov.</p>
                    </details>
                </article>
            </main>
            <aside class="w-full lg:w-1/3"><div class="sticky top-24"><div class="bg-gray-200 h-96 rounded-lg"></div></div></aside>
        </div>
    </div>
    
    <footer class="bg-white border-t mt-12"><div class="container mx-auto p-8 text-center"><p>&copy; 2025 CalcDomain</p></div></footer>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const elements = {
            addLoanBtn: document.getElementById('addLoanBtn'), loansContainer: document.getElementById('loansContainer'),
            repaymentPlan: document.getElementById('repaymentPlan'), graceMonths: document.getElementById('graceMonths'),
            idrInputs: document.getElementById('idrInputs'), agi: document.getElementById('agi'), familySize: document.getElementById('familySize'),
            monthlyPayment: document.getElementById('monthlyPayment'), totalPaid: document.getElementById('totalPaid'),
            payoffDate: document.getElementById('payoffDate'), forgivenessAmount: document.getElementById('forgivenessAmount'),
            forgivenessNote: document.getElementById('forgivenessNote'), scheduleBody: document.getElementById('scheduleBody'),
            balanceChart: document.getElementById('balanceChart').getContext('2d'),
        };
        let chartInstance = null;
        let loanCounter = 0;

        const fmtCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);
        const debounce = (func, wait) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => func.apply(this, args), wait); }; };

        function createLoanRow(data = {}) {
            loanCounter++;
            const div = document.createElement('div');
            div.className = 'loan-row'; div.dataset.id = loanCounter;
            div.innerHTML = `<div class="flex justify-between items-center mb-3"><h4 class="font-semibold">Loan #${loanCounter}</h4><button type="button" class="remove-btn" onclick="removeLoanRow(${loanCounter})">Remove</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-sm">Balance ($)</label><input type="number" data-type="balance" value="${data.balance || ''}" class="mt-1 w-full p-2 border rounded-md"></div><div><label class="block text-sm">Rate (%)</label><input type="number" data-type="rate" value="${data.rate || ''}" class="mt-1 w-full p-2 border rounded-md"></div><div><label class="block text-sm">Type</label><select data-type="type" class="mt-1 w-full p-2 border rounded-md bg-white"><option value="unsubsidized" ${data.type === 'unsubsidized' ? 'selected' : ''}>Unsubsidized</option><option value="subsidized" ${data.type === 'subsidized' ? 'selected' : ''}>Subsidized</option></select></div></div>`;
            div.querySelectorAll('input, select').forEach(i => i.addEventListener('input', debounce(calculate, 250)));
            return div;
        }

        window.removeLoanRow = (id) => { document.querySelector(`.loan-row[data-id='${id}']`).remove(); calculate(); };
        const addLoan = (data) => elements.loansContainer.appendChild(createLoanRow(data));

        function getLoans() {
            return Array.from(document.querySelectorAll('.loan-row')).map(row => ({
                id: row.dataset.id,
                balance: parseFloat(row.querySelector('[data-type="balance"]').value) || 0,
                rate: (parseFloat(row.querySelector('[data-type="rate"]').value) || 0) / 100,
                type: row.querySelector('[data-type="type"]').value,
            })).filter(d => d.balance > 0);
        }

        function calculate() {
            const loans = getLoans();
            if (loans.length === 0) return;
            
            const plan = elements.repaymentPlan.value;
            let result;
            if (plan === 'standard') {
                result = calculateStandard(loans);
            } else if (plan === 'save') {
                result = calculateSAVE(loans);
            }
            displayResults(result);
        }

        function calculateStandard(loans) {
            const graceMonths = parseInt(elements.graceMonths.value) || 0;
            let startingPrincipal = 0;
            let accruedInterest = 0;

            loans.forEach(loan => {
                startingPrincipal += loan.balance;
                if (loan.type === 'unsubsidized') {
                    accruedInterest += loan.balance * (loan.rate / 12) * graceMonths;
                }
            });
            const capitalizedPrincipal = startingPrincipal + accruedInterest;
            const termMonths = 120; // Standard 10-year term
            
            const weightedRate = loans.reduce((sum, l) => sum + l.balance * l.rate, 0) / startingPrincipal;
            const monthlyRate = weightedRate / 12;

            const payment = monthlyRate > 0 ? (capitalizedPrincipal * monthlyRate) / (1 - Math.pow(1 + monthlyRate, -termMonths)) : capitalizedPrincipal / termMonths;
            
            const schedule = [];
            let balance = capitalizedPrincipal;
            let totalPaid = 0;
            for (let i = 1; i <= termMonths; i++) {
                const interest = balance * monthlyRate;
                const principalPaid = payment - interest;
                balance -= principalPaid;
                schedule.push({ month: i, payment, interest, principal: principalPaid, balance: Math.max(0, balance) });
                totalPaid += payment;
            }
            return { payment, totalPaid, payoffMonths: termMonths, forgiveness: 0, schedule };
        }

        function calculateSAVE(loans) {
            const graceMonths = parseInt(elements.graceMonths.value) || 0;
            const agi = parseFloat(elements.agi.value) || 0;
            const familySize = parseInt(elements.familySize.value) || 1;
            
            let startingPrincipal = 0;
            let accruedInterest = 0;
            loans.forEach(loan => {
                startingPrincipal += loan.balance;
                if (loan.type === 'unsubsidized') {
                    accruedInterest += loan.balance * (loan.rate / 12) * graceMonths;
                }
            });
            let balance = startingPrincipal + accruedInterest;

            const povertyGuideline = 15060 + (familySize - 1) * 5380; // Simplified 2024 poverty guidelines
            const discretionaryIncome = Math.max(0, agi - povertyGuideline * 2.25);
            const annualPayment = discretionaryIncome * 0.10;
            const payment = annualPayment / 12;
            
            const schedule = [];
            let totalPaid = 0;
            const maxMonths = 25 * 12;

            for (let i = 1; i <= maxMonths; i++) {
                const monthlyRate = loans.reduce((sum, l) => sum + (l.balance / startingPrincipal) * l.rate, 0) / 12;
                const interestThisMonth = balance * monthlyRate;
                
                const actualPayment = Math.min(balance + interestThisMonth, payment);
                totalPaid += actualPayment;

                const principalPaid = actualPayment - interestThisMonth;
                
                // On SAVE, if payment < interest, the remaining interest is subsidized and balance doesn't grow.
                // If payment > interest, the excess reduces principal.
                if(principalPaid > 0){
                    balance -= principalPaid;
                }

                schedule.push({ month: i, payment: actualPayment, interest: interestThisMonth, principal: Math.max(0, principalPaid), balance: Math.max(0, balance) });
                if (balance <= 0) break;
            }

            const forgiveness = balance > 0 ? balance : 0;
            return { payment, totalPaid, payoffMonths: schedule.length, forgiveness, schedule };
        }
        
        function displayResults({ payment, totalPaid, payoffMonths, forgiveness, schedule }) {
            elements.monthlyPayment.textContent = fmtCurrency(payment);
            elements.totalPaid.textContent = fmtCurrency(totalPaid);
            const payoffDate = new Date();
            payoffDate.setMonth(payoffDate.getMonth() + (parseInt(elements.graceMonths.value) || 0) + payoffMonths);
            elements.payoffDate.textContent = payoffDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
            
            elements.forgivenessAmount.textContent = fmtCurrency(forgiveness);
            if (forgiveness > 0) {
                elements.forgivenessNote.textContent = `After ${Math.ceil(payoffMonths/12)} years. This may be a taxable event.`;
            } else {
                elements.forgivenessNote.textContent = '';
            }

            elements.scheduleBody.innerHTML = schedule.slice(0, 240).map(p => `<tr><td class="p-2 text-left">${p.month}</td><td class="p-2 text-right">${fmtCurrency(p.payment)}</td><td class="p-2 text-right">${fmtCurrency(p.interest)}</td><td class="p-2 text-right">${fmtCurrency(p.principal)}</td><td class="p-2 text-right">${fmtCurrency(p.balance)}</td></tr>`).join('');
            
            updateChart(schedule);
        }

        function updateChart(schedule) {
            if (chartInstance) chartInstance.destroy();
            const labels = schedule.map(p => p.month);
            const data = schedule.map(p => p.balance);
            chartInstance = new Chart(elements.balanceChart, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Loan Balance', data, borderColor: '#3b82f6', fill: false, pointRadius: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        elements.repaymentPlan.addEventListener('change', () => {
            elements.idrInputs.classList.toggle('hidden', elements.repaymentPlan.value !== 'save');
            calculate();
        });
        
        document.querySelectorAll('#calculator-ui input, #calculator-ui select').forEach(el => {
            el.addEventListener('input', debounce(calculate, 250));
        });

        addLoan({ balance: 20000, rate: 5.5, type: 'unsubsidized' });
        addLoan({ balance: 7500, rate: 4.5, type: 'subsidized' });
        calculate();
    });
    </script>
</body>
</html>
