<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weight Loss Calculator – Plan Your Calorie Target, Rate & Goal Date</title>
  <meta name="description" content="Professional weight loss calculator: estimate BMR, TDEE, safe calorie deficit, weekly loss, and goal-date timeline. Includes formulas, methodology, worked example, and FAQs." />
  <link rel="canonical" href="https://calcdomain.com/weight-loss-calculator.html" />
  <meta name="author" content="Ugo Candido" />

  <!-- Icons -->
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
  <!-- MathJax for LaTeX -->
  <script>
    window.MathJax = { tex: { inlineMath: [["$","$"],["\\(","\\)"]] }, svg: { fontCache: 'global' } };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js" defer></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"></noscript>

  <style>
    :root{--focus:#2563eb}
    body{font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Apple Color Emoji','Segoe UI Emoji',sans-serif}
    .prose{max-width:70ch}
    .prose h2{font-size:1.5rem;font-weight:700;margin-top:2rem;margin-bottom:0.75rem}
    .prose h3{font-size:1.125rem;font-weight:700;margin-top:1.25rem;margin-bottom:0.5rem}
    .prose p{margin-bottom:1rem;line-height:1.65}
    .prose ul,.prose ol{margin-left:1.25rem;margin-bottom:1rem}
    .formula-box{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:10px;padding:1rem;overflow:auto}
    .result-card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:1rem;text-align:center}
    .result-card h4{font-size:.9rem;color:#6b7280}
    .result-card p{font-size:1.5rem;font-weight:800;color:#1d4ed8}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    /* Accessible focus */
    :is(a,button,input,select,details,summary,textarea):focus{outline:3px solid var(--focus);outline-offset:2px}
    /* Prevent CLS in results */
    #results-wrap{min-height:420px}
    /* Touch target sizing */
    .tap{min-height:48px;min-width:48px}
    /* Print friendly */
    @media print{#chart-wrap{display:none !important}}
  </style>

  <!-- JSON-LD: WebPage -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"Weight Loss Calculator",
    "description":"Estimate BMR, TDEE, calorie deficit, weekly weight loss, and goal-date timeline with professional methodology.",
    "url":"https://calcdomain.com/weight-loss-calculator.html",
    "inLanguage":"en",
    "author":{"@type":"Person","name":"Ugo Candido"},
    "publisher":{"@type":"Organization","name":"CalcDomain"}
  }
  </script>
  <!-- JSON-LD: Breadcrumbs -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://calcdomain.com/"},
      {"@type":"ListItem","position":2,"name":"Health & Fitness","item":"https://calcdomain.com/health-fitness.html"},
      {"@type":"ListItem","position":3,"name":"Diet & Nutrition","item":"https://calcdomain.com/subcategories/diet-nutrition.html"},
      {"@type":"ListItem","position":4,"name":"Weight Loss Calculator","item":"https://calcdomain.com/weight-loss-calculator.html"}
    ]
  }
  </script>
  <!-- JSON-LD: HowTo -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"HowTo",
    "name":"How to calculate a safe calorie target for weight loss",
    "description":"Step-by-step to compute BMR, TDEE, set a calorie deficit and project weekly weight change.",
    "step":[
      {"@type":"HowToStep","name":"Enter personal data","text":"Provide age, sex, height, weight."},
      {"@type":"HowToStep","name":"Choose activity level","text":"Select your typical daily activity to estimate TDEE."},
      {"@type":"HowToStep","name":"Pick a goal","text":"Choose a weekly loss or a goal date/weight."},
      {"@type":"HowToStep","name":"Review targets","text":"See recommended calorie range and predicted timeline."}
    ]
  }
  </script>
  <!-- JSON-LD: FAQPage -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {"@type":"Question","name":"How fast can I lose weight safely?","acceptedAnswer":{"@type":"Answer","text":"General guidance is 0.25–1.0 kg (0.5–2 lb) per week for most adults. Faster rates may be appropriate only with clinical supervision."}},
      {"@type":"Question","name":"Is 3,500 kcal per pound accurate?","acceptedAnswer":{"@type":"Answer","text":"It is a useful rule of thumb for short-term planning, but human metabolism adapts. Our calculator shows both linear and adaptive projections."}},
      {"@type":"Question","name":"Should I use BMR from Mifflin–St Jeor?","acceptedAnswer":{"@type":"Answer","text":"Yes, it is widely used in dietetics for resting energy expenditure and tends to outperform older formulas for non-obese adults."}},
      {"@type":"Question","name":"Do I need to include exercise calories?","acceptedAnswer":{"@type":"Answer","text":"Activity level already estimates daily movement. If you add deliberate exercise, you can increase activity level or add calories back on training days."}},
      {"@type":"Question","name":"Will weight loss stall?","acceptedAnswer":{"@type":"Answer","text":"Metabolic adaptation and water shifts can temporarily mask fat loss. Track 7‑day average weight and adjust after 2–3 weeks if trends stall."}}
    ]
  }
  </script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header (non-sticky per spec) -->
  <header class="bg-white border-b">
    <div class="container mx-auto px-4 lg:px-6 py-5 flex items-center justify-between">
      <a href="index.html" class="text-2xl font-extrabold text-blue-700">CalcDomain</a>
      <nav class="hidden md:flex gap-6 text-sm">
        <a href="search.html" class="hover:text-blue-700">Search</a>
        <a href="#ecosystem" class="hover:text-blue-700">Methodology</a>
        <a href="#faq" class="hover:text-blue-700">FAQ</a>
      </nav>
    </div>
  </header>

  <main class="container mx-auto px-4 lg:px-6 py-10">
    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
      <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm" aria-labelledby="page-title">
        <nav class="text-sm text-gray-600 mb-4" aria-label="Breadcrumb">
          <a href="index.html" class="hover:text-blue-700">Home</a> &raquo;
          <a href="health-fitness.html" class="hover:text-blue-700">Health &amp; Fitness</a> &raquo;
          <a href="subcategories/diet-nutrition.html" class="hover:text-blue-700">Diet &amp; Nutrition</a> &raquo;
          <span class="text-gray-900">Weight Loss Calculator</span>
        </nav>

        <h1 id="page-title" class="text-3xl font-extrabold mb-2">weight loss calculator</h1>
        <p class="text-gray-700 mb-6">Plan a realistic, safe weight‑loss path. Enter your stats to estimate BMR and TDEE, select your target (weekly loss or goal date/weight), and get a daily calorie range with a week‑by‑week projection.</p>

        <!-- Calculator UI -->
        <section aria-labelledby="calc-title">
          <h2 id="calc-title" class="text-xl font-bold mb-4">Calculator</h2>
          <form id="calc-form" class="grid grid-cols-1 md:grid-cols-2 gap-6" novalidate>
            <!-- Sex -->
            <div>
              <label for="sex" class="block text-sm font-medium text-gray-800">Sex *</label>
              <div class="relative">
                <select id="sex" name="sex" aria-required="true" class="mt-1 tap w-full px-3 py-2 border border-gray-300 rounded-md" aria-describedby="sex-help sex-err">
                  <option value="female">Female</option>
                  <option value="male">Male</option>
                </select>
                <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 px-2 tap" aria-expanded="false" aria-controls="sex-help" aria-label="Toggle help for sex" data-tooltip="sex-help">?</button>
              </div>
              <p id="sex-help" class="mt-1 text-xs text-gray-600 hidden">Used by the Mifflin–St Jeor equation to estimate resting energy expenditure.</p>
              <p id="sex-err" class="mt-1 text-sm text-red-600"></p>
            </div>

            <!-- Age -->
            <div>
              <label for="age" class="block text-sm font-medium text-gray-800">Age (years) *</label>
              <input id="age" name="age" type="number" inputmode="numeric" min="14" max="120" step="1" value="30" aria-required="true" aria-describedby="age-help age-err" class="mt-1 tap w-full px-3 py-2 border border-gray-300 rounded-md" />
              <p id="age-help" class="mt-1 text-xs text-gray-600">Used for BMR. Range 14–120.</p>
              <p id="age-err" class="mt-1 text-sm text-red-600"></p>
            </div>

            <!-- Height -->
            <div>
              <label for="height" class="block text-sm font-medium text-gray-800">Height (cm) *</label>
              <input id="height" name="height" type="number" inputmode="decimal" min="120" max="230" step="0.1" value="175" aria-required="true" aria-describedby="height-help height-err" class="mt-1 tap w-full px-3 py-2 border border-gray-300 rounded-md" />
              <p id="height-help" class="mt-1 text-xs text-gray-600">Enter height in centimeters.</p>
              <p id="height-err" class="mt-1 text-sm text-red-600"></p>
            </div>

            <!-- Weight -->
            <div>
              <label for="weight" class="block text-sm font-medium text-gray-800">Current weight (kg) *</label>
              <input id="weight" name="weight" type="number" inputmode="decimal" min="35" max="300" step="0.1" value="80" aria-required="true" aria-describedby="weight-help weight-err" class="mt-1 tap w-full px-3 py-2 border border-gray-300 rounded-md" />
              <p id="weight-help" class="mt-1 text-xs text-gray-600">Enter body weight in kilograms.</p>
              <p id="weight-err" class="mt-1 text-sm text-red-600"></p>
            </div>

            <!-- Activity -->
            <div>
              <label for="activity" class="block text-sm font-medium text-gray-800">Activity level *</label>
              <div class="relative">
                <select id="activity" name="activity" aria-required="true" class="mt-1 tap w-full px-3 py-2 border border-gray-300 rounded-md" aria-describedby="activity-help activity-err">
                  <option value="1.2">Sedentary (little or no exercise)</option>
                  <option value="1.375">Lightly active (1–3 days/week)</option>
                  <option value="1.55" selected>Moderately active (3–5 days/week)</option>
                  <option value="1.725">Very active (6–7 days/week)</option>
                  <option value="1.9">Extra active (intense + physical job)</option>
                </select>
                <button type="button" class="absolute right-2 top-1/2 -translate-y-1/2 px-2 tap" aria-expanded="false" aria-controls="activity-help" aria-label="Toggle help for activity" data-tooltip="activity-help">?</button>
              </div>
              <p id="activity-help" class="mt-1 text-xs text-gray-600 hidden">Multiplier applied to BMR to estimate TDEE (total daily energy expenditure).</p>
              <p id="activity-err" class="mt-1 text-sm text-red-600"></p>
            </div>

            <!-- Goal mode -->
            <div>
              <label for="goalMode" class="block text-sm font-medium text-gray-800">Goal mode *</label>
              <select id="goalMode" name="goalMode" class="mt-1 tap w-full px-3 py-2 border border-gray-300 rounded-md" aria-required="true" aria-describedby="goal-help goal-err">
                <option value="rate" selected>Weekly loss rate</option>
                <option value="target">Target weight by date</option>
              </select>
              <p id="goal-help" class="mt-1 text-xs text-gray-600">Pick a weekly rate or a goal date + target weight.</p>
              <p id="goal-err" class="mt-1 text-sm text-red-600"></p>
            </div>

            <!-- Weekly rate -->
            <div id="rate-wrap">
              <label for="rate" class="block text-sm font-medium text-gray-800">Weekly loss (kg/week) *</label>
              <input id="rate" name="rate" type="number" inputmode="decimal" min="0.1" max="1.0" step="0.05" value="0.5" aria-required="true" aria-describedby="rate-help rate-err" class="mt-1 tap w-full px-3 py-2 border border-gray-300 rounded-md" />
              <p id="rate-help" class="mt-1 text-xs text-gray-600">Typical safe range: 0.25–1.0 kg/week.</p>
              <p id="rate-err" class="mt-1 text-sm text-red-600"></p>
            </div>

            <!-- Target mode inputs -->
            <div id="target-wrap" class="hidden">
              <label for="targetWeight" class="block text-sm font-medium text-gray-800">Target weight (kg) *</label>
              <input id="targetWeight" name="targetWeight" type="number" inputmode="decimal" min="35" max="300" step="0.1" value="72" aria-describedby="target-help target-err" class="mt-1 tap w-full px-3 py-2 border border-gray-300 rounded-md" />
              <p id="target-help" class="mt-1 text-xs text-gray-600">The weight you want to reach.</p>
              <p id="target-err" class="mt-1 text-sm text-red-600"></p>
              <label for="goalDate" class="block text-sm font-medium text-gray-800 mt-4">Goal date *</label>
              <input id="goalDate" name="goalDate" type="date" class="mt-1 tap w-full px-3 py-2 border border-gray-300 rounded-md" aria-describedby="date-err" />
              <p id="date-err" class="mt-1 text-sm text-red-600"></p>
            </div>

            <!-- Buttons -->
            <div class="md:col-span-2 flex flex-wrap gap-3 pt-2">
              <button id="calc-btn" type="button" class="tap px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg">Calculate</button>
              <button id="reset-btn" type="button" class="tap px-4 py-3 bg-gray-100 hover:bg-gray-200 text-gray-900 font-semibold rounded-lg">Reset</button>
              <button id="print-btn" type="button" class="tap px-4 py-3 bg-white border hover:bg-gray-50 font-semibold rounded-lg">Print</button>
            </div>
          </form>
        </section>

        <!-- Results -->
        <section id="results-wrap" class="mt-8">
          <h2 class="text-xl font-bold mb-4">Results</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="result-card"><h4>BMR</h4><p id="bmr">—</p></div>
            <div class="result-card"><h4>TDEE</h4><p id="tdee">—</p></div>
            <div class="result-card"><h4>Calorie target</h4><p id="calTarget">—</p></div>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            <div class="result-card"><h4>Weekly loss (proj.)</h4><p id="projRate">—</p></div>
            <div class="result-card"><h4>Goal ETA</h4><p id="eta">—</p></div>
            <div class="result-card"><h4>Protein (guide)</h4><p id="protein">—</p></div>
          </div>

          <details id="projection-details" class="mt-6 bg-white border rounded-lg">
            <summary class="px-4 py-3 font-semibold">Show 16‑week projection</summary>
            <div class="p-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div id="chart-wrap" class="h-64"><canvas id="projectionChart" aria-label="Weight projection chart" role="img"></canvas></div>
              <div class="overflow-x-auto border rounded-md">
                <table class="min-w-full text-sm text-right">
                  <thead class="bg-gray-100 text-gray-700 uppercase">
                    <tr>
                      <th class="px-3 py-2 text-left">Week</th>
                      <th class="px-3 py-2">Weight (kg)</th>
                      <th class="px-3 py-2">Deficit (kcal/day)</th>
                    </tr>
                  </thead>
                  <tbody id="projectionBody"></tbody>
                </table>
              </div>
            </div>
          </details>
        </section>

        <!-- Ecosystem / E-E-A-T content -->
        <section id="ecosystem" class="prose mt-10">
          <h2>Data source & methodology</h2>
          <p><strong>AuthoritativeDataSource:</strong> Mifflin MD, St Jeor ST, et al. "A new predictive equation for resting energy expenditure in healthy individuals." <em>Am J Clin Nutr</em>. 1990;51(2):241‑247. doi:10.1093/ajcn/51.2.241. NIH/NIDDK <em>Body Weight Planner</em> for adaptive dynamics; and USDA/HHS <em>Dietary Guidelines for Americans</em> for safe rates and protein guidance. <a href="https://www.niddk.nih.gov/health-information/weight-management/body-weight-planner" target="_blank" rel="nofollow noopener">NIDDK BWP</a>, <a href="https://academic.oup.com/ajcn/article-abstract/51/2/241/4695423" target="_blank" rel="nofollow noopener">Mifflin–St Jeor</a>, <a href="https://www.dietaryguidelines.gov/" target="_blank" rel="nofollow noopener">DGA</a>. <br/><em>Tutti i calcoli si basano rigorosamente sulle formule e sui dati forniti da questa fonte.</em></p>
          <p>We compute BMR using Mifflin–St Jeor and multiply by an activity factor to estimate TDEE. For weight‑change projections we show a <em>linear</em> model using \(7{,}700\,\text{kcal} \approx 1\,\text{kg}\) of body fat and an <em>adaptive</em> model that modestly tapers the deficit over time (simple dynamic factor), acknowledging real‑world metabolic adaptation.</p>

          <h2>The formula explained</h2>
          <div class="formula-box">
            <p><strong>Mifflin–St Jeor (BMR)</strong></p>
            <p>Female: $\text{BMR}=10w+6.25h-5a-161$ &nbsp;&nbsp; Male: $\text{BMR}=10w+6.25h-5a+5$</p>
            <p>where $w$ (kg), $h$ (cm), $a$ (years).</p>
            <p><strong>TDEE</strong>: $\text{TDEE}=\text{BMR}\times AF$ where $AF\in\{1.2,1.375,1.55,1.725,1.9\}$.</p>
            <p><strong>Linear weight change</strong>: With daily deficit $D$, weekly loss $\Delta w = \dfrac{7D}{7700}$ (kg/week).</p>
            <p><strong>Adaptive taper</strong> (heuristic): $D_t = D\,\big/\,(1+0.02t)$ with $t$ in weeks.</p>
          </div>

          <h2>Glossary of variables</h2>
          <table class="w-full text-sm border">
            <thead class="bg-gray-100"><tr><th class="text-left p-2">Symbol/Field</th><th class="text-left p-2">Meaning</th></tr></thead>
            <tbody>
              <tr><td class="p-2">Sex</td><td class="p-2">Biological sex used by Mifflin–St Jeor.</td></tr>
              <tr><td class="p-2">Age</td><td class="p-2">Years; influences BMR.</td></tr>
              <tr><td class="p-2">Height (h)</td><td class="p-2">Body height in centimeters.</td></tr>
              <tr><td class="p-2">Weight (w)</td><td class="p-2">Current body mass in kg.</td></tr>
              <tr><td class="p-2">Activity factor (AF)</td><td class="p-2">Multiplier converting BMR to TDEE.</td></tr>
              <tr><td class="p-2">BMR</td><td class="p-2">Basal metabolic rate (kcal/day at rest).</td></tr>
              <tr><td class="p-2">TDEE</td><td class="p-2">Estimated maintenance calories (kcal/day).</td></tr>
              <tr><td class="p-2">Calorie target</td><td class="p-2">Daily intake to reach goal given chosen rate/date.</td></tr>
            </tbody>
          </table>

          <h2>How it works: a step‑by‑step example</h2>
          <p>Example: Female, 30 years, 175 cm, 80 kg, moderately active. BMR = $10\cdot80 + 6.25\cdot175 - 5\cdot30 - 161 = 1614$ kcal/day. TDEE = $1614\times1.55 \approx 2501$ kcal/day. If the weekly loss goal is 0.5 kg/wk, the required deficit is $\dfrac{7700\cdot0.5}{7} \approx 550$ kcal/day, so calorie target $\approx 2501-550=1951$ kcal/day. Goal ETA for losing 8 kg is roughly 16 weeks with adaptive taper slightly lengthening the timeline.</p>

          <h2 id="faq">Frequently asked questions</h2>
          <details><summary>What deficit should I choose?</summary><p>Common choices are 300–750 kcal/day depending on current weight, activity, and patience. Larger deficits increase fatigue and risk of lean mass loss.</p></details>
          <details><summary>Why do results differ from smartwatches?</summary><p>Devices estimate energy with different models and sensor inputs. Use one consistent method for trends and adjust using 2–3 weeks of real weight data.</p></details>
          <details><summary>Do I need higher protein?</summary><p>For active dieters, 1.6–2.2 g/kg/day is often recommended to preserve lean mass; we display a mid‑range suggestion.</p></details>
          <details><summary>Can I mix goal date and weekly rate?</summary><p>Yes—pick <em>Target weight by date</em>. We compute the implied weekly rate and calorie target. If it exceeds safe bounds, we flag it.</p></details>
          <details><summary>Why show an adaptive projection?</summary><p>Human metabolism adapts to energy deficit; the simple taper models that your initial deficit becomes slightly less effective over time.</p></details>

          <div class="mt-6 p-4 bg-gray-50 border rounded-lg text-sm text-gray-700">
            <p><strong>Tool developed by Ugo Candido.</strong> Content reviewed by CalcDomain Editorial Board.<br>
            Last accuracy review: <time datetime="2025-10-30">October 30, 2025</time></p>
          </div>
        </section>
      </section>

      <aside class="lg:col-span-1 space-y-6">
        <div class="bg-white p-6 rounded-xl shadow-sm">
          <h3 class="font-bold text-lg mb-2">Why this tool beats competitors</h3>
          <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
            <li>Dual projection: linear vs. adaptive.</li>
            <li>Clear BMR/TDEE math with LaTeX formulas.</li>
            <li>Inline validation & accessible tooltips.</li>
            <li>Professional E‑E‑A‑T with primary sources.</li>
          </ul>
        </div>
        <div class="bg-gray-200 h-72 rounded-xl flex items-center justify-center text-gray-600">Ad Placement (300×600)</div>
        <div class="bg-white p-6 rounded-xl shadow-sm">
          <h3 class="font-bold text-lg mb-3">Related calculators</h3>
          <ul class="space-y-2 text-sm">
            <li><a class="text-blue-700 hover:underline" href="calorie-calculator.html">Calorie Calculator</a></li>
            <li><a class="text-blue-700 hover:underline" href="protein-intake-calculator.html">Protein Intake Calculator</a></li>
            <li><a class="text-blue-700 hover:underline" href="calorie-deficit-calculator.html">Calorie Deficit Calculator</a></li>
          </ul>
        </div>
      </aside>
    </div>
  </main>

  <footer class="bg-white border-t">
    <div class="container mx-auto px-6 py-8 text-center text-gray-600 text-sm">
      <p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
      <div class="mt-3 space-x-4">
        <a href="about.html" class="hover:text-blue-700">About</a>
        <a href="contact.html" class="hover:text-blue-700">Contact</a>
        <a href="privacy.html" class="hover:text-blue-700">Privacy</a>
        <a href="terms.html" class="hover:text-blue-700">Terms</a>
      </div>
    </div>
  </footer>

  <!-- Calculator Logic (defer) -->
  <script defer>
  (function(){
    const $ = (id) => document.getElementById(id);
    const els = {
      sex: $('sex'), age: $('age'), height: $('height'), weight: $('weight'), activity: $('activity'),
      goalMode: $('goalMode'), rate: $('rate'), rateWrap: $('rate-wrap'), targetWrap: $('target-wrap'),
      targetWeight: $('targetWeight'), goalDate: $('goalDate'),
      bmr: $('bmr'), tdee: $('tdee'), calTarget: $('calTarget'), projRate: $('projRate'), eta: $('eta'), protein: $('protein'),
      projectionBody: $('projectionBody'),
      chart: $('projectionChart'),
      calcBtn: $('calc-btn'), resetBtn: $('reset-btn'), printBtn: $('print-btn')
    };

    // Accessible tooltips
    document.querySelectorAll('[data-tooltip]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-tooltip');
        const p = document.getElementById(id);
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!expanded));
        p.classList.toggle('hidden');
      })
    });

    // Goal mode switch
    els.goalMode.addEventListener('change',()=>{
      const mode = els.goalMode.value;
      els.rateWrap.classList.toggle('hidden', mode !== 'rate');
      els.targetWrap.classList.toggle('hidden', mode !== 'target');
    });

    // Formatters
    const nf0 = new Intl.NumberFormat(undefined,{maximumFractionDigits:0});
    const nf1 = new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
    const nf2 = new Intl.NumberFormat(undefined,{maximumFractionDigits:2});

    // Validation helpers (on blur)
    const validators = {
      age:(v)=> (v>=14 && v<=120) || 'Enter an age between 14 and 120.',
      height:(v)=> (v>=120 && v<=230) || 'Height must be 120–230 cm.',
      weight:(v)=> (v>=35 && v<=300) || 'Weight must be 35–300 kg.',
      rate:(v)=> (v>=0.1 && v<=1.0) || 'Weekly loss must be 0.1–1.0 kg/wk.',
      targetWeight:(v)=> (v>=35 && v<=300) || 'Target weight must be 35–300 kg.',
      goalDate:(v)=> {
        if(!v) return 'Choose a goal date.';
        const d = new Date(v);
        const today = new Date(); today.setHours(0,0,0,0);
        return (d>today) || 'Goal date must be in the future.';
      }
    };

    function attachBlur(id){
      const input = $(id);
      const err = document.getElementById(id+'-err');
      if(!input) return;
      input.addEventListener('blur',()=>{
        const v = (id==='goalDate')? input.value : parseFloat(input.value);
        const res = validators[id]? validators[id](v) : true;
        if(res!==true){ err.textContent = res; input.setAttribute('aria-invalid','true'); }
        else { err.textContent=''; input.removeAttribute('aria-invalid'); }
      })
    }

    ['age','height','weight','rate','targetWeight','goalDate'].forEach(attachBlur);

    // Core calculations
    function bmrMifflin(sex, w, h, a){
      // w kg, h cm, a years
      return (sex==='female') ? (10*w + 6.25*h - 5*a - 161) : (10*w + 6.25*h - 5*a + 5);
    }

    function safeProteinGuide(weightKg){
      // mid-range 1.8 g/kg/day
      return 1.8 * weightKg;
    }

    function compute(){
      const sex = els.sex.value;
      const a = parseFloat(els.age.value);
      const h = parseFloat(els.height.value);
      const w0 = parseFloat(els.weight.value);
      const AF = parseFloat(els.activity.value);
      const mode = els.goalMode.value;

      // Validate essential
      if([a,h,w0].some(x=>!isFinite(x))){ return; }

      const bmr = Math.max(800, bmrMifflin(sex,w0,h,a));
      const tdee = Math.max(1000, bmr*AF);

      let deficitPerDay, weeklyLossKg, etaWeeks='—', calorieTarget='—';

      if(mode==='rate'){
        const rate = parseFloat(els.rate.value);
        if(isFinite(rate)){
          deficitPerDay = (7700 * rate) / 7; // kcal/day
          weeklyLossKg = rate;
          calorieTarget = Math.max(0, tdee - deficitPerDay);
          etaWeeks = '—';
        }
      } else {
        const tw = parseFloat(els.targetWeight.value);
        const gd = els.goalDate.value ? new Date(els.goalDate.value) : null;
        if(isFinite(tw) && gd){
          const today = new Date();
          const diffWeeks = Math.max(1, Math.round((gd - today)/(1000*60*60*24*7)));
          const kgToLose = Math.max(0, w0 - tw);
          weeklyLossKg = kgToLose / diffWeeks;
          deficitPerDay = (7700 * weeklyLossKg) / 7;
          calorieTarget = Math.max(0, tdee - deficitPerDay);
          etaWeeks = diffWeeks + ' wk';
        }
      }

      // Bound safety: if target unrealistic, flag
      let warn = '';
      if(weeklyLossKg && weeklyLossKg>1.0) warn = 'Chosen rate exceeds typical safe range (0.25–1.0 kg/wk). Consider a smaller deficit.';

      // Protein guide
      const proteinG = safeProteinGuide(w0);

      // Update summary cards
      els.bmr.textContent = nf0.format(bmr) + ' kcal';
      els.tdee.textContent = nf0.format(tdee) + ' kcal';
      els.calTarget.textContent = isFinite(calorieTarget)? nf0.format(calorieTarget)+' kcal' : '—';
      els.projRate.textContent = isFinite(weeklyLossKg)? nf2.format(weeklyLossKg)+' kg/wk' : '—';
      els.eta.textContent = etaWeeks;
      els.protein.textContent = nf0.format(proteinG) + ' g/day';

      // Build 16-week projection table + chart
      buildProjection(w0, tdee, deficitPerDay);

      // Show warning if any
      const existing = document.getElementById('safety-warn');
      if(existing) existing.remove();
      if(warn){
        const p = document.createElement('p');
        p.id='safety-warn';
        p.className='mt-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded p-3';
        p.textContent = warn;
        document.getElementById('results-wrap').prepend(p);
      }
    }

    function buildProjection(startKg, tdee, deficit){
      const body = els.projectionBody; body.innerHTML='';
      const weeks = 16;
      const labels = []; const linear = []; const adaptive = []; const deficits=[];
      let wLin = startKg; let wAdp = startKg;
      for(let t=1;t<=weeks;t++){
        labels.push('W'+t);
        const d_t = (isFinite(deficit) && deficit>0) ? deficit/(1+0.02*t) : 0; // taper 2% per week
        const lossLin = (isFinite(deficit)? (7*deficit)/7700 : 0);
        const lossAdp = (7*d_t)/7700;
        wLin = Math.max(0, wLin - lossLin);
        wAdp = Math.max(0, wAdp - lossAdp);
        linear.push(Number(wLin.toFixed(2)));
        adaptive.push(Number(wAdp.toFixed(2)));
        deficits.push(Math.max(0, Math.round(d_t)));

        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="px-3 py-2 text-left">${t}</td>
                        <td class="px-3 py-2">${wAdp.toFixed(2)}</td>
                        <td class="px-3 py-2">${isFinite(d_t)? Math.round(d_t): 0}</td>`;
        body.appendChild(tr);
      }
      renderChart(labels, linear, adaptive);
    }

    let chartInstance = null;
    function renderChart(labels, linear, adaptive){
      const ctx = els.chart;
      if(!ctx) return;
      const data = {
        labels,
        datasets:[
          {label:'Linear (7,700 kcal/kg)', data: linear, borderWidth:2, tension:0.2},
          {label:'Adaptive (tapered)', data: adaptive, borderWidth:2, tension:0.2}
        ]
      };
      const options = {responsive:true, maintainAspectRatio:false, plugins:{legend:{position:'bottom'}}, scales:{y:{title:{display:true, text:'kg'}}}};
      if(chartInstance){ chartInstance.data=data; chartInstance.update(); }
      else { chartInstance = new Chart(ctx, {type:'line', data, options}); }
    }

    // Buttons
    els.calcBtn.addEventListener('click', compute);
    els.resetBtn.addEventListener('click', ()=>{ document.getElementById('calc-form').reset(); els.goalMode.dispatchEvent(new Event('change')); compute(); });
    els.printBtn.addEventListener('click', ()=>window.print());

    // Recompute on key inputs (but not on every keystroke for perf; use change)
    ['sex','age','height','weight','activity','goalMode','rate','targetWeight','goalDate'].forEach(id=>{
      const node = document.getElementById(id);
      if(!node) return;
      node.addEventListener('change', compute);
    });

    // Initial compute
    compute();
  })();
  </script>
</body>
</html>
