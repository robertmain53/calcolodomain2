<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="manifest" href="/site.webmanifest" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Profit Margin Calculator - Calculate Gross, Operating & Net Margin</title>
<meta name="description" content="Calculate your gross, operating, and net profit margin with our easy-to-use calculator. Understand your business's profitability with clear formulas and examples.">
<link rel="canonical" href="https://calcdomain.com/profit-margin-calculator.html"/>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0KOvd3NUBCbLAssvXCAMS7kbEodCmUfeviCNrIYNFGNGnhhzQVPOv" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGjKGTdwagnANsYEXmNsdU5dkRTlZaUsersSSgcAALN1MvOFUINlSVIhGk" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURPlLJSzFGFgCFvogPKbundle.js" crossorigin="anonymous"></script>

<style>
body { font-family: 'Inter', sans-serif; }
/* Custom focus state for WCAG 2.1 AA */
:focus-visible {
outline: 3px solid #2563eb !important;
outline-offset: 2px;
border-radius: 4px;
}
.prose { max-width: 65ch; }
.prose h2 { font-size: 1.5rem; font-weight: 600; margin-top: 2rem; margin-bottom: 1rem; }
.prose h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; }
.prose p { margin-bottom: 1rem; line-height: 1.6; }
.prose ul, .prose ol { margin-left: 1.5rem; margin-bottom: 1rem; }
.prose li { margin-bottom: 0.5rem; }
.formula-box {
background:#f3f4f6; border:1px solid #d1d5db; border-radius:8px; padding:1.5rem;
overflow-x:auto; font-size: 1.1rem; text-align: center;
}
details > summary { cursor: pointer; font-weight: 600; padding: 0.5rem 0; }
details[open] > summary { margin-bottom: 0.5rem; }
.result-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 1.25rem; text-align: center; }
.result-card h4 { font-size: 0.95rem; color: #6b7280; margin-bottom: 0.25rem; text-transform: uppercase; letter-spacing: 0.05em; }
.result-card p { font-size: 1.75rem; font-weight: 700; color: #2563eb; }
/* Accessible Tooltip */
.tooltip-btn {
display: inline-flex;
align-items: center;
justify-content: center;
width: 20px;
height: 20px;
border: 1px solid #9ca3af;
border-radius: 50%;
background: #f9fafb;
color: #6b7280;
font-weight: 700;
font-size: 0.75rem;
cursor: pointer;
margin-left: 8px;
}
.tooltip-text {
display: none; /* Hidden by default */
position: absolute;
background-color: #1f2937;
color: #fff;
padding: 8px 12px;
border-radius: 6px;
z-index: 10;
width: max-content;
max-width: 250px;
font-size: 0.875rem;
margin-top: 4px;
box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}
.tooltip-btn[aria-expanded="true"] + .tooltip-text {
display: block;
}
/* Error Message Styling */
.error-message {
color: #dc2626;
font-size: 0.875rem;
margin-top: 0.5rem;
}
/* Print Styling */
@media print {
body * { visibility: hidden; }
#print-section, #print-section * { visibility: visible; }
#print-section { position: absolute; left: 0; top: 0; width: 100%; }
#results-chart-container { display: none !important; }
nav, aside, footer, #mobile-menu-toggle { display: none !important; }
}
</style>

<script type="application/ld+json">
{
"@context": "https://schema.org",
"@type": "WebPage",
"name": "Profit Margin Calculator",
"description": "Calculate gross, operating, and net profit margin with our easy-to-use calculator. Understand your business's profitability with clear formulas and examples.",
"url": "https://calcdomain.com/profit-margin-calculator.html",
"inLanguage": "en",
"author": { "@type": "Person", "name": "Ugo Candido" },
"publisher": { "@type": "Organization", "name": "CalcDomain" }
}
</script>
<script type="application/ld+json">
{
"@context": "https://schema.org",
"@type": "BreadcrumbList",
"itemListElement": [
{ "@type": "ListItem", "position": 1, "name": "Home", "item": "https://calcdomain.com/" },
{ "@type": "ListItem", "position": 2, "name": "Finance", "item": "https://calcdomain.com/finance.html" },
{ "@type": "ListItem", "position": 3, "name": "Business & Small Biz", "item": "https://calcdomain.com/subcategories/business-small-biz.html" },
{ "@type": "ListItem", "position": 4, "name": "Profit Margin Calculator", "item": "https://calcdomain.com/profit-margin-calculator.html" }
]
}
</script>
<script type="application/ld+json">
{
"@context": "https://schema.org",
"@type": "HowTo",
"name": "How to Calculate Profit Margin",
"description": "A step-by-step guide to calculating your business's gross, operating, and net profit margin.",
"step": [
{"@type": "HowToStep", "name": "Enter Total Revenue", "text": "Input your total revenue or sales from the period you are measuring."},
{"@type": "HowToStep", "name": "Enter Costs", "text": "Input your Cost of Goods Sold (COGS) and, optionally, your operating expenses, interest, and taxes."},
{"@type": "HowToStep", "name": "Calculate", "text": "The calculator will automatically compute your profit amounts and margin percentages."},
{"@type": "HowToStep", "name": "Review Results", "text": "See your Gross, Operating, and Net Profit Margins, along with a visual breakdown of your revenue."}
]
}
</script>
<script src="search.js" defer></script>
</head>
<body class="bg-gray-50 text-gray-900">

<header class="bg-white shadow-sm">
<nav class="container mx-auto px-4 lg:px-6 py-4">
<div class="flex justify-between items-center">
<a href="index.html" class="text-2xl font-bold text-blue-600">CalcDomain</a>

<div class="w-full max-w-md hidden md:block mx-8">
<div class="relative">
<input type="search" id="search-input" placeholder="Search for a calculator..."
class="w-full py-2 px-4 pr-12 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
autocomplete="off">
<svg class="w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"
fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
</svg>
<div id="search-results" class="absolute top-full left-0 right-0 hidden bg-white border border-gray-200 rounded-lg shadow-lg mt-2 max-h-96 overflow-y-auto z-50"></div>
</div>
</div>

<div class="hidden md:flex items-center space-x-6 text-sm">
<a href="search.html" class="text-gray-700 hover:text-blue-600">Advanced Search</a>
<a href="index.html#categories" class="text-gray-700 hover:text-blue-600">Categories</a>
</div>

<button id="mobile-menu-toggle" class="md:hidden p-2" aria-label="Open menu">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
d="M4 6h16M4 12h16M4 18h16"></path>
</svg>
</button>
</div>

<div id="mobile-menu" class="md:hidden mt-4 hidden">
<div class="space-y-2">
<a href="search.html" class="block py-2 text-gray-700 hover:text-blue-600">Advanced Search</a>
<a href="index.html#categories" class="block py-2 text-gray-700 hover:text-blue-600">Categories</a>
</div>
</div>
</nav>
</header>

<main class="container mx-auto px-4 lg:px-6 py-10">
<div class="flex flex-col lg:flex-row gap-8">

<section class="w-full lg:w-2/3">
<nav class="text-sm text-gray-600 mb-4" aria-label="Breadcrumb">
<a href="index.html" class="hover:text-blue-600">Home</a> &raquo;
<a href="finance.html" class="hover:text-blue-600">Finance</a> &raquo;
<a href="subcategories/business-small-biz.html" class="hover:text-blue-600">Business & Small Biz</a> &raquo;
<span class="text-gray-900">Profit Margin Calculator</span>
</nav>

<div id="print-section">
<div class="bg-white p-6 rounded-lg shadow-md">
<h1 class="text-3xl font-extrabold text-gray-900 mb-2">Profit Margin Calculator</h1>
<p class="text-gray-600 mb-6">Quickly determine your business's profitability. This calculator helps you find your <strong>gross, operating, and net profit margin</strong> by entering your revenue and costs. Ideal for small business owners, financial analysts, and entrepreneurs.</p>

<form id="margin-form" class="space-y-6">
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">

<div>
<div class="flex items-center justify-between">
<label for="revenue" class="block text-sm font-medium text-gray-700">Total Revenue <span class="text-red-600">*</span></label>
<button type="button" class="tooltip-btn" aria-expanded="false" aria-controls="revenue-tooltip" title="What is revenue?">?</button>
</div>
<div class="relative">
<input type="number" id="revenue" value="50000" step="100" min="0"
class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
aria-required="true" aria-describedby="revenue-error revenue-tooltip">
<div id="revenue-tooltip" class="tooltip-text" role="tooltip">Your total income from sales before any costs are deducted.</div>
</div>
<div id="revenue-error" class="error-message" role="alert"></div>
</div>

<div>
<div class="flex items-center justify-between">
<label for="cogs" class="block text-sm font-medium text-gray-700">Cost of Goods Sold (COGS) <span class="text-red-600">*</span></label>
<button type="button" class="tooltip-btn" aria-expanded="false" aria-controls="cogs-tooltip" title="What is COGS?">?</button>
</div>
<div class="relative">
<input type="number" id="cogs" value="20000" step="100" min="0"
class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
aria-required="true" aria-describedby="cogs-error cogs-tooltip">
<div id="cogs-tooltip" class="tooltip-text" role="tooltip">The direct costs of producing your goods, like raw materials and direct labor.</div>
</div>
<div id="cogs-error" class="error-message" role="alert"></div>
</div>

<div>
<div class="flex items-center justify-between">
<label for="opex" class="block text-sm font-medium text-gray-700">Operating Expenses</label>
<button type="button" class="tooltip-btn" aria-expanded="false" aria-controls="opex-tooltip" title="What are Operating Expenses?">?</button>
</div>
<div class="relative">
<input type="number" id="opex" value="15000" step="100" min="0"
class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
aria-describedby="opex-tooltip">
<div id="opex-tooltip" class="tooltip-text" role="tooltip">Indirect costs not related to production, such as rent, marketing, and office salaries.</div>
</div>
</div>

<div>
<div class="flex items-center justify-between">
<label for="taxes" class="block text-sm font-medium text-gray-700">Interest & Taxes</label>
<button type="button" class="tooltip-btn" aria-expanded="false" aria-controls="taxes-tooltip" title="What is Interest & Taxes?">?</button>
</div>
<div class="relative">
<input type="number" id="taxes" value="5000" step="100" min="0"
class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
aria-describedby="taxes-tooltip">
<div id="taxes-tooltip" class="tooltip-text" role="tooltip">Costs related to debt (interest) and government levies (taxes).</div>
</div>
</div>
</div>

<div class="flex items-center gap-4 pt-4">
<button type="submit"
class="py-2.5 px-5 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
Calculate
</button>
<button type="reset"
class="py-2.5 px-5 bg-gray-200 text-gray-700 font-medium rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">
Clear All
</button>
</div>
</form>
</div>

<section id="results" class="mt-8 bg-blue-50 border border-blue-100 rounded-lg p-6 min-h-[420px]" aria-live="polite" tabindex="-1">
<div class="flex flex-col md:flex-row gap-6">
<div class="w-full md:w-2/3 grid grid-cols-1 sm:grid-cols-3 gap-4">
<div class="result-card">
<h4>Gross Margin</h4>
<p id="gross-margin-percent">0.00%</p>
</div>
<div class="result-card">
<h4>Operating Margin</h4>
<p id="operating-margin-percent">0.00%</p>
</div>
<div class="result-card">
<h4>Net Margin</h4>
<p id="net-margin-percent">0.00%</p>
</div>
<div class="result-card">
<h4>Gross Profit</h4>
<p id="gross-profit-amount">$0.00</p>
</div>
<div class="result-card">
<h4>Operating Profit</h4>
<p id="operating-profit-amount">$0.00</p>
</div>
<div class="result-card">
<h4>Net Profit</h4>
<p id="net-profit-amount">$0.00</p>
</div>
</div>
<div class="w-full md:w-1/3">
<h3 class="text-center font-semibold text-gray-700 mb-2">Revenue Breakdown</h3>
<div id="results-chart-container" class="h-48">
<canvas id="resultsChart" aria-label="Breakdown of revenue into costs and profit"></canvas>
</div>
</div>
</div>
</section>
</div><article class="bg-white p-6 rounded-lg shadow-md mt-8 prose">
<section>
<h2>Data Source and Methodology</h2>
<p>Calculations are based on standard financial accounting principles as outlined in foundational texts like "Financial Accounting: An Introduction to Concepts, Methods and Uses" by Clyde P. Stickney and Roman L. Weil. All formulas strictly adhere to Generally Accepted Accounting Principles (GAAP) for profitability analysis.</p>
<p><strong>Authoritative Source:</strong> Stickney, C. P., & Weil, R. L. (2007). <em>Financial Accounting: An Introduction to Concepts, Methods and Uses.</em> Thomson South-Western.</p>
<p>All calculations are based rigorously on the formulas and data provided by this source.</p>
</section>

<section>
<h2>The Formulas Explained</h2>
<p>This calculator uses three core formulas to determine profitability at different stages.</p>

<h3>1. Gross Profit Margin</h3>
<p>This shows the profit left after paying for the direct costs of producing your product (COGS). A high gross margin means you are efficient at producing and pricing your product.</p>
<div class="formula-box">
$$ \text{Gross Profit} = \text{Revenue} - \text{COGS} $$
$$ \text{Gross Margin} = \left( \frac{\text{Gross Profit}}{\text{Revenue}} \right) \times 100 $$
</div>

<h3>2. Operating Profit Margin</h3>
<p>This shows the profit from your core business operations, after both direct costs (COGS) and indirect costs (Operating Expenses) are paid. It's a key indicator of your company's operational efficiency.</p>
<div class="formula-box">
$$ \text{Operating Profit} = \text{Gross Profit} - \text{Operating Expenses} $$
$$ \text{Operating Margin} = \left( \frac{\text{Operating Profit}}{\text{Revenue}} \right) \times 100 $$
</div>

<h3>3. Net Profit Margin</h3>
<p>This is the "bottom line"—the percentage of revenue remaining after all expenses, including interest and taxes, have been deducted. It represents the final profitability of the business.</p>
<div class="formula-box">
$$ \text{Net Profit} = \text{Operating Profit} - \text{Interest & Taxes} $$
$$ \text{Net Margin} = \left( \frac{\text{Net Profit}}{\text{Revenue}} \right) \times 100 $$
</div>
</section>

<section>
<h2>Glossary of Variables</h2>
<ul>
<li><strong>Total Revenue:</strong> The total amount of money generated from sales of goods or services. Also known as "top line" or "sales."</li>
<li><strong>Cost of Goods Sold (COGS):</strong> The direct costs attributable to the production of the goods sold. This includes raw materials and direct labor.</li>
<li><strong>Operating Expenses (Opex):</strong> The indirect costs of running a business, such as rent, utilities, marketing, and administrative salaries. These are not directly tied to production.</li>
<li><strong>Interest & Taxes:</strong> Includes interest paid on debt and corporate income taxes owed to the government.</li>
<li><strong>Gross Profit:</strong> The profit remaining after subtracting COGS from Revenue.</li>
<li><strong>Operating Profit:</strong> The profit remaining after subtracting COGS and Opex from Revenue. Also known as EBIT (Earnings Before Interest and Taxes).</li>
<li><strong>Net Profit:</strong> The final profit remaining after all costs and expenses (COGS, Opex, Interest, and Taxes) have been subtracted. Also known as "net income."</li>
</ul>
</section>

<section>
<h2>How It Works: A Step-by-Step Example</h2>
<p>Let's calculate the profit margins for a small coffee shop in one month.</p>
<p><strong>Inputs:</strong></p>
<ul>
<li><strong>Total Revenue:</strong> $50,000</li>
<li><strong>Cost of Goods Sold (COGS):</strong> $20,000 (coffee beans, milk, cups)</li>
<li><strong>Operating Expenses:</strong> $15,000 (rent, barista salaries, utilities)</li>
<li><strong>Interest & Taxes:</strong> $5,000 (loan interest, taxes)</li>
</ul>

<p><strong>Step 1: Calculate Gross Profit & Margin</strong></p>
<ul>
<li>Gross Profit = $50,000 (Revenue) - $20,000 (COGS) = <strong>$30,000</strong></li>
<li>Gross Margin = ($30,000 / $50,000) &times; 100 = <strong>60%</strong></li>
</ul>

<p><strong>Step 2: Calculate Operating Profit & Margin</strong></p>
<ul>
<li>Operating Profit = $30,000 (Gross Profit) - $15,000 (Opex) = <strong>$15,000</strong></li>
<li>Operating Margin = ($15,000 / $50,000) &times; 100 = <strong>30%</strong></li>
</ul>

<p><strong>Step 3: Calculate Net Profit & Margin</strong></p>
<ul>
<li>Net Profit = $15,000 (Operating Profit) - $5,000 (Interest/Taxes) = <strong>$10,000</strong></li>
<li>Net Margin = ($10,000 / $50,000) &times; 100 = <strong>20%</strong></li>
</ul>
<p>The shop's net profit margin is 20%, meaning for every dollar of coffee sold, it keeps 20 cents as pure profit.</p>
</section>

<section>
<h2>Frequently Asked Questions (FAQ)</h2>
<details>
<summary>What is the difference between profit margin and markup?</summary>
<p>Margin is profit as a percentage of <strong>revenue</strong> (the sale price). Markup is profit as a percentage of <strong>cost</strong>. For example, if you buy a product for $50 (cost) and sell it for $100 (revenue), your profit is $50. Your <strong>margin</strong> is ($50 / $100) = 50%, but your <strong>markup</strong> is ($50 / $50) = 100%.</p>
</details>
<details>
<summary>What is a "good" profit margin?</summary>
<p>A "good" margin varies dramatically by industry. Retail and grocery may have very low net margins (1-5%), while software and digital products can have very high margins (20-40%+). It's best to benchmark your margin against your specific industry average.</p>
</details>
<details>
<summary>How can I improve my profit margin?</summary>
<p>You can improve your margin by:
<ol>
<li><strong>Increasing prices:</strong> Raising your sale price without increasing costs.</li>
<li><strong>Reducing COGS:</strong> Finding cheaper suppliers for raw materials or improving production efficiency.</li>
<li><strong>Controlling Operating Expenses:</strong> Reducing indirect costs like rent, marketing spend, or administrative overhead.</li>
</ol>
</p>
</details>
<details>
<summary>Why is my operating margin different from my net margin?</summary>
<p>Your operating margin shows the profitability of your core business activities. Your net margin shows the final profit after non-operating expenses, primarily interest on debt and taxes, are paid. A large difference indicates that your business has significant debt payments or a high tax burden.</p>
</details>
<details>
<summary>Does this calculator work for service-based businesses?</summary>
<p>Yes. For a service business, your "COGS" is typically the direct cost of providing that service (e.g., contractor fees, software subscriptions essential to the service, or direct labor costs). Your Operating Expenses would be your rent, marketing, administrative salaries, etc.</p>
</details>
</section>

<div class="mt-8 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600">
<p><strong>Tool developed by Ugo Candido.</strong> Finance content reviewed by the CalcDomain Editorial Board.<br>
Last accuracy review: <time datetime="2025-10-15">October 15, 2025</time></p>
</div>
</article>
</section>

<aside class="w-full lg:w-1/3">
<div class="sticky top-24 space-y-6">
<div class="bg-gray-200 h-72 rounded-lg flex items-center justify-center text-gray-500">
Ad Placement (300×600)
</div>
<div class="bg-white p-6 rounded-lg shadow-md">
<h3 class="font-bold text-lg mb-3">Why use this calculator</h3>
<ul class="list-disc list-inside text-sm text-gray-600 space-y-2">
<li>Get a complete picture with Gross, Operating, and Net margins.</li>
<li>Visualize your revenue breakdown instantly with the profit chart.</li>
<li>Understand complex terms with built-in accessible tooltips.</li>
<li>Make informed business decisions based on clear, actionable data.</li>
</ul>
</div>
<div class="bg-white p-6 rounded-lg shadow-md">
<h3 class="font-bold text-lg mb-4">Related Business Tools</h3>
<ul class="space-y-3 text-sm">
<li><a href="markup-calculator.html" class="text-blue-600 hover:underline">Markup Calculator</a></li>
<li><a href="break-even-point-calculator.html" class="text-blue-600 hover:underline">Break-Even Point Calculator</a></li>
<li><a href="roi-calculator.html" class="text-blue-600 hover:underline">ROI Calculator</a></li>
<li><a href="inventory-turnover-ratio.html" class="text-blue-600 hover:underline">Inventory Turnover Ratio</a></li>
</ul>
</div>
</div>
</aside>
</div>
</main>

<footer class="bg-white border-t mt-12">
<div class="container mx-auto px-6 py-8 text-center text-gray-600 text-sm">
<p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
<div class="mt-4 space-x-4">
<a href="about.html" class="hover:text-blue-600">About</a>
<a href="contact.html" class="hover:text-blue-600">Contact</a>
<a href="privacy.html" class="hover:text-blue-600">Privacy</a>
<a href="terms.html" class="hover:text-blue-600">Terms</a>
</div>
</div>
</footer>

<script defer>
document.addEventListener('DOMContentLoaded', () => {
// --- Element References ---
const marginForm = document.getElementById('margin-form');
const revenueInput = document.getElementById('revenue');
const cogsInput = document.getElementById('cogs');
const opexInput = document.getElementById('opex');
const taxesInput = document.getElementById('taxes');
const tooltipButtons = document.querySelectorAll('.tooltip-btn');
const resultsSection = document.getElementById('results');

// Result display elements
const grossMarginPercentEl = document.getElementById('gross-margin-percent');
const operatingMarginPercentEl = document.getElementById('operating-margin-percent');
const netMarginPercentEl = document.getElementById('net-margin-percent');
const grossProfitAmountEl = document.getElementById('gross-profit-amount');
const operatingProfitAmountEl = document.getElementById('operating-profit-amount');
const netProfitAmountEl = document.getElementById('net-profit-amount');

// Error message elements
const revenueErrorEl = document.getElementById('revenue-error');
const cogsErrorEl = document.getElementById('cogs-error');

let chartInstance = null;

// --- Formatters ---
const fmtCurrency = (val) => new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format(val || 0);
const fmtPercent = (val) => (val || 0).toLocaleString(undefined, { style: 'percent', minimumFractionDigits: 2 });

// --- Helper Functions ---

/**
* Displays an error message for a specific field.
* @param {HTMLElement} el - The error message element.
* @param {HTMLElement} inputEl - The input element to mark as invalid.
* @param {string} message - The error message to display.
*/
function showError(el, inputEl, message) {
el.textContent = message;
inputEl.setAttribute('aria-invalid', 'true');
inputEl.classList.add('border-red-600', 'focus:border-red-600', 'focus:ring-red-600');
}

/**
* Clears all error messages and invalid states.
*/
function clearErrors() {
revenueErrorEl.textContent = '';
cogsErrorEl.textContent = '';
[revenueInput, cogsInput].forEach(input => {
input.setAttribute('aria-invalid', 'false');
input.classList.remove('border-red-600', 'focus:border-red-600', 'focus:ring-red-600');
input.classList.add('border-gray-300', 'focus:border-blue-500', 'focus:ring-blue-500');
});
}

/**
* Toggles the visibility of an accessible tooltip.
* @param {Event} e - The click event.
*/
function toggleTooltip(e) {
const btn = e.currentTarget;
const isExpanded = btn.getAttribute('aria-expanded') === 'true';
const tooltipId = btn.getAttribute('aria-controls');
const tooltip = document.getElementById(tooltipId);

if (!tooltip) return;

// Hide all other open tooltips
tooltipButtons.forEach(b => {
if (b !== btn) {
b.setAttribute('aria-expanded', 'false');
const otherTooltip = document.getElementById(b.getAttribute('aria-controls'));
if (otherTooltip) otherTooltip.style.display = 'none';
}
});

// Toggle the current one
if (isExpanded) {
btn.setAttribute('aria-expanded', 'false');
tooltip.style.display = 'none';
} else {
btn.setAttribute('aria-expanded', 'true');
tooltip.style.display = 'block';
}
}

// --- Main Calculation ---

function calculateMargins(e) {
if (e) e.preventDefault();
clearErrors();

// 1. Parse Inputs
const revenue = parseFloat(revenueInput.value) || 0;
const cogs = parseFloat(cogsInput.value) || 0;
const opex = parseFloat(opexInput.value) || 0;
const taxes = parseFloat(taxesInput.value) || 0;

// 2. Validate Inputs
let isValid = true;
if (revenue <= 0) {
showError(revenueErrorEl, revenueInput, 'Revenue must be a positive number.');
isValid = false;
}
if (cogs < 0) {
showError(cogsErrorEl, cogsInput, 'COGS cannot be negative.');
isValid = false;
}
if (cogs > revenue && revenue > 0) {
showError(cogsErrorEl, cogsInput, 'COGS cannot be greater than Revenue.');
isValid = false;
}

if (!isValid) {
// Reset results if validation fails
updateDOM(0, 0, 0, 0, 0, 0);
updateChart(0, 0, 0, 0, 0);
return;
}

// 3. Perform Calculations
const grossProfit = revenue - cogs;
const grossMargin = (revenue > 0) ? (grossProfit / revenue) : 0;

const operatingProfit = grossProfit - opex;
const operatingMargin = (revenue > 0) ? (operatingProfit / revenue) : 0;

const netProfit = operatingProfit - taxes;
const netMargin = (revenue > 0) ? (netProfit / revenue) : 0;

// 4. Update DOM
updateDOM(grossMargin, operatingMargin, netMargin, grossProfit, operatingProfit, netProfit);

// 5. Update Chart
// Ensure chart values are non-negative
const chartNetProfit = Math.max(0, netProfit);
const chartTaxes = Math.max(0, taxes);
const chartOpex = Math.max(0, opex);
const chartCogs = Math.max(0, cogs);
// 'Other' accounts for any remaining portion if profits are negative
const chartOther = Math.max(0, revenue - chartNetProfit - chartTaxes - chartOpex - chartCogs);

updateChart(chartCogs, chartOpex, chartTaxes, chartNetProfit, chartOther);

// 6. Focus results for A11y
resultsSection.focus();
}

/**
* Updates the 6 result cards in the DOM.
*/
function updateDOM(grossMargin, opMargin, netMargin, grossProfit, opProfit, netProfit) {
grossMarginPercentEl.textContent = fmtPercent(grossMargin);
operatingMarginPercentEl.textContent = fmtPercent(opMargin);
netMarginPercentEl.textContent = fmtPercent(netMargin);
grossProfitAmountEl.textContent = fmtCurrency(grossProfit);
operatingProfitAmountEl.textContent = fmtCurrency(opProfit);
netProfitAmountEl.textContent = fmtCurrency(netProfit);
}

/**
* Renders or updates the results chart.
*/
function updateChart(cogs, opex, taxes, netProfit, other) {
const ctx = document.getElementById('resultsChart');
if (!ctx) return;

const data = {
labels: ['COGS', 'Operating Expenses', 'Interest & Taxes', 'Net Profit', 'Other Costs/Loss'],
datasets: [{
data: [cogs, opex, taxes, netProfit, other],
backgroundColor: ['#f97316', '#eab308', '#f43f5e', '#2563eb', '#9ca3af'],
hoverOffset: 4
}]
};

const options = {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: {
position: 'bottom',
labels: {
padding: 15,
boxWidth: 12
}
},
tooltip: {
callbacks: {
label: function(context) {
let label = context.label || '';
let value = context.parsed;
return `${label}: ${fmtCurrency(value)}`;
}
}
}
}
};

if (chartInstance) {
chartInstance.data = data;
chartInstance.update();
} else {
chartInstance = new Chart(ctx, {
type: 'doughnut',
data: data,
options: options
});
}
}

/**
* Resets the form and results.
*/
function resetCalculator() {
clearErrors();
updateDOM(0, 0, 0, 0, 0, 0);
updateChart(0, 0, 0, 0, 0);
// Hide all tooltips
tooltipButtons.forEach(b => {
b.setAttribute('aria-expanded', 'false');
const tooltip = document.getElementById(b.getAttribute('aria-controls'));
if (tooltip) tooltip.style.display = 'none';
});
}

// --- Event Listeners ---
marginForm.addEventListener('submit', calculateMargins);
marginForm.addEventListener('reset', resetCalculator);
tooltipButtons.forEach(btn => btn.addEventListener('click', toggleTooltip));

// Add blur validation for WCAG
revenueInput.addEventListener('blur', () => {
if (parseFloat(revenueInput.value) <= 0) {
showError(revenueErrorEl, revenueInput, 'Revenue must be a positive number.');
} else {
clearErrors(); // Clear only its own error
}
});
cogsInput.addEventListener('blur', () => {
if (parseFloat(cogsInput.value) < 0) {
showError(cogsErrorEl, cogsInput, 'COGS cannot be negative.');
} else {
clearErrors(); // Clear only its own error
}
});

// Initial calculation on page load with default values
calculateMargins();

// Render LaTeX formulas
try {
renderMathInElement(document.body, {
delimiters: [
{left: '$$', right: '$$', display: true},
{left: '$', right: '$', display: false}
]
});
} catch (e) {
console.error('KaTeX rendering failed: ', e);
}
});

// Mobile menu toggle logic
document.getElementById('mobile-menu-toggle').addEventListener('click', function() {
document.getElementById('mobile-menu').classList.toggle('hidden');
});
</script>
</body>
</html>