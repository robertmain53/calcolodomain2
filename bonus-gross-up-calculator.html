<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bonus Gross Up Calculator</title>
  <meta name="description" content="Gross-up a bonus to ensure your employee receives the exact net amount. Handles federal supplemental rate, state/local withholding, Social Security cap, and Additional Medicare tax." />
  <link rel="canonical" href="https://calcdomain.com/bonus-gross-up-calculator.html" />
  <meta name="author" content="Ugo Candido" />

  <!-- Icons -->
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- MathJax for LaTeX rendering -->
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <!-- Fonts & Base Styles -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: light; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .prose { max-width: 70ch; }
    .prose h2 { font-size: 1.5rem; font-weight: 700; margin-top: 2rem; margin-bottom: 0.75rem; }
    .prose h3 { font-size: 1.125rem; font-weight: 700; margin-top: 1.25rem; margin-bottom: 0.5rem; }
    .formula-box {
      background:#f3f4f6; border:1px solid #e5e7eb; border-radius:12px; padding:1rem; overflow-x:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    .result-card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:1rem; text-align:center; }
    .result-card h4 { font-size:.95rem; color:#4b5563; margin-bottom:.25rem; }
    .result-card p  { font-size:1.5rem; font-weight:800; color:#1d4ed8; }
    /* Focus visible for all interactive controls */
    :where(button, [role="button"], a, input, select, summary, details, [tabindex]):focus-visible {
      outline: 3px solid #2563eb; outline-offset: 2px; border-radius: 8px;
    }
    /* Reserve space to prevent CLS in results */
    #results-container { min-height: 420px; }
    /* Touch target */
    .tap-target { min-height:48px; min-width:48px; }
    /* Print */
    @media print {
      body * { visibility: hidden; }
      #print-section, #print-section * { visibility: visible; }
      #print-section { position: absolute; left:0; top:0; width:100%; }
      #resultsChart { display:none !important; }
    }
  </style>

  <!-- JSON-LD: WebPage -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"Bonus Gross Up Calculator",
    "url":"https://calcdomain.com/bonus-gross-up-calculator.html",
    "inLanguage":"en",
    "description":"Gross-up a bonus so the employee receives the exact net amount after taxes. Supports federal supplemental rate, state/local tax, Social Security cap, and Additional Medicare tax.",
    "author":{"@type":"Person","name":"Ugo Candido"},
    "publisher":{"@type":"Organization","name":"CalcDomain"}
  }
  </script>

  <!-- JSON-LD: Breadcrumbs -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://calcdomain.com/"},
      {"@type":"ListItem","position":2,"name":"Finance","item":"https://calcdomain.com/finance.html"},
      {"@type":"ListItem","position":3,"name":"Business Small Biz","item":"https://calcdomain.com/subcategories/finance-business-small-biz.html"},
      {"@type":"ListItem","position":4,"name":"Bonus Gross Up Calculator","item":"https://calcdomain.com/bonus-gross-up-calculator.html"}
    ]
  }
  </script>

  <!-- JSON-LD: HowTo -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"HowTo",
    "name":"How to Gross-Up a Bonus",
    "step":[
      {"@type":"HowToStep","name":"Enter target net bonus","text":"Type the exact net amount the employee should take home."},
      {"@type":"HowToStep","name":"Choose withholding rates","text":"Set federal supplemental rate and add state/local withholding."},
      {"@type":"HowToStep","name":"Add FICA details","text":"Toggle Social Security and Medicare. Provide YTD wages to handle the wage base cap and Additional Medicare."},
      {"@type":"HowToStep","name":"Calculate","text":"The calculator solves for gross using a numerical method that respects caps and thresholds."},
      {"@type":"HowToStep","name":"Review breakdown","text":"See gross pay, total taxes by type, and the effective rate."}
    ]
  }
  </script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header (non-sticky per spec) -->
  <header class="bg-white border-b">
    <div class="container mx-auto px-4 lg:px-6 py-4 flex items-center justify-between">
      <a href="index.html" class="text-2xl font-extrabold text-blue-600">CalcDomain</a>
      <nav class="hidden md:flex gap-6 text-sm">
        <a class="hover:text-blue-600" href="search.html">Search</a>
        <a class="hover:text-blue-600" href="index.html#categories">Categories</a>
      </nav>
      <a class="md:hidden text-sm hover:text-blue-600" href="search.html">Search</a>
    </div>
  </header>

  <main class="container mx-auto px-4 lg:px-6 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Main Column -->
      <section class="w-full lg:w-2/3">
        <nav aria-label="Breadcrumb" class="text-sm text-gray-600 mb-4">
          <a href="index.html" class="hover:text-blue-600">Home</a> &raquo;
          <a href="finance.html" class="hover:text-blue-600">Finance</a> &raquo;
          <a href="subcategories/finance-business-small-biz.html" class="hover:text-blue-600">Business Small Biz</a> &raquo;
          <span class="text-gray-900">Bonus Gross Up Calculator</span>
        </nav>

        <div id="print-section" class="bg-white rounded-xl shadow p-6">
          <h1 class="text-3xl font-extrabold mb-2">Bonus Gross Up Calculator</h1>
          <p class="text-gray-700 mb-6">Ensure your employee receives a precise <em>net</em> bonus by grossing up for taxes. This tool supports the federal supplemental rate method, adds state and local withholding, and correctly handles Social Security’s wage base cap and the Additional Medicare surtax.</p>

          <!-- Calculator UI -->
          <section id="calculator-ui" class="space-y-6" aria-labelledby="calcHeading">
            <h2 id="calcHeading" class="sr-only">Calculator Inputs</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Net target -->
              <div>
                <label for="netTarget" class="block text-sm font-medium text-gray-900">Target Net Bonus (USD) * </label>
                <div class="mt-1 relative">
                  <input type="number" inputmode="decimal" id="netTarget" aria-required="true"
                         class="tap-target w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                         min="0" step="0.01" value="2500" aria-describedby="netTargetHelp netTargetErr">
                  <button type="button" class="tap-target absolute right-2 top-1/2 -translate-y-1/2 text-gray-500"
                          aria-label="What is Target Net Bonus?" data-tooltip-target="netTargetHelp">?</button>
                </div>
                <p id="netTargetHelp" class="text-xs text-gray-600 mt-1">Exact take-home amount the employee should receive after all selected withholdings.</p>
                <p id="netTargetErr" class="text-sm text-red-600 mt-1 hidden"></p>
              </div>

              <!-- Federal supplemental rate -->
              <div>
                <label for="fedRate" class="block text-sm font-medium text-gray-900">Federal Supplemental Rate (%) * </label>
                <div class="mt-1 relative">
                  <input type="number" inputmode="decimal" id="fedRate" aria-required="true"
                         class="tap-target w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                         min="0" max="100" step="0.01" value="22" aria-describedby="fedRateHelp fedRateErr">
                  <button type="button" class="tap-target absolute right-2 top-1/2 -translate-y-1/2 text-gray-500"
                          aria-label="About federal supplemental rate" data-tooltip-target="fedRateHelp">?</button>
                </div>
                <p id="fedRateHelp" class="text-xs text-gray-600 mt-1">Flat supplemental wage withholding rate for bonuses (commonly 22% up to $1M; higher above).</p>
                <p id="fedRateErr" class="text-sm text-red-600 mt-1 hidden"></p>
              </div>

              <!-- State rate -->
              <div>
                <label for="stateRate" class="block text-sm font-medium text-gray-900">State Withholding (%)</label>
                <input type="number" inputmode="decimal" id="stateRate"
                       class="tap-target mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                       min="0" max="100" step="0.01" value="5" aria-describedby="stateRateErr">
                <p id="stateRateErr" class="text-sm text-red-600 mt-1 hidden"></p>
              </div>

              <!-- Local rate -->
              <div>
                <label for="localRate" class="block text-sm font-medium text-gray-900">Local / Other (%)</label>
                <input type="number" inputmode="decimal" id="localRate"
                       class="tap-target mt-1 w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                       min="0" max="100" step="0.01" value="0" aria-describedby="localRateErr">
                <p id="localRateErr" class="text-sm text-red-600 mt-1 hidden"></p>
              </div>

              <!-- FICA toggle -->
              <div class="md:col-span-2">
                <div class="flex items-start gap-3">
                  <input id="includeFica" type="checkbox" class="tap-target mt-1 h-5 w-5 border-gray-300 rounded"
                         aria-describedby="ficaHelp" checked>
                  <div>
                    <label for="includeFica" class="text-sm font-medium text-gray-900">Include FICA (Social Security & Medicare)</label>
                    <p id="ficaHelp" class="text-xs text-gray-600">Social Security 6.2% (up to wage base) + Medicare 1.45% + Additional 0.9% on wages over $200,000 (withholding threshold).</p>
                  </div>
                </div>
              </div>

              <!-- YTD & caps -->
              <div>
                <label for="ytdWages" class="block text-sm font-medium text-gray-900">YTD Taxable Wages (before this bonus)</label>
                <div class="mt-1 relative">
                  <input type="number" inputmode="decimal" id="ytdWages"
                         class="tap-target w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                         min="0" step="0.01" value="120000" aria-describedby="ytdHelp ytdErr">
                  <button type="button" class="tap-target absolute right-2 top-1/2 -translate-y-1/2 text-gray-500"
                          aria-label="What counts as YTD wages?" data-tooltip-target="ytdHelp">?</button>
                </div>
                <p id="ytdHelp" class="text-xs text-gray-600 mt-1">Employee’s year-to-date Medicare/Social Security taxable wages prior to this bonus.</p>
                <p id="ytdErr" class="text-sm text-red-600 mt-1 hidden"></p>
              </div>

              <div>
                <label for="ssWageBase" class="block text-sm font-medium text-gray-900">Social Security Wage Base (USD)</label>
                <div class="mt-1 relative">
                  <input type="number" inputmode="decimal" id="ssWageBase"
                         class="tap-target w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                         min="1" step="1" value="170000" aria-describedby="ssBaseHelp ssBaseErr">
                  <button type="button" class="tap-target absolute right-2 top-1/2 -translate-y-1/2 text-gray-500"
                          aria-label="About wage base" data-tooltip-target="ssBaseHelp">?</button>
                </div>
                <p id="ssBaseHelp" class="text-xs text-gray-600 mt-1">Annual Social Security taxable wage cap. Update for the current year per SSA.</p>
                <p id="ssBaseErr" class="text-sm text-red-600 mt-1 hidden"></p>
              </div>
            </div>

            <div class="flex flex-wrap gap-3 pt-2">
              <button id="calcBtn" class="tap-target px-5 py-3 bg-blue-600 text-white font-semibold rounded-md hover:bg-blue-700 focus-visible:outline-offset-2">Calculate Gross-Up</button>
              <button id="resetBtn" class="tap-target px-5 py-3 bg-gray-100 text-gray-900 font-semibold rounded-md hover:bg-gray-200">Reset</button>
              <button id="printBtn" class="tap-target px-5 py-3 bg-white border border-gray-300 text-gray-900 font-semibold rounded-md hover:bg-gray-50">Print</button>
              <button id="copyBtn" class="tap-target px-5 py-3 bg-white border border-gray-300 text-gray-900 font-semibold rounded-md hover:bg-gray-50">Copy Results</button>
            </div>
          </section>

          <!-- Results -->
          <section id="results-container" class="mt-8" aria-labelledby="resultsHeading" aria-live="polite">
            <h2 id="resultsHeading" class="sr-only">Results</h2>

            <div class="flex flex-col md:flex-row gap-6">
              <div class="w-full md:w-2/3 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="result-card">
                  <h4>Required Gross Bonus</h4>
                  <p id="grossBonus">$0.00</p>
                </div>
                <div class="result-card">
                  <h4>Total Withholding</h4>
                  <p id="totalTax">$0.00</p>
                </div>
                <div class="result-card">
                  <h4>Effective Withholding Rate</h4>
                  <p id="effectiveRate">—</p>
                </div>
                <div class="result-card">
                  <h4>Target Net (You Entered)</h4>
                  <p id="targetNetEcho">$0.00</p>
                </div>
              </div>
              <div class="w-full md:w-1/3">
                <div class="bg-white border border-gray-200 rounded-xl p-3 h-56">
                  <canvas id="resultsChart" aria-label="Tax breakdown chart" role="img"></canvas>
                </div>
              </div>
            </div>

            <div class="mt-6 overflow-x-auto border border-gray-200 rounded-xl">
              <table class="min-w-full text-sm">
                <thead class="bg-gray-100 text-gray-700 uppercase">
                  <tr>
                    <th class="px-4 py-2 text-left">Component</th>
                    <th class="px-4 py-2 text-right">Amount (USD)</th>
                  </tr>
                </thead>
                <tbody id="breakdownBody" class="text-right">
                  <!-- filled by JS -->
                </tbody>
                <tfoot class="bg-gray-50 font-semibold">
                  <tr>
                    <td class="px-4 py-2 text-left">Total Withholding</td>
                    <td id="withholdingTotalCell" class="px-4 py-2">$0.00</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </section>
        </div>

        <!-- Authoritative content -->
        <article class="bg-white rounded-xl shadow p-6 mt-8 prose">
          <h2>Authoritative Data Source &amp; Methodology</h2>
          <p><strong>Primary references:</strong></p>
          <ul>
            <li>IRS Publication 15-T (Federal Income Tax Withholding Methods) — supplemental wage withholding rules (flat rate approach).</li>
            <li>Social Security Administration (SSA) — annual Social Security wage base (“contribution and benefit base”).</li>
          </ul>
          <p><em>Tutti i calcoli si basano rigorosamente sulle formule e sui dati forniti da questa fonte.</em> Update the Social Security wage base and verify the current federal supplemental rate at the start of each tax year.</p>

          <h2>The Formula Explained</h2>
          <p>When all withholding rates are purely proportional (no caps/thresholds), gross-up is closed-form:</p>
          <div class="formula-box">\( \displaystyle \text{Gross} = \frac{\text{Net}}{1 - (r_f + r_s + r_l + r_{fica})} \)</div>
          <p>Where \(r_f\) is the federal supplemental rate, \(r_s\) the state rate, \(r_l\) local/other, and \(r_{fica}\) the FICA rate. However, Social Security is capped at the annual wage base and Additional Medicare (0.9%) applies only to wages over \$200,000 for withholding. Because of these nonlinearities, this tool solves:</p>
          <div class="formula-box">\( \displaystyle \text{Find Gross such that } \text{Net} = \text{Gross} - W(\text{Gross}) \)</div>
          <p>by numerical search (bisection), where \(W(\cdot)\) computes federal, state, local, Social Security (capped), and Medicare (including Additional Medicare) on the candidate gross.</p>

          <h2>Glossary of Variables</h2>
          <ul>
            <li><strong>Target Net Bonus</strong>: Desired employee take-home after all selected withholdings.</li>
            <li><strong>Federal Supplemental Rate</strong>: Flat federal withholding percentage for supplemental wages (bonuses).</li>
            <li><strong>State / Local</strong>: State and local withholding rates applied to the bonus.</li>
            <li><strong>YTD Taxable Wages</strong>: Employee wages year-to-date before this bonus; determines space left under the Social Security wage base and exposure to Additional Medicare.</li>
            <li><strong>Social Security Wage Base</strong>: Maximum annual earnings subject to Social Security (6.2%).</li>
            <li><strong>Additional Medicare</strong>: Extra 0.9% withheld on wages over \$200,000 (for withholding purposes).</li>
          </ul>

          <h2>How It Works: A Step-by-Step Example</h2>
          <p><strong>Inputs:</strong> Target net = \$2,500; Federal = 22%; State = 5%; Local = 0%; Include FICA; YTD wages = \$120,000; SS wage base = \$170,000.</p>
          <ol>
            <li>The solver guesses a gross and computes withholdings:
              <ul>
                <li>Federal: \(0.22 \times \text{Gross}\)</li>
                <li>State: \(0.05 \times \text{Gross}\)</li>
                <li>Social Security: \(0.062 \times \min(\text{Gross}, \max(0, 170{,}000 - 120{,}000))\)</li>
                <li>Medicare: \(0.0145 \times \text{Gross} + 0.009 \times \max(0, 120{,}000+\text{Gross}-200{,}000)\)</li>
              </ul>
            </li>
            <li>It adjusts the gross until <code>Gross − Withholding(Gross) = 2,500</code>.</li>
            <li>The result yields the grossed-up bonus and a full tax breakdown.</li>
          </ol>

          <h2>FAQ</h2>
          <details>
            <summary>What’s the difference between “gross” and “net” bonus?</summary>
            <p><strong>Net</strong> is what the employee takes home after withholding. <strong>Gross</strong> is the pre-tax amount the employer pays. Gross-up finds the gross that delivers your required net.</p>
          </details>
          <details>
            <summary>Do I have to use the federal supplemental flat rate?</summary>
            <p>For supplemental wages (like bonuses), the IRS allows a flat supplemental rate method. Some payroll contexts use an aggregate method based on recent regular wages. This tool implements the flat-rate approach; you can approximate aggregate by adjusting the federal rate.</p>
          </details>
          <details>
            <summary>How does Social Security’s wage base affect gross-up?</summary>
            <p>Social Security (6.2%) only applies up to the annual wage base. If the bonus would exceed the remaining cap, the portion above the cap is not subject to Social Security, lowering total withholding. The solver handles this automatically using your YTD wages and the wage base value.</p>
          </details>
          <details>
            <summary>When does the Additional Medicare 0.9% apply?</summary>
            <p>For withholding, employers must withhold an extra 0.9% on wages exceeding \$200,000 in a calendar year. The tool checks whether YTD wages plus the grossed-up bonus cross that threshold.</p>
          </details>
          <details>
            <summary>Can I include other deductions (401(k), local levies)?</summary>
            <p>You can model local/other withholding with the “Local / Other (%)” field. Pre-tax benefits like 401(k) change taxable wages and aren’t included here.</p>
          </details>
          <details>
            <summary>Will this match my payroll system to the penny?</summary>
            <p>It will be very close. Minor differences can arise from employer-specific rules, rounding, pay period timing, or aggregate vs flat method.</p>
          </details>
          <details>
            <summary>Which year’s values should I use?</summary>
            <p>Always update the Social Security wage base and confirm the federal supplemental rate for the current tax year.</p>
          </details>

          <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700">
            <p><strong>Tool developed by Ugo Candido.</strong> Content verified by the CalcDomain Editorial Board.<br>
              Last accuracy review: <time datetime="2025-10-30">October 30, 2025</time></p>
          </div>
        </article>
      </section>

      <!-- Sidebar -->
      <aside class="w-full lg:w-1/3">
        <div class="sticky top-6 space-y-6">
          <div class="bg-gray-200 h-72 rounded-xl flex items-center justify-center text-gray-500">Ad Placement (300×600)</div>

          <div class="bg-white p-6 rounded-xl shadow">
            <h3 class="font-bold text-lg mb-3">Why use this gross-up tool</h3>
            <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
              <li>Handles FICA caps and Additional Medicare correctly.</li>
              <li>Flat supplemental rate method aligned with IRS rules.</li>
              <li>Clear breakdown and effective rate for documentation.</li>
            </ul>
          </div>

          <div class="bg-white p-6 rounded-xl shadow">
            <h3 class="font-bold text-lg mb-4">Related payroll tools</h3>
            <ul class="space-y-3 text-sm">
              <li><a class="text-blue-600 hover:underline" href="payroll-calculator.html">Payroll Calculator</a></li>
              <li><a class="text-blue-600 hover:underline" href="overtime-calculator.html">Overtime Calculator</a></li>
              <li><a class="text-blue-600 hover:underline" href="net-to-gross-salary-calculator.html">Net-to-Gross Salary</a></li>
              <li><a class="text-blue-600 hover:underline" href="simple-loan-calculator.html">Simple Loan Calculator</a></li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="bg-white border-t">
    <div class="container mx-auto px-6 py-8 text-center text-gray-600 text-sm">
      <p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
      <div class="mt-4 space-x-4">
        <a href="about.html" class="hover:text-blue-600">About</a>
        <a href="contact.html" class="hover:text-blue-600">Contact</a>
        <a href="privacy.html" class="hover:text-blue-600">Privacy</a>
        <a href="terms.html" class="hover:text-blue-600">Terms</a>
      </div>
    </div>
  </footer>

  <!-- Calculator Logic (defer) -->
  <script defer>
  (() => {
    const $ = (id) => document.getElementById(id);
    const els = {
      netTarget: $('netTarget'),
      fedRate: $('fedRate'),
      stateRate: $('stateRate'),
      localRate: $('localRate'),
      includeFica: $('includeFica'),
      ytdWages: $('ytdWages'),
      ssWageBase: $('ssWageBase'),
      calcBtn: $('calcBtn'),
      resetBtn: $('resetBtn'),
      printBtn: $('printBtn'),
      copyBtn: $('copyBtn'),
      grossBonus: $('grossBonus'),
      totalTax: $('totalTax'),
      effectiveRate: $('effectiveRate'),
      targetNetEcho: $('targetNetEcho'),
      breakdownBody: $('breakdownBody'),
      chartCanvas: $('resultsChart'),
      errs: {
        netTarget: $('netTargetErr'),
        fedRate: $('fedRateErr'),
        stateRate: $('stateRateErr'),
        localRate: $('localRateErr'),
        ytd: $('ytdErr'),
        ssBase: $('ssBaseErr')
      },
      helpBtns: Array.from(document.querySelectorAll('[data-tooltip-target]'))
    };

    let chartInstance = null;
    const fmtCurrency = (v) => new Intl.NumberFormat(undefined, { style: 'currency', currency: 'USD' }).format((+v)||0);
    const fmtPct = (v) => `${(v*100).toFixed(2)}%`;

    // Accessible inline validation (on blur)
    const validators = {
      netTarget: (v) => (v > 0) ? '' : 'Please enter a net amount greater than 0.',
      fedRate: (v) => (v >= 0 && v <= 100) ? '' : 'Enter a valid federal supplemental rate between 0% and 100%.',
      stateRate: (v) => (v >= 0 && v <= 100) ? '' : 'Enter a valid state rate between 0% and 100%.',
      localRate: (v) => (v >= 0 && v <= 100) ? '' : 'Enter a valid local/other rate between 0% and 100%.',
      ytdWages: (v) => (v >= 0) ? '' : 'YTD wages cannot be negative.',
      ssWageBase: (v) => (v > 0) ? '' : 'Social Security wage base must be greater than 0.'
    };

    function setError(id, msg) {
      const el = els.errs[id] || null;
      if (!el) return;
      if (msg) { el.textContent = msg; el.classList.remove('hidden'); }
      else { el.textContent = ''; el.classList.add('hidden'); }
    }

    ['netTarget','fedRate','stateRate','localRate','ytdWages','ssWageBase'].forEach(id => {
      const input = els[id] || (id==='ytdWages'?els.ytdWages:els.ssWageBase);
      input.addEventListener('blur', () => {
        const val = parseFloat(input.value || '0');
        const key = (id==='ytdWages'?'ytdWages':(id==='ssWageBase'?'ssWageBase':id));
        const msg = validators[key](val);
        setError(key.replace('Wages','').replace('ssWageBase','ssBase').replace('netTarget','netTarget'), msg);
      }, { passive: true });
    });

    // Simple tooltip toggle (click to read, click again to hide)
    els.helpBtns.forEach(btn => {
      const id = btn.getAttribute('data-tooltip-target');
      const help = $(id);
      btn.addEventListener('click', () => {
        if (!help) return;
        const isHidden = help.getAttribute('data-hidden') === 'true';
        help.style.display = isHidden ? '' : '';
        help.setAttribute('data-hidden', isHidden ? 'false' : 'true');
        // shift focus to help for SR users optionally
      }, { passive: true });
      help?.setAttribute('data-hidden','false');
    });

    // Withholding calculator given a candidate gross
    function withholding(gross, params) {
      const { fed, state, local, includeFica, ytd, ssBase } = params;
      const federal = gross * fed;
      const stateW = gross * state;
      const localW = gross * local;

      let ss = 0, medi = 0, addMedi = 0;
      if (includeFica) {
        const ssRoom = Math.max(0, ssBase - ytd); // remaining space under cap
        const ssTaxable = Math.max(0, Math.min(gross, ssRoom));
        ss = ssTaxable * 0.062;

        medi = gross * 0.0145;
        const over200k = Math.max(0, (ytd + gross) - 200000);
        addMedi = over200k * 0.009;
      }
      return {
        federal, state: stateW, local: localW, ss, medi, addMedi,
        total: federal + stateW + localW + ss + medi + addMedi
      };
    }

    // Solve gross via bisection: find gross s.t. net = gross - withholding(gross).total
    function solveGross(targetNet, params) {
      // quick guard when no taxes
      const zeroTax = withholding(0, params).total === 0
        && withholding(100, { ...params, fed:0, state:0, local:0, includeFica:false }).total === 0;
      if (zeroTax) return targetNet;

      // Establish bounds
      let lo = targetNet;                 // at least net (if no taxes)
      let hi = Math.max(targetNet * 3, targetNet + 10000); // expand until net condition met
      const maxIter = 80;
      const eps = 0.005; // ~half cent

      function netFrom(g) { return g - withholding(g, params).total; }

      // ensure hi is high enough
      let nHi = netFrom(hi);
      while (nHi < targetNet) {
        hi *= 1.5;
        nHi = netFrom(hi);
        if (hi > 1e9) break;
      }

      for (let i=0; i<maxIter; i++) {
        const mid = (lo + hi) / 2;
        const n = netFrom(mid);
        if (Math.abs(n - targetNet) < eps) return mid;
        if (n < targetNet) lo = mid; else hi = mid;
      }
      return (lo + hi) / 2;
    }

    function calculate() {
      // Validate
      const v = {
        net: parseFloat(els.netTarget.value || '0'),
        fed: parseFloat(els.fedRate.value || '0'),
        state: parseFloat(els.stateRate.value || '0'),
        local: parseFloat(els.localRate.value || '0'),
        ytd: parseFloat(els.ytdWages.value || '0'),
        ssBase: parseFloat(els.ssWageBase.value || '0'),
        includeFica: els.includeFica.checked
      };

      const checks = [
        ['netTarget', validators.netTarget(v.net)],
        ['fedRate', validators.fedRate(v.fed)],
        ['stateRate', validators.stateRate(v.state)],
        ['localRate', validators.localRate(v.local)],
        ['ytd', validators.ytdWages(v.ytd)],
        ['ssBase', validators.ssWageBase(v.ssBase)]
      ];
      let hasErr = false;
      checks.forEach(([k,msg]) => { setError(k.replace('ssBase','ssBase'), msg); if (msg) hasErr = true; });
      if (hasErr) return;

      const params = {
        fed: v.fed / 100,
        state: v.state / 100,
        local: v.local / 100,
        includeFica: v.includeFica,
        ytd: v.ytd,
        ssBase: v.ssBase
      };

      const gross = solveGross(v.net, params);
      const w = withholding(gross, params);

      const totalTax = w.total;
      const effRate = totalTax / gross;

      // Update UI
      els.grossBonus.textContent = fmtCurrency(gross);
      els.totalTax.textContent = fmtCurrency(totalTax);
      els.effectiveRate.textContent = isFinite(effRate) ? fmtPct(effRate) : '—';
      els.targetNetEcho.textContent = fmtCurrency(v.net);

      // Breakdown table
      const rows = [
        ['Federal (supplemental)', w.federal],
        ['State', w.state],
        ['Local / Other', w.local],
        ['Social Security (6.2%)', w.ss],
        ['Medicare (1.45%)', w.medi],
        ['Additional Medicare (0.9%)', w.addMedi]
      ].filter(([,amt]) => amt > 0.0001);

      els.breakdownBody.innerHTML = rows.map(([name, amt]) => `
        <tr>
          <td class="px-4 py-2 text-left">${name}</td>
          <td class="px-4 py-2">${fmtCurrency(amt)}</td>
        </tr>
      `).join('');
      const totalCell = document.getElementById('withholdingTotalCell');
      totalCell.textContent = fmtCurrency(totalTax);

      // Chart
      const labels = rows.map(r => r[0]);
      const data = rows.map(r => r[1]);
      if (els.chartCanvas) {
        if (chartInstance) { chartInstance.destroy(); }
        chartInstance = new Chart(els.chartCanvas, {
          type: 'doughnut',
          data: { labels, datasets: [{ data }] },
          options: { plugins: { legend: { position: 'bottom' } }, responsive: true, maintainAspectRatio: false }
        });
      }
    }

    function resetForm() {
      els.netTarget.value = 2500;
      els.fedRate.value = 22;
      els.stateRate.value = 5;
      els.localRate.value = 0;
      els.includeFica.checked = true;
      els.ytdWages.value = 120000;
      els.ssWageBase.value = 170000;
      Object.keys(els.errs).forEach(k => setError(k, ''));
      calculate();
    }

    function copyResults() {
      const txt = [
        `Required Gross Bonus: ${els.grossBonus.textContent}`,
        `Target Net: ${els.targetNetEcho.textContent}`,
        `Total Withholding: ${els.totalTax.textContent}`,
        `Effective Withholding Rate: ${els.effectiveRate.textContent}`
      ].join('\n');
      navigator.clipboard?.writeText(txt);
    }

    // Bind
    els.calcBtn.addEventListener('click', calculate);
    els.resetBtn.addEventListener('click', resetForm);
    els.printBtn.addEventListener('click', () => window.print());
    els.copyBtn.addEventListener('click', copyResults);

    // Recalculate on input (responsive UX) with light debounce
    const inputs = ['netTarget','fedRate','stateRate','localRate','includeFica','ytdWages','ssWageBase'].map(k => els[k] || (k==='ytdWages'?els.ytdWages:els.ssWageBase));
    let t;
    inputs.forEach(inp => {
      inp.addEventListener('input', () => { clearTimeout(t); t = setTimeout(calculate, 120); });
      inp.addEventListener('change', calculate);
    });

    // Initial compute
    calculate();
  })();
  </script>
</body>
</html>
