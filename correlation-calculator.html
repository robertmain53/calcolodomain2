<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Correlation Calculator — Pearson r, p-value, Confidence Interval</title>
  <meta name="description" content="Compute Pearson correlation (r), R², covariance, t-test, p-value, and 95% confidence intervals. Paste paired data, get an interactive scatter plot and regression line." />
  <link rel="canonical" href="https://calcdomain.com/correlation-calculator.html" />

  <!-- Icons / Manifest -->
  <link rel="icon" type="image/png" href="https://calcdomain.com/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="https://calcdomain.com/favicon.svg" />
  <link rel="shortcut icon" href="https://calcdomain.com/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="https://calcdomain.com/apple-touch-icon.png" />
  <link rel="manifest" href="https://calcdomain.com/site.webmanifest" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com" defer></script>

  <!-- Chart.js (scatter + regression line) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>

  <!-- MathJax for LaTeX -->
  <script defer id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
          integrity="sha384-DvO9c3H7zS3m4nE5MWzJf7bQt2yY7b0Q0g5p6wT1x2GgKJwZ6p0UM2h0j8e5H9aL"
          crossorigin="anonymous"></script>

  <!-- Critical styles (focus, prose, min-heights to prevent CLS) -->
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; }
    .prose { max-width: 70ch; }
    .prose h2 { font-size: 1.5rem; font-weight: 700; margin-top: 2rem; margin-bottom: 0.75rem; }
    .prose h3 { font-size: 1.125rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem; }
    .prose p, .prose li { line-height: 1.65; }
    .formula-box { background:#f3f4f6; border:1px solid #d1d5db; border-radius:10px; padding:1rem; overflow:auto; font-family: ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .result-card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:1rem; text-align:center; }
    .result-card h4 { font-size:0.95rem; color:#4b5563; margin-bottom:0.25rem; }
    .result-card p { font-size:1.6rem; font-weight:800; color:#1d4ed8; }
    .a11y-focus:focus { outline: 3px solid #1d4ed8; outline-offset: 3px; border-radius: 6px; }
    /* Prevent CLS by reserving space */
    #results-summary { min-height: 170px; }
    #results-details { min-height: 180px; }
    #chartWrap { min-height: 260px; }
    /* Touch targets */
    button, .btn, input, select, textarea { min-height: 48px; }
    label .req { color:#b91c1c; }
    /* Table */
    th, td { border-bottom: 1px solid #e5e7eb; }
    /* Print */
    @media print {
      header, nav, aside, .no-print { display: none !important; }
      #print-section { position: static; box-shadow:none; }
    }
  </style>

  <!-- JSON-LD: WebApplication + Breadcrumbs + FAQ -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Correlation Calculator",
    "url": "https://calcdomain.com/correlation-calculator.html",
    "applicationCategory": "EducationalApplication",
    "operatingSystem": "Web",
    "description": "Compute Pearson correlation (r), R², covariance, t-statistic, p-value, and 95% CI with an interactive scatter plot and regression line.",
    "inLanguage": "en",
    "author": { "@type": "Person", "name": "Ugo Candido" },
    "publisher": { "@type": "Organization", "name": "CalcDomain" }
  }
  </script>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://calcdomain.com/"},
      {"@type":"ListItem","position":2,"name":"Math","item":"https://calcdomain.com/math.html"},
      {"@type":"ListItem","position":3,"name":"Algebra","item":"https://calcdomain.com/subcategories/core-math-algebra.html"},
      {"@type":"ListItem","position":4,"name":"Correlation Calculator","item":"https://calcdomain.com/correlation-calculator.html"}
    ]
  }
  </script>
  <script type="application/ld+json" id="faq-jsonld">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": []
  }
  </script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header (non-sticky as requested) -->
  <header class="bg-white border-b">
    <div class="container mx-auto px-4 lg:px-6 py-4 flex items-center justify-between">
      <a href="index.html" class="text-2xl font-extrabold text-blue-600 a11y-focus">CalcDomain</a>
      <nav class="hidden md:flex items-center gap-6 text-sm">
        <a href="search.html" class="hover:text-blue-700 a11y-focus">Advanced Search</a>
        <a href="index.html#categories" class="hover:text-blue-700 a11y-focus">Categories</a>
      </nav>
      <a href="search.html" class="md:hidden text-sm text-blue-600 a11y-focus">Search</a>
    </div>
  </header>

  <main class="container mx-auto px-4 lg:px-6 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <section class="w-full lg:w-2/3">
        <!-- Breadcrumb -->
        <nav class="text-sm text-gray-600 mb-4" aria-label="Breadcrumb">
          <a href="index.html" class="hover:text-blue-700 a11y-focus">Home</a> &raquo;
          <a href="math.html" class="hover:text-blue-700 a11y-focus">Math</a> &raquo;
          <a href="subcategories/core-math-algebra.html" class="hover:text-blue-700 a11y-focus">Algebra</a> &raquo;
          <span class="text-gray-900">Correlation Calculator</span>
        </nav>

        <!-- Title & Intro -->
        <div id="print-section" class="bg-white p-6 rounded-lg shadow">
          <h1 class="text-3xl font-extrabold mb-2">correlation calculator</h1>
          <p class="text-gray-700 mb-6">Paste or type paired data to compute Pearson’s correlation coefficient (<em>r</em>), coefficient of determination (<em>R²</em>), covariance, the <em>t</em>-test, two-tailed <em>p</em>-value, and 95% confidence interval via Fisher’s <em>z</em>. Built for analysts, researchers, and students who need fast, accurate, and auditable results.</p>

          <!-- Calculator UI -->
          <section aria-labelledby="calc-heading">
            <h2 id="calc-heading" class="sr-only">Correlation calculator input</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Data Entry -->
              <div>
                <label for="dataInput" class="block text-sm font-medium text-gray-800">Paired data (two columns) <span class="req" aria-hidden="true">*</span></label>
                <div class="flex items-start gap-2">
                  <textarea id="dataInput" rows="8" aria-required="true" aria-describedby="dataHelp dataError"
                    class="mt-1 block w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-600 a11y-focus"
                    placeholder="x,y pairs (comma, tab, or space separated)
10  8
12  9
13  11
15  14"></textarea>
                  <button type="button" id="dataHelpBtn" class="no-print mt-1 px-3 rounded border border-gray-300 a11y-focus"
                          aria-controls="dataHelp" aria-expanded="false" aria-label="Toggle data input help">?</button>
                </div>
                <p id="dataHelp" class="text-sm text-gray-600 mt-2 hidden">
                  Provide two columns with the same number of rows. Delimiters allowed: comma, semicolon, tab, or space. Lines starting with <code>#</code> are ignored.
                </p>
                <p id="dataError" class="text-sm text-red-700 mt-2 hidden"></p>

                <div class="mt-3 flex flex-wrap gap-2 no-print">
                  <button type="button" id="loadSample" class="px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 a11y-focus">Load sample</button>
                  <button type="button" id="clearData" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 a11y-focus">Clear</button>
                  <button type="button" id="transpose" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 a11y-focus">Transpose</button>
                </div>
              </div>

              <!-- Options -->
              <div>
                <fieldset class="border border-gray-200 rounded-lg p-4">
                  <legend class="text-sm font-semibold text-gray-800 px-1">Options</legend>

                  <div class="mt-2">
                    <label for="alpha" class="block text-sm font-medium text-gray-800">Significance level (α) <span class="req" aria-hidden="true">*</span></label>
                    <select id="alpha" aria-required="true" class="mt-1 block w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-600 a11y-focus">
                      <option value="0.05" selected>0.05 (95% CI)</option>
                      <option value="0.01">0.01 (99% CI)</option>
                      <option value="0.10">0.10 (90% CI)</option>
                    </select>
                  </div>

                  <div class="mt-3">
                    <label for="missing" class="block text-sm font-medium text-gray-800">Missing values handling</label>
                    <select id="missing" class="mt-1 block w-full p-2.5 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-600 a11y-focus" aria-describedby="missingHelp">
                      <option value="pairwise" selected>Pairwise: drop any row with a missing/invalid value</option>
                    </select>
                    <p id="missingHelp" class="text-sm text-gray-600 mt-1">Currently pairwise deletion is supported to ensure equal-length vectors.</p>
                  </div>

                  <div class="mt-4 flex gap-2">
                    <button type="button" id="calculateBtn" class="w-full px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 a11y-focus">Calculate</button>
                    <button type="button" id="downloadCSV" class="w-full px-4 py-2 rounded bg-gray-100 hover:bg-gray-200 a11y-focus">Download CSV</button>
                  </div>
                </fieldset>
              </div>
            </div>
          </section>

          <!-- Results -->
          <section class="mt-8" aria-labelledby="results-heading">
            <h2 id="results-heading" class="sr-only">Results</h2>

            <div id="results-summary" class="bg-blue-50 border border-blue-100 rounded-lg p-4">
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="result-card"><h4>n (pairs)</h4><p id="resN">—</p></div>
                <div class="result-card"><h4>Pearson r</h4><p id="resR">—</p></div>
                <div class="result-card"><h4>R²</h4><p id="resR2">—</p></div>
                <div class="result-card"><h4>p-value (two-tailed)</h4><p id="resP">—</p></div>
              </div>
            </div>

            <div id="results-details" class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="font-semibold mb-2">More statistics</h3>
                <dl class="grid grid-cols-2 gap-2 text-sm">
                  <dt class="text-gray-600">t-statistic</dt><dd id="resT" class="text-gray-900">—</dd>
                  <dt class="text-gray-600">df</dt><dd id="resDf" class="text-gray-900">—</dd>
                  <dt class="text-gray-600">Covariance</dt><dd id="resCov" class="text-gray-900">—</dd>
                  <dt class="text-gray-600">Mean (x̄)</dt><dd id="resMeanX" class="text-gray-900">—</dd>
                  <dt class="text-gray-600">Mean (ȳ)</dt><dd id="resMeanY" class="text-gray-900">—</dd>
                  <dt class="text-gray-600">SD (x)</dt><dd id="resSx" class="text-gray-900">—</dd>
                  <dt class="text-gray-600">SD (y)</dt><dd id="resSy" class="text-gray-900">—</dd>
                  <dt class="text-gray-600">95% CI r</dt><dd id="resCI" class="text-gray-900">—</dd>
                </dl>
                <div class="mt-4 flex flex-wrap gap-2 no-print">
                  <button type="button" id="copyResults" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 a11y-focus">Copy results</button>
                  <button type="button" id="resetAll" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 a11y-focus">Reset</button>
                </div>
              </div>

              <div class="bg-white border border-gray-200 rounded-lg p-4">
                <h3 class="font-semibold mb-2">Scatter plot & regression line</h3>
                <div id="chartWrap" class="h-64">
                  <canvas id="scatterChart" aria-label="Scatter plot with regression line"></canvas>
                </div>
                <div class="mt-3 text-sm text-gray-700">
                  Line: <span id="regEquation">—</span>
                </div>
                <div class="mt-3 flex gap-2 no-print">
                  <button type="button" id="downloadPNG" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 a11y-focus">Download chart (PNG)</button>
                </div>
              </div>
            </div>
          </section>

          <!-- Authoritativeness section -->
          <section class="prose mt-10">
            <h2>Data Source & Methodology</h2>
            <p><strong>AuthoritativeDataSource:</strong> NIST/SEMATECH e-Handbook of Statistical Methods (Section: <em>Correlation</em>), updated 2023. Also see Fisher, R.A. (1915) for the <em>z</em> transformation used for confidence intervals. <a class="text-blue-700 underline" href="https://itl.nist.gov/div898/handbook/" rel="nofollow">Visit source</a></p>
            <p><em>"Tutti i calcoli si basano rigorosamente sulle formule e sui dati forniti da questa fonte."</em></p>

            <h2>The formula explained</h2>
            <div class="formula-box">
\[
r=\frac{\sum_{i=1}^n (x_i-\bar{x})(y_i-\bar{y})}{\sqrt{\sum_{i=1}^n (x_i-\bar{x})^2}\sqrt{\sum_{i=1}^n (y_i-\bar{y})^2}}
\]
\[
t = r\sqrt{\frac{n-2}{1-r^2}}\quad \text{with df} = n-2
\]
\[
\text{Fisher } z = \frac{1}{2}\ln\left(\frac{1+r}{1-r}\right), \quad
\text{SE}_z = \frac{1}{\sqrt{n-3}}
\]
\[
z_\text{lower,upper} = z \pm z_{\alpha/2}\text{SE}_z \;\;\Rightarrow\;\;
r = \frac{e^{2z}-1}{e^{2z}+1}
\]
            </div>

            <h2>Glossary of variables</h2>
            <table class="w-full text-sm">
              <thead><tr><th class="text-left py-2">Symbol</th><th class="text-left">Meaning</th></tr></thead>
              <tbody>
                <tr><td><code>n</code></td><td>Number of paired observations</td></tr>
                <tr><td><code>r</code></td><td>Pearson correlation coefficient</td></tr>
                <tr><td><code>R²</code></td><td>Proportion of variance explained (<code>r²</code>)</td></tr>
                <tr><td><code>t</code></td><td>t-statistic testing H₀: r = 0 with df = n − 2</td></tr>
                <tr><td><code>p</code></td><td>Two-tailed p-value for the test above</td></tr>
                <tr><td><code>cov</code></td><td>Sample covariance of X and Y</td></tr>
                <tr><td><code>\bar{x}, \bar{y}</code></td><td>Sample means of X and Y</td></tr>
                <tr><td><code>s_x, s_y</code></td><td>Sample standard deviations of X and Y</td></tr>
              </tbody>
            </table>

            <h2>How it works: A step-by-step example</h2>
            <p>Suppose you observe pairs (X,Y) for 8 students: study hours vs. test score. After pasting the data, the tool computes <code>n</code>, means, SDs, covariance, and <code>r</code>. Then it uses <code>t = r√((n−2)/(1−r²))</code> to get a two-tailed <code>p</code>. Finally, Fisher’s <em>z</em> gives the 95% CI for <code>r</code>. The scatter plot shows the relationship and overlays the least-squares line, reported as <code>ŷ = a + b x</code>.</p>

            <h2>FAQ</h2>
            <details><summary>What’s the minimum sample size to compute r?</summary><p>You need at least 3 valid pairs to compute Pearson’s r and the associated t-test (df = n − 2).</p></details>
            <details><summary>How are missing or non-numeric rows handled?</summary><p>Rows with missing or invalid values are dropped (pairwise deletion) so both vectors remain aligned and of equal length.</p></details>
            <details><summary>Is this the same as Spearman correlation?</summary><p>No. This tool computes Pearson’s correlation on raw values. Spearman uses ranks and is robust to monotonic but non-linear relationships.</p></details>
            <details><summary>Why can r be undefined?</summary><p>If either X or Y has zero variance (all equal), the denominator is zero and r is undefined.</p></details>
            <details><summary>How is the p-value computed?</summary><p>Under H₀: r = 0, we use <code>t</code> with df = <code>n − 2</code> and the two-tailed Student’s t CDF.</p></details>
            <details><summary>What does the confidence interval mean?</summary><p>The Fisher-z interval estimates the plausible range of the population correlation given the sample size and selected confidence level.</p></details>
            <details><summary>What does R² represent here?</summary><p>R² = r², the proportion of variance in Y explained linearly by X.</p></details>

            <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700">
              <p><strong>Tool developed by Ugo Candido.</strong> Content verified by the CalcDomain Editorial Board.<br/>
              Last accuracy review: <time datetime="2025-10-25">October 25, 2025</time></p>
            </div>
          </section>
        </div>
      </section>

      <!-- Aside -->
      <aside class="w-full lg:w-1/3">
        <div class="sticky top-6 space-y-6">
          <div class="bg-gray-200 h-72 rounded-lg flex items-center justify-center text-gray-600">Ad Placement (300×600)</div>

          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-3">Why use this calculator</h3>
            <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
              <li>Professional outputs: r, R², p-value, CI, regression line.</li>
              <li>Copy/Download results and chart for reports.</li>
              <li>Accessible, mobile-first, and fast.</li>
            </ul>
          </div>

          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-4">Related math tools</h3>
            <ul class="space-y-2 text-sm">
              <li><a class="text-blue-700 hover:underline" href="linear-regression.html">Linear Regression</a></li>
              <li><a class="text-blue-700 hover:underline" href="mean-calculator.html">Mean Calculator</a></li>
              <li><a class="text-blue-700 hover:underline" href="median-calculator.html">Median Calculator</a></li>
              <li><a class="text-blue-700 hover:underline" href="standard-deviation.html">Standard Deviation</a></li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="bg-white border-t">
    <div class="container mx-auto px-6 py-8 text-center text-gray-600 text-sm">
      <p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
      <div class="mt-4 space-x-4">
        <a href="about.html" class="hover:text-blue-700 a11y-focus">About</a>
        <a href="contact.html" class="hover:text-blue-700 a11y-focus">Contact</a>
        <a href="privacy.html" class="hover:text-blue-700 a11y-focus">Privacy</a>
        <a href="terms.html" class="hover:text-blue-700 a11y-focus">Terms</a>
      </div>
    </div>
  </footer>

  <!-- Calculator Logic (defer loaded by default because placed before </body>) -->
  <script>
  // Utility: toggle hidden
  function toggleHidden(el, show) {
    el.classList[show ? 'remove' : 'add']('hidden');
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Elements
    const els = {
      dataInput: document.getElementById('dataInput'),
      dataError: document.getElementById('dataError'),
      dataHelp: document.getElementById('dataHelp'),
      dataHelpBtn: document.getElementById('dataHelpBtn'),
      alpha: document.getElementById('alpha'),
      calculate: document.getElementById('calculateBtn'),
      clear: document.getElementById('clearData'),
      transpose: document.getElementById('transpose'),
      loadSample: document.getElementById('loadSample'),
      downloadCSV: document.getElementById('downloadCSV'),
      copyResults: document.getElementById('copyResults'),
      resetAll: document.getElementById('resetAll'),
      downloadPNG: document.getElementById('downloadPNG'),

      // Results
      resN: document.getElementById('resN'),
      resR: document.getElementById('resR'),
      resR2: document.getElementById('resR2'),
      resP: document.getElementById('resP'),
      resT: document.getElementById('resT'),
      resDf: document.getElementById('resDf'),
      resCov: document.getElementById('resCov'),
      resMeanX: document.getElementById('resMeanX'),
      resMeanY: document.getElementById('resMeanY'),
      resSx: document.getElementById('resSx'),
      resSy: document.getElementById('resSy'),
      resCI: document.getElementById('resCI'),
      regEquation: document.getElementById('regEquation'),
    };

    // Accessible tooltip toggle
    els.dataHelpBtn.addEventListener('click', () => {
      const expanded = els.dataHelpBtn.getAttribute('aria-expanded') === 'true';
      els.dataHelpBtn.setAttribute('aria-expanded', String(!expanded));
      toggleHidden(els.dataHelp, expanded);
    });

    // Sample dataset (moderate positive correlation)
    const sample = `# X  Y
10  8
12  9
13  11
15  14
18  15
20  18
22  20
25  23
27  24
30  27`;

    els.loadSample.addEventListener('click', () => {
      els.dataInput.value = sample;
      validateAndCompute();
    });

    els.clear.addEventListener('click', () => {
      els.dataInput.value = '';
      showError('');
      displayResults(null);
      updateChart([]);
    });

    els.transpose.addEventListener('click', () => {
      const rows = parseDataRaw(els.dataInput.value, true);
      if (!rows.length) return;
      // transpose
      const cols = rows[0].length;
      const trans = Array.from({length: cols}, (_, c) => rows.map(r => r[c]).join('\t')).join('\n');
      els.dataInput.value = trans;
      validateAndCompute();
    });

    els.calculate.addEventListener('click', validateAndCompute);
    els.alpha.addEventListener('change', validateAndCompute);

    // Inline validation on blur
    els.dataInput.addEventListener('blur', validateAndCompute);

    // CSV/TSV download of cleaned pairs
    els.downloadCSV.addEventListener('click', () => {
      const pairs = parsePairs(els.dataInput.value);
      if (pairs.length < 3) { showError('Provide at least 3 valid pairs before downloading.'); return; }
      const csv = 'x,y\\n' + pairs.map(p => p[0] + ',' + p[1]).join('\\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'correlation-data.csv';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    // Copy results to clipboard
    els.copyResults.addEventListener('click', async () => {
      const text = gatherResultsPlainText();
      try {
        await navigator.clipboard.writeText(text);
        alert('Results copied.');
      } catch { alert('Copy failed.'); }
    });

    // Reset all
    els.resetAll.addEventListener('click', () => {
      els.dataInput.value = '';
      els.alpha.value = '0.05';
      showError('');
      displayResults(null);
      updateChart([]);
    });

    // Chart PNG
    els.downloadPNG.addEventListener('click', () => {
      if (!chart) return;
      const a = document.createElement('a');
      a.href = chart.toBase64Image();
      a.download = 'correlation-scatter.png';
      a.click();
    });

    // Parsing helpers
    function parseDataRaw(text, loose=false) {
      const lines = (text || '').split(/\\r?\\n/).map(l => l.trim()).filter(l => l && !l.startsWith('#'));
      if (!lines.length) return [];
      return lines.map(line => {
        // Accept comma, semicolon, tab, multiple spaces
        const parts = line.split(/[;,\\t\\s]+/).filter(Boolean);
        return loose ? parts : parts.slice(0, 2);
      });
    }

    function parsePairs(text) {
      const raw = parseDataRaw(text);
      const pairs = [];
      for (const parts of raw) {
        if (parts.length < 2) continue;
        const x = Number(parts[0]), y = Number(parts[1]);
        if (Number.isFinite(x) && Number.isFinite(y)) pairs.push([x, y]);
      }
      return pairs;
    }

    function showError(msg) {
      els.dataError.textContent = msg;
      toggleHidden(els.dataError, !msg);
    }

    function validateAndCompute() {
      const pairs = parsePairs(els.dataInput.value);
      if (pairs.length === 0) {
        showError('Enter two numeric columns separated by comma, tab, or space.');
        displayResults(null);
        updateChart([]);
        return;
      }
      if (pairs.length < 3) {
        showError('At least 3 valid pairs are required to compute Pearson’s r and perform the t-test.');
        displayResults(null);
        updateChart(pairs);
        return;
      }
      showError('');
      const alpha = Number(els.alpha.value) || 0.05;
      const stats = computeStats(pairs, alpha);
      displayResults(stats);
      updateChart(pairs, stats);
    }

    // Math helpers
    function mean(a){ return a.reduce((s,v)=>s+v,0)/a.length; }
    function variance(a, m){ const n=a.length; return a.reduce((s,v)=>s+(v-m)*(v-m),0)/(n-1); }
    function covariance(ax, ay, mx, my){
      const n = ax.length;
      let s = 0;
      for (let i=0;i<n;i++) s += (ax[i]-mx)*(ay[i]-my);
      return s/(n-1);
    }

    // Student's t CDF (two-tailed p via regularized incomplete beta approximation)
    // Based on a simple approximation for practical calculator use.
    function betacf(x, a, b) {
      const MAXITER = 100, EPS=3e-7;
      let qab=a+b, qap=a+1, qam=a-1, c=1, d=1 - qab*x/qap;
      if (Math.abs(d) < 1e-30) d = 1e-30;
      d = 1/d;
      let h = d;
      for (let m=1, m2=2; m<=MAXITER; m++, m2+=2) {
        let aa = m*(b-m)*x/((qam+m2)*(a+m2));
        d = 1 + aa*d; if (Math.abs(d)<1e-30) d=1e-30;
        c = 1 + aa/c; if (Math.abs(c)<1e-30) c=1e-30;
        d = 1/d; h *= d*c;
        aa = -(a+m)*(qab+a+m)*x/((a+m2)*(qap+m2));
        d = 1 + aa*d; if (Math.abs(d)<1e-30) d=1e-30;
        c = 1 + aa/c; if (Math.abs(c)<1e-30) c=1e-30;
        d = 1/d; const del = d*c; h *= del;
        if (Math.abs(del-1) < EPS) break;
      }
      return h;
    }
    function betai(x, a, b) {
      if (x<=0) return 0;
      if (x>=1) return 1;
      const bt = Math.exp(lnGamma(a+b)-lnGamma(a)-lnGamma(b) + a*Math.log(x) + b*Math.log(1-x));
      if (x < (a+1)/(a+b+2)) return bt*betacf(x,a,b)/a;
      return 1 - bt*betacf(1-x,b,a)/b;
    }
    function lnGamma(z){ // Lanczos
      const g=7;
      const C=[0.99999999999980993,676.5203681218851,-1259.1392167224028,771.32342877765313,-176.61502916214059,12.507343278686905,-0.13857109526572012,9.9843695780195716e-6,1.5056327351493116e-7];
      let x=C[0];
      for (let i=1;i<g+2;i++) x += C[i]/(z+i);
      const t=z+g+0.5;
      return 0.5*Math.log(2*Math.PI)+(z+0.5)*Math.log(t)-t+Math.log(x)-Math.log(z);
    }
    function tCDF(t, df){ // two-sided tail we’ll compute from regularized beta
      // Convert to x for incomplete beta: x = df/(df + t^2)
      const x = df/(df + t*t);
      const a = df/2, b = 0.5;
      const ib = betai(x, a, b);
      // For t >= 0, upper tail = 0.5*ib; symmetric
      const p = 0.5*ib;
      return t >= 0 ? 1 - p : p; // right-tail CDF
    }
    function tTwoTailedP(t, df){
      const rightTail = 1 - tCDF(Math.abs(t), df);
      return 2*rightTail;
    }
    function zCritical(alpha){
      // approximate inverse CDF for normal (Beasley-Springer/Moro)
      const a = [ -39.6968302866538, 220.946098424521, -275.928510446969, 138.357751867269, -30.6647980661472, 2.50662827745924 ];
      const b = [ -54.4760987982241, 161.585836858041, -155.698979859887, 66.8013118877197, -13.2806815528857 ];
      const c = [ -0.00778489400243029, -0.322396458041136, -2.40075827716184, -2.54973253934373, 4.37466414146497, 2.93816398269878 ];
      const d = [ 0.00778469570904146, 0.32246712907004, 2.445134137143, 3.75440866190742 ];
      const p = 1 - alpha/2;
      let q, r, x;
      if (p < 0.02425) {
        q = Math.sqrt(-2*Math.log(1-p)); x = (((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5])/((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
      } else if (p > 1-0.02425) {
        q = Math.sqrt(-2*Math.log(1-p)); x = -(((((c[0]*q+c[1])*q+c[2])*q+c[3])*q+c[4])*q+c[5])/((((d[0]*q+d[1])*q+d[2])*q+d[3])*q+1);
      } else {
        q = p - 0.5; r = q*q;
        x = (((((a[0]*r+a[1])*r+a[2])*r+a[3])*r+a[4])*r+a[5])*q/(((((b[0]*r+b[1])*r+b[2])*r+b[3])*r+b[4])*r+1);
      }
      return x;
    }

    function computeStats(pairs, alpha) {
      const X = pairs.map(p=>p[0]), Y = pairs.map(p=>p[1]);
      const n = X.length;
      const mx = mean(X), my = mean(Y);
      const vx = variance(X, mx), vy = variance(Y, my);
      const sx = Math.sqrt(vx), sy = Math.sqrt(vy);
      const cov = covariance(X, Y, mx, my);
      const r = cov / (sx*sy);
      const r2 = r*r;
      const df = n - 2;
      let t = NaN, p = NaN, ciLow = NaN, ciHigh = NaN;

      if (isFinite(r) && df > 0 && Math.abs(r) < 1) {
        t = r * Math.sqrt(df / (1 - r*r));
        p = tTwoTailedP(t, df);
        // Fisher z CI
        const z = 0.5*Math.log((1+r)/(1-r));
        const sez = 1/Math.sqrt(n-3);
        const zcrit = zCritical(alpha);
        const zl = z - zcrit*sez, zu = z + zcrit*sez;
        ciLow = (Math.exp(2*zl)-1)/(Math.exp(2*zl)+1);
        ciHigh = (Math.exp(2*zu)-1)/(Math.exp(2*zu)+1);
      }

      // Regression line (least squares): b = r*sy/sx, a = my - b*mx
      const b = r * (sy / sx);
      const a = my - b*mx;

      return { n, r, r2, t, p, df, cov, mx, my, sx, sy, ciLow, ciHigh, a, b, X, Y };
    }

    function fmt(n, d=6){
      if (n == null || !isFinite(n)) return '—';
      const s = n.toFixed(d);
      // trim trailing zeros
      return s.replace(/\\.0+$/,'').replace(/(\\.\\d*?)0+$/, '$1');
    }

    function displayResults(stats){
      if (!stats) {
        ['resN','resR','resR2','resP','resT','resDf','resCov','resMeanX','resMeanY','resSx','resSy','resCI'].forEach(id=>{
          document.getElementById(id).textContent = '—';
        });
        document.getElementById('regEquation').textContent = '—';
        return;
      }
      const {n, r, r2, t, p, df, cov, mx, my, sx, sy, ciLow, ciHigh, a, b} = stats;
      els.resN.textContent = n;
      els.resR.textContent = fmt(r, 6);
      els.resR2.textContent = fmt(r2, 6);
      els.resP.textContent = (p<1e-6) ? '<1e-6' : fmt(p, 6);
      els.resT.textContent = fmt(t, 6);
      els.resDf.textContent = df;
      els.resCov.textContent = fmt(cov, 6);
      els.resMeanX.textContent = fmt(mx, 6);
      els.resMeanY.textContent = fmt(my, 6);
      els.resSx.textContent = fmt(sx, 6);
      els.resSy.textContent = fmt(sy, 6);
      els.resCI.textContent = (isFinite(ciLow) && isFinite(ciHigh)) ? `[${fmt(ciLow, 6)}, ${fmt(ciHigh, 6)}]` : '—';
      document.getElementById('regEquation').textContent = `ŷ = ${fmt(a,6)} + ${fmt(b,6)} x`;
    }

    function gatherResultsPlainText(){
      return [
        `n: ${els.resN.textContent}`,
        `r: ${els.resR.textContent}`,
        `R^2: ${els.resR2.textContent}`,
        `t: ${els.resT.textContent}`,
        `df: ${els.resDf.textContent}`,
        `p(two-tailed): ${els.resP.textContent}`,
        `cov: ${els.resCov.textContent}`,
        `mean(x): ${els.resMeanX.textContent}`,
        `mean(y): ${els.resMeanY.textContent}`,
        `sd(x): ${els.resSx.textContent}`,
        `sd(y): ${els.resSy.textContent}`,
        `95% CI r: ${els.resCI.textContent}`,
        `Regression: ${document.getElementById('regEquation').textContent}`
      ].join('\\n');
    }

    // Chart
    let chart = null;
    function updateChart(pairs, stats){
      const ctx = document.getElementById('scatterChart');
      if (!ctx) return;
      const data = pairs.map(p => ({x:p[0], y:p[1]}));

      // Regression line endpoints for plot bounds
      let regDataset = [];
      if (stats && data.length) {
        const xs = stats.X;
        const minX = Math.min(...xs), maxX = Math.max(...xs);
        const y1 = stats.a + stats.b*minX;
        const y2 = stats.a + stats.b*maxX;
        regDataset = [{x:minX, y:y1}, {x:maxX, y:y2}];
      }

      const chartData = {
        datasets: [
          {
            type: 'scatter',
            label: 'Data',
            data,
            pointRadius: 3
          },
          ...(regDataset.length ? [{
            type: 'line',
            label: 'Regression',
            data: regDataset,
            fill: false,
            borderWidth: 2,
            tension: 0
          }] : [])
        ]
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } },
        scales: {
          x: { type: 'linear', title: { display: true, text: 'X' } },
          y: { type: 'linear', title: { display: true, text: 'Y' } }
        }
      };

      if (chart) { chart.data = chartData; chart.options = options; chart.update(); }
      else { chart = new Chart(ctx, { data: chartData, options }); }
    }

    // Build FAQ JSON-LD from the rendered <details> (ensures consistency)
    function refreshFAQSchema(){
      const faqEl = document.getElementById('faq-jsonld');
      if (!faqEl) return;
      const items = Array.from(document.querySelectorAll('section.prose details')).map(d => {
        const q = d.querySelector('summary')?.textContent?.trim() || '';
        const a = Array.from(d.childNodes).filter(n => n.nodeName !== 'SUMMARY').map(n => n.textContent.trim()).join(' ').trim();
        return {"@type":"Question","name":q,"acceptedAnswer":{"@type":"Answer","text":a}};
      });
      const schema = { "@context":"https://schema.org", "@type":"FAQPage", "mainEntity": items };
      faqEl.textContent = JSON.stringify(schema);
    }

    // Initialize
    refreshFAQSchema();
    validateAndCompute();
  });
  </script>
</body>
</html>
