<!DOCTYPE html>
<html lang="en">
<head>
<link rel="canonical" href="https://calcdomain.com/loan-prepayment.html">




 
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="manifest" href="/site.webmanifest" />
  <meta charset="utf-8"/>
  <title>Loan Prepayment Calculator | Lump Sum Savings &amp; Payoff Time</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="See how a one-time lump-sum prepayment shortens your loan term and cuts total interest. Enter balance, APR, term, and payment number to quantify payoff savings and months eliminated."/>
  <meta name="author" content="Ugo Candido"/>
  
  <meta name="theme-color" content="#0b3d69"/>
  <meta name="robots" content="index, follow"/>
  <meta property="og:type" content="website"/>
  <meta property="og:title" content="Loan Prepayment Calculator"/>
  <meta property="og:description" content="Estimate the interest saved and months eliminated when you apply a lump-sum prepayment to your loan."/>
  <meta property="og:url" content="https://calcdomain.com/loan-prepayment.html"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .prose { max-width: 70ch; }
    .prose h2 { font-size: 1.5rem; font-weight: 700; margin-top: 2rem; margin-bottom: .75rem; }
    .prose h3 { font-size: 1.125rem; font-weight: 700; margin-top: 1.25rem; margin-bottom: .5rem; }
    .prose p { margin-bottom: .9rem; line-height: 1.7; }
    .prose ul { list-style: disc; padding-left: 1.25rem; }
    .prose ol { list-style: decimal; padding-left: 1.25rem; }
    details > summary { cursor: pointer; font-weight: 600; }
    details[open] > summary { margin-bottom: .5rem; }
    .eeat { display:grid; gap:0.75rem; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); font-size:0.875rem; color:#374151; }
    @media (min-width: 768px) { .eeat { grid-template-columns:repeat(4,minmax(0,1fr)); } }
    .eeat span { display:block; background:#f9fafb; border:1px solid #e5e7eb; border-radius:0.5rem; padding:0.75rem 1rem; }
    .result-pill { display:inline-flex; align-items:center; font-size:0.875rem; font-weight:600; padding:0.25rem 0.75rem; border-radius:9999px; }
    .formula-box { background:#f8fafc; border:1px solid #e2e8f0; border-radius:0.75rem; padding:1rem; overflow:auto; }
    .formula-box mjx-container { overflow-x:auto; }
    .sticky-ad { height: 600px; }
  </style>

  <script src="search.js" defer></script>

  <script>
    window.MathJax = {
      tex: { inlineMath: [['\\(','\\)'], ['$', '$']], displayMath: [['\\[','\\]']] },
      svg: { fontCache: 'global' }
    };
  </script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>

  <script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://calcdomain.com/"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Finance",
      "item": "https://calcdomain.com/finance.html"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "Loans & Debt",
      "item": "https://calcdomain.com/subcategories/finance-loans-debt.html"
    },
    {
      "@type": "ListItem",
      "position": 4,
      "name": "Loan Prepayment Calculator",
      "item": "https://calcdomain.com/loan-prepayment.html"
    }
  ]
}</script>

  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"Loan Prepayment Calculator",
    "url":"https://calcdomain.com/loan-prepayment.html",
    "description":"Calculate months saved and interest reduced when you apply a lump-sum prepayment to an amortizing loan.",
    "publisher":{"@type":"Organization","name":"CalcDomain"},
    "author":{"@type":"Person","name":"Ugo Candido"},
    "mainEntity":{
      "@type":"FAQPage",
      "mainEntity":[
        {"@type":"Question","name":"Does a lump sum change my monthly payment?","acceptedAnswer":{"@type":"Answer","text":"Most lenders keep your payment the same and shorten the term unless you request a loan recast. This calculator assumes the payment stays unchanged."}},
        {"@type":"Question","name":"What if my payment is too small after the prepayment?","acceptedAnswer":{"@type":"Answer","text":"If the monthly payment cannot cover monthly interest, payoff is impossible. Increase the payment or apply a larger lump sum to stay on track."}},
        {"@type":"Question","name":"When is a prepayment most effective?","acceptedAnswer":{"@type":"Answer","text":"The earlier you apply the prepayment, the more interest you save because more of the balance is still outstanding and accruing interest."}}
      ]
    }
  }
  </script>

  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"HowTo",
    "name":"How a lump-sum prepayment changes your loan",
    "description":"Example using a $180,000 balance at 6.25% APR with 20 years remaining, $15,000 lump sum at payment #1.",
    "step":[
      {"@type":"HowToStep","name":"Enter current balance, APR, and remaining term","text":"Balance $180,000, APR 6.25%, 20 years remaining."},
      {"@type":"HowToStep","name":"Provide the lump-sum prepayment","text":"Lump sum $15,000 applied with the next payment (payment number 1)."},
      {"@type":"HowToStep","name":"Review savings","text":"Payoff occurs ~33 months sooner and saves roughly $20,800 in interest while keeping the same monthly payment."}
    ]
  }
  </script>
</head>
<body class="bg-gray-50 text-gray-800">

  <header class="bg-white shadow-sm sticky top-0 z-50">
    <nav class="container mx-auto px-4 lg:px-6 py-4">
      <div class="flex justify-between items-center">
        <a href="index.html" class="text-2xl font-bold text-blue-600">CalcDomain</a>

        <div class="w-full max-w-md hidden md:block mx-8">
          <div class="relative">
            <input id="search-input" type="search" placeholder="Search for a calculator..."
                   class="w-full py-2 px-4 pr-10 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                   autocomplete="off">
            <svg class="w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <div id="search-results" class="absolute top-full left-0 right-0 bg-white shadow-lg rounded-lg mt-2 max-h-96 overflow-y-auto z-50 hidden border border-gray-200"></div>
          </div>
        </div>

        <div class="hidden md:flex items-center space-x-6">
          <a href="search.html" class="text-gray-700 hover:text-blue-600">Advanced Search</a>
          Categories
        </div>

        <button id="mobile-menu-toggle" class="md:hidden p-2" aria-label="Toggle menu">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
          </svg>
        </button>
      </div>

      <div id="mobile-menu" class="md:hidden mt-4 hidden">
        <div class="mb-4">
          <div class="relative">
            <input id="mobile-search-input" type="search" placeholder="Search calculators..."
                   class="w-full py-3 px-4 pr-10 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <svg class="w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
        </div>
        <div class="space-y-2">
          <a href="search.html" class="block py-2 text-gray-700 hover:text-blue-600">Advanced Search</a>
          Categories
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-8">

      <section class="w-full lg:w-2/3">
        <nav class="text-sm mb-4 text-gray-600" aria-label="Breadcrumb">
          <a href="index.html" class="hover:text-blue-600">Home</a> &raquo;
          <a href="finance.html" class="hover:text-blue-600">Finance</a> &raquo;
          <a href="subcategories/finance-loans-debt.html" class="hover:text-blue-600">Loans &amp; Debt</a> &raquo;
          <span class="text-gray-900 font-medium">Loan Prepayment</span>
        </nav>

        <section class="bg-white p-6 rounded-lg shadow-md" aria-labelledby="calc-title">
          <h1 id="calc-title" class="text-3xl font-extrabold mb-2 text-slate-800">Loan Prepayment Calculator</h1>
          <p class="text-gray-600 mb-6">Enter your remaining balance, APR, term, and a one-time lump-sum payment to see the new payoff time and total interest saved. Perfect for planning bonus checks, tax refunds, or windfalls.</p>

          <div class="eeat mb-6">
            <span><strong>Author:</strong> Ugo Candido</span>
            <span><strong>Reviewed by:</strong> Finance Content Editor</span>
            <span><strong>Last updated:</strong> <time id="lastUpdated"></time></span>
            <span><strong>Category:</strong> Finance → Loans &amp; Debt</span>
          </div>

          <div id="calculator-ui" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label for="balance" class="block text-sm font-medium text-gray-700">Current balance *</label>
              <div class="relative">
                <input id="balance" type="number" inputmode="decimal" min="0" step="0.01" value="180000"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md pr-12 focus:ring-blue-500 focus:border-blue-500"
                       aria-describedby="balanceErr" aria-required="true">
                <span id="balanceSymbol" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 font-semibold">$</span>
              </div>
              <p id="balanceErr" class="text-xs text-red-600 min-h-[1rem]" role="alert" aria-live="polite"></p>
            </div>

            <div>
              <label for="apr" class="block text-sm font-medium text-gray-700">APR (%) *</label>
              <div class="relative">
                <input id="apr" type="number" inputmode="decimal" min="0" max="1000" step="0.01" value="6.25"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md pr-12 focus:ring-blue-500 focus:border-blue-500"
                       aria-describedby="aprErr" aria-required="true">
                <span class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 font-semibold">%</span>
              </div>
              <p id="aprErr" class="text-xs text-red-600 min-h-[1rem]" role="alert" aria-live="polite"></p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Remaining term *</label>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label for="termYears" class="block text-xs text-gray-600 uppercase tracking-wide">Years</label>
                  <input id="termYears" type="number" inputmode="numeric" min="0" step="1" value="20"
                         class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                         aria-describedby="termErr" aria-required="true">
                </div>
                <div>
                  <label for="termMonths" class="block text-xs text-gray-600 uppercase tracking-wide">Months</label>
                  <input id="termMonths" type="number" inputmode="numeric" min="0" max="11" step="1" value="0"
                         class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                         aria-describedby="termErr" aria-required="true">
                </div>
              </div>
              <p id="termErr" class="text-xs text-red-600 min-h-[1rem]" role="alert" aria-live="polite"></p>
            </div>

            <div>
              <label for="lumpSum" class="block text-sm font-medium text-gray-700">Lump-sum prepayment</label>
              <div class="relative">
                <input id="lumpSum" type="number" inputmode="decimal" min="0" step="0.01" value="15000"
                       class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md pr-12 focus:ring-blue-500 focus:border-blue-500"
                       aria-describedby="lumpErr">
                <span id="lumpSymbol" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 font-semibold">$</span>
              </div>
              <p id="lumpErr" class="text-xs text-red-600 min-h-[1rem]" role="alert" aria-live="polite"></p>
            </div>

            <div>
              <label for="paymentNumber" class="block text-sm font-medium text-gray-700">Apply lump sum at payment #</label>
              <input id="paymentNumber" type="number" inputmode="numeric" min="1" step="1" value="1"
                     class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                     aria-describedby="paymentNumberErr">
              <p id="paymentNumberErr" class="text-xs text-red-600 min-h-[1rem]" role="alert" aria-live="polite"></p>
            </div>

            <div>
              <label for="startMonth" class="block text-sm font-medium text-gray-700">Start month</label>
              <input id="startMonth" type="month"
                     class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
              <p class="text-xs text-gray-500 mt-1">Used to estimate the scheduled and new payoff dates.</p>
            </div>
          </div>

          <div class="mt-6 flex flex-wrap gap-3">
            <button id="calculate" type="button" class="inline-flex items-center justify-center px-5 py-2.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white font-semibold shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              Calculate prepayment impact
            </button>
            <button id="reset" type="button" class="inline-flex items-center justify-center px-5 py-2.5 rounded-md border border-gray-300 text-gray-700 font-semibold hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              Reset
            </button>
            <button id="example" type="button" class="inline-flex items-center justify-center px-5 py-2.5 rounded-md border border-blue-300 text-blue-700 font-semibold hover:bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              Load example
            </button>
          </div>

          <div id="results" class="mt-8 bg-blue-50 p-6 rounded-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Results</h3>
            <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
              <div class="border-b pb-3">
                <span class="block text-gray-600">Monthly payment (unchanged)</span>
                <span id="paymentValue" class="text-2xl font-extrabold text-blue-700">$0.00</span>
              </div>
              <div class="border-b pb-3">
                <span class="block text-gray-600">Scheduled payoff time</span>
                <span id="baselineTermValue" class="text-2xl font-extrabold text-gray-800">—</span>
                <span id="baselineDateValue" class="block text-xs text-gray-500 mt-1">Payoff date: —</span>
              </div>
              <div class="border-b pb-3">
                <span class="block text-gray-600">Payoff after prepayment</span>
                <span id="newTermValue" class="text-2xl font-extrabold text-gray-800">—</span>
                <span id="newDateValue" class="block text-xs text-gray-500 mt-1">Payoff date: —</span>
              </div>
              <div>
                <span class="block text-gray-600">Interest saved</span>
                <span id="interestSavedValue" class="text-xl font-semibold text-green-700">$0.00</span>
                <span id="baselineInterestValue" class="block text-xs text-gray-500 mt-1">Baseline interest: $0.00</span>
              </div>
              <div>
                <span class="block text-gray-600">Months eliminated</span>
                <span id="monthsSavedValue" class="text-xl font-semibold text-gray-800">0</span>
              </div>
              <div>
                <span class="block text-gray-600">Prepayment details</span>
                <span id="lumpEcho" class="text-xl font-semibold text-gray-800">$0.00</span>
                <span id="paymentNumberEcho" class="block text-xs text-gray-500 mt-1">Applied at payment #1</span>
              </div>
            </div>
            <div class="mt-4 space-x-2">
              <span id="statusPill" class="result-pill bg-slate-100 text-slate-800">Ready to calculate</span>
            </div>
          </div>

          <section class="mt-8">
            <div class="flex items-center justify-between mb-3">
              <h2 class="text-xl font-semibold text-gray-800">Loan amortization timeline</h2>
              <button id="toggleSchedule" type="button" class="text-sm font-semibold text-blue-600 hover:text-blue-700">
                Show full schedule
              </button>
            </div>
            <div class="overflow-auto border border-gray-200 rounded-lg">
              <table class="min-w-full text-sm">
                <caption class="sr-only">Loan payoff schedule with lump-sum prepayment</caption>
                <thead class="bg-slate-100 text-gray-700">
                  <tr>
                    <th class="py-2 px-3 text-left font-semibold">#</th>
                    <th class="py-2 px-3 text-right font-semibold">Payment</th>
                    <th class="py-2 px-3 text-right font-semibold">Interest</th>
                    <th class="py-2 px-3 text-right font-semibold">Principal</th>
                    <th class="py-2 px-3 text-right font-semibold">Lump sum</th>
                    <th class="py-2 px-3 text-right font-semibold">Balance</th>
                  </tr>
                </thead>
                <tbody id="scheduleBody">
                  <tr>
                    <td colspan="6" class="py-6 px-3 text-center text-gray-500">Enter loan details to generate the schedule.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>
        </section>

        <article class="bg-white p-6 rounded-lg shadow-md mt-8 prose">
          <h2>Data Source and Methodology</h2>
          <p>Payments follow the level-payment amortization formula used in Truth in Lending (Regulation Z) Appendix J. The lump-sum prepayment reduces the balance at the payment number you choose. After the lump is applied, the calculator keeps the scheduled payment unchanged and simulates the loan month by month until it pays off to compute interest savings and months eliminated.</p>

          <h2>Formulas Used</h2>
          <div class="formula-box">
            <p><strong>Monthly rate:</strong> \( r = \dfrac{\text{APR}}{12} \)</p>
            <p><strong>Scheduled payment:</strong> \( M = \dfrac{P \cdot r}{1 - (1 + r)^{-n}} \) (if \( r = 0 \) then \( M = P/n \))</p>
            <p>After a lump sum \( L_{\text{ump}} \) at payment \( k \):</p>
            <p>Remaining balance \( B_k = B_{k-1} - (M - B_{k-1} \cdot r) - L_{\text{ump}} \)</p>
            <p>Monthly interest is recalculated each period as \( B_t \cdot r \) until the balance reaches zero.</p>
          </div>

          <h2>Frequently Asked Questions</h2>
          <details>
            <summary>Will my lender reduce the required payment?</summary>
            <p>Usually no. After a lump sum you keep making the same payment and the term shortens. Some lenders allow a “recast” if you request it.</p>
          </details>
          <details>
            <summary>How do I choose the payment number?</summary>
            <p>Payment #1 applies the lump sum immediately. Larger payment numbers simulate applying the lump later in the loan, which saves less interest.</p>
          </details>
          <details>
            <summary>Do I have to pay extra every month?</summary>
            <p>No. This tool models a single lump sum while keeping the regular payment the same.</p>
          </details>
        </article>

        <section class="bg-white p-6 rounded-lg shadow-md mt-8">
          <h2 class="text-xl font-semibold text-gray-900 mb-3">Need more help?</h2>
          <p class="text-sm text-gray-600 leading-relaxed">
            Explore more tools in the <a href="subcategories/finance-loans-debt.html" class="text-blue-600 hover:underline">Loans &amp; Debt hub</a>,
            or visit the <a href="loan-payoff.html" class="text-blue-600 hover:underline">Loan Payoff Calculator</a> to model recurring extra payments.
          </p>
        </section>
      </section>

      <aside class="w-full lg:w-1/3">
        <div class="sticky top-24">
          <div class="bg-gray-200 rounded-lg mb-6 flex items-center justify-center sticky-ad">
            <p class="text-gray-500">Sticky Ad Unit (300×600)</p>
          </div>

          <div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="font-bold text-lg mb-4">Related calculators</h3>
            <ul class="space-y-3">
              <li><a class="text-blue-600 hover:underline" href="loan-payoff.html">Loan Payoff Calculator</a></li>
              <li><a class="text-blue-600 hover:underline" href="simple-loan.html">Simple Loan Calculator</a></li>
              <li><a class="text-blue-600 hover:underline" href="loan-amortization.html">Loan Amortization Schedule</a></li>
              <li><a class="text-blue-600 hover:underline" href="apr.html">APR Calculator</a></li>
            </ul>
          </div>
        </div>
      </aside>

    </div>
  </main>

  <footer class="bg-white border-t mt-12">
    <div class="container mx-auto px-6 py-8 text-center text-gray-600">
      <p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
    </div>
  </footer>

  <script>
    const $ = (id) => document.getElementById(id);

    const els = {
      balance: $('balance'),
      apr: $('apr'),
      termYears: $('termYears'),
      termMonths: $('termMonths'),
      lumpSum: $('lumpSum'),
      paymentNumber: $('paymentNumber'),
      startMonth: $('startMonth'),

      balanceErr: $('balanceErr'),
      aprErr: $('aprErr'),
      termErr: $('termErr'),
      lumpErr: $('lumpErr'),
      paymentNumberErr: $('paymentNumberErr'),

      paymentValue: $('paymentValue'),
      baselineTermValue: $('baselineTermValue'),
      baselineDateValue: $('baselineDateValue'),
      baselineInterestValue: $('baselineInterestValue'),
      newTermValue: $('newTermValue'),
      newDateValue: $('newDateValue'),
      interestSavedValue: $('interestSavedValue'),
      monthsSavedValue: $('monthsSavedValue'),
      lumpEcho: $('lumpEcho'),
      paymentNumberEcho: $('paymentNumberEcho'),
      statusPill: $('statusPill'),

      toggleSchedule: $('toggleSchedule'),
      scheduleBody: $('scheduleBody'),

      calculate: $('calculate'),
      reset: $('reset'),
      example: $('example'),
      lastUpdated: $('lastUpdated'),
      ui: $('calculator-ui')
    };

    let fullSchedule = [];
    let showFullSchedule = false;

    const fmtCurrency = (value) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
    const fmtTerm = (months) => {
      if (!isFinite(months) || months <= 0) return 'Paid off';
      const years = Math.floor(months / 12);
      const rem = Math.round(months % 12);
      const parts = [];
      if (years > 0) parts.push(`${years} year${years === 1 ? '' : 's'}`);
      if (rem > 0) parts.push(`${rem} month${rem === 1 ? '' : 's'}`);
      return parts.join(' ') || 'Less than 1 month';
    };

    const parseStartDate = (value) => {
      if (!value) return new Date();
      const [year, month] = value.split('-').map(Number);
      const parsed = new Date(year, (month || 1) - 1, 1);
      return Number.isNaN(parsed.valueOf()) ? new Date() : parsed;
    };

    const addMonths = (date, months) => {
      const result = new Date(date.getTime());
      result.setMonth(result.getMonth() + Math.round(months));
      return result;
    };

    function setError(input, errEl, message) {
      if (!errEl) return;
      if (message) {
        errEl.textContent = message;
        input?.setAttribute('aria-invalid', 'true');
      } else {
        errEl.textContent = '';
        input?.setAttribute('aria-invalid', 'false');
      }
    }

    function validateBalance() {
      const value = parseFloat(els.balance.value);
      if (!(value > 0)) {
        setError(els.balance, els.balanceErr, 'Enter a balance greater than zero.');
        return false;
      }
      setError(els.balance, els.balanceErr, '');
      return true;
    }

    function validateApr() {
      const value = parseFloat(els.apr.value);
      if (!(value >= 0) || value > 1000) {
        setError(els.apr, els.aprErr, 'Enter an APR between 0 and 1000%.');
        return false;
      }
      setError(els.apr, els.aprErr, '');
      return true;
    }

    function validateTerm() {
      const years = parseFloat(els.termYears.value) || 0;
      const months = parseFloat(els.termMonths.value) || 0;
      const totalMonths = years * 12 + months;
      if (!(totalMonths > 0)) {
        setError(els.termYears, els.termErr, 'Enter a term greater than zero.');
        return false;
      }
      setError(els.termYears, els.termErr, '');
      return true;
    }

    function validateLump() {
      const value = parseFloat(els.lumpSum.value);
      if (els.lumpSum.value.trim() === '') {
        setError(els.lumpSum, els.lumpErr, '');
        return true;
      }
      if (!(value >= 0)) {
        setError(els.lumpSum, els.lumpErr, 'Lump sum cannot be negative.');
        return false;
      }
      setError(els.lumpSum, els.lumpErr, '');
      return true;
    }

    function validatePaymentNumber(totalMonths) {
      let value = parseInt(els.paymentNumber.value, 10);
      if (!Number.isFinite(value) || value < 1) {
        setError(els.paymentNumber, els.paymentNumberErr, 'Enter the payment number starting at 1.');
        return { valid: false, paymentNumber: 1 };
      }
      if (value > totalMonths) {
        value = totalMonths;
        els.paymentNumber.value = String(value);
      }
      setError(els.paymentNumber, els.paymentNumberErr, '');
      return { valid: true, paymentNumber: value };
    }

    function computeMonthlyPayment(principal, rate, totalMonths) {
      if (rate === 0) {
        return principal / totalMonths;
      }
      const pow = Math.pow(1 + rate, totalMonths);
      return principal * rate * pow / (pow - 1);
    }

    function simulateBaseline(balance, rate, payment, maxMonths) {
      const rows = [];
      let remaining = balance;
      let interestSum = 0;
      let periods = 0;
      const cap = maxMonths + 2400;

      while (remaining > 0 && periods < cap) {
        periods += 1;
        const interest = remaining * rate;
        let principal = rate === 0 ? payment : payment - interest;
        if (principal <= 0) {
          return { feasible: false, months: Infinity, interest: Infinity, rows: [] };
        }
        if (principal > remaining) {
          principal = remaining;
        }
        const actualPayment = principal + interest;
        remaining = Math.max(0, remaining - principal);
        interestSum += interest;
        rows.push({ type: 'payment', index: periods, payment: actualPayment, interest, principal, lump: 0, balance: remaining });
        if (remaining <= 0) break;
      }

      if (remaining > 0) {
        return { feasible: false, months: Infinity, interest: Infinity, rows: [] };
      }

      return { feasible: true, months: periods, interest: interestSum, rows };
    }

    function simulateWithLump(balance, rate, payment, lump, paymentNumber) {
      const rows = [];
      let remaining = balance;
      let interestSum = 0;
      let paymentsMade = 0;
      const cap = 2400;

      const advance = () => {
        const interest = remaining * rate;
        let principal = rate === 0 ? payment : payment - interest;
        if (principal <= 0) {
          return { feasible: false };
        }
        if (principal > remaining) {
          principal = remaining;
        }
        const actualPayment = principal + interest;
        remaining = Math.max(0, remaining - principal);
        interestSum += interest;
        paymentsMade += 1;
        rows.push({ type: 'payment', index: paymentsMade, payment: actualPayment, interest, principal, lump: 0, balance: remaining });
        return { feasible: true };
      };

      while (paymentsMade < paymentNumber - 1 && remaining > 0 && paymentsMade < cap) {
        const step = advance();
        if (!step.feasible) {
          return { feasible: false };
        }
      }

      if (lump > 0 && remaining > 0) {
        remaining = Math.max(0, remaining - lump);
        rows.push({ type: 'lump', index: paymentsMade + 1, payment: 0, interest: 0, principal: 0, lump, balance: remaining });
      }

      if (remaining <= 0) {
        return { feasible: true, months: paymentsMade, interest: interestSum, rows };
      }

      while (remaining > 0 && paymentsMade < cap) {
        const step = advance();
        if (!step.feasible) {
          return { feasible: false };
        }
      }

      if (remaining > 0) {
        return { feasible: false };
      }

      return { feasible: true, months: paymentsMade, interest: interestSum, rows };
    }

    function buildSchedule(rows) {
      const tbody = els.scheduleBody;
      tbody.innerHTML = '';
      if (!rows.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.className = 'py-6 px-3 text-center text-gray-500';
        td.textContent = 'Enter loan details to generate the schedule.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      const limit = showFullSchedule ? rows.length : Math.min(rows.length, 12);
      rows.slice(0, limit).forEach((row) => {
        const tr = document.createElement('tr');
        if (row.type === 'lump') {
          tr.innerHTML = `
            <td class="py-2 px-3 text-left font-semibold text-blue-700">Lump @ ${row.index}</td>
            <td class="py-2 px-3 text-right text-gray-500">—</td>
            <td class="py-2 px-3 text-right text-gray-500">—</td>
            <td class="py-2 px-3 text-right text-gray-500">—</td>
            <td class="py-2 px-3 text-right font-semibold text-blue-700">${fmtCurrency(row.lump)}</td>
            <td class="py-2 px-3 text-right">${fmtCurrency(row.balance)}</td>
          `;
        } else {
          tr.innerHTML = `
            <td class="py-2 px-3 text-left">${row.index}</td>
            <td class="py-2 px-3 text-right">${fmtCurrency(row.payment)}</td>
            <td class="py-2 px-3 text-right">${fmtCurrency(row.interest)}</td>
            <td class="py-2 px-3 text-right">${fmtCurrency(row.principal)}</td>
            <td class="py-2 px-3 text-right text-gray-500">—</td>
            <td class="py-2 px-3 text-right">${fmtCurrency(row.balance)}</td>
          `;
        }
        tbody.appendChild(tr);
      });

      if (!showFullSchedule && rows.length > limit) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 6;
        td.className = 'py-3 px-3 text-center text-gray-500';
        td.textContent = `Showing the first ${limit} of ${rows.length} entries.`;
        tr.appendChild(td);
        tbody.appendChild(tr);
      }
    }

    function compute() {
      const okBalance = validateBalance();
      const okApr = validateApr();
      const okTerm = validateTerm();
      const okLump = validateLump();
      if (!okBalance || !okApr || !okTerm || !okLump) {
        els.statusPill.textContent = 'Fix validation errors';
        els.statusPill.className = 'result-pill bg-amber-100 text-amber-800';
        fullSchedule = [];
        buildSchedule(fullSchedule);
        return;
      }

      const balance = parseFloat(els.balance.value);
      const apr = parseFloat(els.apr.value);
      const years = parseFloat(els.termYears.value) || 0;
      const months = parseFloat(els.termMonths.value) || 0;
      const totalMonths = years * 12 + months;
      const lump = parseFloat(els.lumpSum.value) || 0;
      const startDate = parseStartDate(els.startMonth.value);
      const rate = (apr / 100) / 12;
      const monthlyPayment = computeMonthlyPayment(balance, rate, totalMonths);
      const baseline = simulateBaseline(balance, rate, monthlyPayment, totalMonths);

      if (!baseline.feasible) {
        els.paymentValue.textContent = fmtCurrency(monthlyPayment);
        els.baselineTermValue.textContent = 'Payment too low';
        els.baselineDateValue.textContent = 'Payoff date: —';
        els.baselineInterestValue.textContent = 'Baseline interest: —';
        els.newTermValue.textContent = '—';
        els.newDateValue.textContent = 'Payoff date: —';
        els.interestSavedValue.textContent = fmtCurrency(0);
        els.monthsSavedValue.textContent = '0';
        els.statusPill.textContent = 'Payment too low to amortize the loan';
        els.statusPill.className = 'result-pill bg-rose-100 text-rose-800';
        fullSchedule = [];
        buildSchedule(fullSchedule);
        return;
      }

      const { valid: paymentValid, paymentNumber } = validatePaymentNumber(baseline.months);
      if (!paymentValid) {
        els.statusPill.textContent = 'Fix validation errors';
        els.statusPill.className = 'result-pill bg-amber-100 text-amber-800';
        fullSchedule = [];
        buildSchedule(fullSchedule);
        return;
      }

      let scenario;
      if (lump <= 0) {
        scenario = { feasible: true, months: baseline.months, interest: baseline.interest, rows: baseline.rows };
      } else {
        scenario = simulateWithLump(balance, rate, monthlyPayment, lump, paymentNumber);
      }

      if (!scenario.feasible) {
        els.paymentValue.textContent = fmtCurrency(monthlyPayment);
        els.baselineTermValue.textContent = fmtTerm(baseline.months);
        els.baselineDateValue.textContent = `Payoff date: ${addMonths(startDate, baseline.months).toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
        els.baselineInterestValue.textContent = `Baseline interest: ${fmtCurrency(baseline.interest)}`;
        els.newTermValue.textContent = 'Payment too low';
        els.newDateValue.textContent = 'Payoff date: —';
        els.interestSavedValue.textContent = fmtCurrency(0);
        els.monthsSavedValue.textContent = '0';
        els.statusPill.textContent = 'Payment too low after applying the lump sum';
        els.statusPill.className = 'result-pill bg-rose-100 text-rose-800';
        fullSchedule = scenario.rows || [];
        buildSchedule(fullSchedule);
        return;
      }

      const interestSaved = Math.max(0, baseline.interest - scenario.interest);
      const monthsSaved = Math.max(0, baseline.months - scenario.months);
      const newPayoffDate = addMonths(startDate, scenario.months);
      const baselineDate = addMonths(startDate, baseline.months);

      els.paymentValue.textContent = fmtCurrency(monthlyPayment);
      els.baselineTermValue.textContent = fmtTerm(baseline.months);
      els.baselineDateValue.textContent = `Payoff date: ${baselineDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
      els.baselineInterestValue.textContent = `Baseline interest: ${fmtCurrency(baseline.interest)}`;
      els.newTermValue.textContent = fmtTerm(scenario.months);
      els.newDateValue.textContent = `Payoff date: ${newPayoffDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}`;
      els.interestSavedValue.textContent = fmtCurrency(interestSaved);
      els.monthsSavedValue.textContent = monthsSaved.toLocaleString();
      els.lumpEcho.textContent = fmtCurrency(lump);
      els.paymentNumberEcho.textContent = `Applied at payment #${paymentNumber}`;

      if (lump <= 0) {
        els.statusPill.textContent = 'No lump sum entered; baseline schedule shown';
        els.statusPill.className = 'result-pill bg-slate-100 text-slate-800';
      } else if (interestSaved > 0) {
        els.statusPill.textContent = `You save ${fmtCurrency(interestSaved)} and finish ${monthsSaved} month${monthsSaved === 1 ? '' : 's'} sooner`;
        els.statusPill.className = 'result-pill bg-emerald-100 text-emerald-800';
      } else {
        els.statusPill.textContent = 'Lump sum applied but no time or interest savings detected';
        els.statusPill.className = 'result-pill bg-slate-100 text-slate-800';
      }

      fullSchedule = scenario.rows;
      els.toggleSchedule.textContent = showFullSchedule ? 'Show first 12 entries' : 'Show full schedule';
      buildSchedule(fullSchedule);
    }

    function resetForm() {
      els.balance.value = 180000;
      els.apr.value = 6.25;
      els.termYears.value = 20;
      els.termMonths.value = 0;
      els.lumpSum.value = 0;
      els.paymentNumber.value = 1;
      const now = new Date();
      els.startMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

      setError(els.balance, els.balanceErr, '');
      setError(els.apr, els.aprErr, '');
      setError(els.termYears, els.termErr, '');
      setError(els.lumpSum, els.lumpErr, '');
      setError(els.paymentNumber, els.paymentNumberErr, '');

      showFullSchedule = false;
      els.toggleSchedule.textContent = 'Show full schedule';
      compute();
    }

    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      els.lastUpdated.textContent = today.toLocaleDateString('en-GB', { year: 'numeric', month: 'long', day: 'numeric' });
      const now = new Date();
      if (!els.startMonth.value) {
        els.startMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      }

      els.ui.addEventListener('input', () => compute());

      els.calculate.addEventListener('click', compute);
      els.reset.addEventListener('click', resetForm);
      els.example.addEventListener('click', () => {
        els.balance.value = 180000;
        els.apr.value = 6.25;
        els.termYears.value = 20;
        els.termMonths.value = 0;
        els.lumpSum.value = 15000;
        els.paymentNumber.value = 1;
        const now = new Date();
        els.startMonth.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        compute();
      });

      els.toggleSchedule.addEventListener('click', () => {
        if (!fullSchedule.length) return;
        showFullSchedule = !showFullSchedule;
        els.toggleSchedule.textContent = showFullSchedule ? 'Show first 12 entries' : 'Show full schedule';
        buildSchedule(fullSchedule);
      });

      compute();

      const toggle = $('mobile-menu-toggle');
      const menu = $('mobile-menu');
      toggle?.addEventListener('click', () => menu?.classList.toggle('hidden'));

      if (window.MathJax) {
        if (window.MathJax.typesetPromise) {
          window.MathJax.typesetPromise();
        } else if (window.MathJax.typeset) {
          window.MathJax.typeset();
        }
      }
    });
  </script>
</body>
</html>
