<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Meta -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pregnancy Calculator – Due Date, Gestational Age & Milestones</title>
  <meta name="description" content="Professional pregnancy calculator that estimates due date (EDD), current gestational age, and trimester milestones using LMP, conception/IVF, or ultrasound dating. WCAG 2.1 AA accessible." />
  <link rel="canonical" href="https://calcdomain.com/pregnancy-calculator.html" />
  <meta name="author" content="Ugo Candido" />
  <meta name="robots" content="index,follow,max-image-preview:large" />

  <!-- Icons / Manifest -->
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <!-- Fonts + Tailwind -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MathJax for LaTeX formulas -->
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    id="MathJax-script"></script>

  <style>
    :root { --focus-ring: #2563eb; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji','Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'; }
    .prose { max-width: 70ch; }
    .prose h2 { font-size: 1.5rem; font-weight: 700; margin-top: 2rem; margin-bottom: .75rem; }
    .prose h3 { font-size: 1.125rem; font-weight: 700; margin-top: 1.25rem; margin-bottom: .5rem; }
    .prose p, .prose li { line-height: 1.7; }
    .formula-box {
      background:#f3f4f6;border:1px solid #e5e7eb;border-radius:.75rem;padding:1rem;overflow-x:auto;
      font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    /* Visible focus (WCAG 2.4.7) */
    :is(button, a, input, select, details, summary, [role="tab"], [role="tablist"]):focus {
      outline: 3px solid var(--focus-ring);
      outline-offset: 2px;
    }
    /* Prevent CLS in results */
    #results-panel { min-height: 16rem; }
    /* Tooltip popover */
    .tooltip-panel { display:none; }
    .tooltip-panel[data-open="true"] { display:block; }
    /* Touch targets (48x48) */
    .touch-target { min-height:48px; min-width:48px; display:inline-flex; align-items:center; justify-content:center; }
    @media print {
      header, nav, aside, .no-print { display:none !important; }
      #print-section { display:block; }
    }
  </style>

  <!-- JSON-LD: WebPage -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"Pregnancy Calculator",
    "description":"Estimate due date (EDD), gestational age, and trimester milestones using LMP, conception/IVF, or ultrasound.",
    "url":"https://calcdomain.com/pregnancy-calculator.html",
    "inLanguage":"en",
    "author":{"@type":"Person","name":"Ugo Candido"},
    "publisher":{"@type":"Organization","name":"CalcDomain"}
  }
  </script>
  <!-- JSON-LD: Breadcrumbs -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://calcdomain.com/"},
      {"@type":"ListItem","position":2,"name":"Health & Fitness","item":"https://calcdomain.com/health-fitness.html"},
      {"@type":"ListItem","position":3,"name":"Health Metrics","item":"https://calcdomain.com/subcategories/health-metrics.html"},
      {"@type":"ListItem","position":4,"name":"Pregnancy Calculator","item":"https://calcdomain.com/pregnancy-calculator.html"}
    ]
  }
  </script>
  <!-- JSON-LD: HowTo -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"HowTo",
    "name":"How to calculate a pregnancy due date",
    "description":"Use one of three validated methods (LMP, conception/IVF, or ultrasound) to estimate EDD and current gestational age.",
    "step":[
      {"@type":"HowToStep","name":"Choose dating method","text":"Select LMP, Conception/IVF, or Ultrasound."},
      {"@type":"HowToStep","name":"Enter required details","text":"Provide dates and cycle length or scan gestational age."},
      {"@type":"HowToStep","name":"Review results","text":"See due date (EDD), gestational age today, trimester boundaries, and milestone windows."}
    ]
  }
  </script>
  <!-- JSON-LD: FAQPage -->
  <script type="application/ld+json" id="faq-jsonld">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {"@type":"Question","name":"Which method is most accurate for estimating due date?","acceptedAnswer":{"@type":"Answer","text":"Early first-trimester ultrasound (up to 13 weeks) is generally the most accurate for dating, followed by known conception/IVF dates, then LMP if cycles are regular."}},
      {"@type":"Question","name":"How does cycle length affect LMP-based due dates?","acceptedAnswer":{"@type":"Answer","text":"If your cycle differs from 28 days, EDD can be adjusted by using ovulation at cycle length minus 14 days, then adding 266 days to that ovulation date."}},
      {"@type":"Question","name":"Do IVF transfers have special rules?","acceptedAnswer":{"@type":"Answer","text":"Yes. For a 5-day blastocyst transfer, EDD is transfer date + 261 days; for a 3-day transfer, transfer date + 263 days."}},
      {"@type":"Question","name":"Why do different tools give slightly different dates?","acceptedAnswer":{"@type":"Answer","text":"Differences stem from rounding conventions, whether today is included, and how cycle length adjustments are applied."}},
      {"@type":"Question","name":"Can due dates change after an ultrasound?","acceptedAnswer":{"@type":"Answer","text":"Clinicians may revise EDD based on early ultrasound if it differs significantly from LMP-based estimates."}},
      {"@type":"Question","name":"What counts as full term?","acceptedAnswer":{"@type":"Answer","text":"Professional bodies define Early term: 37w0d–38w6d, Full term: 39w0d–40w6d, Late term: 41w0d–41w6d, Postterm: ≥42w."}}
    ]
  }
  </script>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- Header (non-sticky per specs) -->
  <header class="bg-white border-b">
    <nav class="container mx-auto px-4 lg:px-6 py-4 flex items-center justify-between">
      <a class="text-2xl font-bold text-blue-700 hover:text-blue-800" href="index.html">CalcDomain</a>
      <div class="hidden md:block">
        <a href="index.html#categories" class="text-sm text-gray-700 hover:text-blue-700">Categories</a>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 lg:px-6 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <section class="w-full lg:w-2/3">
        <!-- Breadcrumb -->
        <nav class="text-sm text-gray-600 mb-4" aria-label="Breadcrumb">
          <a href="index.html" class="hover:text-blue-700">Home</a> &raquo;
          <a href="health-fitness.html" class="hover:text-blue-700">Health &amp; Fitness</a> &raquo;
          <a href="subcategories/health-metrics.html" class="hover:text-blue-700">Health Metrics</a> &raquo;
          <span class="text-gray-900">Pregnancy Calculator</span>
        </nav>

        <!-- H1 -->
        <div id="print-section" class="bg-white p-6 rounded-xl shadow-sm">
          <h1 class="text-3xl font-extrabold text-gray-900 mb-2">pregnancy calculator</h1>
          <!-- Intro -->
          <p class="text-gray-700 mb-6">
            This professional pregnancy calculator estimates your due date (EDD), current gestational age, and trimester
            milestones using three validated methods: Last Menstrual Period (LMP), Conception/IVF, or Ultrasound dating.
            It’s designed for clear, accessible use and educational planning—always confirm dates with your clinician.
          </p>

          <!-- Calculator UI -->
          <section id="calculator" class="space-y-6" aria-labelledby="calc-heading">
            <h2 id="calc-heading" class="sr-only">Pregnancy calculator inputs</h2>

            <!-- Method Tabs -->
            <div role="tablist" aria-label="Dating method" class="grid grid-cols-1 sm:grid-cols-3 gap-2">
              <button role="tab" id="tab-lmp" aria-selected="true" aria-controls="panel-lmp"
                class="touch-target px-4 py-3 rounded-lg border border-blue-200 bg-blue-50 text-blue-800 font-semibold focus:outline-none"
                data-method="lmp">LMP</button>
              <button role="tab" id="tab-conception" aria-selected="false" aria-controls="panel-conception"
                class="touch-target px-4 py-3 rounded-lg border border-gray-300 bg-white text-gray-800 font-semibold focus:outline-none"
                data-method="conception">Conception / IVF</button>
              <button role="tab" id="tab-ultrasound" aria-selected="false" aria-controls="panel-ultrasound"
                class="touch-target px-4 py-3 rounded-lg border border-gray-300 bg-white text-gray-800 font-semibold focus:outline-none"
                data-method="ultrasound">Ultrasound</button>
            </div>

            <!-- Panels -->
            <div id="panel-lmp" role="tabpanel" aria-labelledby="tab-lmp" class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="lmpDate" class="block text-sm font-medium text-gray-800">First day of last period <span class="text-red-600" aria-hidden="true">*</span></label>
                <div class="flex items-start gap-2">
                  <input type="date" id="lmpDate" required aria-required="true" aria-describedby="lmpDate_error lmp_tip"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-600 focus:ring-2 focus:ring-blue-200" />
                  <button type="button" class="touch-target px-2 rounded-md border border-gray-300 text-gray-700"
                    aria-expanded="false" aria-controls="lmp_tip" data-tooltip="lmp_tip" aria-label="What is LMP?">?</button>
                </div>
                <p id="lmp_tip" class="tooltip-panel mt-2 text-sm text-gray-700" role="note">
                  LMP = first day you saw menstrual flow, not spotting. For irregular cycles consider ultrasound dating.
                </p>
                <p id="lmpDate_error" class="mt-2 text-sm text-red-700"></p>
              </div>

              <div>
                <label for="cycleLen" class="block text-sm font-medium text-gray-800">Usual cycle length (days)</label>
                <div class="flex items-start gap-2">
                  <input type="number" id="cycleLen" inputmode="numeric" min="20" max="45" step="1" value="28"
                    aria-describedby="cycleLen_error cycle_tip"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-600 focus:ring-2 focus:ring-blue-200" />
                  <button type="button" class="touch-target px-2 rounded-md border border-gray-300 text-gray-700"
                    aria-expanded="false" aria-controls="cycle_tip" data-tooltip="cycle_tip" aria-label="Cycle length help">?</button>
                </div>
                <p id="cycle_tip" class="tooltip-panel mt-2 text-sm text-gray-700" role="note">
                  Default is 28 days. If your cycle differs, the ovulation day is approximated as (cycle length − 14).
                </p>
                <p id="cycleLen_error" class="mt-2 text-sm text-red-700"></p>
              </div>
            </div>

            <div id="panel-conception" role="tabpanel" aria-labelledby="tab-conception" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="conceptionDate" class="block text-sm font-medium text-gray-800">Conception date <span class="text-red-600" aria-hidden="true">*</span></label>
                <input type="date" id="conceptionDate" aria-required="true" aria-describedby="conceptionDate_error conception_tip"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-600 focus:ring-2 focus:ring-blue-200" />
                <p id="conception_tip" class="mt-2 text-sm text-gray-700">If unknown, use the midpoint of your fertile window or the day of a positive ovulation test.</p>
                <p id="conceptionDate_error" class="mt-2 text-sm text-red-700"></p>
              </div>

              <div>
                <label for="ivfType" class="block text-sm font-medium text-gray-800">IVF transfer (optional)</label>
                <select id="ivfType" aria-describedby="ivf_tip"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-600 focus:ring-2 focus:ring-blue-200">
                  <option value="none" selected>No IVF</option>
                  <option value="day3">3-day embryo transfer</option>
                  <option value="day5">5-day blastocyst transfer</option>
                </select>
                <p id="ivf_tip" class="mt-2 text-sm text-gray-700">For IVF, use the actual transfer date as the “conception date” and the calculator will apply the correct offset.</p>
              </div>
            </div>

            <div id="panel-ultrasound" role="tabpanel" aria-labelledby="tab-ultrasound" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6">
              <div class="md:col-span-1">
                <label for="scanDate" class="block text-sm font-medium text-gray-800">Ultrasound date <span class="text-red-600" aria-hidden="true">*</span></label>
                <input type="date" id="scanDate" aria-required="true" aria-describedby="scanDate_error"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-600 focus:ring-2 focus:ring-blue-200" />
                <p id="scanDate_error" class="mt-2 text-sm text-red-700"></p>
              </div>
              <div>
                <label for="gaWeeks" class="block text-sm font-medium text-gray-800">GA at scan – weeks <span class="text-red-600" aria-hidden="true">*</span></label>
                <input type="number" id="gaWeeks" inputmode="numeric" min="4" max="42" step="1" value="8"
                  aria-required="true" aria-describedby="gaWeeks_error ga_tip"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-600 focus:ring-2 focus:ring-blue-200" />
                <p id="gaWeeks_error" class="mt-2 text-sm text-red-700"></p>
              </div>
              <div>
                <label for="gaDays" class="block text-sm font-medium text-gray-800">GA at scan – extra days</label>
                <input type="number" id="gaDays" inputmode="numeric" min="0" max="6" step="1" value="0"
                  aria-describedby="gaDays_error ga_tip"
                  class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:border-blue-600 focus:ring-2 focus:ring-blue-200" />
                <p id="gaDays_error" class="mt-2 text-sm text-red-700"></p>
              </div>
              <p id="ga_tip" class="md:col-span-3 text-sm text-gray-700">Enter the gestational age (weeks+days) provided by the sonographer.</p>
            </div>

            <!-- Actions -->
            <div class="flex flex-wrap items-center gap-3 pt-2">
              <button id="calcBtn" class="touch-target px-5 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 focus:outline-none">
                Calculate
              </button>
              <button id="resetBtn" class="touch-target px-5 py-3 rounded-lg bg-gray-100 text-gray-900 font-semibold border border-gray-300 hover:bg-gray-200 focus:outline-none">
                Reset
              </button>
              <div class="text-sm text-gray-600" id="statusMsg" role="status" aria-live="polite"></div>
            </div>
          </section>

          <!-- Results -->
          <section id="results" class="mt-8" aria-labelledby="results-heading">
            <h2 id="results-heading" class="sr-only">Results</h2>
            <div id="results-panel" class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-blue-50 border border-blue-100 rounded-xl p-4">
              <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
                <h3 class="text-sm font-semibold text-gray-600">Estimated Due Date (EDD)</h3>
                <p id="edd" class="text-2xl font-extrabold text-blue-700 mt-1">—</p>
                <p id="eddRange" class="text-xs text-gray-500 mt-1">Typical window: —</p>
              </div>
              <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
                <h3 class="text-sm font-semibold text-gray-600">Gestational Age Today</h3>
                <p id="gaToday" class="text-2xl font-extrabold text-blue-700 mt-1">—</p>
                <p id="daysToEDD" class="text-xs text-gray-500 mt-1">Days to EDD: —</p>
              </div>
              <div class="bg-white border border-gray-200 rounded-lg p-4 text-center">
                <h3 class="text-sm font-semibold text-gray-600">Trimester & Milestones</h3>
                <p id="trimester" class="text-lg font-bold text-blue-700 mt-1">—</p>
                <p id="milestones" class="text-xs text-gray-600 mt-1">—</p>
              </div>
            </div>

            <details class="mt-4 bg-white border border-gray-200 rounded-lg p-4">
              <summary class="font-semibold text-gray-800 cursor-pointer">Key dates & windows (auto-generated)</summary>
              <div id="keyDates" class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-gray-800">
                <!-- Filled by JS -->
              </div>
            </details>
          </section>
        </div>

        <!-- Content Ecosystem -->
        <article class="bg-white p-6 rounded-xl shadow-sm mt-8 prose">
          <h2>Data Source & Methodology</h2>
          <p><strong>AuthoritativeDataSource:</strong></p>
          <ul>
            <li><a class="text-blue-700 hover:underline" href="https://www.acog.org/clinical/clinical-guidance/committee-opinion/articles/2017/05/methods-for-estimating-the-due-date" rel="nofollow noopener" target="_blank">ACOG Committee Opinion – Methods for Estimating the Due Date (2017, reaffirmed)</a></li>
            <li><a class="text-blue-700 hover:underline" href="https://www.nice.org.uk/guidance/cg62" rel="nofollow noopener" target="_blank">NICE (UK) – Antenatal Care: Dating pregnancy (CG62)</a></li>
          </ul>
          <p><em>Tutti i calcoli si basano rigorosamente sulle formule e sui dati forniti da questa fonte.</em></p>

          <h2>The Formula Explained</h2>
          <div class="formula-box" aria-label="Formulas">
            <p><strong>LMP method (Naegele’s rule, 28-day cycle):</strong></p>
            <p>$$ \mathrm{EDD} = \mathrm{LMP} + 280 \ \text{days} $$</p>
            <p><strong>Adjusted for cycle length \(C\) (days):</strong></p>
            <p>Ovulation \(= \mathrm{LMP} + (C - 14)\) days; then $$ \mathrm{EDD} = \mathrm{Ovulation} + 266 \ \text{days}. $$</p>
            <p><strong>Conception known:</strong> $$ \mathrm{EDD} = \mathrm{Conception} + 266 \ \text{days}. $$</p>
            <p><strong>IVF transfers:</strong> 3-day: \( \mathrm{EDD} = \mathrm{Transfer} + 263\ \text{days} \) ; 5-day: \( \mathrm{EDD} = \mathrm{Transfer} + 261\ \text{days} \).</p>
            <p><strong>Ultrasound dating:</strong> Given scan date \(D_s\) and gestational age at scan \(GA_s\) (days),</p>
            <p>$$ \mathrm{EDD} = D_s + (280 - GA_s)\ \text{days}. $$</p>
          </div>

          <h2>Glossary of Variables</h2>
          <ul>
            <li><strong>LMP</strong>: First day of the last menstrual period.</li>
            <li><strong>Cycle length (C)</strong>: Days from first day of one period to the day before the next (default 28).</li>
            <li><strong>Conception/Transfer date</strong>: Date of fertilization or embryo transfer (IVF).</li>
            <li><strong>EDD</strong>: Estimated Due Date.</li>
            <li><strong>GA</strong>: Gestational Age in weeks+days since LMP-based start.</li>
          </ul>

          <h2>How It Works: A Step-by-Step Example</h2>
          <p><strong>Scenario:</strong> LMP = 2025-02-01, cycle length = 30 days.</p>
          <ol>
            <li>Approximate ovulation = LMP + (30 − 14) = 2025-02-17.</li>
            <li>EDD = ovulation + 266 days = 2025-11-10.</li>
            <li>On 2025-10-30 (today), GA ≈ 37w4d, approaching early term (≥37w0d).</li>
          </ol>

          <h2>Frequently Asked Questions</h2>
          <details>
            <summary>Which method is most accurate?</summary>
            <p>First-trimester ultrasound is generally most precise. Known conception/IVF is also reliable. LMP assumes regular ovulation timing.</p>
          </details>
          <details>
            <summary>My cycles are irregular—what should I use?</summary>
            <p>Prefer ultrasound dating. If using LMP, understand the margin of error may be higher.</p>
          </details>
          <details>
            <summary>Why is the EDD a single day if birth rarely happens that day?</summary>
            <p>EDD is the center of a normal distribution; most births occur within ±2 weeks of the EDD.</p>
          </details>
          <details>
            <summary>Can the due date change after a later scan?</summary>
            <p>Professionals avoid changing EDD after reliable early ultrasound unless the discrepancy is large.</p>
          </details>
          <details>
            <summary>What are term categories?</summary>
            <p>Early term: 37w0d–38w6d; Full term: 39w0d–40w6d; Late term: 41w0d–41w6d; Postterm: ≥42w.</p>
          </details>
          <details>
            <summary>Is this medical advice?</summary>
            <p>No. This tool is educational and should not replace professional clinical judgment.</p>
          </details>

          <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700">
            <p><strong>Tool developed by Ugo Candido.</strong> Content medically reviewed by the CalcDomain Editorial Board.<br>
            Last accuracy review: <time datetime="2025-10-30">October 30, 2025</time></p>
          </div>
        </article>
      </section>

      <!-- Sidebar -->
      <aside class="w-full lg:w-1/3">
        <div class="sticky top-24 space-y-6">
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg mb-2">Why this calculator is different</h3>
            <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
              <li>Three validated methods (LMP, Conception/IVF, Ultrasound) with cycle-length adjustment.</li>
              <li>WCAG 2.1 AA accessibility, clear inline validation, and keyboard-friendly UI.</li>
              <li>Auto-generated trimester windows and milestone dates you can print or save.</li>
            </ul>
          </div>
          <div class="bg-gray-200 h-72 rounded-xl flex items-center justify-center text-gray-600 no-print">
            Ad Slot (300×600)
          </div>
          <div class="bg-white p-6 rounded-xl shadow-sm">
            <h3 class="font-bold text-lg mb-2">Related health tools</h3>
            <ul class="space-y-2 text-sm">
              <li><a class="text-blue-700 hover:underline" href="ovulation-calculator.html">Ovulation Calculator</a></li>
              <li><a class="text-blue-700 hover:underline" href="bmi-calculator.html">BMI Calculator</a></li>
              <li><a class="text-blue-700 hover:underline" href="due-date-by-ultrasound.html">EDD by Ultrasound</a></li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="bg-white border-t">
    <div class="container mx-auto px-6 py-8 text-center text-gray-600 text-sm">
      <p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
      <div class="mt-3 space-x-4">
        <a href="about.html" class="hover:text-blue-700">About</a>
        <a href="contact.html" class="hover:text-blue-700">Contact</a>
        <a href="privacy.html" class="hover:text-blue-700">Privacy</a>
        <a href="terms.html" class="hover:text-blue-700">Terms</a>
      </div>
    </div>
  </footer>

  <!-- Calculator Logic (defer) -->
  <script defer>
  (function(){
    // Utilities
    const $ = (id) => document.getElementById(id);
    const fmt = new Intl.DateTimeFormat(undefined, { weekday:'short', year:'numeric', month:'short', day:'numeric' });
    const fmtShort = new Intl.DateTimeFormat(undefined, { year:'numeric', month:'short', day:'numeric' });
    const today = () => new Date(new Date().toDateString()); // strip time
    const addDays = (d, n) => { const x = new Date(d); x.setDate(x.getDate() + n); return x; };
    const diffDays = (a, b) => Math.round((a - b) / 86400000);
    const clamp = (v, min, max) => Math.min(max, Math.max(min, v));

    // Tabs
    const tabs = Array.from(document.querySelectorAll('[role="tab"]'));
    const panels = {
      lmp: $('panel-lmp'),
      conception: $('panel-conception'),
      ultrasound: $('panel-ultrasound')
    };

    function activateTab(method){
      tabs.forEach(t => {
        const sel = t.dataset.method === method;
        t.setAttribute('aria-selected', sel ? 'true' : 'false');
        t.className = sel
          ? "touch-target px-4 py-3 rounded-lg border border-blue-200 bg-blue-50 text-blue-800 font-semibold focus:outline-none"
          : "touch-target px-4 py-3 rounded-lg border border-gray-300 bg-white text-gray-800 font-semibold focus:outline-none";
      });
      Object.entries(panels).forEach(([k, el]) => {
        if (k === method) { el.classList.remove('hidden'); }
        else { el.classList.add('hidden'); }
      });
      $('statusMsg').textContent = '';
      clearErrors();
      // Focus first input in panel for keyboard users
      const first = panels[method].querySelector('input, select, button');
      if (first) first.focus();
    }

    tabs.forEach(t => t.addEventListener('click', () => activateTab(t.dataset.method)));

    // Tooltips
    document.querySelectorAll('[data-tooltip]').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-tooltip');
        const panel = $(id);
        const open = panel.getAttribute('data-open') === 'true';
        panel.setAttribute('data-open', open ? 'false' : 'true');
        btn.setAttribute('aria-expanded', open ? 'false' : 'true');
      });
    });

    // Validation helpers
    function setError(id, msg){
      const el = $(id + '_error');
      if (el) { el.textContent = msg || ''; }
    }
    function clearErrors(){
      ['lmpDate','cycleLen','conceptionDate','scanDate','gaWeeks','gaDays']
        .forEach(id => setError(id, ''));
    }

    // Inline validation on blur
    [['lmpDate', v => !!v, 'Please enter the first day of your last period.'],
     ['cycleLen', v => (v === '' || (v>=20 && v<=45)), 'Cycle length must be between 20 and 45 days.'],
     ['conceptionDate', v => !!v, 'Please enter your conception or transfer date.'],
     ['scanDate', v => !!v, 'Please enter the ultrasound date.'],
     ['gaWeeks', v => (v!=='' && v>=4 && v<=42), 'Enter weeks between 4 and 42.'],
     ['gaDays', v => (v==='' || (v>=0 && v<=6)), 'Extra days must be 0–6.']
    ].forEach(([id, rule, msg]) => {
      const input = $(id);
      if (!input) return;
      input.addEventListener('blur', () => setError(id, rule(input.value) ? '' : msg));
    });

    // Core calculations
    function calcEDDByLMP(lmp, cycleLen){
      // Default Naegele: LMP + 280. If cycle differs, approximate ovulation at C-14, then +266.
      if (!lmp) return null;
      const C = cycleLen ? Number(cycleLen) : 28;
      if (!C || isNaN(C)) return addDays(lmp, 280);
      const ovulationOffset = C - 14;
      const ovulationDate = addDays(lmp, ovulationOffset);
      return addDays(ovulationDate, 266);
    }
    function calcEDDByConception(conception, ivfType){
      if (!conception) return null;
      if (ivfType === 'day3') return addDays(conception, 263);
      if (ivfType === 'day5') return addDays(conception, 261);
      return addDays(conception, 266);
    }
    function calcEDDByUltrasound(scanDate, gaWeeks, gaDays){
      if (!scanDate || gaWeeks==='' ) return null;
      const daysGA = Number(gaWeeks) * 7 + (Number(gaDays)||0);
      return addDays(scanDate, 280 - daysGA);
    }

    function describeTrimester(gaDays){
      const w = Math.floor(gaDays/7), d = gaDays%7;
      let tri = '—';
      if (gaDays < 13*7 + 6) tri = 'First trimester';
      else if (gaDays < 27*7) tri = 'Second trimester';
      else tri = 'Third trimester';
      return { tri, label: `${w}w${d}d` };
    }

    function buildMilestones(edd){
      const firstTriEnd = addDays(edd, - (280 - (13*7 + 6)) ); // 13w6d
      const secondTriStart = addDays(edd, - (280 - 14*7) );
      const secondTriEnd = addDays(edd, - (280 - 27*7) );
      const thirdTriStart = addDays(edd, - (280 - 28*7) );
      const earlyTermStart = addDays(edd, - (280 - 37*7) );
      const fullTermStart = addDays(edd, - (280 - 39*7) );
      const lateTermStart = addDays(edd, - (280 - 41*7) );
      const postTermStart = addDays(edd, - (280 - 42*7) );
      const anatomyStart = addDays(edd, - (280 - 18*7) );
      const anatomyEnd   = addDays(edd, - (280 - 22*7) );
      return {
        firstTriEnd, secondTriStart, secondTriEnd, thirdTriStart,
        earlyTermStart, fullTermStart, lateTermStart, postTermStart,
        anatomyStart, anatomyEnd
      };
    }

    function renderKeyDates(edd){
      const c = $('keyDates');
      c.innerHTML = '';
      const m = buildMilestones(edd);
      const items = [
        ['EDD (estimated due date)', edd],
        ['Early term begins (37w0d)', m.earlyTermStart],
        ['Full term begins (39w0d)', m.fullTermStart],
        ['Late term begins (41w0d)', m.lateTermStart],
        ['Postterm (42w0d)', m.postTermStart],
        ['First trimester ends (13w6d)', m.firstTriEnd],
        ['Second trimester starts (14w0d)', m.secondTriStart],
        ['Second trimester ends (27w6d)', m.secondTriEnd],
        ['Third trimester starts (28w0d)', m.thirdTriStart],
        ['Anatomy scan window (18–22w)', `${fmtShort.format(m.anatomyStart)} → ${fmtShort.format(m.anatomyEnd)}`]
      ];
      for (const [label, val] of items){
        const div = document.createElement('div');
        div.className = "border border-gray-200 rounded-md p-3 bg-gray-50";
        const value = (val instanceof Date) ? fmtShort.format(val) : val;
        div.innerHTML = `<div class="text-xs text-gray-600">${label}</div><div class="font-semibold text-gray-900">${value}</div>`;
        c.appendChild(div);
      }
    }

    function updateResults(edd){
      if (!edd){ $('edd').textContent='—'; $('gaToday').textContent='—'; $('trimester').textContent='—';
        $('milestones').textContent='—'; $('eddRange').textContent='Typical window: —'; $('daysToEDD').textContent='Days to EDD: —'; $('keyDates').innerHTML=''; return; }

      const t = today();
      $('edd').textContent = fmt.format(edd);
      // Typical delivery window ±14 days
      $('eddRange').textContent = `Typical window: ${fmtShort.format(addDays(edd,-14))} – ${fmtShort.format(addDays(edd,14))}`;
      const daysLeft = diffDays(edd, t);
      $('daysToEDD').textContent = `Days to EDD: ${daysLeft}`;

      // GA today from EDD: GA = 280 - (EDD - today)
      const gaDays = clamp(280 - diffDays(edd, t), 0, 45*7); // cap
      const desc = describeTrimester(gaDays);
      $('gaToday').textContent = desc.label;
      $('trimester').textContent = desc.tri;
      $('milestones').textContent = daysLeft >= 0 ? 'Keep regular antenatal care and kick counts as advised.' : 'EDD passed—clinical follow-up recommended.';

      renderKeyDates(edd);
    }

    // Read inputs and calculate
    function handleCalculate(){
      clearErrors();
      const active = tabs.find(t => t.getAttribute('aria-selected') === 'true')?.dataset.method || 'lmp';
      let edd = null;

      if (active === 'lmp'){
        const lmpStr = $('lmpDate').value;
        if (!lmpStr){ setError('lmpDate', 'Please enter the first day of your last period.'); $('statusMsg').textContent='Fix errors and try again.'; return; }
        const C = $('cycleLen').value ? Number($('cycleLen').value) : 28;
        if ($('cycleLen').value && (C < 20 || C > 45)) { setError('cycleLen','Cycle length must be between 20 and 45 days.'); $('statusMsg').textContent='Fix errors and try again.'; return; }
        edd = calcEDDByLMP(new Date(lmpStr), C);
      }

      if (active === 'conception'){
        const concStr = $('conceptionDate').value;
        if (!concStr){ setError('conceptionDate','Please enter your conception or transfer date.'); $('statusMsg').textContent='Fix errors and try again.'; return; }
        edd = calcEDDByConception(new Date(concStr), $('ivfType').value);
      }

      if (active === 'ultrasound'){
        const ds = $('scanDate').value, gw = $('gaWeeks').value, gd = $('gaDays').value || 0;
        if (!ds){ setError('scanDate','Please enter the ultrasound date.'); $('statusMsg').textContent='Fix errors and try again.'; return; }
        if (gw==='' || Number(gw)<4 || Number(gw)>42) { setError('gaWeeks','Enter weeks between 4 and 42.'); $('statusMsg').textContent='Fix errors and try again.'; return; }
        if (gd!=='' && (Number(gd)<0 || Number(gd)>6)) { setError('gaDays','Extra days must be 0–6.'); $('statusMsg').textContent='Fix errors and try again.'; return; }
        edd = calcEDDByUltrasound(new Date(ds), Number(gw), Number(gd));
      }

      updateResults(edd);
      $('statusMsg').textContent = edd ? 'Results updated.' : 'Unable to compute with the current inputs.';
    }

    // Events
    $('calcBtn').addEventListener('click', handleCalculate);
    $('resetBtn').addEventListener('click', () => {
      // Clear inputs and results
      ['lmpDate','conceptionDate','scanDate'].forEach(id => { const el=$(id); if (el) el.value=''; });
      $('cycleLen').value = 28;
      $('ivfType').value = 'none';
      $('gaWeeks').value = 8; $('gaDays').value = 0;
      updateResults(null);
      $('statusMsg').textContent = 'Cleared.';
    });

    // Default tab
    activateTab('lmp');
    updateResults(null);
  })();
  </script>
</body>
</html>
