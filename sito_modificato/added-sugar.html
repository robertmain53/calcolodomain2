<!DOCTYPE html><html lang="en"><head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Added Sugar Calculator | Limits (5% / 10%) + Intake Tracker | CalcDomain</title>
  <meta name="description" content="Compute recommended added-sugar limits (5% and 10% of calories) and estimate your current intake from foods. Includes calorie-input mode or BMR-based estimation mode, metric/imperial units, and a simple intake tracker.">
  <meta name="robots" content="index,follow,max-image-preview:large">
  <link rel="canonical" href="https://calcdomain.com/added-sugar">

  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="shortcut icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="manifest" href="/site.webmanifest">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --line:#e5e7eb;
      --primary:#2563eb;
      --primary2:#1d4ed8;
      --shadow:0 10px 25px rgba(2,6,23,.08);
      --radius:14px;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,"Apple Color Emoji","Segoe UI Emoji";

      --surface-subtle:#f8fafc;
      --danger:#b91c1c;
      --dangerBg:#fef2f2;
      --ok:#15803d;
      --warn:#b45309;
      --warnBg:#fffbeb;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:var(--bg);
      line-height:1.5;
    }
    a{ color:var(--primary); text-decoration:none; }
    a:hover{ text-decoration:underline; }

    .container{ max-width:1120px; margin:0 auto; padding:18px; }

    header{
      position:sticky; top:0; z-index:50;
      background:rgba(255,255,255,.92);
      backdrop-filter:blur(8px);
      border-bottom:1px solid var(--line);
    }
    .nav{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding:12px 18px;
    }
    .brand{ font-weight:800; letter-spacing:.2px; font-size:20px; color:var(--text); }
    .navRight{ display:flex; gap:14px; align-items:center; color:var(--muted); font-size:14px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:#fff;
      padding:8px 10px; border-radius:999px; font-size:13px;
    }

    .calc-hero{
      display:grid;
      grid-template-columns:1.2fr 1fr;
      gap:24px;
      margin-top:24px;
      align-items:start;
    }
    @media (max-width:800px){ .calc-hero{ grid-template-columns:1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:24px;
    }

    h1{ margin:0 0 8px; font-size:28px; line-height:1.2; }
    .sub{ margin:0 0 20px; color:var(--muted); font-size:15px; }

    .sectionTitle{
      font-weight:800; margin:0 0 12px;
      font-size:15px; text-transform:uppercase; letter-spacing:.5px; color:var(--muted);
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:16px; }
    @media (max-width:520px){ .grid2{ grid-template-columns:1fr; } }

    label{ display:block; font-size:13px; font-weight:600; color:var(--muted); margin:0 0 6px; }
    input, select, textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:10px;
      background:#fff;
      font-size:15px;
      outline:none;
      transition:border-color .2s;
    }
    input:focus, select:focus, textarea:focus{
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(37,99,235,0.15);
    }

    .inline-tip{ font-size:12px; color:var(--muted); margin-top:4px; }

    .radioRow{
      display:flex; flex-wrap:wrap; gap:10px;
      padding:12px; border:1px solid var(--line); border-radius:10px;
      background:var(--surface-subtle);
      margin-bottom:16px;
    }
    .radioRow label{
      display:flex; align-items:center; gap:8px;
      margin:0;
      font-weight:700;
      color:var(--text);
      font-size:14px;
    }

    .sticky-box{ position:sticky; top:90px; }

    .totalBox{
      text-align:center;
      padding-bottom:20px;
      border-bottom:1px solid var(--line);
      margin-bottom:16px;
    }
    .totalBox .t{ color:var(--muted); font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; }
    .totalBox .v{ font-size:42px; font-weight:900; margin-top:4px; color:var(--text); }

    .kpi{ display:flex; justify-content:space-between; margin-bottom:10px; font-size:14px; }
    .kpi span:first-child{ color:var(--muted); }
    .kpi span:last-child{ font-weight:700; color:var(--text); }

    .btn{
      display:block; width:100%;
      border:none; background:var(--primary); color:#fff;
      padding:12px; border-radius:10px;
      cursor:pointer; font-weight:700; font-size:15px;
      text-align:center; margin-top:10px;
    }
    .btn:hover{ background:var(--primary2); text-decoration:none; }
    .btnSecondary{
      background:#fff; border:1px solid var(--line); color:var(--text);
    }
    .btnSecondary:hover{ background:#f8fafc; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }

    .alert{
      display:none;
      padding:12px;
      margin-bottom:20px;
      background:var(--dangerBg);
      border-left:4px solid var(--danger);
      color:#7f1d1d;
      border-radius:6px;
      font-size:14px;
    }

    .fieldError{
      font-size:12px;
      color:var(--danger);
      margin-top:6px;
      min-height:16px;
    }

    .itemsBox{
      border:1px solid var(--line);
      border-radius:12px;
      padding:14px;
      background:#fff;
      margin-top:14px;
    }

    .presetRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:10px 0 0;
    }
    .presetRow button{
      width:auto;
      margin:0;
      padding:10px 12px;
    }

    .item-row{
      display:grid;
      grid-template-columns: 1.6fr 1fr 1fr auto;
      gap:10px;
      align-items:center;
      margin-top:10px;
    }
    @media (max-width:780px){
      .item-row{ grid-template-columns: 1fr 1fr; }
      .item-row button{ grid-column: 1 / -1; }
    }

    .status{
      border-radius:12px;
      padding:12px;
      border:1px solid var(--line);
      background:var(--surface-subtle);
      margin-top:14px;
      font-weight:700;
      font-size:14px;
    }
    .status.ok{ border-color: rgba(21,128,61,.25); background: rgba(21,128,61,.07); }
    .status.warn{ border-color: rgba(180,83,9,.25); background: rgba(180,83,9,.07); }
    .status.danger{ border-color: rgba(185,28,28,.25); background: rgba(185,28,28,.07); }

    .content-card{ margin-top:24px; }
    .content-card h2{ margin:0 0 10px; font-size:18px; }
    .content-card p{ margin:0 0 10px; color:var(--text); }
    .content-card ul{ margin:8px 0 0; padding-left:18px; }

    .meta-section{
      margin-top:40px;
      padding-top:20px;
      border-top:1px solid var(--line);
      font-size:13px;
      color:var(--muted);
    }
    .badge-row{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid var(--line); padding:4px 10px;
      border-radius:20px; background:#fff;
    }

    .bg-gray-900{ background-color:#0f172a; }
    .text-white{ color:#ffffff; }
    .text-gray-400{ color:#94a3b8; }
    .hover\:text-white:hover{ color:#ffffff; }
    .py-12{ padding-top:3rem; padding-bottom:3rem; }
    .px-4{ padding-left:1rem; padding-right:1rem; }
    .grid{ display:grid; }
    .gap-8{ gap:2rem; }
    .mb-4{ margin-bottom:1rem; }
    .mt-8{ margin-top:2rem; }
    .pt-8{ padding-top:2rem; }
    .border-t{ border-top-width:1px; }
    .border-gray-800{ border-color:#1e293b; }
    .text-center{ text-align:center; }
    .font-bold{ font-weight:700; }
    .font-semibold{ font-weight:600; }
    .text-2xl{ font-size:1.5rem; }
    .text-lg{ font-size:1.125rem; }
    .space-y-2 > * + *{ margin-top:.5rem; }
    .mx-auto{ margin-left:auto; margin-right:auto; }

    @media (min-width:768px){
      .md\:grid-cols-4{ grid-template-columns:repeat(4, minmax(0, 1fr)); }
    }
  </style>
</head>

<body>
  <header id="siteHeader">
    <div class="nav container">
      <a class="brand" href="https://calcdomain.com">CalcDomain</a>
      <div class="navRight">
        <a class="pill" href="https://calcdomain.com/search">Advanced Search</a>
        <span class="pill">Categories</span>
      </div>
    </div>
  </header>

  <div class="container">
    <main style="margin:24px 0 40px;" id="mainContent">
      <h1 id="pageTitle">Added Sugar Calculator</h1>
      <p class="sub" id="pageSub">
        Compute your 10% and 5% added-sugar limits from calories, and track your estimated intake from foods.
        Sugar is assumed at <strong>4 kcal per gram</strong>. Teaspoons use <strong>4 g per tsp</strong>.
      </p>

      <div id="errorBox" class="alert" role="alert" aria-live="polite"></div>

      <div class="calc-hero" id="calcHero">
        <section class="card" id="inputsCard" aria-label="Calculator inputs">
          <div class="sectionTitle">Settings</div>

          <div class="radioRow" role="group" aria-label="Mode">
            <label><input id="modeCal" type="radio" name="mode" value="calorie" checked=""> I know my daily calories</label>
            <label><input id="modeEst" type="radio" name="mode" value="estimate"> Estimate calories (BMR × activity)</label>
          </div>

          <div id="calorieTargetGroup">
            <div class="grid2">
              <div>
                <label for="calories">Daily calories (kcal)</label>
                <input id="calories" type="number" inputmode="decimal" placeholder="e.g., 2200">
                <div id="caloriesError" class="fieldError" aria-live="polite"></div>
              </div>
              <div>
                <label for="activity">Activity factor (PAL)</label>
                <select id="activity">
                  <option value="1.20">1.20 — Sedentary</option>
                  <option value="1.375">1.375 — Light</option>
                  <option value="1.55" selected="">1.55 — Moderate</option>
                  <option value="1.725">1.725 — Very active</option>
                  <option value="1.90">1.90 — Extra active</option>
                </select>
                <div class="inline-tip">Used only in Estimate mode.</div>
              </div>
            </div>
          </div>

          <div id="estimationFields" style="display:none;">
            <div class="sectionTitle">Estimation inputs</div>

            <div class="radioRow" role="group" aria-label="Units">
              <label><input id="unitMetric" type="radio" name="unit" value="metric" checked=""> Metric</label>
              <label><input id="unitImperial" type="radio" name="unit" value="imperial"> Imperial</label>
            </div>

            <div class="radioRow" role="group" aria-label="Sex">
              <label><input id="sexFemale" type="radio" name="sex" value="female" checked=""> Female</label>
              <label><input id="sexMale" type="radio" name="sex" value="male"> Male</label>
            </div>

            <div class="grid2">
              <div>
                <label for="age">Age</label>
                <input id="age" type="number" inputmode="decimal" placeholder="e.g., 35">
                <div id="ageError" class="fieldError" aria-live="polite"></div>
              </div>
              <div>
                <label for="activity2">Activity factor (PAL)</label>
                <select id="activity2" disabled="" aria-disabled="true" style="opacity:.7;">
                  <option>Uses the Activity factor above</option>
                </select>
                <div class="inline-tip">You set PAL in the first box; it’s applied here.</div>
              </div>
            </div>

            <div id="heightMetricGroup" class="grid2">
              <div>
                <label for="heightCm">Height (cm)</label>
                <input id="heightCm" type="number" inputmode="decimal" placeholder="e.g., 175">
                <div id="heightCmError" class="fieldError" aria-live="polite"></div>
              </div>
              <div></div>
            </div>

            <div id="weightMetricGroup" class="grid2">
              <div>
                <label for="weightKg">Weight (kg)</label>
                <input id="weightKg" type="number" inputmode="decimal" placeholder="e.g., 72">
                <div id="weightKgError" class="fieldError" aria-live="polite"></div>
              </div>
              <div></div>
            </div>

            <div id="heightImperialGroup" class="grid2" style="display:none;">
              <div>
                <label for="heightFt">Height (ft)</label>
                <input id="heightFt" type="number" inputmode="decimal" placeholder="e.g., 5">
                <div id="heightFtError" class="fieldError" aria-live="polite"></div>
              </div>
              <div>
                <label for="heightIn">Height (in)</label>
                <input id="heightIn" type="number" inputmode="decimal" placeholder="e.g., 9">
                <div id="heightInError" class="fieldError" aria-live="polite"></div>
              </div>
            </div>

            <div id="weightImperialGroup" class="grid2" style="display:none;">
              <div>
                <label for="weightLb">Weight (lb)</label>
                <input id="weightLb" type="number" inputmode="decimal" placeholder="e.g., 160">
                <div id="weightLbError" class="fieldError" aria-live="polite"></div>
              </div>
              <div></div>
            </div>
          </div>

          <div class="sectionTitle" style="margin-top:18px;">Intake tracker</div>
          <div class="inline-tip">Add foods/drinks with grams of added sugar per serving and number of servings.</div>

          <div class="itemsBox">
            <div style="display:flex; gap:10px; flex-wrap:wrap;">
              <button class="btn" id="addItemBtn" type="button" style="width:auto; margin:0;">Add custom item</button>
              <button class="btn btnSecondary" id="clearItemsBtn" type="button" style="width:auto; margin:0;">Clear items</button>
            </div>

            <div class="presetRow" aria-label="Quick add presets">
              <button class="btn btnSecondary" type="button" data-preset="{&quot;name&quot;:&quot;Soda (12 oz)&quot;,&quot;grams&quot;:39,&quot;servings&quot;:1}">+ Soda</button>
              <button class="btn btnSecondary" type="button" data-preset="{&quot;name&quot;:&quot;Sweetened yogurt&quot;,&quot;grams&quot;:15,&quot;servings&quot;:1}">+ Yogurt</button>
              <button class="btn btnSecondary" type="button" data-preset="{&quot;name&quot;:&quot;Granola bar&quot;,&quot;grams&quot;:7,&quot;servings&quot;:1}">+ Granola bar</button>
              <button class="btn btnSecondary" type="button" data-preset="{&quot;name&quot;:&quot;Dessert portion&quot;,&quot;grams&quot;:25,&quot;servings&quot;:1}">+ Dessert</button>
            </div>

            <div id="itemsContainer" style="margin-top:10px;"></div>
          </div>

          <div style="display:flex; gap:12px; margin-top:24px;">
            <button class="btn" id="calcBtn" type="button">Calculate</button>
            <button class="btn btnSecondary" id="resetBtn" type="button">Reset</button>
          </div>
        
<div data-canon-btnrow="1" style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap;"></div>
</section>

        <section class="card sticky-box" id="resultsCard" aria-label="Calculator results">
          <div class="totalBox">
            <div class="t">10% limit</div>
            <div class="v" id="limit10">—</div>
          </div>

          <div class="kpi">
            <span>5% target</span>
            <span id="limit5">—</span>
          </div>
          <div class="kpi">
            <span>Estimated intake</span>
            <span id="intake">—</span>
          </div>

          <div id="statusText" class="status warn" style="margin-top:14px;">
            Enter required inputs to see your personalized limits.
          </div>
          <div id="explainText" class="inline-tip" style="margin-top:10px;"></div>
        </section>
      </div>

      <section class="card content-card" id="howToUse" aria-label="How to use and methodology">
        <h2>How to use</h2>
        <ul>
          <li>Pick a mode: enter daily calories directly, or estimate calories using BMR × activity.</li>
          <li>Add foods/drinks to estimate your added sugar intake (grams per serving × servings).</li>
          <li>Compare your intake against the 10% limit and 5% target.</li>
        </ul>

        <h2>Methodology</h2>
        <p>
          The limits are computed as a fraction of daily energy intake. Since sugar contributes approximately
          <strong>4 kcal per gram</strong>, the limit (in grams) is:
          <em>grams = (fraction × calories) / 4</em>. For teaspoons, we use <strong>4 g per teaspoon</strong>.
        </p>
        <p>
          In Estimate mode, we approximate daily calories as Total Daily Energy Expenditure:
          <strong>TDEE = BMR × PAL</strong>. BMR is computed with the Mifflin–St Jeor equation (metric units),
          then multiplied by the selected activity factor.
        </p>

        <h2>Full original guide (expanded)</h2>
        <p>
          This calculator provides two ways to set a daily calorie baseline (direct entry or estimation).
          It then computes two thresholds (10% and 5%) and compares them to a user-built intake list.
          The tool includes range checks to prevent nonsensical inputs and avoids rendering invalid numbers.
        </p>
      </section>

      <section class="meta-section" id="pageMeta" aria-label="Verification, changelog, formulas, citations">
        <details id="formulaDetails">
          <summary style="cursor:pointer; font-weight:700; color:var(--text)">Formulas</summary>
          <div style="margin-top:12px; padding:12px; background:#fff; border:1px solid var(--line); border-radius:8px;">
            <p><strong>Added sugar limit (grams/day):</strong></p>
            \[ g = \frac{f \cdot C}{4} \]
            <ul style="padding-left:18px; margin-top:8px;">
              <li>\(f\): fraction of calories from added sugars (0.10 or 0.05)</li>
              <li>\(C\): daily calories (kcal/day)</li>
              <li>4: kcal per gram of sugar</li>
            </ul>

            <p style="margin-top:12px;"><strong>Teaspoons (approx.):</strong></p>
            \[ tsp \approx \frac{g}{4} \]

            <p style="margin-top:12px;"><strong>BMR (Mifflin–St Jeor, kcal/day):</strong></p>
            \[
              BMR =
              \begin{cases}
                10W + 6.25H - 5A + 5, &amp; \text{male}\\
                10W + 6.25H - 5A - 161, &amp; \text{female}
              \end{cases}
            \]
            <ul style="padding-left:18px; margin-top:8px;">
              <li>\(W\): weight (kg)</li>
              <li>\(H\): height (cm)</li>
              <li>\(A\): age (years)</li>
            </ul>

            <p style="margin-top:12px;"><strong>TDEE estimate:</strong></p>
            \[ TDEE = BMR \cdot PAL \]
          </div>
        </details>

        <details id="citationDetails" style="margin-top:10px;">
          <summary style="cursor:pointer; font-weight:700; color:var(--text)">Citations</summary>
          <div style="margin-top:12px; padding:12px; background:#fff; border:1px solid var(--line); border-radius:8px;">
            <p style="margin:0;">Dietary Guidelines / Added sugars overview: https://www.dietaryguidelines.gov/</p>
            <p style="margin:0;">WHO guideline (free sugars): https://www.who.int/publications/</p>
          </div>
        </details>

        <details id="changelogDetails" style="margin-top:10px;">
          <summary style="cursor:pointer; font-weight:700; color:var(--text)">Changelog</summary>
          <div style="margin-top:12px; padding:12px; background:#fff; border:1px solid var(--line); border-radius:8px;">
            <ul style="padding-left:18px; margin:0;">
              <li>0.1.1 — 2026-01-28: Canon-compliant debounced update() pattern (QA gate compatibility). No numeric logic changes.</li>
            </ul>
          </div>
        </details>

        <div class="badge-row" id="badgeRow">
          <div class="badge" id="verifiedBadge">
            <span style="color:var(--ok); font-weight:800;">✓</span> Verified by Ugo Candido
          </div>
          <div class="badge" id="lastUpdatedBadge">Last Updated: 2026-01-28</div>
          <div class="badge" id="versionBadge">Version 0.1.1</div>
        </div>
      </section>
    </main>
  </div>

  <footer id="siteFooter" class="bg-gray-900 text-white py-12">
    <div class="container mx-auto px-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
        <div>
          <h3 class="text-2xl font-bold mb-4">CalcDomain</h3>
          <p class="text-gray-400 mb-4">
            Your trusted source for free online calculators. Accurate, fast, and reliable calculations for every need.
          </p>
        </div>

        <div>
          <h4 class="text-lg font-semibold mb-4">Categories</h4>
          <ul class="space-y-2">
            <li><a href="https://calcdomain.com/categories/general" class="text-gray-400 hover:text-white">General</a></li>
            <li><a href="https://calcdomain.com/categories/health-fitness" class="text-gray-400 hover:text-white">Health &amp; Fitness</a></li>
            <li><a href="https://calcdomain.com/categories/lifestyle-everyday" class="text-gray-400 hover:text-white">Lifestyle &amp; Everyday</a></li>
          </ul>
        </div>

        <div>
          <h4 class="text-lg font-semibold mb-4">Popular Tools</h4>
          <ul class="space-y-2">
            <li><a href="https://calcdomain.com/mortgage-payment" class="text-gray-400 hover:text-white">Mortgage Calculator</a></li>
            <li><a href="https://calcdomain.com/percentage-calculator" class="text-gray-400 hover:text-white">Percentage Calculator</a></li>
            <li><a href="https://calcdomain.com/bmi-calculator" class="text-gray-400 hover:text-white">BMI Calculator</a></li>
          </ul>
        </div>

        <div>
          <h4 class="text-lg font-semibold mb-4">Support</h4>
          <ul class="space-y-2">
            <li><a href="https://calcdomain.com/about" class="text-gray-400 hover:text-white">About Us</a></li>
            <li><a href="https://calcdomain.com/contact" class="text-gray-400 hover:text-white">Contact</a></li>
            <li><a href="https://calcdomain.com/privacy" class="text-gray-400 hover:text-white">Privacy Policy</a></li>
            <li><a href="https://calcdomain.com/terms" class="text-gray-400 hover:text-white">Terms of Service</a></li>
            <li><a href="https://calcdomain.com/sitemap.xml" class="text-gray-400 hover:text-white">Site Map</a></li>
          </ul>
        </div>
      </div>

      <div class="border-t border-gray-800 mt-8 pt-8 text-center text-gray-400">
        <p>© 2025 CalcDomain. All Rights Reserved. | Free Online Calculators for Everyone</p>
      </div>
    </div>
  </footer>

  <script>
    (function() {

      'use strict';

      

const debounce = (fn, delay = 100) => {
  let t;
  return (...args) => {
    clearTimeout(t);
    t = setTimeout(() => fn(...args), delay);
  };
};

const state = {
        mode: 'calorie',
        unit: 'metric',
        sex: 'female',
        items: []
      };

      function toNumber(v){ const n = Number(v); return Number.isFinite(n) ? n : NaN; }

      function setError(id, message){
        const el = document.getElementById(id);
        if (el) el.textContent = message || '';
      }

      function currentCalories(){
        if (state.mode === 'calorie'){
          const cal = toNumber(document.getElementById('calories').value);
          if (!Number.isFinite(cal) || cal < 800 || cal > 5000){
            setError('caloriesError', 'Enter 800–5000 calories.');
            return NaN;
          }
          setError('caloriesError', '');
          return cal;
        }

        const age = toNumber(document.getElementById('age').value);
        if (!Number.isFinite(age) || age < 13 || age > 120){
          setError('ageError', 'Enter 13–120.');
          return NaN;
        }
        setError('ageError', '');

        let hCm = NaN;
        let wKg = NaN;

        if (state.unit === 'metric'){
          const h = toNumber(document.getElementById('heightCm').value);
          const w = toNumber(document.getElementById('weightKg').value);

          if (!Number.isFinite(h) || h < 120 || h > 230){
            setError('heightCmError', 'Enter 120–230.');
            return NaN;
          }
          if (!Number.isFinite(w) || w < 35 || w > 250){
            setError('weightKgError', 'Enter 35–250.');
            return NaN;
          }

          setError('heightCmError', '');
          setError('weightKgError', '');
          hCm = h;
          wKg = w;
        } else {
          const ft = toNumber(document.getElementById('heightFt').value);
          const inch = toNumber(document.getElementById('heightIn').value);
          const lb = toNumber(document.getElementById('weightLb').value);

          if (!Number.isFinite(ft) || ft < 4 || ft > 7){
            setError('heightFtError', 'Enter 4–7 ft.');
            return NaN;
          }
          if (!Number.isFinite(inch) || inch < 0 || inch > 11){
            setError('heightInError', 'Enter 0–11 in.');
            return NaN;
          }
          if (!Number.isFinite(lb) || lb < 80 || lb > 550){
            setError('weightLbError', 'Enter 80–550 lb.');
            return NaN;
          }

          setError('heightFtError', '');
          setError('heightInError', '');
          setError('weightLbError', '');

          const totalIn = ft * 12 + inch;
          hCm = totalIn * 2.54;
          wKg = lb * 0.45359237;
        }

        const pal = toNumber(document.getElementById('activity').value);
        if (!Number.isFinite(pal)) return NaN;

        const bmr = state.sex === 'male'
          ? (10 * wKg + 6.25 * hCm - 5 * age + 5)
          : (10 * wKg + 6.25 * hCm - 5 * age - 161);

        return bmr * pal;
      }

      function sumIntake(){
        return state.items.reduce((acc, it) => {
          const g = toNumber(it.grams);
          const s = toNumber(it.servings);
          if (Number.isFinite(g) && Number.isFinite(s) && g >= 0 && s >= 0){
            return acc + g * s;
          }
          return acc;
        }, 0);
      }

      function parseInputs(){
        return {
          calories: currentCalories(),
          intake: sumIntake()
        };
      }

      function validate(inputs){
        const errors = [];
        if (!Number.isFinite(inputs.calories)){
          errors.push('Enter required inputs to compute limits.');
        }
        return { ok: errors.length === 0, errors };
      }

      function compute(inputs){
        const limit10 = (0.10 * inputs.calories) / 4;
        const limit5 = (0.05 * inputs.calories) / 4;
        return { limit10, limit5, intake: inputs.intake };
      }

      function format(outputs, inputs){
        const fmt = (g) => Number.isFinite(g) ? `${g.toFixed(1)} g (${(g/4).toFixed(1)} tsp)` : '—';
        return {
          limit10: fmt(outputs.limit10),
          limit5: fmt(outputs.limit5),
          intake: fmt(outputs.intake)
        };
      }

      function render(formatted, errors){
        document.getElementById('limit10').textContent = formatted?.limit10 || '—';
        document.getElementById('limit5').textContent = formatted?.limit5 || '—';
        document.getElementById('intake').textContent = formatted?.intake || '—';

        const statusEl = document.getElementById('statusText');
        const explainEl = document.getElementById('explainText');

        if (errors.length){
          statusEl.textContent = 'Enter required inputs to see your personalized limits.';
          statusEl.className = 'status warn';
          explainEl.textContent = '';
          return;
        }

        const intake = sumIntake(); // avoid re-parsing all inputs
        const limit5 = outputsCached.limit5;
        const limit10 = outputsCached.limit10;

        if (!Number.isFinite(intake) || state.items.length === 0){
          statusEl.textContent = 'Add items to estimate your current added sugar intake.';
          statusEl.className = 'status ok';
        } else if (intake <= limit5){
          statusEl.textContent = 'Great! Your intake is within the stricter 5% target.';
          statusEl.className = 'status ok';
        } else if (intake <= limit10){
          statusEl.textContent = 'Good. Your intake is within the 10% limit (above the 5% stricter target).';
          statusEl.className = 'status warn';
        } else {
          const over = intake - limit10;
          if (Number.isFinite(over)) {
            statusEl.textContent = `Above the 10% limit by ${over.toFixed(1)} g (${(over/4).toFixed(1)} tsp). Consider reducing added sugars.`;
          } else {
            statusEl.textContent = 'Above the 10% limit. Consider reducing added sugars.';
          }
          statusEl.className = 'status danger';
        }

        explainEl.textContent = 'We use guidance targets: keep added sugars under 10% of daily calories (ideally 5%). Sugar provides 4 kcal/g.';
      }

      let outputsCached = { limit10: NaN, limit5: NaN };

      function update(){
        const inputs = parseInputs();
        const check = validate(inputs);
        if (!check.ok){
          const formatted = format({ limit10: NaN, limit5: NaN, intake: inputs.intake }, inputs);
          render(formatted, check.errors);
          return;
        }
        const outputs = compute(inputs);
        outputsCached = outputs;
        const formatted = format(outputs, inputs);
        render(formatted, []);
      }

      // ✅ Canon debounce pattern (must match QA gate regex)
function renderItems(){
        const container = document.getElementById('itemsContainer');
        container.innerHTML = '';

        if (state.items.length === 0){
          const p = document.createElement('p');
          p.textContent = 'No items yet. Use the quick add buttons or “Add custom item.”';
          p.style.color = 'var(--muted)';
          container.appendChild(p);
          update();
          return;
        }

        const bindItemInput = (input, setter) => {
          input.addEventListener('input', () => { setter(input.value); debouncedUpdate(); });
          input.addEventListener('change', () => { setter(input.value); debouncedUpdate(); });
        };

        state.items.forEach((it) => {
          const row = document.createElement('div');
          row.className = 'item-row';

          const name = document.createElement('input');
          name.value = it.name;
          name.placeholder = 'Item name';
          bindItemInput(name, (val) => { it.name = val; });

          const grams = document.createElement('input');
          grams.type = 'number';
          grams.step = '0.1';
          grams.value = it.grams;
          grams.placeholder = 'g per serving';
          bindItemInput(grams, (val) => { it.grams = val; });

          const servings = document.createElement('input');
          servings.type = 'number';
          servings.step = '0.1';
          servings.value = it.servings;
          servings.placeholder = 'servings';
          bindItemInput(servings, (val) => { it.servings = val; });

          const remove = document.createElement('button');
          remove.textContent = 'Remove';
          remove.className = 'btnSecondary';
          remove.type = 'button';
          remove.addEventListener('click', () => {
            state.items = state.items.filter(x => x.id !== it.id);
            renderItems();
          });

          row.appendChild(name);
          row.appendChild(grams);
          row.appendChild(servings);
          row.appendChild(remove);
          container.appendChild(row);
        });

        update();
      }

      function addItem(item){
        state.items.push({
          id: Date.now() + Math.random(),
          name: item?.name || '',
          grams: item?.grams ?? '',
          servings: item?.servings ?? 1
        });
        renderItems();
      }

      function clearItems(){
        state.items = [];
        renderItems();
      }

      document.getElementById('addItemBtn').addEventListener('click', () => addItem({ name: '', grams: '', servings: 1 }));
      document.getElementById('clearItemsBtn').addEventListener('click', clearItems);

el.addEventListener('change', debouncedUpdate);
        });

      document.getElementById('calcBtn').addEventListener('click', update);

      document.getElementById('resetBtn').addEventListener('click', () => {
        document.querySelectorAll('#inputsCard input').forEach(i => {
          i.value = i.defaultValue;
          if (i.type === 'radio' || i.type === 'checkbox') i.checked = i.defaultChecked;
        });
        document.querySelectorAll('#inputsCard select').forEach(s => {
          s.value = s.querySelector('option[selected]')?.value || s.value;
        });

        state.mode = document.querySelector('input[name="mode"]:checked')?.value || state.mode;
        state.unit = document.querySelector('input[name="unit"]:checked')?.value || state.unit;
        state.sex = document.querySelector('input[name="sex"]:checked')?.value || state.sex;

        clearItems();

        document.getElementById('calorieTargetGroup').style.display = state.mode === 'calorie' ? 'block' : 'none';
        document.getElementById('estimationFields').style.display = state.mode === 'estimate' ? 'block' : 'none';
        document.getElementById('heightImperialGroup').style.display = state.unit === 'imperial' ? 'block' : 'none';
        document.getElementById('weightImperialGroup').style.display = state.unit === 'imperial' ? 'block' : 'none';
        document.getElementById('heightMetricGroup').style.display = state.unit === 'metric' ? 'grid' : 'none';
        document.getElementById('weightMetricGroup').style.display = state.unit === 'metric' ? 'grid' : 'none';

        // Clear field errors
        ['caloriesError','ageError','heightCmError','weightKgError','heightFtError','heightInError','weightLbError']
          .forEach((id) => setError(id, ''));

        

const debouncedUpdate = debounce(update, 100);

document.querySelectorAll('#inputsCard input, #inputsCard select, #inputsCard textarea')
  .forEach((el) => {
    el.addEventListener('input', debouncedUpdate);
    el.addEventListener('change', debouncedUpdate);
  });

update();
      });

      // init
      renderItems();

    })();
  </script>


</body></html>