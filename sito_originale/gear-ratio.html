<!DOCTYPE html>
<html lang="en"><head>
<link rel="canonical" href="https://calcdomain.com/gear-ratio">





 
<link rel="icon" type="image/png" href="https://calcdomain.com/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="https://calcdomain.com/favicon.svg" />
<link rel="shortcut icon" href="https://calcdomain.com/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="https://calcdomain.com/apple-touch-icon.png" />
<link rel="manifest" href="https://calcdomain.com/site.webmanifest" />
<meta charset="utf-8">
<title>Gear Ratio Calculator | Engineering Mechanical Tool</title>
<meta content="width=device-width, initial-scale=1" name="viewport">
<meta content="Professional gear ratio calculator. Compute single or multi‑stage gear ratios, output speed, torque, direction, and overall efficiency. Built for mechanical engineers, makers, and students." name="description">
<meta content="Ugo Candido" name="author">

<meta content="#ffffff" name="theme-color">
<style>
    :root{
      --primary:#005A9C; --secondary:#003F6E; --accent:#00A4E4;
      --bg:#F8F9FA; --surface:#FFFFFF;
      --text:#212529; --muted:#6C757D; --border:#DEE2E6;
      --success:#198754; --error:#DC3545;
      --radius:12px; --radius-sm:8px;
      --tt:48px; /* min touch target */
      --shadow:0 2px 10px rgba(0,0,0,.06);
      --focus:0 0 0 3px rgba(0,90,156,.25);
      --container:1200px;
    }
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:.01ms !important; transition-duration:.01ms !important; scroll-behavior:auto !important;}
    }
    *{box-sizing:border-box}
    html{font-size:16px}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--text); line-height:1.6; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:var(--primary); text-decoration:none}
    a:hover{text-decoration:underline}
    a:focus{outline:3px solid var(--primary); outline-offset:2px; border-radius:4px}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
    .skip-link{position:absolute; top:-40px; left:8px; background:var(--primary); color:#fff; padding:8px 12px; border-radius:0 0 6px 6px; z-index:1000}
    .skip-link:focus{top:0}
    header{
      background:var(--surface); border-bottom:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    .container{max-width:var(--container); margin:0 auto; padding:0 1rem}
    .header-inner{
      display:grid; grid-template-columns:auto 1fr auto; gap:1rem; align-items:center; padding:.75rem 0;
    }
    .logo{font-weight:700; font-size:1.1rem; color:var(--secondary)}
    .site-search{display:flex; align-items:center; gap:.5rem; width:100%}
    .site-search input{
      width:100%; padding:.7rem .9rem; border:1px solid var(--border); border-radius:10px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      min-height:var(--tt); min-width:var(--tt); padding:.75rem 1rem; border-radius:10px;
      border:1px solid transparent; cursor:pointer; font-weight:600; background:var(--primary); color:#fff;
    }
    .btn.secondary{background:transparent; color:var(--primary); border-color:var(--primary)}
    .btn.ghost{background:transparent; color:var(--secondary); border-color:var(--border)}
    .btn:focus{outline:3px solid var(--primary); outline-offset:2px}
    nav ul{display:flex; gap:.75rem; list-style:none; padding:0; margin:0}
    nav a{display:inline-block; padding:.5rem .6rem; border-radius:8px}
    main{padding:1.25rem 0 3rem}
    .breadcrumb{font-size:.9rem; color:var(--muted); margin-bottom:.75rem}
    .breadcrumb a{color:inherit}
    h1{font-size:clamp(1.6rem,4vw,2.2rem); margin:.25rem 0 .5rem; color:var(--secondary)}
    h2{font-size:clamp(1.25rem,3.2vw,1.6rem); color:var(--secondary); margin:2rem 0 .75rem}
    h3{font-size:1.1rem; color:var(--secondary); margin:1.25rem 0 .5rem}
    .layout{
      display:grid; grid-template-columns:1fr; gap:1.5rem;
    }
    @media (min-width: 992px){
      .layout{grid-template-columns:420px 1fr}
    }
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius);
      padding:1.25rem; box-shadow:var(--shadow)
    }
    .calculator .form-group{margin-bottom:1rem}
    label{display:inline-flex; align-items:center; gap:.5rem; font-weight:700; margin-bottom:.4rem}
    .hint{font-size:.9rem; color:var(--muted)}
    .input{width:100%; min-height:var(--tt); padding:.7rem .9rem; border:1px solid var(--border); border-radius:10px}
    .input:focus{outline:none; box-shadow:var(--focus); border-color:var(--primary)}
    .input[aria-invalid="true"]{border-color:var(--error)}
    .error{color:var(--error); font-size:.9rem; margin-top:.25rem; min-height:1.2em}
    .inline{
      display:grid; grid-template-columns:1fr 1fr; gap:.75rem;
    }
    .inline-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:.75rem}
    .input-affix{position:relative}
    .affix{
      position:absolute; right:.75rem; top:50%; transform:translateY(-50%); color:var(--muted); pointer-events:none;
    }
    .toolbar{display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; margin-bottom:.5rem}
    .stage{
      border:1px solid var(--border); border-radius:10px; padding:1rem; margin-bottom:.75rem; background:#fff;
    }
    .stage-header{display:flex; align-items:center; gap:.5rem; justify-content:space-between; margin-bottom:.75rem}
    .stage-title{font-weight:700; color:var(--secondary)}
    .stage-controls{display:flex; gap:.5rem; align-items:center}
    .select{min-height:var(--tt); padding:.6rem .9rem; border:1px solid var(--border); border-radius:10px; background:#fff}
    .select:focus{outline:none; box-shadow:var(--focus); border-color:var(--primary)}
    .tooltip{
      display:none; margin-top:.25rem; background:#F1F5F9; border:1px solid #CBD5E1; color:#0F172A;
      border-radius:8px; padding:.6rem .75rem; font-size:.92rem;
    }
    .tooltip[aria-hidden="false"]{display:block}
    .help{
      width:var(--tt); min-height:var(--tt); border-radius:10px; border:1px solid var(--border);
      background:#fff; color:var(--secondary)
    }
    .results{
      margin-top:1rem; background:#F6F8FA; border:1px solid var(--border); border-radius:10px; padding:1rem; min-height:240px;
    }
    .result-row{display:flex; justify-content:space-between; gap:1rem; padding:.5rem 0; border-bottom:1px solid var(--border)}
    .result-row:last-child{border-bottom:none}
    .result-label{color:var(--muted)}
    .result-value{font-weight:800; color:var(--success)}
    .formula{background:#EFF2F6; border:1px solid #d9e1ea; border-radius:10px; padding:1rem; overflow:auto}
    ul{padding-left:1.1rem}
    .faq h3{margin-top:1rem}
    footer{background:var(--secondary); color:#fff; padding:2rem 0; margin-top:2.5rem}
    footer a{color:#fff}
  </style>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "Gear Ratio Calculator",
  "description": "Compute single or multi-stage gear ratios, output speed, torque, direction, and efficiency. Built for mechanical engineers, makers, and students.",
  "url": "https://calcdomain.com/gear-ratio",
  "inLanguage": "en",
  "author": {
    "@type": "Person",
    "name": "Ugo Candido"
  },
  "publisher": {
    "@type": "Organization",
    "name": "CalcDomain"
  },
  "mainEntity": [
    {
      "@type": "HowTo",
      "name": "How It Works: A Step-by-Step Example",
      "description": "A two-stage example showing how to compute the overall ratio, output speed, torque, and direction.",
      "step": [
        {
          "@type": "HowToStep",
          "name": "Stage inputs",
          "text": "Stage 1: driver 20 teeth, driven 60 teeth. Stage 2: driver 18 teeth, driven 54 teeth. Per-stage efficiency 98%."
        },
        {
          "@type": "HowToStep",
          "name": "Compute each ratio",
          "text": "i1 = 60/20 = 3.0, i2 = 54/18 = 3.0."
        },
        {
          "@type": "HowToStep",
          "name": "Overall ratio",
          "text": "i_total = i1 × i2 = 9.0. Since there are two meshes, direction is not reversed."
        },
        {
          "@type": "HowToStep",
          "name": "Speed and torque",
          "text": "If input speed is 1500 rpm and torque is 2.0 N·m: n_out = 1500/9 = 166.67 rpm. η_total = 0.98 × 0.98 = 0.9604. T_out = 2.0 × 9 × 0.9604 ≈ 17.29 N·m."
        }
      ]
    },
    {
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "What is a gear ratio?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "The gear ratio is the ratio of the angular speeds or tooth counts of two meshing gears. It equals driven teeth divided by driver teeth."
          }
        },
        {
          "@type": "Question",
          "name": "How do I know if the output direction reverses?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "For external gear meshes, each mesh flips rotation. An odd number of meshes reverses the direction; an even number keeps it the same."
          }
        },
        {
          "@type": "Question",
          "name": "Can I use diameters instead of teeth?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Yes. Ratio also equals the driven pitch diameter divided by the driver pitch diameter when using standard gears with equal module/DP."
          }
        },
        {
          "@type": "Question",
          "name": "How does efficiency affect torque?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Real gears have losses. Output torque equals input torque times the overall ratio times the overall efficiency (product of per-stage efficiencies)."
          }
        },
        {
          "@type": "Question",
          "name": "What about idler gears?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Idlers change direction but not the magnitude of the overall ratio. Only teeth counts of the first driver and final driven matter for the net ratio if intermediate gears are idlers."
          }
        },
        {
          "@type": "Question",
          "name": "Does this account for belts or chains?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "You can approximate belt or chain stages using pulley/sprocket tooth counts or pitch diameters—the same ratio relations apply. Efficiency may differ from gear meshes."
          }
        }
      ]
    }
  ]
}
  </script>
<!-- MathJax for LaTeX rendering (deferred, non-blocking) -->
<script defer="" id="mathjax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="search.js" defer></script>
<!-- MathJax for LaTeX formulas -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\(','\)'], ['$', '$']],
      displayMath: [['$','$'], ['\[','\]']]
    },
    svg: { fontCache: 'global' }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link rel="preload" href="https://calcdomain.com/assets/js/mobile-menu.js" as="script">
<link rel="preload" href="https://calcdomain.com/assets/js/page-enhancements.js" as="script">

</head>
<body>

<a class="skip-link" href="#main">Skip to main content</a>
<header role="banner">
<div class="container header-inner">
CalcDomain
<form aria-label="Site-wide" class="site-search" role="search">
<label class="sr-only" for="q">Search calculators</label>
<input aria-label="Search calculators" autocomplete="off" id="q" name="q" placeholder="Search calculators…" type="search">
<button aria-label="Submit search" class="btn secondary" type="submit">Search</button>
</form>
<nav aria-label="Main navigation">
<ul>
<li><a href="https://calcdomain.com/engineering">Engineering</a></li>
<li><a href="https://calcdomain.com/math">Math</a></li>
<li><a href="https://calcdomain.com/science">Science</a></li>
</ul>
</nav>
</div>
</header>
<main class="container" id="main" role="main">
<nav aria-label="Breadcrumb" class="breadcrumb">
Home / <a href="https://calcdomain.com/engineering">Engineering</a> / <a href="https://calcdomain.com/subcategories/mechanical-engineering">Mechanical</a> / Gear Ratio Calculator
    </nav>
<div class="layout">
<aside aria-labelledby="calculator-heading" class="card calculator">
<h1 id="calculator-heading">Gear Ratio Calculator</h1>
<p class="hint">Instantly compute single or multi-stage gear ratios, output speed, torque, direction, and overall efficiency.</p>
<div class="form-group">
<div class="inline">
<div>
<label for="inputSpeed">Input speed (RPM) *</label>
<div class="input-affix">
<input aria-describedby="speedHelp speedErr" aria-required="true" class="input" id="inputSpeed" inputmode="decimal" min="0" placeholder="e.g., 1500" step="any" type="number">
<span class="affix">rpm</span>
</div>
<div class="hint" id="speedHelp">Rotational speed of the driver shaft.</div>
<div aria-live="polite" class="error" id="speedErr" role="alert"></div>
</div>
<div>
<label for="inputTorque">Input torque *</label>
<div class="inline">
<div class="input-affix">
<input aria-describedby="torqueHelp torqueErr" aria-required="true" class="input" id="inputTorque" inputmode="decimal" min="0" placeholder="e.g., 2.5" step="any" type="number">
<span aria-hidden="true" class="affix"></span>
</div>
<select aria-label="Torque unit" class="select" id="torqueUnit">
<option value="Nm">N·m</option>
<option value="lbft">lb·ft</option>
</select>
</div>
<div class="hint" id="torqueHelp">Driver shaft torque. Choose unit.</div>
<div aria-live="polite" class="error" id="torqueErr" role="alert"></div>
</div>
</div>
</div>
<div aria-label="Stages toolbar" class="toolbar" role="group">
<button class="btn" id="addStage" type="button">+ Add stage</button>
<button class="btn ghost" id="resetForm" type="button">Reset</button>
<div aria-live="polite" class="hint" id="stageCountText">1 stage</div>
</div>
<div aria-label="Gear stages list" id="stagesContainer">
<!-- Stage templates injected here -->
</div>
<div class="form-group">
<div class="inline">
<div>
<label for="effMode">Efficiency mode</label>
<select aria-describedby="effModeHelp" class="select" id="effMode">
<option value="per">Per-stage efficiencies</option>
<option value="global">Single global efficiency</option>
</select>
<div class="hint" id="effModeHelp">Choose how efficiency is handled in calculations.</div>
</div>
<div hidden="" id="globalEffWrap">
<label for="globalEff">Global efficiency (%)</label>
<div class="input-affix">
<input aria-describedby="globalEffErr" class="input" id="globalEff" inputmode="decimal" max="100" min="0" step="any" type="number" value="95">
<span class="affix">%</span>
</div>
<div aria-live="polite" class="error" id="globalEffErr" role="alert"></div>
</div>
</div>
</div>
<section aria-labelledby="results-heading" class="results">
<h2 id="results-heading">Results</h2>
<div class="result-row">
<div class="result-label">Overall gear ratio</div>
<div aria-live="polite" class="result-value" id="ratioDisplay">—</div>
</div>
<div class="result-row">
<div class="result-label">Output speed</div>
<div aria-live="polite" class="result-value" id="speedOutDisplay">—</div>
</div>
<div class="result-row">
<div class="result-label">Output torque</div>
<div aria-live="polite" class="result-value" id="torqueOutDisplay">—</div>
</div>
<div class="result-row">
<div class="result-label">Overall efficiency</div>
<div aria-live="polite" class="result-value" id="effDisplay">—</div>
</div>
<div class="result-row">
<div class="result-label">Output direction</div>
<div aria-live="polite" class="result-value" id="directionDisplay">—</div>
</div>
</section>
</aside>
<article aria-labelledby="content-heading" class="card content">
<h2 id="content-heading">Authoritative reference, formulas, and guidance</h2>
<p>This gear ratio calculator helps mechanical engineers, technicians, makers, cyclists, and students quickly determine the overall ratio of single or multi‑stage gear trains, estimate output speed and torque, and understand direction changes and efficiency losses.</p>
<section>
<h2>Data Source and Methodology</h2>
<p>
            Authoritative Data Source: Shigley’s Mechanical Engineering Design, 11th Edition (2019), McGraw‑Hill. See Chapter on Gears: Kinematics and Power Transmission.
            <a href="https://www.mheducation.com/" rel="nofollow noopener" target="_blank">Publisher link</a>.
          </p>
<p>
            Secondary Reference: Machinery’s Handbook, 31st Edition (2020), Industrial Press — sections on gear kinematics and proportions.
            <a href="https://www.industrialpress.com/machinerys-handbook-31st-edition" rel="nofollow noopener" target="_blank">Publisher link</a>.
          </p>
<p><strong>All calculations strictly follow the formulas and data provided by these sources.</strong></p>
</section>
<section>
<h2>The Formula Explained</h2>
<div class="formula">
<p>For a single stage with driver gear 1 and driven gear 2:</p>
<p>Inline teeth/diameter equivalence:</p>
<p>$$ i = \frac{\omega_1}{\omega_2} = \frac{n_1}{n_2} = \frac{z_2}{z_1} = \frac{D_{p2}}{D_{p1}} $$</p>
<p>Multi‑stage (k = 1…m) overall ratio:</p>
<p>$$ i_{\text{total}} = \prod_{k=1}^{m} i_k $$</p>
<p>Output speed from input speed:</p>
<p>$$ n_{\text{out}} = \frac{n_{\text{in}}}{i_{\text{total}}} $$</p>
<p>Overall efficiency (product of stage efficiencies):</p>
<p>$$ \eta_{\text{total}} = \prod_{k=1}^{m} \eta_k $$</p>
<p>Output torque (ideal torque scaled by efficiency):</p>
<p>$$ T_{\text{out}} = T_{\text{in}} \cdot i_{\text{total}} \cdot \eta_{\text{total}} $$</p>
<p>Direction of rotation for external meshes:</p>
<p>$$ \text{Direction factor} = (-1)^{m} \quad \Rightarrow \quad \text{reversed if m is odd} $$</p>
</div>
</section>
<section>
<h2>Glossary of Variables</h2>
<ul>
<li>z1, z2 — Tooth count of driver and driven gears respectively.</li>
<li>Dp1, Dp2 — Pitch diameters of driver and driven gears (consistent units).</li>
<li>i — Gear ratio of a stage, equal to driven/driver (z2/z1 or Dp2/Dp1). i &gt; 1 is reduction; i &lt; 1 is overdrive.</li>
<li>i_total — Product of all stage ratios.</li>
<li>n_in, n_out — Input and output rotational speed (RPM).</li>
<li>T_in, T_out — Input and output torque.</li>
<li>η_k, η_total — Efficiency of stage k and product efficiency (0–1).</li>
<li>Direction — Whether output rotation matches or reverses the input (external meshes flip each time).</li>
</ul>
</section>
<section>
<h2>How It Works: A Step‑by‑Step Example</h2>
<p><strong>Scenario:</strong> Two external gear stages. Stage 1: driver 20 teeth, driven 60 teeth. Stage 2: driver 18 teeth, driven 54 teeth. Each stage at 98% efficiency. Input speed 1500 rpm, input torque 2.0 N·m.</p>
<ol>
<li>Stage ratios: i1 = 60/20 = 3.0; i2 = 54/18 = 3.0.</li>
<li>Overall ratio: i_total = 3.0 × 3.0 = 9.0 (reduction).</li>
<li>Direction: 2 meshes → even → output direction same as input.</li>
<li>Overall efficiency: η_total = 0.98 × 0.98 = 0.9604.</li>
<li>Output speed: n_out = 1500 / 9 = 166.67 rpm.</li>
<li>Output torque: T_out = 2.0 × 9 × 0.9604 ≈ 17.29 N·m.</li>
</ol>
</section>
<section class="faq">
<h2>Frequently Asked Questions (FAQ)</h2>
<h3>Is the “ratio” displayed as x:1 or 1:x?</h3>
<p>This tool reports the magnitude as x:1 where x = driven/driver. Values above 1 indicate reduction; below 1 indicate overdrive.</p>
<h3>Do idler gears change the overall ratio?</h3>
<p>No. Idlers reverse direction but do not change the magnitude of the ratio.</p>
<h3>Can I mix teeth and diameter inputs?</h3>
<p>Yes. Each stage can be defined by teeth or pitch diameters. Just ensure both driver and driven for that stage use the same method.</p>
<h3>What efficiency should I use?</h3>
<p>For quality spur/helical gears, 97–99% per mesh is typical under good lubrication. Chains/belts may be lower. Consult vendor data.</p>
<h3>Does the calculator include backlash or slip?</h3>
<p>No. Backlash does not affect the nominal ratio. Slip is not modeled for gears; belt/chain slip is not considered unless you lower efficiency accordingly.</p>
<h3>How precise are the results?</h3>
<p>They are as precise as your inputs. The kinematic relations are exact; efficiency is an approximation based on your assumption.</p>
<h3>What unit should I use for pitch diameter?</h3>
<p>Any consistent length unit (mm, in). The ratio uses a ratio of diameters, so units cancel.</p>
</section>
<section class="author">
<h2>Authorship and Review</h2>
<p>
            Tool developed by <strong>Ugo Candido</strong>. Content verified by the <strong>CalcDomain Technical Review Board</strong>.<br/>
            Last reviewed for accuracy on: <time datetime="2025-09-14">September 14, 2025</time>.
          </p>
</section>
</article>
</div>
</main>
<!-- Standard Footer --> 
<script defer="">
    (function(){
      'use strict';

      // Utilities
      const $ = sel => document.querySelector(sel);
      const $$ = sel => Array.from(document.querySelectorAll(sel));
      const clamp = (v, min, max) => Math.min(Math.max(v, min), max);
      const toNumber = v => {
        const n = Number(v);
        return Number.isFinite(n) ? n : NaN;
      };
      const fmt = (n, decimals=2) => Number.isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:decimals, minimumFractionDigits:0}) : '—';
      const fmtFixed = (n, decimals=2) => Number.isFinite(n) ? n.toLocaleString(undefined,{maximumFractionDigits:decimals, minimumFractionDigits:decimals}) : '—';

      // Elements
      const stagesContainer = $('#stagesContainer');
      const addStageBtn = $('#addStage');
      const resetBtn = $('#resetForm');
      const stageCountText = $('#stageCountText');
      const inputSpeed = $('#inputSpeed');
      const inputTorque = $('#inputTorque');
      const torqueUnit = $('#torqueUnit');
      const effMode = $('#effMode');
      const globalEffWrap = $('#globalEffWrap');
      const globalEff = $('#globalEff');

      const ratioDisplay = $('#ratioDisplay');
      const speedOutDisplay = $('#speedOutDisplay');
      const torqueOutDisplay = $('#torqueOutDisplay');
      const effDisplay = $('#effDisplay');
      const directionDisplay = $('#directionDisplay');

      // Track stages
      let stageIdCounter = 0;

      function stageTemplate(id){
        const stage = document.createElement('section');
        stage.className = 'stage';
        stage.setAttribute('data-stage-id', id);
        stage.innerHTML = `
          <div class="stage-header">
            <div class="stage-title">Stage <span class="stage-number"></span></div>
            <div class="stage-controls">
              <label for="mode-${id}" class="sr-only">Input mode</label>
              <select id="mode-${id}" class="select mode-select" aria-label="Stage input mode">
                <option value="teeth">Teeth (z)</option>
                <option value="diameter">Pitch diameter (Dp)</option>
              </select>
              <button type="button" class="help" aria-expanded="false" aria-controls="tip-${id}" title="Show help">?</button>
              <button type="button" class="btn secondary remove-stage" aria-label="Remove this stage">Remove</button>
            </div>
          </div>

          <div id="tip-${id}" class="tooltip" role="note" aria-hidden="true">
            For each stage, enter driver and driven values using either tooth counts or pitch diameters. Ratio = driven / driver.
          </div>

          <div class="form-group stage-teeth">
            <div class="inline">
              <div>
                <label for="driver-teeth-${id}">Driver teeth *</label>
                <input id="driver-teeth-${id}" class="input driver-teeth" type="number" inputmode="numeric" min="1" step="1" placeholder="e.g., 20" aria-required="true" aria-describedby="err-driver-teeth-${id}">
                <div id="err-driver-teeth-${id}" class="error" role="alert" aria-live="polite"></div>
              </div>
              <div>
                <label for="driven-teeth-${id}">Driven teeth *</label>
                <input id="driven-teeth-${id}" class="input driven-teeth" type="number" inputmode="numeric" min="1" step="1" placeholder="e.g., 60" aria-required="true" aria-describedby="err-driven-teeth-${id}">
                <div id="err-driven-teeth-${id}" class="error" role="alert" aria-live="polite"></div>
              </div>
            </div>
          </div>

          <div class="form-group stage-diameter" hidden>
            <div class="inline">
              <div>
                <label for="driver-dia-${id}">Driver pitch diameter *</label>
                <div class="input-affix">
                  <input id="driver-dia-${id}" class="input driver-dia" type="number" inputmode="decimal" min="0" step="any" placeholder="e.g., 25.4" aria-required="true" aria-describedby="err-driver-dia-${id}">
                  <span class="affix">length</span>
                </div>
                <div id="err-driver-dia-${id}" class="error" role="alert" aria-live="polite"></div>
              </div>
              <div>
                <label for="driven-dia-${id}">Driven pitch diameter *</label>
                <div class="input-affix">
                  <input id="driven-dia-${id}" class="input driven-dia" type="number" inputmode="decimal" min="0" step="any" placeholder="e.g., 76.2" aria-required="true" aria-describedby="err-driven-dia-${id}">
                  <span class="affix">length</span>
                </div>
                <div id="err-driven-dia-${id}" class="error" role="alert" aria-live="polite"></div>
              </div>
            </div>
          </div>

          <div class="form-group eff-wrap">
            <label for="eff-${id}">Stage efficiency (%)</label>
            <div class="input-affix">
              <input id="eff-${id}" class="input eff" type="number" inputmode="decimal" min="0" max="100" step="any" value="98" aria-describedby="err-eff-${id}">
              <span class="affix">%</span>
            </div>
            <div id="err-eff-${id}" class="error" role="alert" aria-live="polite"></div>
          </div>
        `;
        return stage;
      }

      function renumberStages(){
        $$('.stage').forEach((s, idx)=>{
          const num = s.querySelector('.stage-number');
          if(num) num.textContent = String(idx+1);
        });
        const count = $$('.stage').length;
        stageCountText.textContent = count + (count === 1 ? ' stage' : ' stages');
      }

      function addStage(prefill){
        const id = ++stageIdCounter;
        const el = stageTemplate(id);
        stagesContainer.appendChild(el);
        renumberStages();

        // Prefill optional
        if(prefill && prefill.type === 'teeth'){
          el.querySelector('.driver-teeth').value = prefill.driver || '';
          el.querySelector('.driven-teeth').value = prefill.driven || '';
        }
        bindStageEvents(el);
        validateStage(el, false);
        compute();
      }

      function removeStage(el){
        el.remove();
        renumberStages();
        compute();
      }

      function bindStageEvents(stageEl){
        const modeSel = stageEl.querySelector('.mode-select');
        const teethWrap = stageEl.querySelector('.stage-teeth');
        const diaWrap = stageEl.querySelector('.stage-diameter');
        const removeBtn = stageEl.querySelector('.remove-stage');
        const helpBtn = stageEl.querySelector('.help');
        const tip = stageEl.querySelector('.tooltip');

        modeSel.addEventListener('change', ()=>{
          const mode = modeSel.value;
          if(mode === 'teeth'){ teethWrap.hidden = false; diaWrap.hidden = true; }
          else { teethWrap.hidden = true; diaWrap.hidden = false; }
          compute();
        });

        removeBtn.addEventListener('click', ()=>{
          if($$('.stage').length > 1){
            removeStage(stageEl);
          }
        });

        helpBtn.addEventListener('click', ()=>{
          const expanded = helpBtn.getAttribute('aria-expanded') === 'true';
          helpBtn.setAttribute('aria-expanded', String(!expanded));
          tip.setAttribute('aria-hidden', String(expanded));
        });
        helpBtn.addEventListener('keydown', (e)=>{
          if(e.key === 'Escape'){ helpBtn.setAttribute('aria-expanded','false'); tip.setAttribute('aria-hidden','true'); helpBtn.focus(); }
        });

        // Validation on blur
        stageEl.querySelectorAll('input').forEach(inp=>{
          inp.addEventListener('blur', ()=>validateStage(stageEl, true));
          inp.addEventListener('input', ()=>{ clearError(inp); compute(); });
        });
      }

      function setError(input, message){
        input.setAttribute('aria-invalid','true');
        const errId = input.getAttribute('aria-describedby')?.split(' ').find(id => id.startsWith('err-')) || null;
        if(errId){
          const errEl = document.getElementById(errId);
          if(errEl){ errEl.textContent = message || ''; }
        }
      }
      function clearError(input){
        input.removeAttribute('aria-invalid');
        const errId = input.getAttribute('aria-describedby')?.split(' ').find(id => id.startsWith('err-')) || null;
        if(errId){
          const errEl = document.getElementById(errId);
          if(errEl){ errEl.textContent = ''; }
        }
      }

      function validateStage(stageEl, showMessages=true){
        let valid = true;
        const mode = stageEl.querySelector('.mode-select').value;
        if(mode === 'teeth'){
          const d = stageEl.querySelector('.driver-teeth');
          const r = stageEl.querySelector('.driven-teeth');
          const dv = toNumber(d.value);
          const rv = toNumber(r.value);
          if(!(Number.isFinite(dv) && dv>=1 && Number.isInteger(dv))){
            valid = false; if(showMessages) setError(d,'Enter a whole number ≥ 1 for driver teeth.'); else clearError(d);
          } else { clearError(d); }
          if(!(Number.isFinite(rv) && rv>=1 && Number.isInteger(rv))){
            valid = false; if(showMessages) setError(r,'Enter a whole number ≥ 1 for driven teeth.'); else clearError(r);
          } else { clearError(r); }
        } else {
          const d = stageEl.querySelector('.driver-dia');
          const r = stageEl.querySelector('.driven-dia');
          const dv = toNumber(d.value);
          const rv = toNumber(r.value);
          if(!(Number.isFinite(dv) && dv>0)){
            valid = false; if(showMessages) setError(d,'Enter a positive driver pitch diameter.'); else clearError(d);
          } else { clearError(d); }
          if(!(Number.isFinite(rv) && rv>0)){
            valid = false; if(showMessages) setError(r,'Enter a positive driven pitch diameter.'); else clearError(r);
          } else { clearError(r); }
        }
        const eff = stageEl.querySelector('.eff');
        const ev = toNumber(eff.value);
        if(!(Number.isFinite(ev) && ev>=0 && ev<=100)){
          valid = false; if(showMessages) setError(eff,'Enter efficiency between 0 and 100.'); else clearError(eff);
        } else { clearError(eff); }
        return valid;
      }

      function validateTop(){
        let ok = true;
        const s = toNumber(inputSpeed.value);
        if(!(Number.isFinite(s) && s>=0)){
          ok = false; setError(inputSpeed, 'Enter a non-negative speed (RPM).');
        } else clearError(inputSpeed);

        const t = toNumber(inputTorque.value);
        if(!(Number.isFinite(t) && t>=0)){
          ok = false; setError(inputTorque, 'Enter a non-negative torque.');
        } else clearError(inputTorque);

        if(effMode.value === 'global'){
          const ge = toNumber(globalEff.value);
          if(!(Number.isFinite(ge) && ge>=0 && ge<=100)){
            ok = false; setError(globalEff,'Enter a global efficiency 0–100.');
          } else clearError(globalEff);
        }
        return ok;
      }

      function getStageRatio(stageEl){
        const mode = stageEl.querySelector('.mode-select').value;
        let ratio = NaN;
        if(mode === 'teeth'){
          const d = toNumber(stageEl.querySelector('.driver-teeth').value);
          const r = toNumber(stageEl.querySelector('.driven-teeth').value);
          ratio = r / d;
        } else {
          const d = toNumber(stageEl.querySelector('.driver-dia').value);
          const r = toNumber(stageEl.querySelector('.driven-dia').value);
          ratio = r / d;
        }
        return ratio;
      }

      function getStageEfficiency(stageEl){
        const e = toNumber(stageEl.querySelector('.eff').value);
        return clamp(e, 0, 100) / 100;
      }

      function compute(){
        if(!validateTop()) { updateResults(null); return; }

        const stages = $$('.stage');
        if(stages.length === 0){ updateResults(null); return; }

        let iTotal = 1;
        let etaTotal = 1;
        let validAll = true;

        for(const st of stages){
          const v = validateStage(st, false);
          if(!v) validAll = false;
          const ratio = getStageRatio(st);
          if(!Number.isFinite(ratio) || ratio <= 0) { validAll = false; break; }
          iTotal *= ratio;
          if(effMode.value === 'per'){
            const eta = getStageEfficiency(st);
            etaTotal *= eta;
          }
        }

        if(effMode.value === 'global'){
          etaTotal = clamp(toNumber(globalEff.value),0,100)/100;
        }

        if(!validAll){ updateResults(null); return; }

        const nIn = toNumber(inputSpeed.value);
        let tIn = toNumber(inputTorque.value);
        const unit = torqueUnit.value;
        // Convert to N·m internal
        if(unit === 'lbft') tIn = tIn * 1.3558179483;

        const nOut = (iTotal !== 0) ? (nIn / iTotal) : NaN;
        const tOutNm = tIn * iTotal * etaTotal;
        const tOutLbft = tOutNm / 1.3558179483;

        const meshes = stages.length; // assuming all external
        const reversed = (meshes % 2) === 1;

        updateResults({
          iTotal, nOut, tOutNm, tOutLbft, etaTotal, reversed
        });
      }

      function updateResults(data){
        if(!data){
          ratioDisplay.textContent = '—';
          speedOutDisplay.textContent = '—';
          torqueOutDisplay.textContent = '—';
          effDisplay.textContent = '—';
          directionDisplay.textContent = '—';
          return;
        }
        const {iTotal, nOut, tOutNm, tOutLbft, etaTotal, reversed} = data;
        // Human-friendly ratio string
        const ratioStr = iTotal >= 1
          ? `${fmtFixed(iTotal, 3)} : 1 (reduction)`
          : `${fmtFixed(iTotal, 3)} : 1 (overdrive)`;

        ratioDisplay.textContent = ratioStr;
        speedOutDisplay.textContent = `${fmtFixed(nOut, 2)} rpm`;
        torqueOutDisplay.textContent = `${fmtFixed(tOutNm, 2)} N·m  •  ${fmtFixed(tOutLbft, 2)} lb·ft`;
        effDisplay.textContent = `${fmtFixed(etaTotal*100, 2)} %`;
        directionDisplay.textContent = reversed ? 'Reversed' : 'Same as input';
      }

      // Hook top-level events
      [inputSpeed, inputTorque].forEach(el=>{
        el.addEventListener('blur', ()=>validateTop());
        el.addEventListener('input', ()=>{ clearError(el); compute(); });
      });
      torqueUnit.addEventListener('change', compute);

      effMode.addEventListener('change', ()=>{
        const useGlobal = effMode.value === 'global';
        globalEffWrap.hidden = !useGlobal;
        // Toggle per-stage field enable/disable
        $$('.stage .eff').forEach(inp => inp.disabled = useGlobal);
        compute();
      });
      globalEff.addEventListener('blur', ()=>validateTop());
      globalEff.addEventListener('input', compute);

      addStageBtn.addEventListener('click', ()=>addStage());
      resetBtn.addEventListener('click', ()=>{
        // Clear stages
        stagesContainer.innerHTML = '';
        stageIdCounter = 0;
        addStage({type:'teeth', driver:20, driven:60});
        inputSpeed.value = '';
        inputTorque.value = '';
        torqueUnit.value = 'Nm';
        effMode.value = 'per';
        globalEffWrap.hidden = true;
        globalEff.value = 95;
        $$('.error').forEach(e=>e.textContent='');
        [inputSpeed, inputTorque, globalEff].forEach(el=>el.removeAttribute('aria-invalid'));
        compute();
        inputSpeed.focus();
      });

      // Initialize with one stage
      addStage({type:'teeth', driver:20, driven:60});
      // Set default placeholders
      inputSpeed.value = '';
      inputTorque.value = '';
      compute();
    })();
  </script>

</body></html>
