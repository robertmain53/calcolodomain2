<!DOCTYPE html>
<html lang="en">
<head>
<link rel="canonical" href="https://calcdomain.com/function-calculator">





  <!-- Meta -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Function Calculator — Plot, Evaluate, Derivative & Integral</title>
  <meta name="description" content="Evaluate a function f(x), compute the derivative and definite integral, find roots, and plot the graph. Supports sin, cos, tan, ln, log10, exp, sqrt, abs, π, e, and exponentiation. Built for students, engineers, and analysts." />
  
  <meta name="author" content="Ugo Candido" />

  <!-- Icons -->
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <!-- Fonts & UI -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <!-- KaTeX for formulas -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js" defer></script>

  <!-- Styles: mobile-first, high contrast, visible focus, min-heights to avoid CLS -->
  <style>
    :root { --brand:#1d4ed8; --ink:#0b1220; --muted:#4b5563; --surface:#ffffff; --bg:#f8fafc; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    a{color:var(--brand)}
    a:focus,button:focus,input:focus,select:focus,textarea:focus,summary:focus{outline:3px solid #60a5fa; outline-offset:2px}
    .prose{max-width:68ch}
    .formula-box{background:#f3f4f6;border:1px solid #d1d5db;border-radius:10px;padding:1rem;overflow:auto;font-family:ui-monospace,Consolas,Monaco,monospace}
    .result-card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:1rem;text-align:center}
    .result-card h4{font-size:.95rem;color:#6b7280;margin-bottom:.25rem}
    .result-card p{font-size:1.5rem;font-weight:800;color:#1d4ed8;word-break:break-word}
    .minh-results{min-height:12rem} /* prevents CLS when results render */
    .help-btn{min-width:48px;min-height:36px}
    .tap-target{min-height:48px}
    .err{color:#b91c1c;font-size:.85rem;margin-top:.375rem}
    @media print{
      body *{visibility:hidden}
      #print-section,#print-section *{visibility:visible}
      #print-section{position:absolute;left:0;top:0;width:100%}
    }
  </style>

  <!-- JSON-LD: WebPage + WebApplication + Breadcrumb + FAQ -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "function calculator",
    "inLanguage": "en",
    "url": "https://calcdomain.com/function-calculator",
    "description": "Evaluate, differentiate, integrate, find roots, and plot mathematical functions with a professional, accessible tool.",
    "author": { "@type": "Person", "name": "Ugo Candido" },
    "publisher": { "@type": "Organization", "name": "CalcDomain" }
  }
  </script>
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebApplication",
    "name":"Function Calculator",
    "applicationCategory":"EducationalApplication",
    "operatingSystem":"Any",
    "offers": { "@type":"Offer", "price":"0", "priceCurrency":"USD" },
    "featureList":[
      "Expression parsing with sin, cos, tan, ln, log10, exp, sqrt, abs, ^",
      "Point evaluation f(x0)",
      "Numerical derivative f'(x0)",
      "Definite integral ∫_a^b f(x) dx",
      "Root finding over a range",
      "Interactive plot"
    ]
  }
  </script>
  <script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": "https://calcdomain.com"
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": "Math & Conversions",
      "item": "https://calcdomain.com/math-conversions"
    },
    {
      "@type": "ListItem",
      "position": 3,
      "name": "Algebra",
      "item": "https://calcdomain.com/subcategories/core-math-algebra"
    },
    {
      "@type": "ListItem",
      "position": 4,
      "name": "Function Calculator",
      "item": "https://calcdomain.com/function-calculator"
    }
  ]
}</script>
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {"@type":"Question","name":"What functions are supported?","acceptedAnswer":{"@type":"Answer","text":"Real-valued expressions with + − × ÷, exponentiation (^), parentheses, and functions sin, cos, tan, ln, log10, exp, sqrt, abs; constants pi and e."}},
      {"@type":"Question","name":"How is the derivative computed?","acceptedAnswer":{"@type":"Answer","text":"Numerically via a symmetric difference quotient with adaptive step sizing to reduce round-off and truncation error."}},
      {"@type":"Question","name":"How are integrals computed?","acceptedAnswer":{"@type":"Answer","text":"Numerically using composite Simpson’s rule over the specified interval with automatic even subdivision."}},
      {"@type":"Question","name":"How are roots found?","acceptedAnswer":{"@type":"Answer","text":"The tool scans the range and applies bisection on sign changes, then refines using secant steps if possible."}},
      {"@type":"Question","name":"Can I plot discontinuous functions?","acceptedAnswer":{"@type":"Answer","text":"Yes, but discontinuities may appear as vertical lines or gaps; the plot routine segments where values overflow or become NaN."}},
      {"@type":"Question","name":"What about degrees vs radians?","acceptedAnswer":{"@type":"Answer","text":"Trigonometric functions use radians."}},
      {"@type":"Question","name":"Is this suitable for exams or grading?","acceptedAnswer":{"@type":"Answer","text":"It’s an educational tool. Always verify critical results and cite authoritative sources as required by your course or organization."}}
    ]
  }
  </script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header (non-sticky as required) -->
  <header class="bg-white border-b">
    <nav class="container mx-auto px-4 lg:px-6 py-4">
      <div class="flex items-center justify-between">
        <a href="https://calcdomain.com" class="text-2xl font-extrabold text-blue-700">CalcDomain</a>
        <div class="hidden md:flex items-center gap-6 text-sm">
          <a href="https://calcdomain.com/search" class="text-gray-700 hover:text-blue-700">Advanced Search</a>
          Categories
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 lg:px-6 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <section class="w-full lg:w-2/3">
        <nav class="text-sm text-gray-600 mb-4" aria-label="Breadcrumb">
          <a href="https://calcdomain.com" class="hover:text-blue-700">Home</a> &raquo;
          <a href="https://calcdomain.com/math" class="hover:text-blue-700">Math</a> &raquo;
          <a href="https://calcdomain.com/subcategories/core-math-algebra" class="hover:text-blue-700">Algebra</a> &raquo;
          <span class="text-gray-900">Function Calculator</span>
        </nav>

        <div id="print-section" class="bg-white p-6 rounded-lg shadow">
          <!-- 1) H1 -->
          <h1 class="text-3xl font-extrabold mb-2">function calculator</h1>

          <!-- 2) Intro -->
          <p class="text-gray-700 mb-6">
            Enter a function <strong>f(x)</strong>, evaluate it at a point, compute the numerical derivative and the definite integral, find roots over a range, and visualize the graph. Built for students, engineers, and analysts who need fast, accurate, accessible results.
          </p>

          <!-- 3) Calculator UI -->
          <section aria-labelledby="calc-heading" class="space-y-6">
            <h2 id="calc-heading" class="sr-only">Function calculator inputs</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- Function expression -->
              <div class="md:col-span-2">
                <label for="expr" class="block text-sm font-medium text-gray-800">
                  Function f(x) * <button type="button" class="help-btn inline-flex items-center justify-center ml-2 text-xs px-2 py-1 rounded border border-gray-300 hover:bg-gray-100" aria-expanded="false" aria-controls="tip-expr" id="btn-expr">?</button>
                </label>
                <input id="expr" name="expr" type="text" inputmode="text" aria-required="true" aria-describedby="err-expr tip-expr"
                  class="tap-target mt-1 w-full px-3 py-3 border border-gray-300 rounded-md shadow-sm focus:border-blue-600"
                  placeholder="e.g., sin(x) + x^2 - 3*x + 2" value="sin(x)+x^2-3*x+2" />
                <p id="err-expr" class="err" role="alert" aria-live="polite"></p>
                <p id="tip-expr" class="text-xs text-gray-600 mt-2 hidden">
                  Supported: + - * / ^, parentheses, sin cos tan ln log10 exp sqrt abs, constants: pi, e. Trig functions use radians.
                </p>
              </div>

              <!-- x0 for evaluation/derivative -->
              <div>
                <label for="x0" class="block text-sm font-medium text-gray-800">Point x<sub>0</sub> for f(x<sub>0</sub>) & f′(x<sub>0</sub>) *</label>
                <input id="x0" name="x0" type="number" step="any" aria-required="true" aria-describedby="err-x0"
                  class="tap-target mt-1 w-full px-3 py-3 border border-gray-300 rounded-md focus:border-blue-600" value="1" />
                <p id="err-x0" class="err" role="alert" aria-live="polite"></p>
              </div>

              <!-- Integral bounds -->
              <div>
                <label for="a" class="block text-sm font-medium text-gray-800">Integral lower bound a *</label>
                <input id="a" name="a" type="number" step="any" aria-required="true" aria-describedby="err-a"
                  class="tap-target mt-1 w-full px-3 py-3 border border-gray-300 rounded-md focus:border-blue-600" value="0" />
                <p id="err-a" class="err" role="alert" aria-live="polite"></p>
              </div>
              <div>
                <label for="b" class="block text-sm font-medium text-gray-800">Integral upper bound b *</label>
                <input id="b" name="b" type="number" step="any" aria-required="true" aria-describedby="err-b"
                  class="tap-target mt-1 w-full px-3 py-3 border border-gray-300 rounded-md focus:border-blue-600" value="3" />
                <p id="err-b" class="err" role="alert" aria-live="polite"></p>
              </div>

              <!-- Range for roots / plot -->
              <div>
                <label for="xmin" class="block text-sm font-medium text-gray-800">Plot/scan range: x<sub>min</sub> *</label>
                <input id="xmin" name="xmin" type="number" step="any" aria-required="true" aria-describedby="err-xmin"
                  class="tap-target mt-1 w-full px-3 py-3 border border-gray-300 rounded-md focus:border-blue-600" value="-6.28318" />
                <p id="err-xmin" class="err" role="alert" aria-live="polite"></p>
              </div>
              <div>
                <label for="xmax" class="block text-sm font-medium text-gray-800">x<sub>max</sub> *</label>
                <input id="xmax" name="xmax" type="number" step="any" aria-required="true" aria-describedby="err-xmax"
                  class="tap-target mt-1 w-full px-3 py-3 border border-gray-300 rounded-md focus:border-blue-600" value="6.28318" />
                <p id="err-xmax" class="err" role="alert" aria-live="polite"></p>
              </div>

              <div>
                <label for="step" class="block text-sm font-medium text-gray-800">Sampling step (plot/roots) *</label>
                <input id="step" name="step" type="number" step="any" aria-required="true" aria-describedby="err-step"
                  class="tap-target mt-1 w-full px-3 py-3 border border-gray-300 rounded-md focus:border-blue-600" value="0.02" />
                <p id="err-step" class="err" role="alert" aria-live="polite"></p>
              </div>

              <div class="md:col-span-2">
                <div class="flex flex-wrap gap-3">
                  <button id="btn-calc" class="tap-target px-4 py-3 rounded-md bg-blue-700 text-white font-semibold hover:bg-blue-800" aria-label="Calculate results">Calculate</button>
                  <button id="btn-plot" class="tap-target px-4 py-3 rounded-md bg-gray-800 text-white font-semibold hover:bg-black" aria-label="Plot function">Plot</button>
                  <button id="btn-print" class="tap-target px-4 py-3 rounded-md border font-semibold hover:bg-gray-100" aria-label="Print results">Print</button>
                  <button id="btn-reset" class="tap-target px-4 py-3 rounded-md border font-semibold hover:bg-gray-100" aria-label="Reset inputs">Reset</button>
                </div>
              </div>
            </div>
          </section>

          <!-- 4) Results Area -->
          <section aria-labelledby="results-heading" class="mt-8">
            <h2 id="results-heading" class="sr-only">Results</h2>

            <div id="results" class="minh-results bg-blue-50 border border-blue-100 rounded-lg p-6">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="result-card">
                  <h4>f(x₀)</h4>
                  <p id="res-fx">—</p>
                </div>
                <div class="result-card">
                  <h4>f′(x₀)</h4>
                  <p id="res-dfx">—</p>
                </div>
                <div class="result-card">
                  <h4>∫<span class="align-middle">a</span><sup class="align-middle">b</sup> f(x) dx</h4>
                  <p id="res-int">—</p>
                </div>
                <div class="result-card">
                  <h4>Roots in [x<sub>min</sub>, x<sub>max</sub>]</h4>
                  <p id="res-roots" class="text-base font-semibold text-blue-900">—</p>
                </div>
              </div>

              <details class="mt-6 bg-white rounded-lg">
                <summary class="font-semibold text-gray-800 px-4 py-3 cursor-pointer">Computation details</summary>
                <div class="p-4 text-sm text-gray-700 space-y-2">
                  <p id="res-meta">—</p>
                </div>
              </details>

              <div class="mt-6 h-64">
                <canvas id="chart" aria-label="Function plot" role="img"></canvas>
              </div>
            </div>
          </section>
        </div>

        <!-- 5) Authoritative Content Ecosystem -->
        <article class="bg-white p-6 rounded-lg shadow mt-8 prose">
          <h2>Data source & methodology</h2>
          <p><strong>Authoritative data source:</strong> <a href="https://dlmf.nist.gov/" rel="noopener" target="_blank">NIST Digital Library of Mathematical Functions (DLMF), 2023–2025</a>. All numerical methods (finite differences, composite Simpson’s rule, bisection) follow standard formulations as taught in numerical analysis texts (e.g., Burden &amp; Faires, 11th ed., 2015).</p>
          <p><em>Tutti i calcoli si basano rigorosamente sulle formule e sui dati forniti da questa fonte.</em></p>

          <h2>The formula explained</h2>
          <div class="formula-box" id="latex-block">
\[
\textbf{Evaluation:}\quad y = f(x_0)
\]
\[
\textbf{Derivative (symmetric difference):}\quad
f'(x_0) \approx \frac{f(x_0+h)-f(x_0-h)}{2h}
\]
\[
\textbf{Definite integral (composite Simpson):}\quad
\int_a^b f(x)\,dx \approx \frac{\Delta x}{3}\left[f(x_0)+f(x_{2n}) + 4\sum_{k=1}^{n} f(x_{2k-1}) + 2\sum_{k=1}^{n-1} f(x_{2k})\right]
\]
\[
\textbf{Root finding:}\ \text{scan for sign changes on }[x_{\min},x_{\max}]\ \Rightarrow \ \text{bisection (and secant refinement).}
\]
          </div>

          <h2>Glossary of variables</h2>
          <ul>
            <li><strong>f(x)</strong>: user-defined function.</li>
            <li><strong>x₀</strong>: point where f(x) and f′(x) are evaluated.</li>
            <li><strong>a, b</strong>: bounds of the definite integral (a ≤ b recommended).</li>
            <li><strong>x<sub>min</sub>, x<sub>max</sub></strong>: scan range for plotting and root search.</li>
            <li><strong>step</strong>: sampling step for plotting and sign-change detection.</li>
          </ul>

          <h2>How it works: a step-by-step example</h2>
          <h3>Example function</h3>
          <p>Let \( f(x)=\sin x + x^2 - 3x + 2 \). Choose \( x_0 = 1 \), integrate from \( a=0 \) to \( b=3 \), and plot/scan on \([-2\pi,2\pi]\) with step \(0.02\).</p>
          <ol>
            <li><strong>Evaluate:</strong> compute \( f(1) \).</li>
            <li><strong>Differentiate:</strong> compute \( f'(1) \approx \frac{f(1+h)-f(1-h)}{2h} \) with an adaptive \(h\).</li>
            <li><strong>Integrate:</strong> apply composite Simpson on \([0,3]\) with even subintervals.</li>
            <li><strong>Roots:</strong> scan the range; if \(f(x_i)\cdot f(x_{i+1})<0\), refine with bisection.</li>
            <li><strong>Plot:</strong> sample points and draw a continuous line, segmenting where values overflow.</li>
          </ol>

          <h2>FAQ</h2>
          <details><summary>Which constants and functions can I use?</summary><p>Use <code>pi</code>, <code>e</code>; functions: <code>sin</code>, <code>cos</code>, <code>tan</code>, <code>ln</code> (natural log), <code>log10</code>, <code>exp</code>, <code>sqrt</code>, <code>abs</code>. Use <code>^</code> for powers and parentheses liberally.</p></details>
          <details><summary>What if the integral diverges?</summary><p>If the function explodes or is non-integrable over the interval, the result shows “NaN/∞” and the plot may show gaps or vertical lines.</p></details>
          <details><summary>How accurate are the numerical results?</summary><p>For well-behaved functions, errors are typically small. You can tighten the plot/scan step for finer resolution. For highly oscillatory or discontinuous functions, consider analytic methods.</p></details>
          <details><summary>Can I copy results?</summary><p>Yes—use the browser print or copy from the results area. The “Print” button renders a clean section.</p></details>
          <details><summary>Radians or degrees?</summary><p>Radians.</p></details>
          <details><summary>Why do I see strange spikes?</summary><p>They usually indicate discontinuities or overflow (e.g., near vertical asymptotes). Reduce the range or step and interpret with care.</p></details>

          <!-- 6) Authorship -->
          <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded text-sm text-gray-700">
            <p><strong>Tool developed by Ugo Candido.</strong> Content reviewed by the CalcDomain Editorial Board.<br>
            Last accuracy review: <time datetime="2025-10-25">October 25, 2025</time></p>
          </div>
        </article>
      </section>

      <aside class="w-full lg:w-1/3">
        <div class="sticky top-6 space-y-6">
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-3">Why this beats typical function solvers</h3>
            <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
              <li>Single-screen workflow: evaluate, differentiate, integrate, root-find, and plot.</li>
              <li>Accessible UI with inline validation and clear error messages.</li>
              <li>Deterministic numeric methods with transparent methodology.</li>
            </ul>
          </div>
          <div class="bg-gray-200 h-72 rounded-lg flex items-center justify-center text-gray-600">
            Ad Placement (300×600)
          </div>
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-4">Related math tools</h3>
            <ul class="space-y-2 text-sm">
              <li><a href="https://calcdomain.com/derivative" class="hover:underline">Derivative Calculator</a></li>
              <li><a href="https://calcdomain.com/integral" class="hover:underline">Integral Calculator</a></li>
              <li><a href="https://calcdomain.com/limit" class="hover:underline">Limit Calculator</a></li>
              <li>Function Plotter</li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="bg-white border-t">
    <div class="container mx-auto px-6 py-8 text-center text-gray-600 text-sm">
      <p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
      <div class="mt-4 space-x-4">
        <a href="https://calcdomain.com/about" class="hover:text-blue-700">About</a>
        <a href="https://calcdomain.com/contact" class="hover:text-blue-700">Contact</a>
        <a href="https://calcdomain.com/privacy" class="hover:text-blue-700">Privacy</a>
        <a href="https://calcdomain.com/terms" class="hover:text-blue-700">Terms</a>
      </div>
    </div>
  </footer>

  <!-- Calculator logic (defer) -->
  <script defer>
  (function(){
    // --- KaTeX render for formulas ---
    document.addEventListener('DOMContentLoaded', () => {
      if (window.renderMathInElement) {
        renderMathInElement(document.getElementById('latex-block'), {
          delimiters: [{left:"$$", right:"$$", display:true},{left:"\\[", right:"\\]", display:true},{left:"$", right:"$", display:false}]
        });
      }
    });

    // --- Helpers: formatting ---
    const fmt = (v) => (Number.isFinite(v) ? new Intl.NumberFormat(undefined,{maximumSignificantDigits:8}).format(v) : '—');

    // --- Accessible tooltip toggle for function help ---
    const btnExpr = document.getElementById('btn-expr');
    const tipExpr = document.getElementById('tip-expr');
    if (btnExpr) {
      btnExpr.addEventListener('click', () => {
        const open = tipExpr.classList.toggle('hidden');
        btnExpr.setAttribute('aria-expanded', String(!open));
      });
      btnExpr.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); btnExpr.click(); } });
    }

    // --- Inputs & outputs ---
    const el = {
      expr:  document.getElementById('expr'),
      x0:    document.getElementById('x0'),
      a:     document.getElementById('a'),
      b:     document.getElementById('b'),
      xmin:  document.getElementById('xmin'),
      xmax:  document.getElementById('xmax'),
      step:  document.getElementById('step'),
      err: {
        expr: document.getElementById('err-expr'),
        x0:   document.getElementById('err-x0'),
        a:    document.getElementById('err-a'),
        b:    document.getElementById('err-b'),
        xmin: document.getElementById('err-xmin'),
        xmax: document.getElementById('err-xmax'),
        step: document.getElementById('err-step')
      },
      res: {
        fx:   document.getElementById('res-fx'),
        dfx:  document.getElementById('res-dfx'),
        int:  document.getElementById('res-int'),
        roots:document.getElementById('res-roots'),
        meta: document.getElementById('res-meta')
      },
      btnCalc: document.getElementById('btn-calc'),
      btnPlot: document.getElementById('btn-plot'),
      btnPrint:document.getElementById('btn-print'),
      btnReset:document.getElementById('btn-reset'),
      chart:  document.getElementById('chart')
    };

    // --- Validation (on blur) ---
    function setErr(id, msg){ el.err[id].textContent = msg || ''; }
    function numVal(id){
      const v = Number(el[id].value);
      if (!isFinite(v)) throw [id, 'Please enter a valid number.'];
      return v;
    }
    el.expr.addEventListener('blur', ()=> { try{ parseExpression(el.expr.value); setErr('expr',''); } catch(e){ setErr('expr', String(e.message||e)); } });
    ['x0','a','b','xmin','xmax','step'].forEach(id=>{
      el[id].addEventListener('blur', ()=>{
        try{
          const v = numVal(id);
          if(id==='step' && v<=0) throw [id,'Step must be positive.'];
          setErr(id,'');
        }catch(err){
          const [fld,msg]=Array.isArray(err)?err:[id,'Please enter a valid number.'];
          setErr(fld,msg);
        }
      })
    });

    // --- Expression parser (shunting-yard to RPN + evaluator) ---
    const funcs = new Set(['sin','cos','tan','ln','log10','exp','sqrt','abs']);
    const consts = { pi: Math.PI, e: Math.E };
    const ops = {
      '+':{p:1,a:'L',f:(a,b)=>a+b},
      '-':{p:1,a:'L',f:(a,b)=>a-b},
      '*':{p:2,a:'L',f:(a,b)=>a*b},
      '/':{p:2,a:'L',f:(a,b)=>a/b},
      '^':{p:3,a:'R',f:(a,b)=>Math.pow(a,b)}
    };

    function tokenize(s){
      s = s.replace(/\s+/g,'');
      if(!s) throw new Error('Function cannot be empty.');
      const out=[];
      let i=0;
      while(i<s.length){
        const c=s[i];
        if(/[0-9.]/.test(c)){
          let j=i+1; while(j<s.length && /[0-9.]/.test(s[j])) j++;
          out.push({t:'num',v:parseFloat(s.slice(i,j))}); i=j; continue;
        }
        if(/[a-z]/i.test(c)){
          let j=i+1; while(j<s.length && /[a-z0-9_]/i.test(s[j])) j++;
          const name=s.slice(i,j);
          if(funcs.has(name)) out.push({t:'fn',v:name});
          else if(name in consts) out.push({t:'num',v:consts[name]});
          else if(name==='x') out.push({t:'var'});
          else throw new Error(`Unknown symbol: ${name}`);
          i=j; continue;
        }
        if(c==='('||c===')'){ out.push({t:c}); i++; continue; }
        if(c in ops){ out.push({t:'op',v:c}); i++; continue; }
        throw new Error(`Unexpected character: ${c}`);
      }
      return out;
    }

    function toRPN(tokens){
      const out=[], stack=[];
      let prev=null;
      for(const tok of tokens){
        if(tok.t==='num'||tok.t==='var'){ out.push(tok); }
        else if(tok.t==='fn'){ stack.push(tok); }
        else if(tok.t==='op'){
          // Handle unary minus: convert to (0 x) pair
          if(tok.v==='-' && (!prev || (prev.t!=='num' && prev.t!=='var' && prev.t!==')'))){
            out.push({t:'num',v:0});
          }
          while(stack.length){
            const top=stack[stack.length-1];
            if(top.t==='op' && ((ops[top.v].p>ops[tok.v].p) || (ops[top.v].p===ops[tok.v].p && ops[tok.v].a==='L'))){
              out.push(stack.pop());
            }else if(top.t==='fn'){ out.push(stack.pop()); }
            else break;
          }
          stack.push(tok);
        }
        else if(tok.t==='('){ stack.push(tok); }
        else if(tok.t===')'){
          while(stack.length && stack[stack.length-1].t!=='('){ out.push(stack.pop()); }
          if(!stack.length) throw new Error('Mismatched parentheses.');
          stack.pop(); // pop '('
          if(stack.length && stack[stack.length-1].t==='fn'){ out.push(stack.pop()); }
        }
        prev=tok;
      }
      while(stack.length){
        const t=stack.pop();
        if(t.t==='('||t.t===')') throw new Error('Mismatched parentheses.');
        out.push(t);
      }
      return out;
    }

    function evalRPN(rpn, x){
      const st=[];
      for(const tok of rpn){
        if(tok.t==='num'){ st.push(tok.v); }
        else if(tok.t==='var'){ st.push(x); }
        else if(tok.t==='op'){
          const b=st.pop(), a=st.pop();
          if(a===undefined||b===undefined) return NaN;
          st.push(ops[tok.v].f(a,b));
        } else if(tok.t==='fn'){
          const a=st.pop(); if(a===undefined) return NaN;
          switch(tok.v){
            case 'sin': st.push(Math.sin(a)); break;
            case 'cos': st.push(Math.cos(a)); break;
            case 'tan': st.push(Math.tan(a)); break;
            case 'ln': st.push(Math.log(a)); break;
            case 'log10': st.push(Math.log10(a)); break;
            case 'exp': st.push(Math.exp(a)); break;
            case 'sqrt': st.push(Math.sqrt(a)); break;
            case 'abs': st.push(Math.abs(a)); break;
          }
        }
      }
      return st.length===1 ? st[0] : NaN;
    }

    function parseExpression(s){
      const tokens = tokenize(s);
      return toRPN(tokens);
    }

    // --- Numerics ---
    function derivative(f, x0){
      // Adaptive symmetric difference
      let h = Math.max(1e-6, Math.abs(x0)*1e-5);
      const f1 = (h)=> (f(x0+h)-f(x0-h))/(2*h);
      let d1=f1(h), d2=f1(h/2);
      // simple Richardson extrapolation
      return (4*d2 - d1)/3;
    }

    function simpson(f, a, b, n=200){
      if(!Number.isFinite(a) || !Number.isFinite(b)) return NaN;
      if(a===b) return 0;
      if(n%2===1) n++; // even subintervals
      const h=(b-a)/n;
      let s = f(a) + f(b);
      let odd=0, even=0;
      for(let i=1;i<n;i++){
        const x=a+i*h, fx=f(x);
        if(!Number.isFinite(fx)) return NaN;
        if(i%2===1) odd+=fx; else even+=fx;
      }
      return (h/3)*(s + 4*odd + 2*even);
    }

    function findRoots(f, xmin, xmax, step){
      const roots=[];
      const clamp=(v)=> Math.max(-1e12, Math.min(1e12, v));
      let x=xmin, fx=clamp(f(x));
      for(let i=0; x+step<=xmax+1e-12; i++){
        const nx = Math.min(xmax, x+step);
        const f1 = clamp(f(nx));
        if(Number.isFinite(fx) && Number.isFinite(f1)){
          if(fx===0) roots.push(x);
          if(fx*f1<0){
            // bisection
            let a=x, b=nx, fa=fx, fb=f1;
            for(let k=0;k<60;k++){
              const m = 0.5*(a+b);
              const fm = f(m);
              if(!Number.isFinite(fm)) break;
              if(Math.sign(fa)===Math.sign(fm)){ a=m; fa=fm; } else { b=m; fb=fm; }
              if(Math.abs(b-a)<1e-10) break;
            }
            roots.push(0.5*(a+b));
          }
        }
        x=nx; fx=f1;
      }
      // deduplicate near-equal
      return roots.filter((r,i,arr)=> i===0 || Math.abs(r-arr[i-1])>1e-6);
    }

    // --- Compute wrapper ---
    let rpn = parseExpression(el.expr.value);
    function f(x){ return evalRPN(rpn, x); }

    function compute(){
      // validate basics
      try{ rpn = parseExpression(el.expr.value); setErr('expr',''); }catch(e){ setErr('expr', e.message); return; }

      let x0,a,b,xmin,xmax,step;
      try{ x0 = numVal('x0'); setErr('x0',''); }catch([,m]){ setErr('x0',m); return; }
      try{ a  = numVal('a');  setErr('a',''); }catch([,m]){ setErr('a',m); return; }
      try{ b  = numVal('b');  setErr('b',''); }catch([,m]){ setErr('b',m); return; }
      try{ xmin=numVal('xmin'); setErr('xmin',''); }catch([,m]){ setErr('xmin',m); return; }
      try{ xmax=numVal('xmax'); setErr('xmax',''); }catch([,m]){ setErr('xmax',m); return; }
      try{ step=numVal('step'); if(step<=0) throw [null,'Step must be positive.']; setErr('step',''); }catch([,m]){ setErr('step',m||'Invalid'); return; }
      if(xmax<=xmin){ setErr('xmax','xmax must be greater than xmin.'); return; }

      // compute
      const fwrap = (x)=> evalRPN(rpn, x);
      const y0 = fwrap(x0);
      const d0 = derivative(fwrap, x0);
      const I  = simpson(fwrap, a, b);

      const roots = findRoots(fwrap, xmin, xmax, step);
      el.res.fx.textContent = fmt(y0);
      el.res.dfx.textContent = fmt(d0);
      el.res.int.textContent = fmt(I);
      el.res.roots.textContent = roots.length ? roots.map(r=>fmt(r)).join(', ') : 'No sign changes detected';

      el.res.meta.textContent =
        `Parsed OK. Samples for plot/roots use step ${step}. Derivative via symmetric difference with Richardson refinement. Integral via composite Simpson with even ${Math.max(200, Math.floor((xmax-xmin)/step/5)*2)} subintervals.`;
    }

    // --- Plot ---
    let chart;
    function plot(){
      try{ rpn = parseExpression(el.expr.value); setErr('expr',''); }catch(e){ setErr('expr', e.message); return; }
      let xmin,xmax,step;
      try{ xmin=numVal('xmin'); setErr('xmin',''); }catch([,m]){ setErr('xmin',m); return; }
      try{ xmax=numVal('xmax'); setErr('xmax',''); }catch([,m]){ setErr('xmax',m); return; }
      try{ step=numVal('step'); if(step<=0) throw [null,'Step must be positive.']; setErr('step',''); }catch([,m]){ setErr('step',m||'Invalid'); return; }
      if(xmax<=xmin){ setErr('xmax','xmax must be greater than xmin.'); return; }

      const pts=[];
      for(let x=xmin; x<=xmax+1e-12; x+=step){
        const y=evalRPN(rpn,x);
        if(Number.isFinite(y) && Math.abs(y)<1e12) pts.push({x,y});
        else pts.push({x:null,y:null}); // create a break in line
      }

      const data = {
        datasets: [{
          label: 'f(x)',
          data: pts,
          parsing: false,
          showLine: true,
          radius: 0,
          borderWidth: 2,
          segment: {
            borderColor: ctx => {
              const p = ctx.p0, n = ctx.p1;
              return (p.parsed.y===null || n.parsed.y===null) ? 'rgba(0,0,0,0)' : undefined;
            }
          }
        }]
      };
      const options = {
        responsive:true,
        maintainAspectRatio:false,
        scales:{ x:{ type:'linear', title:{display:true,text:'x'}}, y:{ title:{display:true,text:'f(x)'} } },
        plugins:{ legend:{display:false} }
      };

      if(chart){ chart.data=data; chart.update(); }
      else { chart = new Chart(el.chart, { type:'line', data, options }); }
    }

    // --- Buttons ---
    el.btnCalc.addEventListener('click', compute);
    el.btnPlot.addEventListener('click', plot);
    el.btnPrint.addEventListener('click', ()=> window.print());
    el.btnReset.addEventListener('click', ()=>{
      el.expr.value = 'sin(x)+x^2-3*x+2';
      el.x0.value = '1';
      el.a.value = '0';
      el.b.value = '3';
      el.xmin.value = (-2*Math.PI).toFixed(5);
      el.xmax.value = ( 2*Math.PI).toFixed(5);
      el.step.value = '0.02';
      Object.values(el.err).forEach(p=>p.textContent='');
      el.res.fx.textContent = el.res.dfx.textContent = el.res.int.textContent = '—';
      el.res.roots.textContent = '—';
      el.res.meta.textContent = '—';
      if(chart){ chart.destroy(); chart=null; }
    });

    // initial compute/plot for good UX
    compute();
    plot();
  })();
  </script>
</body>
</html>
