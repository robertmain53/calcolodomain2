<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<title>IBU Calculator Homebrew | Advanced Tinseth IBU Calculator for Brewers</title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="Professional-grade IBU calculator for homebrewers. Compute bitterness using the Tinseth method with multiple hop additions, whirlpool adjustments, pellet/leaf factors, and BU:GU ratio. WCAG 2.1 AA accessible and mobile-first." name="description"/>
<meta content="Ugo Candido" name="author"/>
<link href="https://calcdomain.com/ibu-homebrew.html" rel="canonical"/>
<meta content="#ffffff" name="theme-color"/>
<meta content="index,follow,max-snippet:-1,max-image-preview:large,max-video-preview:-1" name="robots"/>
<!-- Preload + async-load non-critical global stylesheet -->
<link as="style" href="style.css" onload="this.onload=null;this.rel='stylesheet'" rel="preload"/>
<noscript><link href="style.css" rel="stylesheet"/></noscript>
<!-- KaTeX for LaTeX rendering (lightweight, fast) -->
<link as="style" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" onload="this.onload=null;this.rel='stylesheet'" rel="preload"/>
<noscript><link href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" rel="stylesheet"/></noscript>
<script crossorigin="anonymous" defer="" integrity="" src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script crossorigin="anonymous" defer="" integrity="" onload="renderMathInElement(document.body,{delimiters:[{left:'$$',right:'$$',display:true},{left:'\\[',right:'\\]',display:true},{left:'$',right:'$',display:false}]});" src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "name": "IBU Calculator Homebrew",
  "description": "Professional-grade IBU calculator using the Tinseth method. Compute IBUs from multiple hop additions, whirlpool temperature, and pellet/leaf form with accessible, mobile-first UX.",
  "url": "https://calcdomain.com/ibu-homebrew.html",
  "inLanguage": "en",
  "isPartOf": {
    "@type": "WebSite",
    "name": "CalcDomain",
    "url": "https://calcdomain.com"
  },
  "author": {
    "@type": "Person",
    "name": "Ugo Candido"
  },
  "publisher": {
    "@type": "Organization",
    "name": "CalcDomain",
    "logo": {
      "@type": "ImageObject",
      "url": "https://calcdomain.com/logo.png"
    }
  },
  "mainEntity": [
    {
      "@type": "HowTo",
      "name": "How it works: a step-by-step example",
      "description": "Calculate beer bitterness (IBU) with the Tinseth method using batch volume, wort gravity, and hop additions.",
      "totalTime": "PT1M",
      "tool": "Tinseth IBU formula",
      "step": [
        {
          "@type": "HowToStep",
          "name": "Input wort parameters",
          "text": "Set Batch Volume to 20 L and Original Gravity to 1.050."
        },
        {
          "@type": "HowToStep",
          "name": "Add hop additions",
          "text": "Add 25 g of 10% AA pellet hops at 60 minutes and 15 g at 10 minutes (boil)."
        },
        {
          "@type": "HowToStep",
          "name": "Review results",
          "text": "The calculator displays total IBUs and the per-addition breakdown, plus BU:GU ratio."
        }
      ]
    },
    {
      "@type": "FAQPage",
      "mainEntity": [
        {
          "@type": "Question",
          "name": "Which IBU method does this calculator use?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "By default it uses the Tinseth method, a widely accepted approach for modern homebrewing. You can toggle pellet vs. leaf and whirlpool factors."
          }
        },
        {
          "@type": "Question",
          "name": "Can I account for whirlpool/steep additions?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Yes. Select 'Whirlpool' for an addition, set the steep time and temperature, and the tool applies a temperature-based utilization factor."
          }
        },
        {
          "@type": "Question",
          "name": "Do pellet hops change the IBU?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "Pellet hops typically yield slightly higher utilization. We apply a 10% utilization increase when 'Pellet' is selected."
          }
        },
        {
          "@type": "Question",
          "name": "What units can I use?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "You can switch batch volume between liters and US gallons, and hop weight between grams and ounces. Values convert automatically without losing precision."
          }
        },
        {
          "@type": "Question",
          "name": "How accurate are IBU estimates?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "IBU is a model-based estimate. Factors like boil vigor, kettle geometry, and trub losses can shift real outcomes. This tool focuses on high-quality calculations grounded in Tinseth’s formula and best-practice adjustments."
          }
        },
        {
          "@type": "Question",
          "name": "What is the BU:GU ratio?",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "BU:GU is Bitterness Units to Gravity Units. GU equals (OG − 1) × 1000. The ratio helps balance hop bitterness against malt sweetness in recipe design."
          }
        }
      ]
    }
  ]
}
  </script>
<style>
    /* Critical, mobile-first CSS (WCAG 2.1 AA, high-contrast defaults) */
    :root{
      --primary:#005A9C; --secondary:#003F6E; --bg:#FFFFFF; --bg-alt:#F8F9FA;
      --text:#212529; --muted:#6C757D; --border:#DEE2E6; --success:#1E7E34; --error:#DC3545;
      --radius:12px; --radius-sm:8px; --shadow:0 2px 8px rgba(0,0,0,.06);
      --touch:48px;
    }
    @media (prefers-reduced-motion: reduce){
      *{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}
    }
    *{box-sizing:border-box}
    html{font-size:16px}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6}
    a{color:var(--primary);text-decoration:none}
    a:hover{text-decoration:underline}
    .skip-link{position:absolute;left:8px;top:-40px;background:var(--primary);color:#fff;padding:8px 12px;border-radius:6px;z-index:1000}
    .skip-link:focus{top:8px}
    header{border-bottom:1px solid var(--border);background:#fff}
    .container{max-width:1160px;margin:0 auto;padding:0 1rem}
    .header-inner{display:flex;align-items:center;gap:1rem;justify-content:space-between;min-height:64px}
    .brand{font-weight:800;color:var(--secondary);font-size:1.125rem}
    .main{padding:1.25rem 0}
    nav.breadcrumb{font-size:.9rem;color:var(--muted);margin-bottom:1rem}
    h1{font-size:1.75rem;margin:0 0 .5rem;color:var(--secondary)}
    p{margin:.5rem 0 1rem;max-width:75ch}
    .layout{display:grid;grid-template-columns:1fr;gap:1.25rem;margin-top:.5rem}
    @media (min-width: 992px){ .layout{grid-template-columns: minmax(280px,420px) 1fr} }

    .card{background:#fff;border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem}
    .calculator-container h2{margin:0 0 .75rem}
    .form-group{margin-bottom:1rem}
    label{display:block;font-weight:700;margin-bottom:.4rem}
    .help-inline{font-size:.9rem;color:var(--muted)}
    .tooltip-btn{margin-left:.5rem;inline-size:var(--touch);block-size:var(--touch);min-width:var(--touch);min-height:var(--touch);display:inline-flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:50%;background:#fff;color:var(--secondary);cursor:pointer}
    .tooltip-btn:focus{outline:3px solid var(--primary);outline-offset:2px}
    .tooltip-text{display:none;margin-top:.35rem;color:var(--muted);font-size:.9rem}
    .tooltip-text[aria-hidden="false"]{display:block}

    .input-row{display:flex;gap:.5rem;align-items:stretch}
    .input-row > *{flex:1}
    .input-wrap{position:relative}
    input[type="number"],input[type="text"],select{
      width:100%;min-height:var(--touch);padding:.7rem .85rem;border:1px solid var(--border);
      border-radius:10px;font-size:1rem;transition:border-color .2s, box-shadow .2s; background:#fff;color:var(--text)
    }
    input:focus,select:focus{outline:3px solid var(--primary);outline-offset:2px;border-color:var(--primary);box-shadow:0 0 0 2px rgba(0,90,156,.15)}
    .unit-suffix{position:absolute;right:.75rem;top:50%;transform:translateY(-50%);color:var(--muted);pointer-events:none}
    .error{color:var(--error);font-size:.9rem;margin-top:.25rem}
    .radio-group{display:flex;gap:.5rem}
    .radio-item{flex:1}
    .radio-item input{position:absolute;opacity:0}
    .radio-item label{display:flex;align-items:center;justify-content:center;border:1px solid var(--border);border-radius:10px;padding:.6rem;min-height:var(--touch);cursor:pointer}
    .radio-item input:checked + label{background:var(--primary);color:#fff;border-color:var(--primary)}
    .radio-item input:focus + label{outline:3px solid var(--primary);outline-offset:2px}

    .hop-table{display:grid;gap:.75rem}
    .hop-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:.5rem}
    .hop-controls{display:flex;gap:.5rem}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.4rem;min-height:var(--touch);min-width:var(--touch);padding:.6rem .9rem;border-radius:10px;border:1px solid var(--primary);background:var(--primary);color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:#fff;color:var(--primary)}
    .btn.ghost{background:#fff;border-color:var(--border);color:var(--secondary)}
    .btn:focus{outline:3px solid var(--primary);outline-offset:2px}
    .btn.small{min-height:40px;padding:.45rem .7rem;font-size:.95rem}

    .results{margin-top:1rem;padding:1rem;background:var(--bg-alt);border:1px solid var(--border);border-radius:var(--radius);min-height:240px}
    .result-line{display:flex;justify-content:space-between;align-items:flex-end;border-bottom:1px solid var(--border);padding:.5rem 0}
    .result-line:last-child{border-bottom:0}
    .result-key{color:var(--muted)}
    .result-val{font-weight:800;color:var(--success);font-size:1.25rem}

    .content h2{margin-top:1.25rem;color:var(--secondary)}
    .formula{background:#eef3f8;border:1px solid #d9e3ef;border-radius:10px;padding:1rem;margin:.75rem 0;overflow-x:auto}

    footer{border-top:1px solid var(--border);background:#fff;margin-top:2rem}
    .footer-inner{display:grid;gap:1rem;padding:1.25rem 0;color:var(--muted);font-size:.95rem}
    .author-box{margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border);color:var(--muted);font-size:.95rem}
    .sr-only{position:absolute !important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
  </style>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="search.js" defer></script>
<!-- MathJax for LaTeX formulas -->
<script>
  window.MathJax = {
    tex: {
      inlineMath: [['\(','\)'], ['$', '$']],
      displayMath: [['\[','\]']]
    },
    svg: { fontCache: 'global' }
  };
</script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link rel="preload" href="/assets/js/mobile-menu.js" as="script">
<link rel="preload" href="/assets/js/page-enhancements.js" as="script">

</head>
<body>

<a class="skip-link" href="#main">Skip to main content</a>
<header>
<div class="container header-inner" role="banner">
<a aria-label="CalcDomain - Home" class="brand" href="/">CalcDomain</a>
<form action="/search" aria-label="Site search" method="get" role="search">
<label class="sr-only" for="q">Search calculators</label>
<div class="input-row">
<input aria-label="Search calculators" id="q" name="q" placeholder="Search calculators…" type="search"/>
<button aria-label="Submit search" class="btn secondary" type="submit">Search</button>
</div>
</form>
</div>
</header>
<main class="main" id="main">
<div class="container">
<nav aria-label="Breadcrumb" class="breadcrumb">
<a href="/">Home</a> / <a href="https://calcdomain.com/everyday-life.html">Everyday Life</a> / <a href="https://calcdomain.com/everyday-life/hobbies.html">Hobbies</a> / IBU Calculator
      </nav>
<h1>ibu calculator homebrew</h1>
<p>This advanced IBU calculator helps homebrewers precisely estimate beer bitterness using the Tinseth method. It supports multiple hop additions, whirlpool temperature adjustments, pellet vs. leaf utilization, unit switching, and instant per-addition breakdown—optimized for mobile and accessibility.</p>
<div class="layout">
<!-- Calculator -->
<aside aria-labelledby="calc-heading" class="card calculator-container">
<section aria-labelledby="calc-heading">
<h2 id="calc-heading">Interactive IBU Calculator</h2>
<!-- Units -->
<div class="form-group">
<fieldset>
<legend class="sr-only">Choose units</legend>
<div aria-label="Units" class="radio-group" role="radiogroup">
<div class="radio-item">
<input checked="" id="unitsMetric" name="units" type="radio" value="metric"/>
<label for="unitsMetric">Metric (L, g)</label>
</div>
<div class="radio-item">
<input id="unitsUS" name="units" type="radio" value="us"/>
<label for="unitsUS">US (gal, oz)</label>
</div>
</div>
</fieldset>
</div>
<!-- Wort parameters -->
<div class="form-group">
<label for="volume">Batch volume *</label>
<div class="input-wrap">
<input aria-describedby="volumeHelp volumeError" aria-required="true" id="volume" inputmode="decimal" min="0" placeholder="e.g., 20" step="0.1" type="number"/>
<span class="unit-suffix" id="volumeUnitLabel">L</span>
</div>
<div class="help-inline" id="volumeHelp">Final volume into fermenter.</div>
<div aria-live="polite" class="error" id="volumeError"></div>
</div>
<div class="form-group">
<label for="og">
                Original gravity (OG) *
                <button aria-controls="ogTip" aria-expanded="false" aria-label="Explain original gravity" class="tooltip-btn" id="ogTipBtn" title="What is OG?" type="button">?</button>
</label>
<div class="input-wrap">
<input aria-describedby="ogTip ogError" aria-required="true" id="og" inputmode="decimal" max="1.2" min="1" placeholder="e.g., 1.050" step="0.001" type="number"/>
</div>
<div aria-hidden="true" class="tooltip-text" id="ogTip">Specific gravity of wort before fermentation (e.g., 1.050). Used by Tinseth to adjust hop utilization.</div>
<div aria-live="polite" class="error" id="ogError"></div>
</div>
<!-- Hop additions -->
<div class="form-group">
<label>Hop additions *</label>
<div aria-live="off" class="hop-table" id="hopTable">
<!-- Dynamic rows injected here -->
</div>
<div class="hop-controls" style="margin-top:.5rem">
<button aria-label="Add hop addition" class="btn" id="addAdditionBtn" type="button">+ Add addition</button>
<button aria-label="Clear all additions" class="btn ghost" id="clearAllBtn" type="button">Clear</button>
</div>
</div>
<!-- Results container -->
<section aria-labelledby="resultsHeading" aria-live="polite" class="results" id="resultsContainer">
<h3 class="sr-only" id="resultsHeading">Results</h3>
<div class="result-line">
<span class="result-key">Total IBU</span>
<span class="result-val" id="totalIbu">0.0</span>
</div>
<div class="result-line">
<span class="result-key">BU:GU ratio</span>
<span class="result-val" id="bugu">0.00</span>
</div>
<div class="result-line">
<span class="result-key">Per-addition breakdown</span>
<span class="result-val" id="breakdownLabel">See list below</span>
</div>
<div class="help-inline" id="breakdownList" style="margin-top:.5rem"></div>
</section>
</section>
</aside>
<!-- Content -->
<article aria-labelledby="content-heading" class="card content">
<h2 id="content-heading">Authoritative content for precise results</h2>
<section aria-labelledby="data-source-heading">
<h2 id="data-source-heading">Data Source and Methodology</h2>
<p>
              Primary method: <strong>Tinseth IBU</strong> based on: Glen Tinseth, “The Relative Utilization of Alpha Acids from Hops,” 1997.
              Reference: <a href="https://web.archive.org/web/20181224162305/http://www.realbeer.com/hops/research.html" rel="noopener" target="_blank">RealBeer Hop Research (Archived)</a>.
              All calculations implement Tinseth’s utilization function with adjustments for pellet form and whirlpool temperature.
            </p>
<p>Tutti i calcoli si basano rigorosamente sulle formule e sui dati forniti da questa fonte.</p>
</section>
<section aria-labelledby="formula-heading">
<h2 id="formula-heading">The Formula Explained</h2>
<div class="formula">
<p>Utilization U (Tinseth):</p>
<p>$$ U = 1.65 \\times 0.000125^{(SG - 1)} \\times \\frac{1 - e^{-0.04\\,t}}{4.15} $$</p>
<p>IBU per addition:</p>
<p>$$ \\mathrm{IBU} = \\frac{\\mathrm{AA} \\times W_{g} \\times 1000 \\times U \\times F_{form} \\times F_{wp}}{V_{L}} $$</p>
<p>Where:</p>
<ul>
<li>SG = specific gravity of the boil/wort (e.g., 1.050).</li>
<li>t = boil time in minutes for the addition.</li>
<li>AA = alpha-acid fraction (e.g., 0.10 for 10%).</li>
<li>W_g = hop weight in grams.</li>
<li>V_L = batch volume in liters.</li>
<li>F_form = pellet factor (1.10 for pellet, 1.00 for whole leaf).</li>
<li>F_wp = whirlpool temperature factor (0.02–1.0; see glossary).</li>
</ul>
</div>
</section>
<section aria-labelledby="glossary-heading">
<h2 id="glossary-heading">Glossary of Variables</h2>
<ul>
<li><strong>Batch volume (V_L):</strong> Final post-boil volume into fermenter (L or US gal).</li>
<li><strong>Original gravity (SG/OG):</strong> Wort density before fermentation (e.g., 1.050).</li>
<li><strong>Alpha acid (AA%):</strong> Hop alpha acid percentage; enter as a percent (e.g., 10).</li>
<li><strong>Weight (W):</strong> Hop weight (g or oz). The calculator converts internally to grams.</li>
<li><strong>Boil time (t):</strong> Minutes the hops are boiled (0–120).</li>
<li><strong>Hop form factor (F_form):</strong> 1.10 for pellet, 1.00 for leaf/whole cone.</li>
<li><strong>Whirlpool factor (F_wp):</strong> Temperature-based reduction for non-boil isomerization. For example: 99–100°C ≈ 1.0, 90°C ≈ 0.6, 85°C ≈ 0.5, 80°C ≈ 0.3, 70°C ≈ 0.15, 60°C ≈ 0.05.</li>
<li><strong>BU:GU ratio:</strong> IBU divided by gravity units (GU = (OG − 1) × 1000).</li>
</ul>
</section>
<section aria-labelledby="example-heading">
<h2 id="example-heading">Worked Example</h2>
<h3>How It Works: A Step-by-Step Example</h3>
<p>Goal: 20 L batch, OG 1.050.</p>
<ol>
<li>Addition A: 25 g, 10% AA, pellet, 60 min boil.</li>
<li>Addition B: 15 g, 10% AA, pellet, 10 min boil.</li>
</ol>
<div class="formula">
<p>Bigness factor: $1.65 \\times 0.000125^{(1.050 - 1)} \\approx 1.65 \\times 0.000125^{0.050}$</p>
<p>Time factor at 60 min: $\\frac{1 - e^{-0.04 \\cdot 60}}{4.15}$; at 10 min: $\\frac{1 - e^{-0.04 \\cdot 10}}{4.15}$</p>
<p>Compute U for each, multiply by AA, weight, pellet factor (1.10), divide by 20 L, then sum IBUs.</p>
</div>
</section>
<section aria-labelledby="faq-heading">
<h2 id="faq-heading">Frequently Asked Questions (FAQ)</h2>
<div>
<h3>Which IBU method does this calculator use?</h3>
<p>It implements the Tinseth method with optional pellet and whirlpool adjustments—an industry-standard approach for accurate homebrew planning.</p>
<h3>How do whirlpool temperatures affect IBUs?</h3>
<p>Isomerization slows as temperature drops below boiling. This tool applies a temperature factor so 80°C contributes less bitterness than 95–100°C for the same time.</p>
<h3>Does leaf vs. pellet matter?</h3>
<p>Yes. Pellet hops typically yield slightly higher utilization. We apply a 10% uplift when you choose pellet form.</p>
<h3>Why is my measured IBU different from the estimate?</h3>
<p>Kettle geometry, boil vigor, trub losses, and hop age can impact real IBUs. The model gives a close estimate; consider sensory evaluation and lab tests for exactness.</p>
<h3>Can I enter additions at 0 minutes (flameout)?</h3>
<p>Yes. Use 0 minutes as a boil addition (minimal bitterness) or choose Whirlpool and set your steep time and temperature for a more realistic estimate.</p>
<h3>What BU:GU should I aim for?</h3>
<p>It depends on style. For example, ~0.5–0.8 is typical for pale ales/IPAs, while malty styles may be lower. Always cross-check the target style guidelines.</p>
</div>
<div class="author-box">
<p>
                Strumento sviluppato da <strong>Ugo Candido</strong>. Contenuti verificati da <strong>CalcDomain Editorial Team</strong>.<br/>
                Tool developed by <strong>Ugo Candido</strong>. Content reviewed by <strong>CalcDomain Editorial Team</strong>.<br/>
                Ultima revisione per l'accuratezza in data: <time datetime="" id="lastReviewed">2025-09-12</time>.
              </p>
</div>
</section>
</article>
</div>
</div>
</main>
<!-- Standard Footer --> 
<script defer="">
  (function(){
    'use strict';

    // DOM helpers
    const $ = (sel, ctx=document) => ctx.querySelector(sel);
    const $$ = (sel, ctx=document) => Array.from(ctx.querySelectorAll(sel));

    const volumeInput = $('#volume');
    const volumeError = $('#volumeError');
    const ogInput = $('#og');
    const ogError = $('#ogError');
    const unitsMetric = $('#unitsMetric');
    const unitsUS = $('#unitsUS');
    const volumeUnitLabel = $('#volumeUnitLabel');

    const hopTable = $('#hopTable');
    const addBtn = $('#addAdditionBtn');
    const clearBtn = $('#clearAllBtn');

    const totalIbuEl = $('#totalIbu');
    const buguEl = $('#bugu');
    const breakdownList = $('#breakdownList');

    const ogTipBtn = $('#ogTipBtn');
    const ogTip = $('#ogTip');
    const resultsContainer = $('#resultsContainer');

    // State
    const state = {
      units: { volume: 'L', weight: 'g' }, // 'L' or 'gal'; 'g' or 'oz'
      rows: [], // {id, name, aa, weight, time, type, form, tempC}
      nextId: 1
    };

    // Accessibility: tooltip toggle
    ogTipBtn.addEventListener('click', function(){
      const expanded = this.getAttribute('aria-expanded') === 'true';
      this.setAttribute('aria-expanded', String(!expanded));
      ogTip.setAttribute('aria-hidden', String(expanded));
    });

    // Units toggling
    function setUnits(system){
      if(system === 'metric'){
        // convert current values to metric
        if(state.units.volume === 'gal'){
          const v = parseFloat(volumeInput.value);
          if(!isNaN(v)){ volumeInput.value = round(v * 3.78541, 2); }
        }
        volumeUnitLabel.textContent = 'L';
        state.units.volume = 'L';
        // convert hop rows weights to grams
        state.rows.forEach(r=>{
          const weightInput = document.getElementById(`weight-${r.id}`);
          const unitLabel = document.getElementById(`unit-${r.id}`);
          const w = parseFloat(weightInput.value);
          if(!isNaN(w) && r.__unit === 'oz'){
            weightInput.value = round(w * 28.349523125, 1);
            r.__unit = 'g';
          }
          unitLabel.textContent = 'g';
        });
      } else {
        // convert to US units
        if(state.units.volume === 'L'){
          const v = parseFloat(volumeInput.value);
          if(!isNaN(v)){ volumeInput.value = round(v / 3.78541, 3); }
        }
        volumeUnitLabel.textContent = 'gal';
        state.units.volume = 'gal';
        // convert hop rows weights to ounces
        state.rows.forEach(r=>{
          const weightInput = document.getElementById(`weight-${r.id}`);
          const unitLabel = document.getElementById(`unit-${r.id}`);
          const w = parseFloat(weightInput.value);
          if(!isNaN(w) && (r.__unit === 'g' || !r.__unit)){
            weightInput.value = round(w / 28.349523125, 2);
            r.__unit = 'oz';
          }
          unitLabel.textContent = 'oz';
        });
      }
      recalc();
    }

    unitsMetric.addEventListener('change', (e)=>{ if(e.target.checked) setUnits('metric'); });
    unitsUS.addEventListener('change', (e)=>{ if(e.target.checked) setUnits('us'); });

    // Validation helpers
    function setError(el, msg){
      el.textContent = msg || '';
    }
    function round(n, d=2){
      return Math.round(n * Math.pow(10,d)) / Math.pow(10,d);
    }

    function validateVolume(){
      const v = parseFloat(volumeInput.value);
      if(isNaN(v) || v <= 0){
        setError(volumeError, 'Enter a valid positive batch volume.');
        volumeInput.setAttribute('aria-invalid', 'true');
        return null;
      }
      setError(volumeError, '');
      volumeInput.removeAttribute('aria-invalid');
      return v;
    }

    function validateOG(){
      const og = parseFloat(ogInput.value);
      if(isNaN(og) || og < 1.0 || og > 1.2){
        setError(ogError, 'Enter OG between 1.000 and 1.200 (e.g., 1.050).');
        ogInput.setAttribute('aria-invalid', 'true');
        return null;
      }
      setError(ogError, '');
      ogInput.removeAttribute('aria-invalid');
      return og;
    }

    volumeInput.addEventListener('blur', validateVolume);
    ogInput.addEventListener('blur', validateOG);
    volumeInput.addEventListener('input', recalc);
    ogInput.addEventListener('input', recalc);

    // Hop rows
    function hopRowTemplate(id){
      /* Row fields:
         - name (optional)
         - type: boil | whirlpool
         - aa %
         - weight
         - time (min)
         - form: pellet | leaf
         - tempC (only for whirlpool)
      */
      const row = document.createElement('div');
      row.className = 'hop-row';
      row.id = `row-${id}`;
      row.setAttribute('role', 'group');
      row.setAttribute('aria-label', `Hop addition ${id}`);

      row.innerHTML = `
        <div>
          <label class="sr-only" for="name-${id}">Addition name</label>
          <input id="name-${id}" type="text" placeholder="Addition name (optional)" aria-label="Addition name">
        </div>
        <div>
          <label class="sr-only" for="type-${id}">Type</label>
          <select id="type-${id}" aria-label="Addition type">
            <option value="boil" selected>Boil</option>
            <option value="whirlpool">Whirlpool</option>
          </select>
        </div>
        <div>
          <label class="sr-only" for="aa-${id}">Alpha acid % *</label>
          <div class="input-wrap">
            <input id="aa-${id}" type="number" inputmode="decimal" min="0" max="25" step="0.1" placeholder="AA %" aria-required="true" aria-describedby="aaErr-${id}">
            <span class="unit-suffix">%</span>
          </div>
          <div id="aaErr-${id}" class="error" aria-live="polite"></div>
        </div>
        <div>
          <label class="sr-only" for="weight-${id}">Weight *</label>
          <div class="input-wrap">
            <input id="weight-${id}" type="number" inputmode="decimal" min="0" step="0.1" placeholder="Weight" aria-required="true" aria-describedby="weightErr-${id}">
            <span class="unit-suffix" id="unit-${id}">${state.units.volume === 'gal' ? 'oz' : 'g'}</span>
          </div>
          <div id="weightErr-${id}" class="error" aria-live="polite"></div>
        </div>
        <div>
          <label class="sr-only" for="time-${id}">Time (min) *</label>
          <div class="input-wrap">
            <input id="time-${id}" type="number" inputmode="numeric" min="0" max="120" step="1" placeholder="Time (min)" aria-required="true" aria-describedby="timeErr-${id}">
            <span class="unit-suffix">min</span>
          </div>
          <div id="timeErr-${id}" class="error" aria-live="polite"></div>
        </div>
        <div>
          <label class="sr-only" for="form-${id}">Hop form</label>
          <select id="form-${id}" aria-label="Hop form">
            <option value="pellet" selected>Pellet</option>
            <option value="leaf">Leaf/Whole</option>
          </select>
        </div>
        <div>
          <label class="sr-only" for="temp-${id}">Whirlpool temp (°C)</label>
          <div class="input-wrap">
            <input id="temp-${id}" type="number" inputmode="decimal" min="50" max="100" step="1" placeholder="Temp (°C)" aria-describedby="tempHelp-${id} tempErr-${id}" disabled>
            <span class="unit-suffix">°C</span>
          </div>
          <div id="tempHelp-${id}" class="help-inline">Required only for whirlpool.</div>
          <div id="tempErr-${id}" class="error" aria-live="polite"></div>
        </div>
        <div class="hop-controls">
          <button type="button" class="btn small ghost" id="dup-${id}" aria-label="Duplicate addition">Duplicate</button>
          <button type="button" class="btn small secondary" id="del-${id}" aria-label="Remove addition">Remove</button>
        </div>
      `;
      return row;
    }

    function addRow(prefill){
      const id = state.nextId++;
      const rowEl = hopRowTemplate(id);
      hopTable.appendChild(rowEl);

      // default unit marker
      const rowState = {
        id, name:'', aa:null, weight:null, time:null, type:'boil', form:'pellet', tempC:null, __unit: state.units.volume === 'gal' ? 'oz' : 'g'
      };
      state.rows.push(rowState);

      // references
      const nameI = document.getElementById(`name-${id}`);
      const typeI = document.getElementById(`type-${id}`);
      const aaI = document.getElementById(`aa-${id}`);
      const weightI = document.getElementById(`weight-${id}`);
      const timeI = document.getElementById(`time-${id}`);
      const formI = document.getElementById(`form-${id}`);
      const tempI = document.getElementById(`temp-${id}`);

      const aaErr = document.getElementById(`aaErr-${id}`);
      const weightErr = document.getElementById(`weightErr-${id}`);
      const timeErr = document.getElementById(`timeErr-${id}`);
      const tempErr = document.getElementById(`tempErr-${id}`);

      const delBtn = document.getElementById(`del-${id}`);
      const dupBtn = document.getElementById(`dup-${id}`);

      function syncAndCalc(){ recalc(); }

      function validateAA(){
        const v = parseFloat(aaI.value);
        if(isNaN(v) || v < 0 || v > 25){
          aaErr.textContent = 'Enter AA% between 0 and 25.';
          aaI.setAttribute('aria-invalid','true');
          return null;
        }
        aaErr.textContent = '';
        aaI.removeAttribute('aria-invalid');
        return v;
      }
      function validateWeight(){
        const v = parseFloat(weightI.value);
        if(isNaN(v) || v <= 0){
          weightErr.textContent = 'Enter a positive hop weight.';
          weightI.setAttribute('aria-invalid','true');
          return null;
        }
        weightErr.textContent = '';
        weightI.removeAttribute('aria-invalid');
        return v;
      }
      function validateTime(){
        const v = parseFloat(timeI.value);
        if(isNaN(v) || v < 0 || v > 120){
          timeErr.textContent = 'Enter time in minutes (0–120).';
          timeI.setAttribute('aria-invalid','true');
          return null;
        }
        timeErr.textContent = '';
        timeI.removeAttribute('aria-invalid');
        return v;
      }
      function validateTemp(){
        if(typeI.value !== 'whirlpool'){ tempErr.textContent=''; tempI.removeAttribute('aria-invalid'); return null; }
        const v = parseFloat(tempI.value);
        if(isNaN(v) || v < 50 || v > 100){
          tempErr.textContent = 'Enter whirlpool temp between 50°C and 100°C.';
          tempI.setAttribute('aria-invalid','true');
          return null;
        }
        tempErr.textContent = '';
        tempI.removeAttribute('aria-invalid');
        return v;
      }

      // Events
      nameI.addEventListener('input', ()=>{ rowState.name = nameI.value; });
      typeI.addEventListener('change', ()=>{
        rowState.type = typeI.value;
        if(typeI.value === 'whirlpool'){ tempI.disabled = false; } else { tempI.disabled = true; tempI.value=''; }
        recalc();
      });
      aaI.addEventListener('blur', validateAA);
      weightI.addEventListener('blur', validateWeight);
      timeI.addEventListener('blur', validateTime);
      tempI.addEventListener('blur', validateTemp);

      [aaI, weightI, timeI, formI, tempI].forEach(el=> el.addEventListener('input', syncAndCalc));
      formI.addEventListener('change', ()=>{ rowState.form = formI.value; recalc(); });

      delBtn.addEventListener('click', ()=>{
        state.rows = state.rows.filter(r => r.id !== id);
        rowEl.remove();
        recalc();
      });

      dupBtn.addEventListener('click', ()=>{
        const clone = {
          name: nameI.value,
          type: typeI.value,
          aa: aaI.value,
          weight: weightI.value,
          time: timeI.value,
          form: formI.value,
          tempC: tempI.value
        };
        const newId = addRow();
        // prefill on the newly created row
        $('#name-'+newId).value = clone.name;
        $('#type-'+newId).value = clone.type;
        $('#aa-'+newId).value = clone.aa;
        $('#weight-'+newId).value = clone.weight;
        $('#time-'+newId).value = clone.time;
        $('#form-'+newId).value = clone.form;
        const newTemp = $('#temp-'+newId);
        if(clone.type === 'whirlpool'){ newTemp.disabled = false; newTemp.value = clone.tempC; } else { newTemp.disabled = true; newTemp.value=''; }
        recalc();
      });

      // Prefill defaults
      if(prefill){
        if(prefill.name) nameI.value = prefill.name;
        typeI.value = prefill.type || 'boil';
        aaI.value = prefill.aa || '';
        weightI.value = prefill.weight || '';
        timeI.value = prefill.time || '';
        formI.value = prefill.form || 'pellet';
        if(typeI.value === 'whirlpool'){ tempI.disabled = false; tempI.value = prefill.tempC || 80; } else { tempI.disabled = true; }
      }

      return id;
    }

    addBtn.addEventListener('click', ()=> addRow());
    clearBtn.addEventListener('click', ()=>{
      state.rows = [];
      hopTable.innerHTML = '';
      recalc();
    });

    // Initial defaults
    volumeInput.value = '20';
    ogInput.value = '1.050';
    addRow({ name: 'Bittering', type: 'boil', aa: 10, weight: 25, time: 60, form: 'pellet' });
    addRow({ name: 'Flavor', type: 'boil', aa: 10, weight: 15, time: 10, form: 'pellet' });

    // Tinseth + factors
    function whirlpoolFactor(tempC){
      if(isNaN(tempC)) return 0.0;
      if(tempC >= 99) return 1.0;
      if(tempC >= 95) return 0.8;
      if(tempC >= 90) return 0.6;
      if(tempC >= 85) return 0.5;
      if(tempC >= 80) return 0.3;
      if(tempC >= 75) return 0.2;
      if(tempC >= 70) return 0.15;
      if(tempC >= 65) return 0.1;
      if(tempC >= 60) return 0.05;
      return 0.02;
    }

    function tinsethUtil(og, minutes){
      const bigness = 1.65 * Math.pow(0.000125, (og - 1.0));
      const timeFactor = (1 - Math.exp(-0.04 * Math.max(0, minutes))) / 4.15;
      return bigness * timeFactor;
    }

    function toLiters(value, unitVol){
      return unitVol === 'gal' ? value * 3.78541 : value;
    }
    function toGrams(value, unitWeight){
      return unitWeight === 'oz' ? value * 28.349523125 : value;
    }

    function recalc(){
      const vRaw = validateVolume();
      const og = validateOG();
      const unitVol = state.units.volume; // 'L' or 'gal'
      const unitWeight = (state.units.volume === 'gal') ? 'oz' : 'g'; // align with display
      if(vRaw === null || og === null){
        totalIbuEl.textContent = '0.0';
        buguEl.textContent = '0.00';
        breakdownList.innerHTML = '';
        return;
      }
      const volumeL = toLiters(vRaw, unitVol);
      let total = 0;
      const lines = [];

      // iterate rows
      state.rows.forEach(r=>{
        const aaI = document.getElementById(`aa-${r.id}`);
        const weightI = document.getElementById(`weight-${r.id}`);
        const timeI = document.getElementById(`time-${r.id}`);
        const typeI = document.getElementById(`type-${r.id}`);
        const formI = document.getElementById(`form-${r.id}`);
        const tempI = document.getElementById(`temp-${r.id}`);

        const name = ($('#name-'+r.id)?.value || '').trim() || `Addition ${r.id}`;
        const aaPct = parseFloat(aaI.value);
        const weightVal = parseFloat(weightI.value);
        const timeMin = parseFloat(timeI.value);
        const type = typeI.value;
        const form = formI.value;
        const tempCVal = parseFloat(tempI.value);

        if(isNaN(aaPct) || isNaN(weightVal) || isNaN(timeMin)) return; // incomplete row

        const weightG = toGrams(weightVal, unitWeight);
        const AA = aaPct/100;
        const baseU = tinsethUtil(og, timeMin);
        const pelletFactor = form === 'pellet' ? 1.10 : 1.00;
        const wpFactor = type === 'whirlpool' ? whirlpoolFactor(tempCVal) : 1.0;

        const IBU = (AA * weightG * 1000 * baseU * pelletFactor * wpFactor) / Math.max(0.001, volumeL);
        if(isFinite(IBU) && IBU > 0){
          total += IBU;
          const tStr = type === 'whirlpool'
            ? `Whirlpool ${isNaN(timeMin)?0:timeMin} min @ ${isNaN(tempCVal)?'—':tempCVal}°C`
            : `${isNaN(timeMin)?0:timeMin} min`;
          const unitLabel = unitWeight;
          lines.push(`${name}: ${round(IBU,1)} IBU (${aaPct}% AA, ${weightVal} ${unitLabel}, ${tStr}, ${form})`);
        }
      });

      totalIbuEl.textContent = round(total, 1).toString();
      // BU:GU
      const GU = (og - 1) * 1000;
      const bugu = GU > 0 ? total / GU : 0;
      buguEl.textContent = round(bugu, 2).toFixed(2);
      // Breakdown
      breakdownList.innerHTML = lines.length ? '<ul>'+ lines.map(li => `<li>${escapeHtml(li)}</li>`).join('') +'</ul>' : '<em>No valid additions yet.</em>';
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // Set review date
    (function(){
      const d = new Date();
      const iso = d.toISOString().slice(0,10);
      const el = document.getElementById('lastReviewed');
      if(el){ el.dateTime = iso; el.textContent = d.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' }); }
    })();

    // Recalculate on any change within hop table (event delegation safety)
    hopTable.addEventListener('input', recalc);
    hopTable.addEventListener('change', recalc);

    // Initial calc
    recalc();
  })();
  </script>

</body></html>