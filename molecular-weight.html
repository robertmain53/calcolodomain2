<!DOCTYPE html>
<html lang="en">
<head> 
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="manifest" href="/site.webmanifest" />
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Molecular Weight Calculator | Standard Atomic Weights</title>
  <meta name="description" content="Compute molecular weight (molar mass) and elemental composition from any chemical formula. Supports hydrates, nested parentheses, and an element builder using CIAAW 2021 atomic weights."/>
  <meta name="author" content="Ugo Candido"/>
  <link rel="canonical" href="https://calcdomain.com/molecular-weight.html"/>
  <meta name="robots" content="index,follow"/>
  <meta name="theme-color" content="#0f172a"/>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="search.js" defer></script>
  <link rel="preload" href="/assets/js/mobile-menu.js" as="script">
  <link rel="preload" href="/assets/js/page-enhancements.js" as="script">

  <style>
    :root{
      --primary:#005A9C; --primary-700:#003F6E; --bg:#FFFFFF; --bg-soft:#F8F9FA;
      --text:#1C1E21; --muted:#5C6770; --border:#D7DBE0; --success:#1B9E4B; --danger:#B00020;
      --radius:12px; --radius-sm:8px; --shadow:0 4px 12px rgba(0,0,0,.06);
      --touch:48px;
    }
    @media (prefers-contrast: more){
      :root{ --primary:#003A66; --text:#000; --border:#000; }
    }
    *,*::before,*::after{ box-sizing:border-box }
    html{ font-size:16px; }
    body{
      margin:0; font-family:'Inter', system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background:var(--bg); color:var(--text); line-height:1.6;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{ color:var(--primary); text-decoration:none }
    a:hover{ text-decoration:underline }
    .skip-link{
      position:absolute; left:12px; top:-40px; background:var(--primary); color:#fff; padding:.5rem .75rem; border-radius:0 0 8px 8px; z-index:1000;
    }
    .skip-link:focus{ top:8px }
    h1{ font-size:1.875rem; line-height:1.2; margin:0 0 1rem; color:var(--primary-700) }
    p{ margin:.75rem 0; color:var(--text) }
    .lead{ color:#2b2f33; font-size:1.05rem }
    .calculator-layout{ display:grid; grid-template-columns:1fr; gap:1.25rem; margin-top:1.5rem }
    @media(min-width:992px){ .calculator-layout{ grid-template-columns:420px 1fr } }
    .card{
      background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
      padding:1.25rem;
    }
    .section-title{ font-size:1.25rem; margin:0 0 .75rem; color:var(--primary-700) }
    .form-group{ margin-bottom:1rem }
    .form-group label{ display:flex; align-items:center; gap:.5rem; font-weight:600; margin-bottom:.35rem; color:#12202e }
    .required{ color:var(--danger); margin-left:.15rem }
    .help-btn{
      appearance:none; border:1px solid var(--border); background:#fff; color:#222;
      width:var(--touch); height:var(--touch); border-radius:50%; font-weight:700; cursor:pointer;
    }
    .help-btn:focus{ outline:3px solid var(--primary); outline-offset:2px }
    .tooltip{
      display:none; border-left:4px solid var(--primary); background:var(--bg-soft); padding:.75rem; border-radius:6px;
      color:#1b2831; margin:.35rem 0 0
    }
    .tooltip[aria-hidden="false"]{ display:block }
    .input, select{
      width:100%; min-height:var(--touch); padding:.75rem .85rem; border:1px solid var(--border); border-radius:10px;
      font-size:1rem; background:#fff;
    }
    .input:focus, select:focus{ outline:3px solid var(--primary); outline-offset:2px; border-color:var(--primary) }
    .error{ color:var(--danger); font-size:.9rem; margin-top:.25rem }
    .radio-group{
      display:flex; gap:.5rem; border:1px solid var(--border); border-radius:10px; padding:.25rem;
    }
    .radio-option{ position:relative; flex:1 }
    .radio-option input{ position:absolute; inset:0; opacity:0 }
    .radio-option label{
      display:flex; align-items:center; justify-content:center; min-height:var(--touch); border-radius:8px; cursor:pointer;
      font-weight:600; color:#0f2432;
    }
    .radio-option input:focus + label{ outline:3px solid var(--primary); outline-offset:2px }
    .radio-option input:checked + label{ background:var(--primary); color:#fff }
    .controls-row{ display:flex; gap:.5rem; flex-wrap:wrap }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
      min-height:var(--touch); min-width:var(--touch); padding:.75rem 1rem; border-radius:10px; cursor:pointer;
      border:1px solid var(--primary); color:#fff; background:var(--primary); font-weight:700;
    }
    .btn.secondary{ background:#fff; color:var(--primary); }
    .btn:focus{ outline:3px solid var(--primary); outline-offset:2px }
    .builder{ border:1px dashed var(--border); border-radius:10px; padding:.75rem; background:#fbfcfd }
    .builder-row{ display:grid; grid-template-columns:1fr 1fr auto; gap:.5rem; align-items:center; margin:.5rem 0 }
    .btn-icon{
      border:1px solid var(--border); background:#fff; color:#111; width:var(--touch); height:var(--touch);
      border-radius:10px; font-size:1.1rem; cursor:pointer;
    }
    .btn-icon:hover{ background:#f1f5f9 }
    .results{ min-height:260px; }
    .result-item{ display:flex; align-items:baseline; justify-content:space-between; gap:1rem; padding:.5rem 0; border-bottom:1px solid var(--border) }
    .result-item:last-child{ border-bottom:none }
    .result-label{ color:#33424f }
    .result-value{ font-weight:800; font-size:1.15rem; color:var(--success) }
    .muted{ color:var(--muted) }
    .table-wrap{ overflow:auto; border:1px solid var(--border); border-radius:10px; margin-top:.5rem }
    table{ border-collapse:collapse; width:100%; min-width:480px; background:#fff }
    th, td{ padding:.65rem .75rem; border-bottom:1px solid var(--border); text-align:left }
    th{ background:#f1f5f9; color:#0d1d2a }
    tr:last-child td{ border-bottom:none }
    .content h2{ margin-top:1.5rem; font-size:1.35rem; color:#0a2a43 }
    .formula-box{ background:#eef4fa; border:1px solid #d7e3f2; border-radius:10px; padding:1rem; margin:.75rem 0 }
    .author-box{ margin-top:1.5rem; padding-top:.75rem; border-top:1px solid var(--border); color:#3a454e; font-size:.95rem }
    .sr-only{ position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0 }
  </style>
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Molecular Weight Calculator",
    "description": "Accurate molar mass and elemental composition from chemical formulas, hydrates, and nested groups using CIAAW 2021 standard atomic weights.",
    "url": "https://calcdomain.com/molecular-weight.html",
    "inLanguage": "en",
    "author": { "@type": "Person", "name": "Ugo Candido" },
    "publisher": { "@type": "Organization", "name": "CalcDomain" },
    "breadcrumb": {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {"@type": "ListItem","position":1,"name":"Science","item":"https://calcdomain.com/science.html"},
        {"@type": "ListItem","position":2,"name":"Chemistry","item":"https://calcdomain.com/science.html#chemistry"},
        {"@type": "ListItem","position":3,"name":"Molecular Weight Calculator","item":"https://calcdomain.com/molecular-weight.html"}
      ]
    },
    "mainEntity": [
      {
        "@type": "HowTo",
        "name": "How to compute molecular weight",
        "description": "Worked example for caffeine (C8H10N4O2) using standard atomic weights.",
        "step": [
          {"@type":"HowToStep","name":"Enter the formula","text":"Supply C8H10N4O2 in the calculator."},
          {"@type":"HowToStep","name":"Multiply counts","text":"C: 8×12.011; H: 10×1.008; N: 4×14.007; O: 2×15.999."},
          {"@type":"HowToStep","name":"Sum contributions","text":"Total molar mass = 194.194 g/mol."},
          {"@type":"HowToStep","name":"Review percentages","text":"The tool reports percent composition and empirical formula."}
        ]
      },
      {
        "@type":"FAQPage",
        "mainEntity":[
          {"@type":"Question","name":"What atomic weights are used?","acceptedAnswer":{"@type":"Answer","text":"CIAAW 2021 conventional standard atomic weights, suitable for most lab calculations."}},
          {"@type":"Question","name":"Can I enter hydrates or nested groups?","acceptedAnswer":{"@type":"Answer","text":"Yes. Parentheses, brackets, and hydrate dots (e.g., CuSO4·5H2O) are supported."}},
          {"@type":"Question","name":"Does it handle isotopes?","acceptedAnswer":{"@type":"Answer","text":"Isotopic prefixes (e.g., 13C) are stripped for now. Dedicated isotope calculations are not included."}}
        ]
      }
    ]
  }
  </script>
</head>
<body class="bg-slate-50 text-slate-900">
<a class="skip-link" href="#main">Skip to main content</a>

<header class="bg-white shadow-sm sticky top-0 z-40">
  <nav class="container mx-auto px-4 lg:px-6 py-4 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div class="flex items-center justify-between w-full md:w-auto">
      <a href="index.html" class="text-2xl font-bold text-blue-600">CalcDomain</a>
      <button id="mobile-menu-toggle" class="md:hidden p-2 text-slate-600" type="button" aria-label="Toggle menu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
      </button>
    </div>
    <div class="hidden md:block flex-1 md:px-6">
      <div class="relative max-w-xl mx-auto md:mx-0">
        <input id="search-input" type="search" placeholder="Search for a calculator..." autocomplete="off"
               class="w-full rounded-full border border-gray-300 py-2 pr-11 pl-4 focus:border-blue-500 focus:ring-2 focus:ring-blue-200"/>
        <svg class="absolute right-4 top-1/2 h-5 w-5 -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <div id="search-results" class="hidden absolute top-full left-0 right-0 z-30 mt-2 max-h-96 overflow-y-auto rounded-xl border border-gray-200 bg-white shadow-xl"></div>
      </div>
    </div>
    <div id="mobile-menu" class="hidden flex-col gap-2 md:hidden">
      <a href="search.html" class="block rounded-lg px-3 py-2 text-slate-700 hover:bg-blue-50 hover:text-blue-700">Advanced Search</a>
      <a href="science.html#categories" class="block rounded-lg px-3 py-2 text-slate-700 hover:bg-blue-50 hover:text-blue-700">Categories</a>
    </div>
    <div class="hidden md:flex items-center gap-6 text-sm">
      <a href="search.html" class="text-slate-700 hover:text-blue-600">Advanced Search</a>
      <a href="science.html#categories" class="text-slate-700 hover:text-blue-600">Categories</a>
    </div>
  </nav>
</header>

<main class="container mx-auto px-4 lg:px-6 py-10" id="main">
  <nav class="text-sm text-slate-600 mb-4" aria-label="Breadcrumb">
    <a href="index.html" class="hover:text-blue-600">Home</a> &raquo;
    <a href="science.html" class="hover:text-blue-600">Science</a> &raquo;
    <a href="science.html#chemistry" class="hover:text-blue-600">Chemistry</a> &raquo;
    <span class="text-slate-900 font-medium">Molecular Weight Calculator</span>
  </nav>

  <h1>Molecular Weight Calculator</h1>
  <p class="lead">Compute molar mass and elemental composition for any chemical formula. Parse hydrates, nested groups, and build formulas from element lists using CIAAW 2021 atomic weights.</p>

  <section class="card" aria-labelledby="calc-heading">
    <h2 class="section-title" id="calc-heading">Calculator</h2>
    <div class="form-group" role="radiogroup" aria-labelledby="mode-label">
      <div id="mode-label" class="sr-only">Select input mode</div>
      <div class="radio-group">
        <div class="radio-option">
          <input id="mode-formula" name="mode" type="radio" value="formula" checked>
          <label for="mode-formula">Formula</label>
        </div>
        <div class="radio-option">
          <input id="mode-builder" name="mode" type="radio" value="builder">
          <label for="mode-builder">Element list</label>
        </div>
      </div>
    </div>

    <div id="formula-panel" role="region" aria-labelledby="formula-label">
      <div class="form-group">
        <label id="formula-label" for="formula-input">
          Chemical formula <span class="required" aria-hidden="true">*</span>
          <button id="formula-help-btn" class="help-btn" type="button" aria-controls="formula-help" aria-expanded="false" aria-label="Toggle help for entering chemical formulas">?</button>
        </label>
        <input id="formula-input" class="input" type="text" name="formula" placeholder="e.g., C8H10N4O2, CuSO4·5H2O, Ca3(PO4)2"
               aria-required="true" aria-describedby="formula-help formula-error" inputmode="text">
        <div id="formula-help" class="tooltip" role="note" aria-hidden="true">
          Enter a valid chemical formula. Tips:
          <ul>
            <li>Use parentheses with multipliers, e.g., Ca3(PO4)2.</li>
            <li>Hydrates with a middle dot are supported, e.g., CuSO4·5H2O.</li>
            <li>Nested groups and [ ] or { } are accepted.</li>
            <li>A leading coefficient multiplies a part: 3H2O.</li>
            <li>Isotope prefixes like 13C are ignored in this version.</li>
          </ul>
        </div>
        <div id="formula-error" class="error" role="alert" aria-live="polite"></div>
      </div>
    </div>

    <div id="builder-panel" class="builder" role="region" aria-labelledby="builder-label" hidden>
      <div id="builder-label" class="sr-only">Build a composition by selecting elements and counts</div>
      <div id="builder-rows">
        <div class="builder-row">
          <select class="input el-select" aria-label="Element symbol">
            <option value="">Element…</option>
          </select>
          <input class="input el-count" type="number" min="1" step="1" inputmode="numeric" placeholder="Count" aria-label="Atom count">
          <button class="btn-icon remove-row" type="button" aria-label="Remove row">−</button>
        </div>
      </div>
      <div class="controls-row mt-2">
        <button id="add-row" type="button" class="btn secondary" aria-label="Add element row">Add element</button>
        <button id="builder-to-formula" type="button" class="btn secondary" aria-label="Convert to formula">Convert to formula</button>
      </div>
      <div id="builder-error" class="error" aria-live="polite"></div>
    </div>

    <div class="controls-row mt-3">
      <button id="clear-btn" type="button" class="btn secondary" aria-label="Clear inputs">Clear</button>
    </div>
    <div id="calc-status" class="sr-only" aria-live="polite"></div>
  </section>

  <section class="card results mt-6" aria-labelledby="results-heading">
    <h2 class="section-title" id="results-heading">Results</h2>
    <div class="result-item">
      <div class="result-label">Normalized formula (Hill notation)</div>
      <div id="normalized-formula" class="result-value" aria-live="polite">—</div>
    </div>
    <div class="result-item">
      <div class="result-label">Empirical formula</div>
      <div id="empirical-formula" class="result-value" aria-live="polite">—</div>
    </div>
    <div class="result-item">
      <div class="result-label">Molar mass</div>
      <div id="molar-mass" class="result-value" aria-live="polite">0.000 g/mol</div>
    </div>
    <div class="result-item">
      <div class="result-label">Total atoms per formula unit</div>
      <div id="total-atoms" class="result-value" aria-live="polite">0</div>
    </div>
    <div class="table-wrap" aria-live="polite" aria-label="Elemental breakdown table">
      <table>
        <thead>
          <tr>
            <th scope="col">Element</th>
            <th scope="col">Count</th>
            <th scope="col">Atomic weight (g/mol)</th>
            <th scope="col">Mass contribution (g/mol)</th>
            <th scope="col">% by mass</th>
          </tr>
        </thead>
        <tbody id="breakdown">
          <tr><td colspan="5" class="muted">Enter a formula to see the breakdown.</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <article class="card mt-6 content">
    <h2>Authoritative Data Source and Methodology</h2>
    <div class="formula-box" role="note">
      Primary source: Commission on Isotopic Abundances and Atomic Weights (CIAAW), “Standard Atomic Weights 2021.” Secondary reference: NIST Chemistry WebBook. All atomic weights are conventional values suitable for general laboratory calculations.<br>
      <strong>Statement:</strong> Tutti i calcoli si basano rigorosamente sulle formule e sui dati forniti da queste fonti.
    </div>

    <h2>The Formula Explained</h2>
    <div class="formula-box">
      For a compound composed of elements \( E_i \) with stoichiometric coefficients \( n_i \), the molar mass \( M \) is:<br>
      \( M = \sum_i n_i \, A_r(E_i) \quad [\mathrm{g \, mol^{-1}}] \)<br><br>
      The mass percent of element \( i \) is:<br>
      \( w_i(\%) = \dfrac{n_i \, A_r(E_i)}{\sum_j n_j \, A_r(E_j)} \times 100 \)
    </div>

    <h2>Worked Example</h2>
    <p><strong>Formula:</strong> C<sub>8</sub>H<sub>10</sub>N<sub>4</sub>O<sub>2</sub> (caffeine).<br>
      Multiply each atomic weight by its count and sum: 194.194 g/mol. The tool also reports percent composition and empirical formula.</p>

    <h2>Frequently Asked Questions</h2>
    <details>
      <summary>Does the calculator support hydrates and nested groups?</summary>
      <p>Yes. Use middle dots for hydrates (CuSO4·5H2O) and parentheses or brackets for nested groups (Ca3(PO4)2, K4[Fe(CN)6]).</p>
    </details>
    <details>
      <summary>Why might my value differ from literature?</summary>
      <p>Atomic weights can vary slightly by source. We use CIAAW conventional values; studies using isotopic composition or exact masses may report different figures.</p>
    </details>
    <details>
      <summary>Can I include isotopes or charges?</summary>
      <p>Isotopic prefixes (e.g., 13C) are ignored; charge does not affect molar mass in this calculator. For isotope-specific work, use a mass spectrometry tool.</p>
    </details>

    <div class="author-box">
      Tool developed by <strong>Ugo Candido</strong>. Chemistry content reviewed <time datetime="2025-02-21">February 21, 2025</time>.
    </div>
  </article>
</main>

<footer class="bg-white border-t">
  <div class="container mx-auto px-6 py-8 text-center text-sm text-slate-600 space-y-3">
    <p>&copy; 2025 CalcDomain. All rights reserved.</p>
    <div class="space-x-4">
      <a href="about.html" class="hover:text-blue-600">About</a>
      <a href="contact.html" class="hover:text-blue-600">Contact</a>
      <a href="privacy.html" class="hover:text-blue-600">Privacy</a>
      <a href="terms.html" class="hover:text-blue-600">Terms</a>
    </div>
  </div>
</footer>

<script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" id="MathJax-script"></script>
<script>
  const ATOMIC_WEIGHTS = {
    H:1.008, He:4.002602, Li:6.94, Be:9.0121831, B:10.81, C:12.011, N:14.007, O:15.999, F:18.998403163, Ne:20.1797,
    Na:22.98976928, Mg:24.305, Al:26.9815385, Si:28.085, P:30.973761998, S:32.06, Cl:35.45, Ar:39.948, K:39.0983, Ca:40.078,
    Sc:44.955908, Ti:47.867, V:50.9415, Cr:51.9961, Mn:54.938044, Fe:55.845, Co:58.933194, Ni:58.6934, Cu:63.546, Zn:65.38,
    Ga:69.723, Ge:72.63, As:74.921595, Se:78.971, Br:79.904, Kr:83.798, Rb:85.4678, Sr:87.62, Y:88.90584, Zr:91.224,
    Nb:92.90637, Mo:95.95, Tc:98, Ru:101.07, Rh:102.90550, Pd:106.42, Ag:107.8682, Cd:112.414, In:114.818, Sn:118.71,
    Sb:121.76, Te:127.60, I:126.90447, Xe:131.293, Cs:132.905452, Ba:137.327, La:138.90547, Ce:140.116, Pr:140.90766, Nd:144.242,
    Pm:145, Sm:150.36, Eu:151.964, Gd:157.25, Tb:158.92535, Dy:162.5, Ho:164.93033, Er:167.259, Tm:168.93422, Yb:173.045,
    Lu:174.9668, Hf:178.49, Ta:180.94788, W:183.84, Re:186.207, Os:190.23, Ir:192.217, Pt:195.084, Au:196.966569, Hg:200.592,
    Tl:204.38, Pb:207.2, Bi:208.98040, Po:209, At:210, Rn:222, Fr:223, Ra:226, Ac:227, Th:232.0377,
    Pa:231.03588, U:238.02891, Np:237, Pu:244, Am:243, Cm:247, Bk:247, Cf:251, Es:252, Fm:257,
    Md:258, No:259, Lr:266, Rf:267, Db:268, Sg:269, Bh:270, Hs:269, Mt:278, Ds:281,
    Rg:282, Cn:285, Nh:286, Fl:289, Mc:290, Lv:293, Ts:294, Og:294
  };

  const elementsList = Object.keys(ATOMIC_WEIGHTS).sort((a,b)=>a.localeCompare(b));
  const subMap = {'₀':'0','₁':'1','₂':'2','₃':'3','₄':'4','₅':'5','₆':'6','₇':'7','₈':'8','₉':'9'};

  const els = {
    modeFormula: document.getElementById('mode-formula'),
    modeBuilder: document.getElementById('mode-builder'),
    formulaPanel: document.getElementById('formula-panel'),
    builderPanel: document.getElementById('builder-panel'),
    formulaInput: document.getElementById('formula-input'),
    formulaError: document.getElementById('formula-error'),
    builderRows: document.getElementById('builder-rows'),
    addRow: document.getElementById('add-row'),
    builderError: document.getElementById('builder-error'),
    builderToFormula: document.getElementById('builder-to-formula'),
    normalized: document.getElementById('normalized-formula'),
    empirical: document.getElementById('empirical-formula'),
    molarMass: document.getElementById('molar-mass'),
    totalAtoms: document.getElementById('total-atoms'),
    breakdown: document.getElementById('breakdown'),
    status: document.getElementById('calc-status'),
    clearBtn: document.getElementById('clear-btn'),
    helpBtn: document.getElementById('formula-help-btn'),
    helpBox: document.getElementById('formula-help')
  };

  function populateSelect(select){
    if(select.options.length > 1) return;
    const frag = document.createDocumentFragment();
    elementsList.forEach(sym=>{
      const opt = document.createElement('option');
      opt.value = sym;
      opt.textContent = `${sym} (${ATOMIC_WEIGHTS[sym]})`;
      frag.appendChild(opt);
    });
    select.appendChild(frag);
  }

  function setMode(mode){
    if(mode === 'builder'){
      els.formulaPanel.hidden = true;
      els.builderPanel.hidden = false;
      els.modeBuilder.checked = true;
      els.modeFormula.checked = false;
      els.builderPanel.querySelectorAll('.el-select').forEach(populateSelect);
      els.formulaInput.setAttribute('tabindex','-1');
      els.builderPanel.focus({preventScroll:true});
    }else{
      els.formulaPanel.hidden = false;
      els.builderPanel.hidden = true;
      els.modeBuilder.checked = false;
      els.modeFormula.checked = true;
      els.formulaInput.removeAttribute('tabindex');
      els.formulaInput.focus({preventScroll:true});
    }
  }
  document.getElementsByName('mode').forEach(r=>{
    r.addEventListener('change', e=> setMode(e.target.value));
  });

  els.helpBtn.addEventListener('click', ()=>{
    const expanded = els.helpBtn.getAttribute('aria-expanded') === 'true';
    els.helpBtn.setAttribute('aria-expanded', String(!expanded));
    els.helpBox.setAttribute('aria-hidden', String(expanded));
  });

  function addBuilderRow(sym='', count=''){
    const row = document.createElement('div');
    row.className = 'builder-row';
    row.innerHTML = `
      <select class="input el-select" aria-label="Element symbol">
        <option value="">Element…</option>
      </select>
      <input class="input el-count" type="number" inputmode="numeric" min="1" step="1" placeholder="Count" aria-label="Atom count" value="${count}">
      <button type="button" class="btn-icon remove-row" aria-label="Remove row">−</button>
    `;
    els.builderRows.appendChild(row);
    const sel = row.querySelector('.el-select');
    populateSelect(sel);
    if(sym) sel.value = sym;
    row.querySelector('.remove-row').addEventListener('click', ()=>{
      row.remove();
      validateBuilder();
      computeFromCurrentMode();
    });
    row.querySelector('.el-count').addEventListener('blur', ()=>{ validateBuilder(); computeFromCurrentMode(); });
    sel.addEventListener('change', ()=>{ validateBuilder(); computeFromCurrentMode(); });
  }
  els.addRow.addEventListener('click', ()=> addBuilderRow());

  els.builderToFormula.addEventListener('click', ()=>{
    const parts = [];
    const rows = Array.from(els.builderRows.querySelectorAll('.builder-row'));
    for(const r of rows){
      const sym = r.querySelector('.el-select').value;
      const cnt = Number(r.querySelector('.el-count').value || 0);
      if(!sym || !cnt || cnt<1){ continue; }
      parts.push(sym + (cnt>1 ? String(cnt) : ''));
    }
    const formula = parts.sort((a,b)=>a.localeCompare(b)).join('');
    if(formula){
      setMode('formula');
      els.formulaInput.value = formula;
      els.formulaInput.dispatchEvent(new Event('blur'));
    }
  });

  addBuilderRow();

  function setError(el, msg){
    el.setAttribute('aria-invalid','true');
    if(el === els.formulaInput){
      els.formulaError.textContent = msg;
    } else {
      els.builderError.textContent = msg;
    }
  }
  function clearError(el){
    el.removeAttribute('aria-invalid');
    if(el === els.formulaInput){
      els.formulaError.textContent = '';
    } else {
      els.builderError.textContent = '';
    }
  }

  function normalizeInput(str){
    if(!str) return '';
    let s = str.trim();
    s = s.replace(/[₀₁₂₃₄₅₆₇₈₉]/g, m => subMap[m] || m);
    s = s.replace(/\s+/g,'');
    return s;
  }

  function parseFormula(formula){
    const F = normalizeInput(formula)
      .replace(/·|•/g, '+')
      .replace(/–|—/g, '-')
      .replace(/\[(.*?)\]/g,'($1)')
      .replace(/\{(.*?)\}/g,'($1)');
    if(!F) throw new Error('Please enter a chemical formula.');
    const parts = F.split('+').filter(Boolean);
    const total = new Map();
    for(let part of parts){
      let lead = 1;
      const m = part.match(/^(\d+)(.*)$/);
      if(m){ lead = parseInt(m[1],10); part = m[2]; }
      const counts = parseGroup(part, 0).counts;
      multiplyInto(total, counts, lead);
    }
    if(total.size === 0) throw new Error('The formula does not contain any recognizable elements.');
    return total;
  }

  function parseGroup(s, i){
    const counts = new Map();
    while(i < s.length){
      const ch = s[i];
      if(ch === '('){
        const inner = parseGroup(s, i+1);
        i = inner.index;
        let {num, next} = readNumber(s, i);
        i = next;
        if(num === null) num = 1;
        multiplyInto(counts, inner.counts, num);
        continue;
      }
      if(ch === ')'){
        return {counts, index: i+1};
      }
      if(/[A-Z]/.test(ch)){
        let j = i+1;
        while(j < s.length && /[a-z]/.test(s[j]) && j-i < 3){ j++; }
        const sym = s.slice(i, j);
        if(!ATOMIC_WEIGHTS[sym]){
          if(/^\d+$/.test(sym)) { i = j; continue; }
          throw new Error(`Unknown element symbol: “${sym}”.`);
        }
        const read = readNumber(s, j);
        let n = read.num==null ? 1 : read.num;
        i = read.next;
        counts.set(sym, (counts.get(sym)||0) + n);
        continue;
      }
      if(/\d/.test(ch)){
        throw new Error(`Unexpected number “${ch}” at position ${i+1}. Place multipliers after parentheses or element symbols.`);
      }
      throw new Error(`Invalid character “${ch}” at position ${i+1}.`);
    }
    return {counts, index:i};
  }

  function readNumber(s, i){
    if(i >= s.length) return {num:null, next:i};
    let j=i;
    while(j < s.length && /\d/.test(s[j])) j++;
    if(j===i) return {num:null, next:i};
    return {num: parseInt(s.slice(i,j), 10), next:j};
  }

  function multiplyInto(target, src, factor){
    for(const [k,v] of src.entries()){
      target.set(k, (target.get(k)||0) + v * factor);
    }
  }

  function computeFromCounts(counts){
    let M = 0;
    for(const [e,n] of counts.entries()){
      M += ATOMIC_WEIGHTS[e] * n;
    }
    const entries = Array.from(counts.entries());
    const hasCarbon = counts.has('C');
    entries.sort((a,b)=>{
      if(hasCarbon){
        if(a[0]==='C') return -1;
        if(b[0]==='C') return 1;
        if(a[0]==='H' && b[0]!=='C') return -1;
        if(b[0]==='H' && a[0]!=='C') return 1;
        if(a[0]==='H' && b[0]==='H') return 0;
        return a[0].localeCompare(b[0]);
      }
      return a[0].localeCompare(b[0]);
    });
    const normalized = entries.map(([e,n]) => e + (n>1 ? n : '')).join('');

    let g = 0;
    entries.forEach(([,n]) => { g = gcd(g, n); });
    const empirical = entries.map(([e,n]) => e + (n/g>1 ? (n/g) : '')).join('');

    const totalAtoms = entries.reduce((acc, [,n]) => acc+n, 0);
    const breakdown = entries.map(([e,n])=>{
      const aw = ATOMIC_WEIGHTS[e];
      const mass = aw * n;
      const pct = M>0 ? (mass/M*100) : 0;
      return {e, n, aw, mass, pct};
    });

    return {M, normalized, empirical, totalAtoms, breakdown};
  }

  function gcd(a,b){ if(!a) return b; if(!b) return a; while(b){ const t=a%b; a=b; b=t; } return a; }

  function renderResults(res){
    els.normalized.textContent = res.normalized || '—';
    els.empirical.textContent = res.empirical || '—';
    els.molarMass.textContent = `${res.M.toFixed(3)} g/mol`;
    els.totalAtoms.textContent = String(res.totalAtoms);

    const tbody = els.breakdown;
    tbody.innerHTML = '';
    res.breakdown.forEach(row=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><strong>${row.e}</strong></td>
        <td>${row.n}</td>
        <td>${row.aw.toFixed(3)}</td>
        <td>${row.mass.toFixed(3)}</td>
        <td>${row.pct.toFixed(2)}%</td>
      `;
      tbody.appendChild(tr);
    });
    if(res.breakdown.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="5" class="muted">Enter a formula to see the breakdown.</td>`;
      tbody.appendChild(tr);
    }
  }

  function validateFormula(){
    const val = els.formulaInput.value;
    if(!val.trim()){
      setError(els.formulaInput, 'This field is required. Please enter a chemical formula.');
      return null;
    }
    try{
      const counts = parseFormula(val);
      clearError(els.formulaInput);
      return counts;
    }catch(err){
      setError(els.formulaInput, err.message + ' Example: C6H12O6 or Ca3(PO4)2.');
      return null;
    }
  }

  function validateBuilder(){
    const rows = Array.from(els.builderRows.querySelectorAll('.builder-row'));
    const counts = new Map();
    let hasAny = false;
    for(const r of rows){
      const sym = r.querySelector('.el-select').value;
      const cntRaw = r.querySelector('.el-count').value;
      if(!sym && !cntRaw) continue;
      hasAny = true;
      const cnt = Number(cntRaw);
      if(!sym){
        setError(els.builderPanel, 'Please select an element in each filled row.');
        return null;
      }
      if(!cnt || cnt < 1 || !Number.isFinite(cnt) || Math.floor(cnt) !== cnt){
        setError(els.builderPanel, `Invalid count for ${sym}. Enter a positive integer (e.g., 1, 2, 3).`);
        return null;
      }
      counts.set(sym, (counts.get(sym)||0) + cnt);
    }
    if(!hasAny){
      setError(els.builderPanel, 'Add at least one element row with a positive count.');
      return null;
    }
    clearError(els.builderPanel);
    return counts;
  }

  function computeFromCurrentMode(){
    let counts = null;
    if(els.modeFormula.checked){
      counts = validateFormula();
    } else {
      counts = validateBuilder();
    }
    if(!counts){
      renderResults({M:0, normalized:'—', empirical:'—', totalAtoms:0, breakdown:[]});
      els.status.textContent = '';
      return;
    }
    const res = computeFromCounts(counts);
    renderResults(res);
    els.status.textContent = `Calculated molar mass ${res.M.toFixed(3)} g/mol for ${res.normalized}.`;
  }

  els.formulaInput.addEventListener('blur', computeFromCurrentMode);
  els.clearBtn.addEventListener('click', ()=>{
    els.formulaInput.value = '';
    els.formulaError.textContent = '';
    els.builderError.textContent = '';
    els.breakdown.innerHTML = '<tr><td colspan="5" class="muted">Enter a formula to see the breakdown.</td></tr>';
    els.normalized.textContent = '—';
    els.empirical.textContent = '—';
    els.molarMass.textContent = '0.000 g/mol';
    els.totalAtoms.textContent = '0';
    els.status.textContent = 'Cleared.';
    els.formulaInput.focus();
  });

  document.querySelectorAll('.el-select').forEach(populateSelect);
  window.addEventListener('DOMContentLoaded', ()=>{
    els.formulaInput.value = 'C8H10N4O2';
    computeFromCurrentMode();
  });

  document.getElementById('mobile-menu-toggle')?.addEventListener('click', ()=>{
    document.getElementById('mobile-menu')?.classList.toggle('hidden');
  });
</script>
<script defer src="/assets/js/mobile-menu.js"></script>
<script defer src="/assets/js/page-enhancements.js"></script>

</body>
</html>
