<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
<link rel="shortcut icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="manifest" href="/site.webmanifest" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Contribution Margin Calculator - Calculate CM &amp; Ratio</title>
<meta name="description" content="Calculate contribution margin (CM) and CM ratio by entering sales revenue and variable costs. Understand your per-unit profitability and make smarter pricing decisions.">
<link rel="canonical" href="https://calcdomain.com/contribution-margin-calculator.html"/>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0KOxRfFGkyLlIWMsxTRDSvK2AA+Oioo2I/sQoB2nlpSBOiT1M/DCP" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIeR3OaKcuB8nEGgeTTCagwvcT5e/EecvVzB1eAGyPjxwL/O" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURPlLJSzFGFgMFckl2Sgd1A+D8HRZNqMpHfLChAHcNf1vB1OKpqgY" crossorigin="anonymous"></script>

<style>
body { font-family: 'Inter', sans-serif; }
.prose { max-width: 65ch; }
.prose h2 { font-size: 1.5rem; font-weight: 600; margin-top: 2rem; margin-bottom: 1rem; }
.prose h3 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; }
.prose p { margin-bottom: 1rem; line-height: 1.6; }
.prose ul, .prose ol { margin-left: 1.5rem; margin-bottom: 1rem; }
.prose li { margin-bottom: 0.5rem; }
.formula-box {
background:#f3f4f6; border:1px solid #d1d5db; border-radius:8px; padding:1rem;
overflow-x:auto; text-align: center;
}
details > summary { cursor: pointer; font-weight: 600; padding: 0.5rem 0; }
details[open] > summary { margin-bottom: 0.5rem; }
.result-card { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 1.25rem; text-align: center; }
.result-card h4 { font-size: 0.95rem; color: #6b7280; margin-bottom: 0.25rem; }
.result-card p { font-size: 1.75rem; font-weight: 700; color: #2563eb; }
.result-card p.is-negative { color: #dc2626; } /* red-600 */

/* Accessibility & UX Styles */
.error-message {
color: #dc2626; /* red-600 */
font-size: 0.875rem; /* text-sm */
margin-top: 0.5rem;
}
.tooltip-btn {
background: none; border: none; padding: 0 0.25rem; margin-left: 0.25rem;
cursor: pointer; color: #6b7280; /* gray-500 */
line-height: 1; vertical-align: middle;
}
.tooltip-btn:hover { color: #3b82f6; /* blue-500 */ }
.tooltip-content {
display: none;
background-color: #1f2937; /* gray-800 */
color: white;
padding: 0.5rem 0.75rem;
border-radius: 6px;
font-size: 0.875rem;
font-weight: 400;
margin-top: 0.5rem;
position: relative;
z-index: 10;
width: 100%;
}
.tooltip-content.is-visible {
display: block;
}
/* Ensure form inputs are large enough for touch */
input[type="number"], select {
min-height: 48px;
}
.btn {
min-height: 48px;
padding: 0.5rem 1rem;
}

@media print {
body * { visibility: hidden; }
#print-section, #print-section * { visibility: visible; }
#print-section { position: absolute; left: 0; top: 0; width: 100%; }
#results-chart-container { display: none !important; }
}
</style>

<script type="application/ld+json">
{
"@context": "https://schema.org",
"@type": "WebPage",
"name": "Contribution Margin Calculator",
"description": "Calculate contribution margin (CM) and CM ratio by entering sales revenue and variable costs. Understand your per-unit profitability and make smarter pricing decisions.",
"url": "https://calcdomain.com/contribution-margin-calculator.html",
"inLanguage": "en",
"author": { "@type": "Person", "name": "Ugo Candido" },
"publisher": { "@type": "Organization", "name": "CalcDomain" }
}
</script>
<script type="application/ld+json">
{
"@context": "https://schema.org",
"@type": "BreadcrumbList",
"itemListElement": [
{ "@type": "ListItem", "position": 1, "name": "Home", "item": "https://calcdomain.com/" },
{ "@type": "ListItem", "position": 2, "name": "Finance", "item": "https://calcdomain.com/finance.html" },
{ "@type": "ListItem", "position": 3, "name": "Business & Small Biz", "item": "https://calcdomain.com/subcategories/business-small-biz.html" },
{ "@type": "ListItem", "position": 4, "name": "Contribution Margin Calculator", "item": "https://calcdomain.com/contribution-margin-calculator.html" }
]
}
</script>
<script type="application/ld+json">
{
"@context": "https://schema.org",
"@type": "HowTo",
"name": "How to Calculate Contribution Margin",
"description": "A step-by-step guide to calculating contribution margin and contribution margin ratio.",
"step": [
{"@type": "HowToStep", "name": "Enter Sales Revenue", "text": "Input your total sales revenue for the period. This is the total income from sales."},
{"@type": "HowToStep", "name": "Enter Variable Costs", "text": "Input your total variable costs for the period. These are costs that change with production volume, like raw materials."},
{"@type": "HowToStep", "name": "Review Results", "text": "The calculator instantly displays your total Contribution Margin ($) and Contribution Margin Ratio (%)."},
{"@type": "HowToStep", "name": "Analyze", "text": "Use the contribution margin to understand how much money is available to cover fixed costs and generate profit."}
]
}
</script>
<script src="search.js" defer></script>
</head>
<body class="bg-gray-50 text-gray-900">

<header class="bg-white shadow-sm">
<nav class="container mx-auto px-4 lg:px-6 py-4">
<div class="flex justify-between items-center">
<a href="index.html" class="text-2xl font-bold text-blue-600">CalcDomain</a>

<div class="w-full max-w-md hidden md:block mx-8">
<div class="relative">
<input type="search" id="search-input" placeholder="Search for a calculator..."
class="w-full py-2 px-4 pr-12 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500"
autocomplete="off">
<svg class="w-5 h-5 absolute right-4 top-1/2 -translate-y-1/2 text-gray-400"
fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
</svg>
<div id="search-results" class="absolute top-full left-0 right-0 hidden bg-white border border-gray-200 rounded-lg shadow-lg mt-2 max-h-96 overflow-y-auto z-50"></div>
</div>
</div>

<div class="hidden md:flex items-center space-x-6 text-sm">
<a href="search.html" class="text-gray-700 hover:text-blue-600">Advanced Search</a>
<a href="index.html#categories" class="text-gray-700 hover:text-blue-600">Categories</a>
</div>

<button id="mobile-menu-toggle" class="md:hidden p-2" aria-label="Open menu">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
d="M4 6h16M4 12h16M4 18h16"></path>
</svg>
</button>
</div>

<div id="mobile-menu" class="md:hidden mt-4 hidden">
<div class="space-y-2">
<a href="search.html" class="block py-2 text-gray-700 hover:text-blue-600">Advanced Search</a>
<a href="index.html#categories" class="block py-2 text-gray-700 hover:text-blue-600">Categories</a>
</div>
</div>
</nav>
</header>

<main class="container mx-auto px-4 lg:px-6 py-10">
<div class="flex flex-col lg:flex-row gap-8">

<section class="w-full lg:w-2/3">
<nav class="text-sm text-gray-600 mb-4" aria-label="Breadcrumb">
<a href="index.html" class="hover:text-blue-600">Home</a> &raquo;
<a href="finance.html" class="hover:text-blue-600">Finance</a> &raquo;
<a href="subcategories/business-small-biz.html" class="hover:text-blue-600">Business & Small Biz</a> &raquo;
<span class="text-gray-900">Contribution Margin Calculator</span>
</nav>

<div id="print-section" class="bg-white p-6 rounded-lg shadow-md">
<h1 class="text-3xl font-extrabold text-gray-900 mb-2">Contribution Margin Calculator</h1>
<p class="text-gray-600 mb-6">This calculator helps you determine your company's contribution margin and contribution margin ratio. It's essential for business owners, financial analysts, and managers to understand profitability per unit and make informed decisions about pricing, costs, and product mix.</p>

<div id="calculator-ui" class="space-y-6">
<div>
<label for="salesRevenue" class="block text-sm font-medium text-gray-700">
Total Sales Revenue
<span class="text-red-500">*</span>
<button type="button" class="tooltip-btn" aria-label="What is Total Sales Revenue?" aria-controls="tooltip-revenue" aria-expanded="false">
<svg class="w-4 h-4 inline-block" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0110 5a3 3 0 013 3v.236a1 1 0 11-2 0V8a1 1 0 00-1-1H9.867a1 1 0 00-.867.5zM10 15a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>
</button>
</label>
<div id="tooltip-revenue" role="tooltip" class="tooltip-content">
Enter the total income generated from sales of goods or services, before any expenses are deducted.
</div>
<input type="number" id="salesRevenue" value="10000" step="100" min="0"
class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
aria-required="true" aria-describedby="tooltip-revenue error-revenue">
<div id="error-revenue" class="error-message" role="alert" aria-live="assertive"></div>
</div>
<div>
<label for="variableCosts" class="block text-sm font-medium text-gray-700">
Total Variable Costs
<span class="text-red-500">*</span>
<button type="button" class="tooltip-btn" aria-label="What are Total Variable Costs?" aria-controls="tooltip-variable" aria-expanded="false">
<svg class="w-4 h-4 inline-block" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0110 5a3 3 0 013 3v.236a1 1 0 11-2 0V8a1 1 0 00-1-1H9.867a1 1 0 00-.867.5zM10 15a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path></svg>
</button>
</label>
<div id="tooltip-variable" role="tooltip" class="tooltip-content">
Enter all costs that change in direct proportion to how many products you sell or services you deliver (e.g., raw materials, direct labor, sales commissions).
</div>
<input type="number" id="variableCosts" value="4000" step="100" min="0"
class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
aria-required="true" aria-describedby="tooltip-variable error-variable">
<div id="error-variable" class="error-message" role="alert" aria-live="assertive"></div>
</div>
<div class="flex justify-start">
<button type="button" id="resetButton" class="btn bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium rounded-md">
Reset
</button>
</div>
</div>

<section id="results" class="mt-8 bg-blue-50 border border-blue-100 rounded-lg p-6 min-h-[200px]">
<h3 class="text-xl font-semibold text-gray-800 mb-4">Your Results</h3>
<div class="flex flex-col md:flex-row gap-6">
<div class="w-full md:w-2/3 grid grid-cols-1 sm:grid-cols-2 gap-4">
<div class="result-card">
<h4>Contribution Margin</h4>
<p id="contributionMargin">$0.00</p>
</div>
<div class="result-card">
<h4>Contribution Margin Ratio</h4>
<p id="contributionMarginRatio">0.0%</p>
</div>
<div class="result-card">
<h4>Total Sales Revenue</h4>
<p id="totalSalesRevenue">$0.00</p>
</div>
<div class="result-card">
<h4>Total Variable Costs</h4>
<p id="totalVariableCosts">$0.00</p>
</div>
</div>
<div class="w-full md:w-1/3">
<div id="results-chart-container" class="h-48 md:h-full">
<canvas id="resultsChart" aria-label="Breakdown of Sales Revenue into Variable Costs and Contribution Margin"></canvas>
</div>
</div>
</div>
</section>
</div>

<article class="bg-white p-6 rounded-lg shadow-md mt-8 prose">
<section>
<h2>Data Source and Methodology</h2>
<p>This calculator is based on the foundational principles of managerial accounting and cost-volume-profit (CVP) analysis, as detailed in leading corporate finance textbooks, such as "Corporate Finance" (12th Ed.) by Ross, Westerfield, and Jaffe.</p>
<p><strong>All calculations are based strictly on the formulas and principles from this established financial theory.</strong> The methodology is peer-reviewed and universally accepted in financial analysis.</p>
</section>

<section>
<h2>The Formula Explained</h2>
<p>The contribution margin can be calculated on a total (aggregate) basis or a per-unit basis. The ratio is the same in either case.</p>

<h3>Total Contribution Margin</h3>
<p>This measures the total amount of money available to cover fixed costs and generate profit from all units sold.</p>
<div class="formula-box">
$$ CM = S - VC $$
</div>
<ul>
<li>$CM$ = Total Contribution Margin</li>
<li>$S$ = Total Sales Revenue</li>
<li>$VC$ = Total Variable Costs</li>
</ul>

<h3>Contribution Margin Per Unit</h3>
<p>This measures the amount each unit sold contributes to covering fixed costs and profit.</p>
<div class="formula-box">
$$ CMU = P - VCU $$
</div>
<ul>
<li>$CMU$ = Contribution Margin per Unit</li>
<li>$P$ = Sales Price per Unit</li>
<li>$VCU$ = Variable Cost per Unit</li>
</ul>

<h3>Contribution Margin Ratio (CMR)</h3>
<p>This expresses the contribution margin as a percentage of sales. It shows what percentage of each sales dollar is available to cover fixed costs and profit.</p>
<div class="formula-box">
$$ CMR = \frac{CM}{S} \quad \text{or} \quad \frac{CMU}{P} $$
</div>
</section>

<section>
<h2>Glossary of Variables</h2>
<dl class="space-y-4">
<div>
<dt class="font-semibold">Sales Revenue (S or P)</dt>
<dd class="pl-4">The total income from sales (S) or the selling price of a single unit (P). This is the "top line" figure before any costs are subtracted.</dd>
</div>
<div>
<dt class="font-semibold">Variable Costs (VC or VCU)</dt>
<dd class="pl-4">Costs that change in direct proportion to production or sales volume. Examples include raw materials, direct labor, sales commissions, and shipping costs. If you sell zero units, your total variable cost is $0.</dd>
</div>
<div>
<dt class="font-semibold">Fixed Costs (Not Used in Formula)</dt>
<dd class="pl-4">Costs that remain the same regardless of production volume, such as rent, salaries, insurance, and utilities. The contribution margin is the amount that goes toward paying these costs.</dd>
</div>
<div>
<dt class="font-semibold">Contribution Margin (CM or CMU)</dt>
<dd class="pl-4">The revenue remaining after subtracting all variable costs. It is the portion of sales that "contributes" to paying off fixed costs and generating profit.</dd>
</div>
<div>
<dt class="font-semibold">Contribution Margin Ratio (CMR)</dt>
<dd class="pl-4">The contribution margin as a percentage of sales revenue. A 40% CMR means that for every $1.00 of sales, $0.40 is contribution margin.</dd>
</div>
</dl>
</section>

<section>
<h2>How it Works: A Step-by-Step Example</h2>
<p>Let's analyze a small coffee shop to see how contribution margin works in practice.</p>
<ul>
<li>The shop sells a cup of coffee for <strong>(P) = $5.00</strong>.</li>
<li>The variable costs for each cup (coffee beans, cup, lid, direct labor) are <strong>(VCU) = $2.00</strong>.</li>
<li>The shop's monthly fixed costs (rent, utilities, manager's salary) are <strong>$4,000</strong>.</li>
</ul>
<p>In one month, the shop sells <strong>2,000 cups</strong> of coffee.</p>
<p><strong>Step 1: Calculate Total Sales Revenue (S)</strong><br>
$S = \text{Price per Unit} \times \text{Units Sold}$<br>
$S = \$5.00 \times 2,000 = \$10,000$</p>
<p><strong>Step 2: Calculate Total Variable Costs (VC)</strong><br>
$VC = \text{Variable Cost per Unit} \times \text{Units Sold}$<br>
$VC = \$2.00 \times 2,000 = \$4,000$</p>
<p><strong>Step 3: Calculate Total Contribution Margin (CM)</strong><br>
$CM = S - VC$<br>
$CM = \$10,000 - \$4,000 = \$6,000$</p>
<p><strong>Step 4: Calculate Contribution Margin Ratio (CMR)</strong><br>
$CMR = \frac{CM}{S}$<br>
$CMR = \frac{\$6,000}{\$10,000} = 0.60 \text{ or } 60\%$</p>
<p><strong>Analysis:</strong> The shop's contribution margin is $6,000. This $6,000 is used to cover its $4,000 in fixed costs, leaving a net profit of $2,000. The 60% CMR shows that $0.60 of every $1.00 in coffee sales is available to cover fixed costs and profit.</p>
</section>

<section>
<h2>Frequently Asked Questions (FAQ)</h2>
<details>
<summary>What's the difference between contribution margin and gross margin?</summary>
<p>This is the most common point of confusion.
<strong>Gross Margin</strong> = Sales Revenue - Cost of Goods Sold (COGS). COGS includes *all* manufacturing costs, both variable (like raw materials) and fixed (like factory rent).
<strong>Contribution Margin</strong> = Sales Revenue - Variable Costs. This *only* subtracts variable costs and ignores fixed costs.
Contribution margin is a tool for internal decision-making (like pricing), while gross margin is a standard metric for external financial reporting (like an income statement).</p>
</details>
<details>
<summary>Why are fixed costs not included in the calculation?</summary>
<p>The entire purpose of the contribution margin is to *isolate* the profitability of a product or sale, independent of fixed, sunk costs. It answers the question: "Does this sale generate more revenue than the direct costs it creates?" The resulting margin is what you have *available* to pay down your fixed costs.</p>
</details>
<details>
<summary>How can I use the contribution margin ratio?</summary>
<p>The CMR is extremely powerful for quick analysis.
<strong>1. Break-Even Analysis:</strong> $\text{Break-Even Point (in dollars)} = \frac{\text{Total Fixed Costs}}{CMR}$. If your fixed costs are $10,000 and your CMR is 40%, you need $10,000 / 0.40 = $25,000 in sales to break even.
<strong>2. Profit Targeting:</strong> $\text{Sales needed for target profit} = \frac{\text{Total Fixed Costs} + \text{Target Profit}}{CMR}$.
<strong>3. Product Mix:</strong> It helps you decide which products are most profitable to promote. A product with a higher CMR is more efficient at generating profit.</p>
</details>
<details>
<summary>What does a negative contribution margin mean?</summary>
<p>A negative contribution margin means your variable costs are higher than your sales price (e.g., you sell a product for $10, but it costs $12 in materials and labor). This is an unsustainable situation. For every sale you make, you are *losing* money, even before accounting for fixed costs like rent. This indicates a critical problem with your pricing or cost structure.</p>
</details>
<details>
<summary>Can this be used for a service-based business?</summary>
<p>Yes. For a service business, the sales revenue is your billing or project fee. The variable costs would be any costs directly tied to delivering that service, such as contractor fees, third-party software licenses used *only* for that client, or travel expenses billed to the project. Your fixed costs would be salaries for permanent staff, office rent, and general software subscriptions.</p>
</details>
</section>

<div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-600">
<p><strong>Tool developed by Ugo Candido.</strong> Finance content reviewed by the CalcDomain Editorial Board.<br>
Last accuracy review: <time datetime="2025-10-27">October 27, 2025</time></p>
</div>
</article>
</section>

<aside class="w-full lg:w-1/3">
<div class="sticky top-24 space-y-6">
<div class="bg-gray-200 h-72 rounded-lg flex items-center justify-center text-gray-500">
Ad Placement (300×600)
</div>
<div class="bg-white p-6 rounded-lg shadow-md">
<h3 class="font-bold text-lg mb-3">Why Use This Calculator</h3>
<ul class="list-disc list-inside text-sm text-gray-600 space-y-2">
<li>Instantly see how much each sale contributes to fixed costs and profit.</li>
<li>Perform quick "what-if" analysis for new pricing strategies.</li>
<li>Understand the core profitability of your products or services.</li>
<li>Calculate a key metric needed for break-even analysis.</li>
</ul>
</div>
<div class="bg-white p-6 rounded-lg shadow-md">
<h3 class="font-bold text-lg mb-4">Related Business Tools</h3>
<ul class="space-y-3 text-sm">
<li><a href="gross-margin-calculator.html" class="text-blue-600 hover:underline">Gross Margin Calculator</a></li>
<li><a href="break-even-point-calculator.html" class="text-blue-600 hover:underline">Break-Even Point Calculator</a></li>
<li><a href="operating-margin-calculator.html" class="text-blue-600 hover:underline">Operating Margin Calculator</a></li>
<li><a href="profit-margin-calculator.html" class="text-blue-600 hover:underline">Profit Margin Calculator</a></li>
</ul>
</div>
</div>
</aside>
</div>
</main>

<footer class="bg-white border-t">
<div class="container mx-auto px-6 py-8 text-center text-gray-600 text-sm">
<p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
<div class="mt-4 space-x-4">
<a href="about.html" class="hover:text-blue-600">About</a>
<a href="contact.html" class="hover:text-blue-600">Contact</a>
<a href="privacy.html" class="hover:text-blue-600">Privacy</a>
<a href="terms.html" class="hover:text-blue-600">Terms</a>
</div>
</div>
</footer>

<script>
document.addEventListener('DOMContentLoaded', () => {
const elements = {
salesRevenue: document.getElementById('salesRevenue'),
variableCosts: document.getElementById('variableCosts'),
resetButton: document.getElementById('resetButton'),
contributionMargin: document.getElementById('contributionMargin'),
contributionMarginRatio: document.getElementById('contributionMarginRatio'),
totalSalesRevenue: document.getElementById('totalSalesRevenue'),
totalVariableCosts: document.getElementById('totalVariableCosts'),
errorRevenue: document.getElementById('error-revenue'),
errorVariable: document.getElementById('error-variable'),
chartCtx: document.getElementById('resultsChart')
};

const defaultValues = {
salesRevenue: 10000,
variableCosts: 4000
};

let chartInstance = null;

// Formatters
const fmtCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(val || 0);
const fmtPercent = (val) => new Intl.NumberFormat('en-US', { style: 'percent', minimumFractionDigits: 1, maximumFractionDigits: 1 }).format(val || 0);

// --- Validation ---
function showError(inputEl, errorEl, message) {
errorEl.textContent = message;
inputEl.setAttribute('aria-invalid', 'true');
inputEl.classList.add('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
}

function clearError(inputEl, errorEl) {
errorEl.textContent = '';
inputEl.setAttribute('aria-invalid', 'false');
inputEl.classList.remove('border-red-500', 'focus:border-red-500', 'focus:ring-red-500');
}

function validateInputs(revenue, variable) {
let isValid = true;
clearError(elements.salesRevenue, elements.errorRevenue);
clearError(elements.variableCosts, elements.errorVariable);

if (revenue < 0) {
showError(elements.salesRevenue, elements.errorRevenue, 'Sales Revenue must be zero or greater.');
isValid = false;
}

if (variable < 0) {
showError(elements.variableCosts, elements.errorVariable, 'Variable Costs must be zero or greater.');
isValid = false;
}

if (isValid && variable > revenue) {
// This is not an error, but a warning/info state
showError(elements.variableCosts, elements.errorVariable, 'Variable costs are higher than revenue, resulting in a negative margin.');
// We still allow calculation, so isValid remains true, but the message is shown.
}

return isValid;
}

// --- Calculation ---
function calculate() {
const revenue = parseFloat(elements.salesRevenue.value) || 0;
const variable = parseFloat(elements.variableCosts.value) || 0;

if (!validateInputs(revenue, variable)) {
// If critical error (e.g., negative numbers), stop and show zeroed results
updateOutputs(0, 0, 0, 0);
return;
}

const cm = revenue - variable;
const cmr = (revenue > 0) ? (cm / revenue) : 0;

updateOutputs(revenue, variable, cm, cmr);
}

// --- DOM Updates ---
function updateOutputs(revenue, variable, cm, cmr) {
elements.contributionMargin.textContent = fmtCurrency(cm);
elements.contributionMarginRatio.textContent = fmtPercent(cmr);
elements.totalSalesRevenue.textContent = fmtCurrency(revenue);
elements.totalVariableCosts.textContent = fmtCurrency(variable);

// Handle negative margin styling
if (cm < 0) {
elements.contributionMargin.classList.add('is-negative');
elements.contributionMarginRatio.classList.add('is-negative');
} else {
elements.contributionMargin.classList.remove('is-negative');
elements.contributionMarginRatio.classList.remove('is-negative');
}

renderChart(revenue, variable, cm);
}

// --- Chart ---
function renderChart(revenue, variable, cm) {
if (!elements.chartCtx) return;

let chartData, chartLabels, chartColors;

if (cm >= 0) {
chartLabels = ['Variable Costs', 'Contribution Margin'];
chartData = [variable, cm];
chartColors = ['#f97316', '#2563eb']; // Orange (cost), Blue (margin)
} else {
// Handle negative margin
chartLabels = ['Sales Revenue', 'Negative Margin (Loss)'];
chartData = [revenue, Math.abs(cm)];
chartColors = ['#2563eb', '#dc2626']; // Blue (revenue), Red (loss)
}

// Ensure chart scales correctly even if all values are 0
if (revenue === 0 && variable === 0 && cm === 0) {
chartData = [1]; // Show a blank "no data" state
chartLabels = ['No Data'];
chartColors = ['#e5e7eb']; // gray-200
}

const data = {
labels: chartLabels,
datasets: [{
data: chartData,
backgroundColor: chartColors
}]
};

if (chartInstance) {
chartInstance.data = data;
chartInstance.update();
} else {
chartInstance = new Chart(elements.chartCtx, {
type: 'doughnut',
data,
options: {
plugins: {
legend: { position: 'bottom', labels: { boxWidth: 12 } },
tooltip: {
callbacks: {
label: function(context) {
let label = context.label || '';
if (label) {
label += ': ';
}
if (context.parsed !== null) {
label += fmtCurrency(context.parsed);
}
return label;
}
}
}
},
responsive: true,
maintainAspectRatio: false
}
});
}
}

// --- Tooltips ---
function setupTooltips() {
document.querySelectorAll('.tooltip-btn').forEach(button => {
const tooltipId = button.getAttribute('aria-controls');
const tooltip = document.getElementById(tooltipId);
if (!tooltip) return;

button.addEventListener('click', () => {
const isExpanded = button.getAttribute('aria-expanded') === 'true';
button.setAttribute('aria-expanded', !isExpanded);
tooltip.classList.toggle('is-visible');
});
});
}

// --- Reset ---
function resetCalculator() {
elements.salesRevenue.value = defaultValues.salesRevenue;
elements.variableCosts.value = defaultValues.variableCosts;
clearError(elements.salesRevenue, elements.errorRevenue);
clearError(elements.variableCosts, elements.errorVariable);
calculate();
}

// --- Event Listeners ---
elements.salesRevenue.addEventListener('input', calculate);
elements.variableCosts.addEventListener('input', calculate);
elements.resetButton.addEventListener('click', resetCalculator);

// --- Initialization ---
setupTooltips();
calculate(); // Initial calculation on load

// Configure and run KaTeX (LaTeX renderer)
renderMathInElement(document.body, {
delimiters: [
{left: "$$", right: "$$", display: true},
{left: "$", right: "$", display: false}
]
});
});
</script>

</body>
</html>