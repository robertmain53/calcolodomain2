<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Debt Avalanche Calculator — Optimize Your Debt Payoff Order & Save Interest</title>
  <meta name="description" content="Use our Debt Avalanche Calculator to prioritize high-APR balances, minimize total interest, and estimate your exact debt-free date. Add multiple debts, set minimums, and apply extra payments."/>
  <link rel="canonical" href="https://calcdomain.com/debt-avalanche-calculator.html"/>

  <!-- Icons -->
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />

  <!-- Fonts & UI -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- MathJax for LaTeX -->
  <script>
    window.MathJax = { tex: {inlineMath: [['$', '$'], ['\\(', '\\)']]} };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>

  <style>
    :root { --focus: #2563eb; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif;}
    .prose { max-width: 72ch; }
    .prose h2 { font-size: 1.5rem; font-weight: 700; margin-top: 2rem; margin-bottom: .75rem;}
    .prose h3 { font-size: 1.25rem; font-weight: 700; margin-top: 1.25rem; margin-bottom: .5rem;}
    .prose p { margin-bottom: .85rem; line-height: 1.65; }
    .prose ul, .prose ol { margin-left: 1.25rem; margin-bottom: .85rem; }
    .formula-box { background:#f3f4f6; border:1px solid #d1d5db; border-radius:10px; padding:1rem; overflow-x:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, 'Liberation Mono', monospace;}

    /* Accessible focus */
    :where(a, button, input, select, textarea, summary, [role="button"], [tabindex]) :focus { outline: none; }
    :where(a, button, input, select, textarea, summary, [role="button"], [tabindex]):focus-visible {
      box-shadow: 0 0 0 3px rgba(37,99,235,.55);
      outline: 3px solid var(--focus);
      outline-offset: 2px;
      border-radius: 8px;
    }

    /* Result area min-heights to prevent CLS */
    #kpi-cards { min-height: 140px; }
    #results-chart-container { min-height: 180px; }
    #scheduleContainer { min-height: 240px; }

    /* Touch target minimums */
    .tappable { min-height: 48px; min-width: 48px; }

    /* Print */
    @media print {
      body { background: #fff; }
      header, aside, nav, .no-print { display: none !important; }
      #print-section { display: block !important; }
      #results-chart-container { display: none !important; }
      a[href]:after { content: ""; }
    }
  </style>

  <!-- JSON-LD: WebPage -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebPage",
    "name":"Debt Avalanche Calculator",
    "url":"https://calcdomain.com/debt-avalanche-calculator.html",
    "inLanguage":"en",
    "description":"Interactive debt avalanche calculator that orders balances by APR to minimize interest and shows your debt-free date.",
    "author":{"@type":"Person","name":"Ugo Candido"},
    "publisher":{"@type":"Organization","name":"CalcDomain"}
  }
  </script>
  <!-- JSON-LD: Breadcrumbs -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      {"@type":"ListItem","position":1,"name":"Home","item":"https://calcdomain.com/"},
      {"@type":"ListItem","position":2,"name":"Finance","item":"https://calcdomain.com/finance.html"},
      {"@type":"ListItem","position":3,"name":"Loans & Debt","item":"https://calcdomain.com/subcategories/finance-loans-debt.html"},
      {"@type":"ListItem","position":4,"name":"Debt Avalanche Calculator","item":"https://calcdomain.com/debt-avalanche-calculator.html"}
    ]
  }
  </script>
  <!-- JSON-LD: HowTo -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"HowTo",
    "name":"How to use the Debt Avalanche Calculator",
    "step":[
      {"@type":"HowToStep","name":"Enter each debt","text":"Add balance, APR, and required minimum payment for every debt."},
      {"@type":"HowToStep","name":"Set monthly budget","text":"Enter the total amount you can pay each month including minimums."},
      {"@type":"HowToStep","name":"Choose payoff strategy","text":"Keep Avalanche (highest APR first) or try Snowball (smallest balance) for motivation."},
      {"@type":"HowToStep","name":"Review schedule","text":"See total interest, debt-free date, and month-by-month progress."}
    ]
  }
  </script>
  <!-- JSON-LD: FAQPage -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {"@type":"Question","name":"What is the debt avalanche method?","acceptedAnswer":{"@type":"Answer","text":"A payoff strategy that prioritizes debts with the highest APR first, minimizing total interest cost while keeping all other debts at their minimums."}},
      {"@type":"Question","name":"Is avalanche always cheaper than snowball?","acceptedAnswer":{"@type":"Answer","text":"Yes, for the same payments and terms, avalanche yields equal or lower total interest than snowball because it targets the highest rates first."}},
      {"@type":"Question","name":"How are minimum payments handled?","acceptedAnswer":{"@type":"Answer","text":"Each month the calculator applies the minimum to every open account, then allocates all remaining budget to the current target debt."}},
      {"@type":"Question","name":"Can I add extra payments mid-schedule?","acceptedAnswer":{"@type":"Answer","text":"Yes. Adjust your monthly budget amount; the calculator will recompute the schedule and new debt-free date."}},
      {"@type":"Question","name":"Does the calculator consider daily compounding?","acceptedAnswer":{"@type":"Answer","text":"It models interest monthly (APR/12). For most consumer debts this closely approximates statements; minor rounding differences may occur."}}
    ]
  }
  </script>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header (non-sticky per brief) -->
  <header class="bg-white border-b">
    <div class="container mx-auto px-4 lg:px-6 py-4 flex items-center justify-between">
      <a href="index.html" class="text-2xl font-extrabold text-blue-700">CalcDomain</a>
      <nav class="hidden md:flex gap-6 text-sm">
        <a class="text-gray-700 hover:text-blue-700" href="search.html">Advanced Search</a>
        <a class="text-gray-700 hover:text-blue-700" href="index.html#categories">Categories</a>
      </nav>
      <button class="md:hidden tappable p-2" id="mobile-menu-toggle" aria-label="Open menu" aria-expanded="false" aria-controls="mobile-menu">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
        </svg>
      </button>
    </div>
    <div id="mobile-menu" class="md:hidden hidden border-t">
      <div class="container mx-auto px-4 py-3 space-y-2">
        <a class="block py-2 text-gray-700 hover:text-blue-700" href="search.html">Advanced Search</a>
        <a class="block py-2 text-gray-700 hover:text-blue-700" href="index.html#categories">Categories</a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 lg:px-6 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Main content -->
      <section class="w-full lg:w-2/3">
        <nav class="text-sm text-gray-600 mb-4" aria-label="Breadcrumb">
          <a href="index.html" class="hover:text-blue-700">Home</a> &raquo;
          <a href="finance.html" class="hover:text-blue-700">Finance</a> &raquo;
          <a href="subcategories/finance-loans-debt.html" class="hover:text-blue-700">Loans &amp; Debt</a> &raquo;
          <span class="text-gray-900">Debt Avalanche Calculator</span>
        </nav>

        <!-- Print section wraps calculator & results -->
        <div id="print-section" class="bg-white p-6 rounded-lg shadow">
          <h1 class="text-3xl font-extrabold text-gray-900 mb-2">Debt Avalanche Calculator</h1>
          <p class="text-gray-700 mb-6">
            Enter all your debts and a monthly payoff budget. We’ll apply minimums to each account, then target the
            <strong>highest APR first</strong> to minimize total interest and show your exact <strong>debt-free date</strong>.
            Ideal for credit cards, personal loans, and other revolving balances.
          </p>

          <!-- Calculator UI -->
          <section id="calculator-ui" aria-labelledby="calc-heading">
            <h2 id="calc-heading" class="sr-only">Calculator Inputs</h2>

            <div class="mb-4 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label for="monthlyBudget" class="block text-sm font-medium text-gray-900">
                  Monthly payoff budget* </label>
                <div class="flex items-start gap-2">
                  <input type="number" inputmode="decimal" min="0" step="1" id="monthlyBudget" value="800"
                    aria-required="true" aria-describedby="budget-help budget-error"
                    class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-600"
                  />
                  <button type="button" class="tappable mt-1 px-3 py-2 border rounded-md text-sm" id="budget-tip-btn"
                          aria-expanded="false" aria-controls="budget-help" aria-label="Budget help">
                    ?
                  </button>
                </div>
                <p id="budget-help" class="text-xs text-gray-600 mt-1">
                  Total you can pay each month (includes all minimums + any extra).
                </p>
                <p id="budget-error" class="text-sm text-red-600 mt-1 hidden"></p>
              </div>

              <div>
                <label for="strategy" class="block text-sm font-medium text-gray-900">
                  Payoff strategy* </label>
                <select id="strategy" aria-required="true" aria-describedby="strategy-help"
                        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                  <option value="avalanche" selected>Debt Avalanche (highest APR first)</option>
                  <option value="snowball">Debt Snowball (smallest balance first)</option>
                </select>
                <p id="strategy-help" class="text-xs text-gray-600 mt-1">
                  Avalanche minimizes interest; Snowball maximizes motivation by quick wins.
                </p>
              </div>
            </div>

            <!-- Debts table -->
            <div class="overflow-x-auto border border-gray-200 rounded-lg">
              <table class="min-w-full text-sm">
                <caption class="sr-only">Debts</caption>
                <thead class="bg-gray-100 text-gray-700">
                  <tr>
                    <th class="px-3 py-2 text-left">Name</th>
                    <th class="px-3 py-2 text-right">Balance*</th>
                    <th class="px-3 py-2 text-right">APR %*</th>
                    <th class="px-3 py-2 text-right">Min Payment*</th>
                    <th class="px-3 py-2 text-right">Notes</th>
                    <th class="px-3 py-2 text-center">Actions</th>
                  </tr>
                </thead>
                <tbody id="debts-body" aria-live="polite"></tbody>
              </table>
            </div>
            <div class="flex flex-wrap gap-3 mt-3">
              <button type="button" id="add-debt" class="tappable px-4 py-2 bg-blue-700 text-white rounded-md">
                Add debt
              </button>
              <button type="button" id="load-sample" class="tappable px-4 py-2 bg-gray-100 text-gray-900 rounded-md border">
                Load sample data
              </button>
              <button type="button" id="reset-all" class="tappable px-4 py-2 bg-white text-gray-900 rounded-md border">
                Reset
              </button>
            </div>
          </section>

          <!-- Results -->
          <section id="results" class="mt-8 bg-blue-50 border border-blue-100 rounded-lg p-6" aria-labelledby="results-heading">
            <h2 id="results-heading" class="text-xl font-bold text-gray-900 mb-3">Results</h2>
            <div id="kpi-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
              <div class="bg-white border rounded-lg p-4 text-center">
                <h3 class="text-xs uppercase tracking-wide text-gray-600">Debt-free date</h3>
                <p class="text-2xl font-bold text-blue-700" id="kpi-debtfree">—</p>
              </div>
              <div class="bg-white border rounded-lg p-4 text-center">
                <h3 class="text-xs uppercase tracking-wide text-gray-600">Months to payoff</h3>
                <p class="text-2xl font-bold text-blue-700" id="kpi-months">—</p>
              </div>
              <div class="bg-white border rounded-lg p-4 text-center">
                <h3 class="text-xs uppercase tracking-wide text-gray-600">Total interest</h3>
                <p class="text-2xl font-bold text-blue-700" id="kpi-interest">$0.00</p>
              </div>
              <div class="bg-white border rounded-lg p-4 text-center">
                <h3 class="text-xs uppercase tracking-wide text-gray-600">Total paid</h3>
                <p class="text-2xl font-bold text-blue-700" id="kpi-total">$0.00</p>
              </div>
            </div>

            <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
              <div class="lg:col-span-2">
                <details class="bg-white rounded-lg" id="schedule-details" open>
                  <summary class="font-semibold text-gray-900 px-4 py-3 border-b tappable">View monthly schedule</summary>
                  <div id="scheduleContainer" class="overflow-x-auto">
                    <table class="min-w-full text-right text-sm">
                      <thead class="bg-gray-100 text-gray-700 uppercase">
                        <tr>
                          <th class="px-3 py-2 text-left">#</th>
                          <th class="px-3 py-2 text-left">Month</th>
                          <th class="px-3 py-2">Payment</th>
                          <th class="px-3 py-2">Interest</th>
                          <th class="px-3 py-2">Principal</th>
                          <th class="px-3 py-2">Balance</th>
                        </tr>
                      </thead>
                      <tbody id="schedule-body"></tbody>
                    </table>
                  </div>
                </details>
              </div>
              <div>
                <div id="results-chart-container" class="bg-white border rounded-lg p-3 h-56">
                  <canvas id="breakdownChart" aria-label="Principal versus interest chart"></canvas>
                </div>
                <button id="print-btn" class="tappable mt-3 w-full px-4 py-2 border rounded-md bg-white">Print / Save PDF</button>
              </div>
            </div>
          </section>
        </div>

        <!-- Authoritative content -->
        <article class="bg-white p-6 rounded-lg shadow mt-8 prose">
          <h2>Authoritative data source & methodology</h2>
          <p>
            Primary guidance: Consumer Financial Protection Bureau (CFPB), “<a class="text-blue-700 underline" href="https://www.consumerfinance.gov/">Paying down debt</a>” (accessed 2025).
            Also see: Federal Trade Commission (FTC), “<a class="text-blue-700 underline" href="https://www.ftc.gov/">Getting Out of Debt</a>”.
            <br><strong>Tutti i calcoli si basano rigorosamente sulle formule e sui dati forniti da questa fonte.</strong>
          </p>
          <p>Our simulator applies each statement cycle as follows: (1) apply minimums to all open accounts; (2) allocate remaining budget to the target account based on the selected strategy (Avalanche = highest APR; Snowball = smallest balance); (3) accrue interest monthly using APR/12 on each remaining balance; (4) repeat until all balances reach zero.</p>

          <h2>The formula explained</h2>
          <div class="formula-box">
            For a given debt \(i\) with monthly rate \(r_i = \frac{\text{APR}_i}{12}\) and balance \(B_{i,t}\):<br/>
            Monthly interest: \(I_{i,t} = B_{i,t}\, r_i\)<br/>
            Principal reduction: \(P_{i,t} = \max(0,\ \text{payment}_{i,t} - I_{i,t})\)<br/>
            Next balance: \(B_{i,t+1} = \max(0,\ B_{i,t} + I_{i,t} - \text{payment}_{i,t})\)<br/>
            Strategy order each month:<br/>
            Avalanche: sort debts by \( \text{APR}_i \) descending. Snowball: sort by \( B_{i,t} \) ascending.
          </div>

          <h2>Glossary of variables</h2>
          <ul>
            <li><strong>Balance</strong>: Current amount owed for each account.</li>
            <li><strong>APR %</strong>: Annual Percentage Rate used to compute monthly interest.</li>
            <li><strong>Minimum payment</strong>: The required per-month payment to keep the account current.</li>
            <li><strong>Monthly payoff budget</strong>: The total you commit each month; any amount above minimums is directed to the target debt.</li>
            <li><strong>Debt-free date</strong>: Estimated calendar month when all balances reach zero.</li>
            <li><strong>Total interest</strong>: Sum of all monthly interest charges paid until payoff.</li>
          </ul>

          <h2>How it works: a step-by-step example</h2>
          <h3>Example inputs</h3>
          <ul>
            <li>Debt A: $4,000 at 22.99% APR, min $100</li>
            <li>Debt B: $2,500 at 17.99% APR, min $60</li>
            <li>Debt C: $1,200 at 9.99% APR, min $35</li>
            <li>Monthly payoff budget: $800, Strategy: Avalanche</li>
          </ul>
          <h3>Process</h3>
          <ol>
            <li>Pay minimums to A, B, C ($195 total). Remaining $605 goes to the highest APR (A).</li>
            <li>Accrue monthly interest APR/12 on each debt after payments.</li>
            <li>Repeat monthly; once A hits zero, roll its entire prior payment into B, then C.</li>
          </ol>
          <p>The calculator outputs months to payoff, debt-free date, total interest, and a month-by-month schedule to verify the math.</p>

          <h2>Frequently Asked Questions</h2>
          <details>
            <summary>Should I choose Avalanche or Snowball?</summary>
            <p>Pick Avalanche if minimizing interest is your priority. Choose Snowball if quick psychological wins help you stay consistent—then switch to Avalanche later.</p>
          </details>
          <details>
            <summary>What if my budget is less than the sum of minimums?</summary>
            <p>The model flags an error because accounts would fall behind. Increase your budget, reduce expenses, or consider speaking with your lender or a nonprofit credit counselor.</p>
          </details>
          <details>
            <summary>How accurate is APR/12 monthly modeling?</summary>
            <p>Most credit cards and loans accrue interest daily, but statements summarize monthly. APR/12 closely approximates outcomes and is standard for planning tools.</p>
          </details>
          <details>
            <summary>Can I reorder debts manually?</summary>
            <p>Yes—change strategy to Snowball for smallest-balance prioritization, or edit APRs to reflect teaser rates and see the effect.</p>
          </details>
          <details>
            <summary>Will closing a paid account hurt my credit score?</summary>
            <p>It can affect utilization and age of credit. Consider leaving $0 accounts open unless fees apply; check guidance from your issuer or credit bureau resources.</p>
          </details>

          <div class="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg text-sm text-gray-700">
            <p><strong>Tool developed by Ugo Candido.</strong> Content reviewed by the CalcDomain Editorial Board.<br/>
              Last accuracy review: <time datetime="2025-10-30">October 30, 2025</time></p>
          </div>
        </article>
      </section>

      <!-- Sidebar -->
      <aside class="w-full lg:w-1/3">
        <div class="sticky top-24 space-y-6 no-print">
          <div class="bg-gray-200 h-72 rounded-lg flex items-center justify-center text-gray-600">
            Ad Placement (300×600)
          </div>
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-3">Why this calculator is different</h3>
            <ul class="list-disc list-inside text-sm text-gray-700 space-y-2">
              <li>Exact month-by-month avalanche vs snowball modeling.</li>
              <li>Inline WCAG-compliant validation and accessible tooltips.</li>
              <li>Clear, printable schedule for professional planning.</li>
            </ul>
          </div>
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="font-bold text-lg mb-4">Related debt tools</h3>
            <ul class="space-y-3 text-sm">
              <li><a href="credit-card-payoff-calculator.html" class="text-blue-700 hover:underline">Credit Card Payoff</a></li>
              <li><a href="loan-amortization.html" class="text-blue-700 hover:underline">Loan Amortization</a></li>
              <li><a href="apr.html" class="text-blue-700 hover:underline">APR Calculator</a></li>
              <li><a href="debt-snowball-calculator.html" class="text-blue-700 hover:underline">Debt Snowball</a></li>
            </ul>
          </div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="bg-white border-t">
    <div class="container mx-auto px-6 py-8 text-center text-gray-700 text-sm">
      <p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
      <div class="mt-4 space-x-4">
        <a href="about.html" class="hover:text-blue-700">About</a>
        <a href="contact.html" class="hover:text-blue-700">Contact</a>
        <a href="privacy.html" class="hover:text-blue-700">Privacy</a>
        <a href="terms.html" class="hover:text-blue-700">Terms</a>
      </div>
    </div>
  </footer>

  <!-- Calculator Logic -->
  <script>
  (function(){
    const $ = (id) => document.getElementById(id);
    const debtsBody = $('debts-body');
    const monthlyBudget = $('monthlyBudget');
    const strategy = $('strategy');
    const budgetErr = $('budget-error');
    const budgetTipBtn = $('budget-tip-btn');

    const kpiDebtfree = $('kpi-debtfree');
    const kpiMonths = $('kpi-months');
    const kpiInterest = $('kpi-interest');
    const kpiTotal = $('kpi-total');

    const scheduleBody = $('schedule-body');
    const printBtn = $('print-btn');

    const mobileToggle = $('mobile-menu-toggle');
    const mobileMenu = $('mobile-menu');

    let chartInstance = null;

    // Accessibility helpers
    mobileToggle?.addEventListener('click', () => {
      const expanded = mobileToggle.getAttribute('aria-expanded') === 'true';
      mobileToggle.setAttribute('aria-expanded', String(!expanded));
      mobileMenu.classList.toggle('hidden', expanded);
    });
    budgetTipBtn?.addEventListener('click', () => {
      const expanded = budgetTipBtn.getAttribute('aria-expanded') === 'true';
      budgetTipBtn.setAttribute('aria-expanded', String(!expanded));
      const help = $('budget-help');
      if (help) help.classList.toggle('hidden', expanded);
    });

    // Currency & number formatters
    const fmtCurrency = (v, currency='USD') =>
      new Intl.NumberFormat(undefined, { style:'currency', currency}).format(isFinite(v)? v : 0);
    const fmtMonth = (date) =>
      new Intl.DateTimeFormat(undefined, { year:'numeric', month:'short' }).format(date);

    // Debts state
    let debts = [];
    const defaultCurrency = 'USD';

    function addDebtRow(d = {}) {
      const rowId = crypto.randomUUID();
      const tr = document.createElement('tr');
      tr.dataset.id = rowId;

      tr.innerHTML = `
        <td class="px-3 py-2 text-left align-top">
          <label class="sr-only" for="name-${rowId}">Name</label>
          <input id="name-${rowId}" class="w-full px-2 py-2 border rounded-md" value="${d.name ?? ''}" placeholder="e.g., Card A">
        </td>
        <td class="px-3 py-2 align-top">
          <label class="sr-only" for="bal-${rowId}">Balance</label>
          <input id="bal-${rowId}" type="number" inputmode="decimal" min="0" step="0.01"
                 class="w-full px-2 py-2 border rounded-md text-right"
                 aria-describedby="bal-err-${rowId}" value="${d.balance ?? ''}">
          <p id="bal-err-${rowId}" class="text-xs text-red-600 mt-1 hidden"></p>
        </td>
        <td class="px-3 py-2 align-top">
          <label class="sr-only" for="apr-${rowId}">APR %</label>
          <input id="apr-${rowId}" type="number" inputmode="decimal" min="0" step="0.01"
                 class="w-full px-2 py-2 border rounded-md text-right"
                 aria-describedby="apr-err-${rowId}" value="${d.apr ?? ''}">
          <p id="apr-err-${rowId}" class="text-xs text-red-600 mt-1 hidden"></p>
        </td>
        <td class="px-3 py-2 align-top">
          <label class="sr-only" for="min-${rowId}">Minimum Payment</label>
          <input id="min-${rowId}" type="number" inputmode="decimal" min="0" step="0.01"
                 class="w-full px-2 py-2 border rounded-md text-right"
                 aria-describedby="min-err-${rowId}" value="${d.min ?? ''}">
          <p id="min-err-${rowId}" class="text-xs text-red-600 mt-1 hidden"></p>
        </td>
        <td class="px-3 py-2 align-top">
          <label class="sr-only" for="note-${rowId}">Notes</label>
          <input id="note-${rowId}" class="w-full px-2 py-2 border rounded-md" value="${d.note ?? ''}" placeholder="optional">
        </td>
        <td class="px-3 py-2 text-center align-top">
          <div class="flex items-center justify-center gap-2">
            <button type="button" class="tappable px-3 py-2 border rounded-md bg-white" data-act="dup" aria-label="Duplicate row">Duplicate</button>
            <button type="button" class="tappable px-3 py-2 border rounded-md bg-white" data-act="del" aria-label="Delete row">Delete</button>
          </div>
        </td>
      `;

      debtsBody.appendChild(tr);

      // attach validation on blur
      ['bal', 'apr', 'min'].forEach(prefix => {
        tr.querySelector('#' + prefix + '-' + rowId).addEventListener('blur', () => validateRow(tr));
        tr.querySelector('#' + prefix + '-' + rowId).addEventListener('input', recomputeThrottled);
      });
      tr.querySelector('#name-' + rowId).addEventListener('input', recomputeThrottled);
      tr.querySelector('#note-' + rowId).addEventListener('input', ()=>{});

      tr.addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-act]');
        if (!btn) return;
        const act = btn.dataset.act;
        if (act === 'del') {
          tr.remove();
          recompute();
        } else if (act === 'dup') {
          const vals = getRowValues(tr);
          addDebtRow(vals);
          recompute();
        }
      });
    }

    function getRowValues(tr) {
      const id = tr.dataset.id;
      return {
        name: tr.querySelector('#name-' + id).value.trim() || '',
        balance: parseFloat(tr.querySelector('#bal-' + id).value) || 0,
        apr: parseFloat(tr.querySelector('#apr-' + id).value) || 0,
        min: parseFloat(tr.querySelector('#min-' + id).value) || 0,
        note: tr.querySelector('#note-' + id).value.trim() || ''
      };
    }

    function readDebts() {
      const rows = Array.from(debtsBody.querySelectorAll('tr'));
      return rows.map(getRowValues).filter(d => d.balance > 0);
    }

    function validateRow(tr) {
      const id = tr.dataset.id;
      const bal = tr.querySelector('#bal-' + id);
      const apr = tr.querySelector('#apr-' + id);
      const min = tr.querySelector('#min-' + id);

      let ok = true;

      // Balance
      const balErr = $('bal-err-' + id);
      if (bal.value === '' || parseFloat(bal.value) <= 0) {
        balErr.textContent = 'Enter a positive balance.';
        balErr.classList.remove('hidden'); ok = false;
      } else {
        balErr.classList.add('hidden');
      }

      // APR
      const aprErr = $('apr-err-' + id);
      if (apr.value === '' || parseFloat(apr.value) < 0) {
        aprErr.textContent = 'APR cannot be negative.';
        aprErr.classList.remove('hidden'); ok = false;
      } else {
        aprErr.classList.add('hidden');
      }

      // Minimum
      const minErr = $('min-err-' + id);
      if (min.value === '' || parseFloat(min.value) < 0) {
        minErr.textContent = 'Minimum cannot be negative.';
        minErr.classList.remove('hidden'); ok = false;
      } else if (parseFloat(min.value) > parseFloat(bal.value)) {
        minErr.textContent = 'Minimum cannot exceed the balance.';
        minErr.classList.remove('hidden'); ok = false;
      } else {
        minErr.classList.add('hidden');
      }
      return ok;
    }

    function validateAll() {
      const rows = Array.from(debtsBody.querySelectorAll('tr'));
      let allOk = true;
      rows.forEach(tr => { if (!validateRow(tr)) allOk = false; });
      const budgetVal = parseFloat(monthlyBudget.value);
      if (!(budgetVal > 0)) {
        budgetErr.textContent = 'Please enter a positive monthly budget.';
        budgetErr.classList.remove('hidden');
        allOk = false;
      } else {
        budgetErr.classList.add('hidden');
      }
      return allOk;
    }

    // Core simulation
    function simulate(debtsInput, monthlyBudgetVal, mode='avalanche') {
      // Deep copy and ensure fields
      const ds = debtsInput.map(d => ({...d, balance: +d.balance, apr:+d.apr, min:+d.min}));
      const monthlyRates = ds.map(d => d.apr / 100 / 12);

      const sumMins = ds.reduce((s, d) => s + d.min, 0);
      if (monthlyBudgetVal < sumMins) {
        throw new Error('Budget is less than the sum of minimums. Increase your budget to at least ' + fmtCurrency(sumMins, defaultCurrency) + '.');
      }

      // Strategy ordering function (recomputed monthly for snowball)
      const order = () => {
        if (mode === 'snowball') {
          ds.sort((a,b) => a.balance - b.balance || b.apr - a.apr);
        } else { // avalanche
          ds.sort((a,b) => b.apr - a.apr || a.balance - b.balance);
        }
      };

      const schedule = [];
      let month = 0;
      let totalInterest = 0;
      let totalPaid = 0;

      let guard = 0; // safety to prevent infinite loop
      order();

      while (ds.some(d => d.balance > 0) && guard < 1200) {
        guard++;
        month++;

        // Payments this month
        let budgetLeft = monthlyBudgetVal;
        // Apply minimums
        ds.forEach((d,i) => {
          if (d.balance <= 0) return;
          const pay = Math.min(d.min, d.balance);
          d.balance -= pay;
          budgetLeft -= pay;
          totalPaid += pay;
        });

        // Reorder for snowball after mins (balances changed)
        order();

        // Allocate extra to current target
        let target = ds.find(d => d.balance > 0);
        if (target && budgetLeft > 0) {
          const extra = Math.min(budgetLeft, target.balance);
          target.balance -= extra;
          budgetLeft -= extra;
          totalPaid += extra;
        }

        // Accrue interest after payments
        let interestThisMonth = 0;
        ds.forEach((d, i) => {
          if (d.balance <= 0) return;
          const interest = d.balance * monthlyRates[i];
          d.balance += interest;
          interestThisMonth += interest;
        });
        totalInterest += interestThisMonth;

        // Aggregate balance
        const totalBalance = ds.reduce((s,d)=> s + Math.max(0,d.balance), 0);

        schedule.push({
          month,
          payment: monthlyBudgetVal - budgetLeft,
          interest: interestThisMonth,
          principal: (monthlyBudgetVal - budgetLeft) - interestThisMonth,
          balance: totalBalance
        });

        // small epsilon clamp
        ds.forEach(d => { if (d.balance < 0.005) d.balance = 0; });
        if (schedule.length > 600) break; // practical cap (50 years)
      }

      return {
        months: month,
        totalInterest,
        totalPaid: totalPaid + 0, // already includes interest via accrual + payments
        schedule
      };
    }

    // Rendering
    function renderKPIs(result) {
      if (!result) {
        kpiDebtfree.textContent = '—';
        kpiMonths.textContent = '—';
        kpiInterest.textContent = fmtCurrency(0, defaultCurrency);
        kpiTotal.textContent = fmtCurrency(0, defaultCurrency);
        return;
      }
      const today = new Date();
      const debtfree = new Date(today.getFullYear(), today.getMonth() + result.months, 1);
      kpiDebtfree.textContent = fmtMonth(debtfree);
      kpiMonths.textContent = String(result.months);
      kpiInterest.textContent = fmtCurrency(result.totalInterest, defaultCurrency);
      // Total paid = sum of monthly payments until payoff (approx) -> from simulate we have totalPaid tracked
      // However, because we accrue interest, a clearer KPI is principal + interest; principal = initial balances sum.
      const principalSum = readDebts().reduce((s,d)=> s + d.balance, 0);
      kpiTotal.textContent = fmtCurrency(principalSum + result.totalInterest, defaultCurrency);
    }

    function renderSchedule(result) {
      scheduleBody.innerHTML = '';
      if (!result) return;
      const rows = result.schedule;
      const today = new Date();
      rows.forEach((r, idx) => {
        const when = new Date(today.getFullYear(), today.getMonth() + (idx+1), 1);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2 text-left">${r.month}</td>
          <td class="px-3 py-2 text-left">${fmtMonth(when)}</td>
          <td class="px-3 py-2">${fmtCurrency(r.payment, defaultCurrency)}</td>
          <td class="px-3 py-2">${fmtCurrency(r.interest, defaultCurrency)}</td>
          <td class="px-3 py-2">${fmtCurrency(Math.max(0, r.principal), defaultCurrency)}</td>
          <td class="px-3 py-2">${fmtCurrency(Math.max(0, r.balance), defaultCurrency)}</td>
        `;
        scheduleBody.appendChild(tr);
      });
    }

    function renderChart(result) {
      const ctx = $('breakdownChart');
      if (!ctx) return;
      const principalSum = readDebts().reduce((s,d)=> s + d.balance, 0);
      const interest = result ? result.totalInterest : 0;
      const data = {
        labels: ['Principal', 'Interest'],
        datasets: [{ data: [Math.max(0, principalSum), Math.max(0, interest)] }]
      };
      if (chartInstance) {
        chartInstance.data = data;
        chartInstance.update();
      } else {
        chartInstance = new Chart(ctx, {
          type: 'doughnut',
          data,
          options: {
            plugins: { legend: { position: 'bottom' } },
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }
    }

    // Compute pipeline
    function recompute() {
      // Validate
      if (!validateAll()) { renderKPIs(null); renderSchedule(null); renderChart(null); return; }

      const ds = readDebts();
      const budget = parseFloat(monthlyBudget.value);
      try {
        const res = simulate(ds, budget, strategy.value);
        renderKPIs(res);
        renderSchedule(res);
        renderChart(res);
      } catch (e) {
        budgetErr.textContent = e.message;
        budgetErr.classList.remove('hidden');
        renderKPIs(null);
        renderSchedule(null);
        renderChart(null);
      }
    }
    const recomputeThrottled = throttle(recompute, 120);

    // Utilities
    function throttle(fn, wait) {
      let t = 0, last = 0, pendingArgs = null;
      return function(...args) {
        const now = Date.now();
        if (now - last > wait) { last = now; fn.apply(this, args); }
        else {
          pendingArgs = args;
          clearTimeout(t);
          t = setTimeout(() => { last = Date.now(); fn.apply(this, pendingArgs); }, wait);
        }
      }
    }

    // Events
    $('add-debt').addEventListener('click', () => { addDebtRow({}); });
    $('reset-all').addEventListener('click', () => {
      debtsBody.innerHTML = '';
      monthlyBudget.value = 800;
      strategy.value = 'avalanche';
      addDebtRow({});
      recompute();
    });
    $('load-sample').addEventListener('click', () => {
      debtsBody.innerHTML = '';
      [
        { name:'Card A', balance: 4000, apr:22.99, min:100 },
        { name:'Card B', balance: 2500, apr:17.99, min:60 },
        { name:'Loan C', balance: 1200, apr:9.99,  min:35 }
      ].forEach(addDebtRow);
      monthlyBudget.value = 800;
      strategy.value = 'avalanche';
      recompute();
    });

    monthlyBudget.addEventListener('blur', recompute);
    monthlyBudget.addEventListener('input', recomputeThrottled);
    strategy.addEventListener('change', recompute);

    printBtn.addEventListener('click', () => window.print());

    // Init with one empty row
    addDebtRow({});
    // If there’s a meaningful default, compute
    recompute();

  })();
  </script>
</body>
</html>
