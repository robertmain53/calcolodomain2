<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>calendar calculator — Add/Subtract Dates, Day Counter, Business Days</title>
  <meta name="description" content="Calendar calculator to add or subtract days, months, or years; find the difference between dates; count business days (with holidays); and get weekday & ISO week." />
  <link rel="canonical" href="https://calcdomain.com/calendar-calculator.html"/>
  <link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96" />
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="shortcut icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="manifest" href="/site.webmanifest" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>
  <!-- MathJax for LaTeX formulas -->
  <script defer id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    :root { --focus: #2563eb; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol'; }
    .prose { max-width: 70ch; }
    .prose h2 { font-size: 1.5rem; font-weight: 700; margin-top: 2rem; margin-bottom: .75rem; }
    .prose h3 { font-size: 1.15rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: .5rem; }
    .formula-box { background:#f3f4f6; border:1px solid #d1d5db; border-radius:.75rem; padding:1rem; overflow-x:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .result-shell { min-height: 7rem; } /* Prevent CLS */
    .focus-ring:focus { outline: 3px solid var(--focus); outline-offset: 2px; }
    details > summary { cursor: pointer; font-weight: 600; }
    details[open] > summary { margin-bottom: .5rem; }
    [role="tooltip"] { box-shadow: 0 10px 20px rgba(0,0,0,.08); }
    /* Larger tap targets on mobile */
    button, input, select, textarea { min-height: 48px; }
    label .req { color:#b91c1c; }
    @media print {
      body * { visibility: hidden; }
      #print-section, #print-section * { visibility: visible; }
      #print-section { position: absolute; inset: 0; width: 100%; }
    }
  </style>

  <!-- WebPage -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "calendar calculator — Add/Subtract Dates, Day Counter, Business Days",
    "description": "Calendar calculator to add or subtract days, months, or years; find the difference between dates; count business days (with holidays); and get weekday & ISO week.",
    "url": "https://calcdomain.com/calendar-calculator.html",
    "inLanguage": "en",
    "author": { "@type": "Person", "name": "Ugo Candido" },
    "publisher": { "@type": "Organization", "name": "CalcDomain" }
  }
  </script>

  <!-- Breadcrumbs -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BreadcrumbList",
    "itemListElement":[
      { "@type":"ListItem","position":1,"name":"Home","item":"https://calcdomain.com/" },
      { "@type":"ListItem","position":2,"name":"Lifestyle & Everyday","item":"https://calcdomain.com/lifestyle-everyday.html" },
      { "@type":"ListItem","position":3,"name":"Time and Date","item":"https://calcdomain.com/subcategories/time-date.html" },
      { "@type":"ListItem","position":4,"name":"Calendar Calculator","item":"https://calcdomain.com/calendar-calculator.html" }
    ]
  }
  </script>

  <!-- HowTo -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"HowTo",
    "name":"How to use the calendar calculator",
    "description":"Step-by-step to add/subtract dates, find differences, and count business days with optional holidays.",
    "step":[
      {"@type":"HowToStep","name":"Choose a mode","text":"Select Date Difference, Add/Subtract Date, Business Days, or Week & Weekday."},
      {"@type":"HowToStep","name":"Enter inputs","text":"Provide the required dates; optionally add holidays for business day counting."},
      {"@type":"HowToStep","name":"Calculate","text":"Press Calculate to get an instant result and detailed breakdown."},
      {"@type":"HowToStep","name":"Review & export","text":"Copy results or print the page section for records."}
    ]
  }
  </script>

  <!-- FAQPage -->
  <script type="application/ld+json" id="faq-json">
  {
    "@context":"https://schema.org",
    "@type":"FAQPage",
    "mainEntity":[
      {"@type":"Question","name":"Which calendar system does this tool use?","acceptedAnswer":{"@type":"Answer","text":"It uses the proleptic Gregorian calendar, aligned with ISO 8601 conventions for weeks and dates."}},
      {"@type":"Question","name":"How are business days counted?","acceptedAnswer":{"@type":"Answer","text":"Weekends (Saturday and Sunday) are excluded by default. You can also exclude custom holidays you enter."}},
      {"@type":"Question","name":"Can I add months and years accurately across end-of-month boundaries?","acceptedAnswer":{"@type":"Answer","text":"Yes. Adding months/years clamps to the last valid day of the target month when the original day does not exist (e.g., adding 1 month to Jan 31 becomes Feb 29 in leap years or Feb 28 otherwise)."}},
      {"@type":"Question","name":"What about leap years?","acceptedAnswer":{"@type":"Answer","text":"Leap years follow the Gregorian rules: divisible by 4, except centuries not divisible by 400."}},
      {"@type":"Question","name":"How is ISO week number defined?","acceptedAnswer":{"@type":"Answer","text":"Per ISO 8601, weeks start on Monday, and week 1 is the week containing the year’s first Thursday."}},
      {"@type":"Question","name":"Can I paste holidays from a spreadsheet?","acceptedAnswer":{"@type":"Answer","text":"Yes. Paste dates as YYYY-MM-DD, one per line; duplicates and blanks are ignored."}},
      {"@type":"Question","name":"Does the tool consider time zones?","acceptedAnswer":{"@type":"Answer","text":"Calculations are date-based (no time-of-day) and ignore time zones for consistency."}}
    ]
  }
  </script>
</head>

<body class="bg-gray-50 text-gray-900">
  <!-- Header (non-sticky per spec) -->
  <header class="bg-white border-b">
    <nav class="container mx-auto px-4 md:px-6 py-4">
      <div class="flex items-center justify-between">
        <a href="index.html" class="text-2xl font-extrabold text-blue-700 hover:underline focus-ring">CalcDomain</a>
        <div class="text-sm hidden md:flex gap-6">
          <a href="search.html" class="hover:text-blue-700 focus-ring">Advanced Search</a>
          <a href="index.html#categories" class="hover:text-blue-700 focus-ring">Categories</a>
        </div>
      </div>
    </nav>
  </header>

  <main class="container mx-auto px-4 md:px-6 py-8">
    <div id="print-section" class="max-w-[1200px] mx-auto">
      <!-- 1) H1 -->
      <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight mb-2">calendar calculator.</h1>

      <!-- 2) Intro -->
      <p class="text-gray-700 mb-6">
        A professional, standards-based calendar calculator for planners, lawyers, accountants, and operations teams.
        Compute precise date differences, add or subtract months/years safely across end-of-month boundaries, count business days with optional holidays, and retrieve weekday & ISO week numbers.
      </p>

      <!-- Breadcrumb (visible) -->
      <nav aria-label="Breadcrumb" class="text-sm text-gray-600 mb-6">
        <a href="index.html" class="hover:text-blue-700 focus-ring">Home</a> &raquo;
        <a href="lifestyle-everyday.html" class="hover:text-blue-700 focus-ring">Everyday Life</a> &raquo;
        <a href="subcategories/time-date.html" class="hover:text-blue-700 focus-ring">Time and Date</a> &raquo;
        <span class="text-gray-900">calendar calculator</span>
      </nav>

      <!-- 3) Calculator UI -->
      <section aria-labelledby="calc-title" class="bg-white rounded-2xl shadow p-4 md:p-6">
        <h2 id="calc-title" class="sr-only">Calendar Calculator Interface</h2>

        <!-- Mode selector -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label for="mode" class="block text-sm font-medium text-gray-900 mb-1">Mode <span class="req" aria-hidden="true">*</span></label>
            <select id="mode" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus-ring" aria-required="true" aria-describedby="mode-tip mode-err">
              <option value="diff" selected>Date Difference (two dates)</option>
              <option value="addsub">Add/Subtract (date ± y/m/d)</option>
              <option value="biz">Business Days between dates</option>
              <option value="week">Weekday & ISO week</option>
            </select>
            <p id="mode-err" class="mt-1 text-sm text-red-700 hidden">Please choose a calculation mode.</p>
            <div class="mt-1">
              <button type="button" class="text-xs px-2 py-1 rounded bg-gray-100 border focus-ring" aria-expanded="false" aria-controls="mode-tip" aria-describedby="mode">
                ?
                <span class="sr-only">About modes</span>
              </button>
            </div>
            <div id="mode-tip" role="tooltip" class="hidden mt-2 text-sm bg-white border rounded-lg p-3">
              Choose the operation: difference (days/years-months-days), add or subtract components to a date, business-day count (excludes weekends & your holidays), or weekday & ISO week number.
            </div>
          </div>

          <!-- Print button -->
          <div class="flex items-end">
            <button id="printBtn" class="w-full md:w-auto ml-0 md:ml-auto px-4 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 focus-ring" type="button">
              Print results
            </button>
          </div>
        </div>

        <!-- Panels -->
        <div id="panels" class="grid grid-cols-1 md:grid-cols-2 gap-4">

          <!-- Date Difference -->
          <fieldset id="panel-diff" class="border rounded-xl p-4" aria-labelledby="legend-diff">
            <legend id="legend-diff" class="font-semibold">Date Difference</legend>
            <div class="space-y-4">
              <div>
                <label for="diff-start" class="block text-sm font-medium text-gray-900 mb-1">Start date <span class="req">*</span></label>
                <input id="diff-start" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus-ring"
                       aria-required="true" aria-describedby="diff-start-err">
                <p id="diff-start-err" class="mt-1 text-sm text-red-700 hidden">Enter a valid start date.</p>
              </div>
              <div>
                <label for="diff-end" class="block text-sm font-medium text-gray-900 mb-1">End date <span class="req">*</span></label>
                <input id="diff-end" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus-ring"
                       aria-required="true" aria-describedby="diff-end-err">
                <p id="diff-end-err" class="mt-1 text-sm text-red-700 hidden">Enter a valid end date (same or after start).</p>
              </div>
              <button id="btn-diff" class="w-full md:w-auto px-4 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 focus-ring" type="button">Calculate</button>
            </div>
          </fieldset>

          <!-- Add/Subtract -->
          <fieldset id="panel-addsub" class="border rounded-xl p-4 hidden" aria-labelledby="legend-addsub">
            <legend id="legend-addsub" class="font-semibold">Add / Subtract</legend>
            <div class="space-y-4">
              <div>
                <label for="as-base" class="block text-sm font-medium text-gray-900 mb-1">Base date <span class="req">*</span></label>
                <input id="as-base" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus-ring" aria-required="true" aria-describedby="as-base-err">
                <p id="as-base-err" class="mt-1 text-sm text-red-700 hidden">Enter a valid base date.</p>
              </div>
              <div class="grid grid-cols-3 gap-3">
                <div>
                  <label for="as-years" class="block text-sm font-medium text-gray-900 mb-1">Years</label>
                  <input id="as-years" type="number" step="1" value="0" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus-ring" aria-describedby="as-tip">
                </div>
                <div>
                  <label for="as-months" class="block text-sm font-medium text-gray-900 mb-1">Months</label>
                  <input id="as-months" type="number" step="1" value="0" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus-ring" aria-describedby="as-tip">
                </div>
                <div>
                  <label for="as-days" class="block text-sm font-medium text-gray-900 mb-1">Days</label>
                  <input id="as-days" type="number" step="1" value="0" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus-ring" aria-describedby="as-tip">
                </div>
              </div>
              <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                  <input id="as-add" name="as-sign" type="radio" class="h-5 w-5 focus-ring" checked>
                  <label for="as-add">Add</label>
                </div>
                <div class="flex items-center gap-2">
                  <input id="as-sub" name="as-sign" type="radio" class="h-5 w-5 focus-ring">
                  <label for="as-sub">Subtract</label>
                </div>
                <button type="button" class="text-xs px-2 py-1 rounded bg-gray-100 border focus-ring" aria-expanded="false" aria-controls="as-tip" aria-describedby="as-years as-months as-days">?</button>
              </div>
              <div id="as-tip" role="tooltip" class="hidden mt-2 text-sm bg-white border rounded-lg p-3">
                Month/year arithmetic is <em>end-of-month safe</em>: if the target month is shorter, the result clamps to its last valid day.
              </div>
              <button id="btn-as" class="w-full md:w-auto px-4 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 focus-ring" type="button">Calculate</button>
            </div>
          </fieldset>

          <!-- Business Days -->
          <fieldset id="panel-biz" class="border rounded-xl p-4 hidden" aria-labelledby="legend-biz">
            <legend id="legend-biz" class="font-semibold">Business Days (excl. weekends & holidays)</legend>
            <div class="space-y-4">
              <div>
                <label for="biz-start" class="block text-sm font-medium text-gray-900 mb-1">Start date <span class="req">*</span></label>
                <input id="biz-start" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus-ring" aria-required="true" aria-describedby="biz-start-err">
                <p id="biz-start-err" class="mt-1 text-sm text-red-700 hidden">Enter a valid start date.</p>
              </div>
              <div>
                <label for="biz-end" class="block text-sm font-medium text-gray-900 mb-1">End date <span class="req">*</span></label>
                <input id="biz-end" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus-ring" aria-required="true" aria-describedby="biz-end-err">
                <p id="biz-end-err" class="mt-1 text-sm text-red-700 hidden">Enter a valid end date (same or after start).</p>
              </div>
              <div>
                <label for="biz-holidays" class="block text-sm font-medium text-gray-900 mb-1">
                  Holidays (YYYY-MM-DD, one per line)
                </label>
                <textarea id="biz-holidays" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus-ring" rows="4" placeholder="2025-01-01&#10;2025-12-25"></textarea>
                <p class="text-xs text-gray-600 mt-1">Blank lines and duplicates are ignored.</p>
              </div>
              <button id="btn-biz" class="w-full md:w-auto px-4 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 focus-ring" type="button">Calculate</button>
            </div>
          </fieldset>

          <!-- Weekday & ISO Week -->
          <fieldset id="panel-week" class="border rounded-xl p-4 hidden" aria-labelledby="legend-week">
            <legend id="legend-week" class="font-semibold">Weekday & ISO Week</legend>
            <div class="space-y-4">
              <div>
                <label for="week-date" class="block text-sm font-medium text-gray-900 mb-1">Date <span class="req">*</span></label>
                <input id="week-date" type="date" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus-ring" aria-required="true" aria-describedby="week-date-err">
                <p id="week-date-err" class="mt-1 text-sm text-red-700 hidden">Enter a valid date.</p>
              </div>
              <button id="btn-week" class="w-full md:w-auto px-4 py-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 focus-ring" type="button">Calculate</button>
            </div>
          </fieldset>

        </div>
      </section>

      <!-- 4) Results -->
      <section aria-labelledby="results-title" class="mt-6">
        <h2 id="results-title" class="sr-only">Results</h2>
        <div id="results" class="result-shell bg-blue-50 border border-blue-100 rounded-2xl p-4 md:p-6">
          <div id="results-summary" class="text-lg font-semibold text-blue-900">Enter inputs and press Calculate.</div>
          <div id="results-detail" class="mt-3 text-gray-900 text-sm space-y-2"></div>
        </div>
      </section>

      <!-- 5) Authoritative Content Ecosystem -->
      <section class="mt-10 bg-white rounded-2xl shadow p-6 prose">
        <h2>Authoritative Data Source & Methodology</h2>
        <p>
          Primary standards referenced:
        </p>
        <ul>
          <li><strong>ISO 8601:2019</strong> — Date and time — Representations for information interchange (weeks start Monday; week 1 contains the first Thursday).</li>
          <li><strong>Gregorian calendar rules</strong> — Leap year if divisible by 4, except end-of-century years not divisible by 400.</li>
        </ul>
        <p><em>Tutti i calcoli si basano rigorosamente sulle formule e sui dati forniti da questa fonte.</em></p>
        <p>See also: <a class="text-blue-700 hover:underline" href="https://www.iso.org/iso-8601-date-and-time-format.html">ISO overview</a> and <a class="text-blue-700 hover:underline" href="https://en.wikipedia.org/wiki/ISO_week_date">ISO week date summary</a>.</p>

        <h2>The Formula Explained</h2>
        <div class="formula-box">
          <p><strong>Date difference (days)</strong>:</p>
          <p>\[
            \Delta d = \mathrm{days}(d_2) - \mathrm{days}(d_1)
          \]</p>
          <p><strong>Y–M–D breakdown</strong> (proleptic Gregorian):</p>
          <p>\[
            \Delta y = y_2 - y_1,\quad
            \Delta m = m_2 - m_1,\quad
            \Delta d' = d_2 - d_1
          \]
          Adjust \(\Delta m,\Delta d'\) by borrowing/carrying based on month lengths and leap-year rules.</p>
          <p><strong>Add/Subtract</strong> with end-of-month safety:</p>
          <p>\[
            \mathrm{add}(y,m,d; \Delta y,\Delta m,\Delta d) =
            \mathrm{clampEOM}\bigl(y+\Delta y,\; m+\Delta m,\; d\bigr) + \Delta d
          \]
          where \(\mathrm{clampEOM}\) sets the day to the month's last valid day if needed.</p>
          <p><strong>Business days, excluding weekends & holidays</strong>:</p>
          <p>\[
            \mathrm{bizdays}(d_1,d_2,H)=\sum_{t=d_1}^{d_2-1}\mathbf{1}\bigl(\mathrm{weekday}(t)\in\{1,\dots,5\}\land t\notin H\bigr)
          \]</p>
          <p><strong>ISO week number</strong> (ISO 8601):</p>
          <p>\[
            \mathrm{week}(d)=\mathrm{ISOWeekNumber}(d),\quad \mathrm{weekday}_{\mathrm{ISO}}\in\{1\ldots7\}
          \]</p>
        </div>

        <h2>Glossary of Variables</h2>
        <ul>
          <li><strong>Start/End date</strong>: The two dates used for difference or business-day counting.</li>
          <li><strong>Base date</strong>: The date to which years/months/days are added or subtracted.</li>
          <li><strong>Years / Months / Days</strong>: Integer components applied to the base date; negative values are supported via the subtract option.</li>
          <li><strong>Business days</strong>: Monday–Friday, excluding listed holidays.</li>
          <li><strong>ISO week</strong>: Week numbering per ISO 8601; weeks start Monday; week 1 holds the first Thursday.</li>
        </ul>

        <h2>How It Works: A Step-by-Step Example</h2>
        <h3>Add one month to January 31, 2024, then 10 days</h3>
        <ol>
          <li>Base date: 2024-01-31. Add 0 years, 1 month, 10 days.</li>
          <li>Month add yields February 31 → clamped to February 29 (leap year).</li>
          <li>Add 10 days → 2024-03-10.</li>
        </ol>
        <p>The clamping uses the \(\mathrm{clampEOM}\) rule above to guarantee valid results in shorter months.</p>

        <h2>Frequently Asked Questions</h2>
        <details>
          <summary>Which calendar system does this tool use?</summary>
          <p>Proleptic Gregorian with ISO 8601 conventions for weeks/dates.</p>
        </details>
        <details>
          <summary>How are business days counted?</summary>
          <p>It excludes weekends and any holidays you provide. The interval is start-inclusive, end-exclusive by default.</p>
        </details>
        <details>
          <summary>What happens at the end of months?</summary>
          <p>When adding months/years, if the original day isn’t present in the target month, the date clamps to the month’s last valid day.</p>
        </details>
        <details>
          <summary>Does it support negative differences?</summary>
          <p>Yes, the tool reports signed day differences and also shows absolute values.</p>
        </details>
        <details>
          <summary>Are time zones considered?</summary>
          <p>No, this is a pure date calculator—no time-of-day or DST effects.</p>
        </details>
        <details>
          <summary>Is ISO week the same as US week numbers?</summary>
          <p>Not necessarily; ISO weeks start Monday and can differ from locale-specific systems.</p>
        </details>
      </section>

      <!-- 6) Authorship & Review -->
      <section class="mt-6">
        <div class="bg-gray-50 border border-gray-200 rounded-2xl p-4 text-sm text-gray-700">
          <p><strong>Tool developed by Ugo Candido.</strong> Content verified by CalcDomain Editorial Board.<br>
            Last accuracy review: <time id="review-date" datetime="2025-10-27">October 27, 2025</time>
          </p>
        </div>
      </section>
    </div>
  </main>

  <footer class="bg-white border-t">
    <div class="container mx-auto px-6 py-8 text-center text-gray-600 text-sm">
      <p>&copy; 2025 CalcDomain. All Rights Reserved.</p>
      <div class="mt-4 space-x-4">
        <a href="about.html" class="hover:text-blue-700 focus-ring">About</a>
        <a href="contact.html" class="hover:text-blue-700 focus-ring">Contact</a>
        <a href="privacy.html" class="hover:text-blue-700 focus-ring">Privacy</a>
        <a href="terms.html" class="hover:text-blue-700 focus-ring">Terms</a>
      </div>
    </div>
  </footer>

  <!-- Calculator logic (defer) -->
  <script defer>
  (function(){
    const $ = (id) => document.getElementById(id);
    const show = (el) => el.classList.remove('hidden');
    const hide = (el) => el.classList.add('hidden');

    // Elements
    const els = {
      mode: $('mode'),
      panels: {
        diff: $('panel-diff'),
        addsub: $('panel-addsub'),
        biz: $('panel-biz'),
        week: $('panel-week')
      },
      // diff
      diffStart: $('diff-start'),
      diffEnd: $('diff-end'),
      btnDiff: $('btn-diff'),
      // add/sub
      asBase: $('as-base'),
      asYears: $('as-years'),
      asMonths: $('as-months'),
      asDays: $('as-days'),
      asAdd: $('as-add'),
      asSub: $('as-sub'),
      btnAs: $('btn-as'),
      // biz
      bizStart: $('biz-start'),
      bizEnd: $('biz-end'),
      bizHolidays: $('biz-holidays'),
      btnBiz: $('btn-biz'),
      // week
      weekDate: $('week-date'),
      btnWeek: $('btn-week'),
      // UI
      resultsSummary: $('results-summary'),
      resultsDetail: $('results-detail'),
      printBtn: $('printBtn')
    };

    // Tooltips (accessible toggle)
    document.querySelectorAll('[aria-controls][aria-expanded]').forEach(btn => {
      btn.addEventListener('click', () => {
        const target = document.getElementById(btn.getAttribute('aria-controls'));
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        btn.setAttribute('aria-expanded', String(!expanded));
        if (expanded) { target.classList.add('hidden'); }
        else { target.classList.remove('hidden'); }
      });
    });

    // Mode switching
    function switchMode() {
      const v = els.mode.value;
      Object.values(els.panels).forEach(p => hide(p));
      if (v === 'diff') show(els.panels.diff);
      if (v === 'addsub') show(els.panels.addsub);
      if (v === 'biz') show(els.panels.biz);
      if (v === 'week') show(els.panels.week);
      resetResults();
    }
    els.mode.addEventListener('change', switchMode);

    // Validation helpers
    function parseDate(value) {
      if (!value) return null;
      const d = new Date(value + 'T00:00:00');
      return isNaN(d.getTime()) ? null : d;
    }
    function setErr(id, cond, msgId) {
      const p = $(msgId);
      if (!p) return;
      if (cond) { p.classList.remove('hidden'); $(id).setAttribute('aria-invalid', 'true'); }
      else { p.classList.add('hidden'); $(id).removeAttribute('aria-invalid'); }
      return !cond;
    }
    function onBlurValidate(inputId, msgId, test) {
      const el = $(inputId);
      el.addEventListener('blur', () => { setErr(inputId, !test(el.value), msgId); });
    }

    // Attach on-blur validators
    onBlurValidate('diff-start','diff-start-err', v => !!parseDate(v));
    onBlurValidate('diff-end','diff-end-err', v => !!parseDate(v));
    onBlurValidate('as-base','as-base-err', v => !!parseDate(v));
    onBlurValidate('biz-start','biz-start-err', v => !!parseDate(v));
    onBlurValidate('biz-end','biz-end-err', v => !!parseDate(v));
    onBlurValidate('week-date','week-date-err', v => !!parseDate(v));

    // Core helpers
    const daysBetween = (a, b) => Math.round((b - a) / 86400000); // end-exclusive when used appropriately
    const isLeap = (y) => (y%4===0) && (y%100!==0 || y%400===0);
    const monthLen = (y, m) => [31, (isLeap(y)?29:28), 31,30,31,30,31,31,30,31,30,31][m-1];

    function clampEOM(y, m, d) {
      // Normalize month overflow
      while (m > 12) { y += 1; m -= 12; }
      while (m < 1) { y -= 1; m += 12; }
      const ml = monthLen(y, m);
      return new Date(Date.UTC(y, m-1, Math.min(d, ml)));
    }

    function addYMD(base, y, m, d) {
      const by = base.getUTCFullYear();
      const bm = base.getUTCMonth()+1;
      const bd = base.getUTCDate();
      const sign = 1;
      let ty = by + y;
      let tm = bm + m;
      let out = clampEOM(ty, tm, bd); // handle EOM for Y/M
      // Add days after month/year adjustment
      out = new Date(out.getTime() + d*86400000);
      // Return local date (strip time)
      return new Date(out.getUTCFullYear(), out.getUTCMonth(), out.getUTCDate());
    }

    function isoWeek(date) {
      // Copy date, set to Thursday in current week
      const d = new Date(Date.UTC(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()));
      const day = (d.getUTCDay() + 6) % 7; // Monday=0
      d.setUTCDate(d.getUTCDate() - day + 3);
      const firstThursday = new Date(Date.UTC(d.getUTCFullYear(), 0, 4));
      const firstDay = (firstThursday.getUTCDay() + 6) % 7;
      firstThursday.setUTCDate(firstThursday.getUTCDate() - firstDay + 3);
      const week = 1 + Math.round((d - firstThursday) / 604800000);
      return { year: d.getUTCFullYear(), week };
    }

    function weekdayName(d) {
      return ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][d.getDay()];
    }

    // Results
    function resetResults() {
      els.resultsSummary.textContent = 'Enter inputs and press Calculate.';
      els.resultsDetail.innerHTML = '';
    }
    function setResults(title, detailsHTML) {
      els.resultsSummary.textContent = title;
      els.resultsDetail.innerHTML = detailsHTML || '';
      // Typeset any MathJax if present
      if (window.MathJax && window.MathJax.typesetPromise) { MathJax.typesetPromise(); }
    }

    // Button handlers
    els.btnDiff.addEventListener('click', () => {
      const a = parseDate(els.diffStart.value);
      const b = parseDate(els.diffEnd.value);
      const okA = setErr('diff-start', !a, 'diff-start-err');
      const okB = setErr('diff-end', !(b && a && (b>=a)), 'diff-end-err');
      if (!(okA && okB)) return;

      const days = daysBetween(a, b); // end-exclusive
      // Y-M-D breakdown
      let y1=a.getFullYear(), m1=a.getMonth()+1, d1=a.getDate();
      let y2=b.getFullYear(), m2=b.getMonth()+1, d2=b.getDate();
      let dy=y2-y1, dm=m2-m1, dd=d2-d1;
      if (dd<0){ dm-=1; const prevMonth=m2-1 || 12; const prevYear = prevMonth===12? y2-1 : y2; dd += monthLen(prevYear, prevMonth); }
      if (dm<0){ dy-=1; dm+=12; }

      setResults(
        `Difference: ${days} day${Math.abs(days)===1?'':'s'} (end-exclusive)`,
        `<p><strong>Breakdown:</strong> ${dy} year(s), ${dm} month(s), ${dd} day(s)</p>
         <p><strong>Absolute days:</strong> ${Math.abs(days)}</p>
         <p class="text-xs text-gray-600">By convention here, the range counts days from start (inclusive) to end (exclusive). For inclusive ranges, add 1.</p>`
      );
    });

    els.btnAs.addEventListener('click', () => {
      const base = parseDate(els.asBase.value);
      const ok = setErr('as-base', !base, 'as-base-err');
      if (!ok) return;
      const yrs = parseInt(els.asYears.value || '0',10);
      const mon = parseInt(els.asMonths.value || '0',10);
      const day = parseInt(els.asDays.value || '0',10);
      const sign = els.asSub.checked ? -1 : 1;

      const result = addYMD(new Date(Date.UTC(base.getFullYear(), base.getMonth(), base.getDate())), sign*yrs, sign*mon, sign*day);
      const iso = result.toISOString().slice(0,10);
      setResults(
        `Resulting date: ${result.toDateString()}`,
        `<p><strong>ISO:</strong> ${iso}</p>
         <p><strong>Operation:</strong> ${els.asSub.checked? 'Subtract' : 'Add'} ${Math.abs(yrs)}y ${Math.abs(mon)}m ${Math.abs(day)}d to ${base.toDateString()}</p>
         <p class="text-xs text-gray-600">Month/year arithmetic uses end-of-month clamping for validity.</p>`
      );
    });

    els.btnBiz.addEventListener('click', () => {
      const a = parseDate(els.bizStart.value);
      const b = parseDate(els.bizEnd.value);
      const okA = setErr('biz-start', !a, 'biz-start-err');
      const okB = setErr('biz-end', !(b && a && (b>=a)), 'biz-end-err');
      if (!(okA && okB)) return;

      // Holidays set
      const hol = new Set();
      (els.bizHolidays.value || '')
        .split(/\r?\n/)
        .map(s => s.trim())
        .filter(s => /^\d{4}-\d{2}-\d{2}$/.test(s))
        .forEach(s => hol.add(s));

      // Count start-inclusive, end-exclusive
      let cur = new Date(a.getFullYear(), a.getMonth(), a.getDate());
      let end = new Date(b.getFullYear(), b.getMonth(), b.getDate());
      let count = 0;
      const skipped = [];
      while (cur < end) {
        const dow = cur.getDay(); // 0 Sun .. 6 Sat
        const iso = cur.toISOString().slice(0,10);
        if (dow>=1 && dow<=5 && !hol.has(iso)) count++;
        else if (hol.has(iso)) skipped.push(iso);
        cur.setDate(cur.getDate()+1);
      }
      setResults(
        `Business days: ${count}`,
        `<p><strong>Window:</strong> ${a.toDateString()} → ${b.toDateString()} (end-exclusive)</p>
         <p><strong>Weekends excluded:</strong> Yes &nbsp;|&nbsp; <strong>Holidays excluded:</strong> ${hol.size}</p>
         ${skipped.length ? `<p class="text-sm text-gray-700"><strong>Holidays encountered:</strong> ${skipped.join(', ')}</p>` : '' }
         <p class="text-xs text-gray-600">For inclusive ranges, add 1 if the end day would count as a business day.</p>`
      );
    });

    els.btnWeek.addEventListener('click', () => {
      const d = parseDate(els.weekDate.value);
      const ok = setErr('week-date', !d, 'week-date-err');
      if (!ok) return;
      const iso = isoWeek(new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())));
      setResults(
        `Weekday & ISO week`,
        `<p><strong>Weekday:</strong> ${weekdayName(d)}</p>
         <p><strong>ISO week:</strong> ${iso.year}-W${String(iso.week).padStart(2,'0')}</p>`
      );
    });

    // Print
    els.printBtn.addEventListener('click', () => window.print());

    // Initialize
    switchMode();

    // Prefill review date (already set to 2025-10-27 in HTML; keep as fallback)
    const rd = document.getElementById('review-date');
    if (rd) {
      const now = new Date();
      rd.dateTime = now.toISOString().slice(0,10);
      rd.textContent = now.toLocaleDateString(undefined, { year:'numeric', month:'long', day:'numeric' });
    }
  })();
  </script>
</body>
</html>
